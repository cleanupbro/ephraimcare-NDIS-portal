---
phase: 09-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/lib/notifications/types.ts
  - apps/admin/lib/notifications/templates.ts
  - apps/admin/lib/notifications/send-email.ts
  - apps/admin/lib/notifications/index.ts
autonomous: true

must_haves:
  truths:
    - "sendNotificationEmail() can fire HTTP request to Resend API without blocking caller"
    - "Email templates render clean HTML with Ephraim Care branding"
    - "Date/time values are formatted in Sydney timezone"
  artifacts:
    - path: "apps/admin/lib/notifications/send-email.ts"
      provides: "Fire-and-forget email sending to Resend API"
      exports: ["sendNotificationEmail", "sendShiftAssignmentEmail", "sendShiftCancellationEmail", "sendInvoiceFinalizedEmail"]
    - path: "apps/admin/lib/notifications/templates.ts"
      provides: "HTML template strings for all notification types"
      exports: ["shiftAssignmentTemplate", "shiftCancellationTemplate", "invoiceFinalizedTemplate"]
    - path: "apps/admin/lib/notifications/types.ts"
      provides: "TypeScript interfaces for notification payloads"
      exports: ["NotificationEmailParams", "ShiftAssignmentEmailParams", "ShiftCancellationEmailParams", "InvoiceFinalizedEmailParams"]
  key_links:
    - from: "apps/admin/lib/notifications/send-email.ts"
      to: "https://api.resend.com/emails"
      via: "fetch POST request"
      pattern: "fetch\\('https://api\\.resend\\.com/emails'"
    - from: "apps/admin/lib/notifications/send-email.ts"
      to: "@ephraimcare/utils"
      via: "formatSydneyDate import"
      pattern: "formatSydneyDate"
---

<objective>
Create the notification infrastructure: email sending helper, HTML templates, and type definitions.

Purpose: Establish the foundation for all notification emails so that shift and invoice wiring plans can simply call wrapper functions.

Output: `/apps/admin/lib/notifications/` directory with `send-email.ts`, `templates.ts`, `types.ts`, and `index.ts` barrel export.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-notifications/09-CONTEXT.md
@.planning/phases/09-notifications/09-RESEARCH.md
@apps/admin/app/api/workers/invite/route.ts
@packages/utils/src/dates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification types</name>
  <files>apps/admin/lib/notifications/types.ts</files>
  <action>
    Create TypeScript interfaces for notification payloads:

    1. `NotificationEmailParams` - base interface for sendNotificationEmail():
       - `to: string | string[]`
       - `cc?: string | string[]`
       - `subject: string`
       - `html: string`

    2. `ShiftAssignmentEmailParams`:
       - `workerEmail: string`
       - `workerName: string`
       - `scheduledStart: string` (ISO datetime)
       - `scheduledEnd: string` (ISO datetime)
       - `participantName: string`
       - `shiftId: string`

    3. `ShiftCancellationEmailParams`:
       - `workerEmail: string`
       - `workerName: string`
       - `participantEmail: string | null`
       - `participantName: string`
       - `scheduledStart: string` (ISO datetime)
       - `cancellationReason: string`

    4. `InvoiceFinalizedEmailParams`:
       - `participantEmail: string`
       - `participantName: string`
       - `emergencyContactEmail: string | null`
       - `invoiceNumber: string`
       - `invoiceId: string`
       - `total: number`
  </action>
  <verify>TypeScript file compiles without errors: `npx tsc --noEmit apps/admin/lib/notifications/types.ts`</verify>
  <done>All 4 interfaces exported from types.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create HTML email templates</name>
  <files>apps/admin/lib/notifications/templates.ts</files>
  <action>
    Create template literal functions returning clean HTML strings:

    1. `shiftAssignmentTemplate(params: { workerName, date, time, participantName, viewUrl })`:
       - Subject line mentions new shift
       - Green heading (#66BB6A) "New Shift Assigned"
       - Brief greeting with worker name
       - Info block with date, time, participant name (gray background, 8px radius)
       - Green CTA button "View Shift Details" linking to viewUrl
       - Footer: "Ephraim Care"
       - Mobile-friendly (max-width 600px, system fonts)

    2. `shiftCancellationTemplate(params: { recipientName, date, time, participantName, reason })`:
       - Heading: "Shift Cancelled"
       - Info block with date, time, participant
       - "Reason:" section with the cancellation reason
       - No CTA button needed
       - Footer: "Ephraim Care"

    3. `invoiceFinalizedTemplate(params: { participantName, invoiceNumber, total, viewUrl })`:
       - Heading: "Invoice Ready"
       - Brief message that invoice is available
       - Info block with invoice number and total amount
       - Green CTA button "View Invoice" linking to participant portal
       - Footer: "Ephraim Care"

    Use inline CSS only (no external stylesheets). Keep templates scannable - workers check on phones.
  </action>
  <verify>File exports 3 functions, each returns a string containing `<!DOCTYPE html>`</verify>
  <done>shiftAssignmentTemplate, shiftCancellationTemplate, invoiceFinalizedTemplate exported</done>
</task>

<task type="auto">
  <name>Task 3: Create email sending helper with wrapper functions</name>
  <files>apps/admin/lib/notifications/send-email.ts, apps/admin/lib/notifications/index.ts</files>
  <action>
    Create send-email.ts with:

    1. `ADMIN_EMAIL` constant: `'ephraimcare252@gmail.com'`

    2. `sendNotificationEmail(params: NotificationEmailParams): void`
       - Check `process.env.RESEND_API_KEY` exists, log warning and return early if missing
       - Fire-and-forget fetch to `https://api.resend.com/emails`
       - Headers: Authorization Bearer token, Content-Type application/json
       - Body: from `Ephraim Care <noreply@ephraimcare.com.au>`, to, cc, subject, html
       - `.catch()` to log errors without throwing (don't block caller)
       - NO await - this is fire-and-forget

    3. `sendShiftAssignmentEmail(params: ShiftAssignmentEmailParams): void`
       - Import `formatSydneyDate` from `@ephraimcare/utils`
       - Format date: `EEEE, d MMMM yyyy` (e.g., "Monday, 27 January 2026")
       - Format times: `h:mm a` (e.g., "9:00 AM")
       - Build viewUrl from `process.env.NEXT_PUBLIC_WORKER_APP_URL` or fallback
       - Call sendNotificationEmail with worker email TO, admin CC
       - Subject: `New Shift: ${dateStr}`

    4. `sendShiftCancellationEmail(params: ShiftCancellationEmailParams): void`
       - Format date and time same way
       - Send to worker with admin CC
       - If participantEmail exists, send separate email to participant with admin CC
       - Subject: `Shift Cancelled: ${dateStr}`

    5. `sendInvoiceFinalizedEmail(params: InvoiceFinalizedEmailParams): void`
       - Build viewUrl from `process.env.NEXT_PUBLIC_PARTICIPANT_URL` or fallback
       - CC list includes admin, plus emergencyContactEmail if on file
       - Subject: `Invoice ${invoiceNumber} Ready`

    Create index.ts barrel export:
    - Re-export all from types.ts
    - Re-export all from send-email.ts
    - Re-export templates (for testing purposes)
  </action>
  <verify>
    1. `npx tsc --noEmit apps/admin/lib/notifications/*.ts` succeeds
    2. Verify `sendNotificationEmail` does NOT have `await` before fetch
  </verify>
  <done>
    - sendNotificationEmail fires without awaiting
    - Three wrapper functions format dates using Sydney timezone
    - index.ts re-exports all public APIs
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit apps/admin/lib/notifications/*.ts` - all files compile
2. Grep for `await fetch` in send-email.ts - should NOT match (fire-and-forget)
3. Templates include `#66BB6A` color for Ephraim Care branding
4. formatSydneyDate import works (no missing module errors)
</verification>

<success_criteria>
- [ ] lib/notifications/ directory created with 4 files
- [ ] Types define all notification payloads
- [ ] Templates render valid HTML with Ephraim Care branding
- [ ] sendNotificationEmail is fire-and-forget (no await)
- [ ] Wrapper functions format Sydney dates correctly
- [ ] Barrel export provides clean import path
</success_criteria>

<output>
After completion, create `.planning/phases/09-notifications/09-01-SUMMARY.md`
</output>
