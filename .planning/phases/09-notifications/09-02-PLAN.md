---
phase: 09-notifications
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - apps/admin/hooks/use-create-shift.ts
  - apps/admin/hooks/use-cancel-shift.ts
autonomous: true

must_haves:
  truths:
    - "Creating a shift triggers email to assigned worker with shift details"
    - "Cancelling a shift triggers email to worker with cancellation reason"
    - "Emails include correct date, time, and participant/worker names"
  artifacts:
    - path: "apps/admin/hooks/use-create-shift.ts"
      provides: "Shift creation with notification trigger"
      contains: "sendShiftAssignmentEmail"
    - path: "apps/admin/hooks/use-cancel-shift.ts"
      provides: "Shift cancellation with notification trigger"
      contains: "sendShiftCancellationEmail"
  key_links:
    - from: "apps/admin/hooks/use-create-shift.ts"
      to: "apps/admin/lib/notifications/send-email.ts"
      via: "import and call in onSuccess"
      pattern: "sendShiftAssignmentEmail"
    - from: "apps/admin/hooks/use-cancel-shift.ts"
      to: "apps/admin/lib/notifications/send-email.ts"
      via: "import and call in mutationFn after update"
      pattern: "sendShiftCancellationEmail"
---

<objective>
Wire shift notifications: send emails when shifts are created or cancelled.

Purpose: Workers receive timely notifications about their shift assignments and cancellations (NOTF-01, NOTF-02), keeping them informed without manual communication.

Output: Updated `use-create-shift.ts` and `use-cancel-shift.ts` hooks that call notification functions after successful mutations.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-notifications/09-CONTEXT.md
@.planning/phases/09-notifications/09-RESEARCH.md
@.planning/phases/09-notifications/09-01-SUMMARY.md
@apps/admin/hooks/use-create-shift.ts
@apps/admin/hooks/use-cancel-shift.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire shift assignment notification</name>
  <files>apps/admin/hooks/use-create-shift.ts</files>
  <action>
    Update use-create-shift.ts to send notification email after shift creation:

    1. Add import: `import { sendShiftAssignmentEmail } from '@/lib/notifications'`

    2. Define a local type for the notification data (since ShiftWithRelations doesn't have email):
       ```typescript
       interface CreatedShiftWithNotificationData {
         id: string
         scheduled_start: string
         scheduled_end: string
         worker: {
           profile: { email: string; first_name: string }
         }
         participant: { first_name: string; last_name: string }
       }
       ```

    3. Update the select in mutationFn to fetch worker and participant details:
       ```typescript
       const { data, error } = await (supabase
         .from('shifts')
         .insert({
           // ... existing insert fields
         }) as any)
         .select(`
           id,
           scheduled_start,
           scheduled_end,
           worker:workers(
             profile:profiles(email, first_name)
           ),
           participant:participants(first_name, last_name)
         `)
         .single()

       if (error) throw error
       return data as CreatedShiftWithNotificationData
       ```

    4. Update onSuccess to use the new data shape and send email:
       ```typescript
       onSuccess: (data) => {
         queryClient.invalidateQueries({ queryKey: ['shifts'] })

         // Fire-and-forget notification (NOTF-01)
         sendShiftAssignmentEmail({
           workerEmail: data.worker.profile.email,
           workerName: data.worker.profile.first_name,
           scheduledStart: data.scheduled_start,
           scheduledEnd: data.scheduled_end,
           participantName: `${data.participant.first_name} ${data.participant.last_name}`,
           shiftId: data.id,
         })

         toast({ title: 'Shift scheduled successfully', variant: 'success' })
         router.push('/shifts')
       }
       ```

    Note: Fire-and-forget - do NOT await the notification. The toast and navigation happen regardless of email success.
  </action>
  <verify>
    1. TypeScript compiles: `npx tsc --noEmit apps/admin/hooks/use-create-shift.ts`
    2. sendShiftAssignmentEmail appears in onSuccess
    3. No await before sendShiftAssignmentEmail call
    4. Select includes worker.profile.email
  </verify>
  <done>
    - use-create-shift imports from @/lib/notifications
    - mutationFn selects worker email and participant name
    - onSuccess calls sendShiftAssignmentEmail with complete data
    - Notification is fire-and-forget (no await)
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire shift cancellation notification</name>
  <files>apps/admin/hooks/use-cancel-shift.ts</files>
  <action>
    Update use-cancel-shift.ts to send notification email after cancellation.

    IMPORTANT: Per NOTF-02, only the WORKER receives cancellation email (not participant).
    The approach: Fetch worker notification data INSIDE mutationFn, send email before returning.
    This keeps the mutation signature unchanged ({ id: string }) so callers are not affected.

    1. Add import: `import { sendShiftCancellationEmail } from '@/lib/notifications'`

    2. Update mutationFn to:
       a. First, perform the existing update
       b. Then fetch notification data using a separate query
       c. Send email (fire-and-forget)
       d. Return the same { id: string } shape

       ```typescript
       mutationFn: async (input: CancelShiftInput) => {
         const supabase = createClient()

         // Step 1: Cancel the shift (existing logic)
         const { data, error } = await (supabase
           .from('shifts') as any)
           .update({
             status: 'cancelled',
             cancellation_reason: input.cancellation_reason,
             updated_at: new Date().toISOString(),
           })
           .eq('id', shiftId)
           .select('id')
           .single()

         if (error) throw error

         // Step 2: Fetch notification data (worker email, participant name, scheduled_start)
         const { data: notifData } = await (supabase
           .from('shifts') as any)
           .select(`
             scheduled_start,
             worker:workers(profile:profiles(email, first_name)),
             participant:participants(first_name, last_name)
           `)
           .eq('id', shiftId)
           .single()

         // Step 3: Send cancellation email to worker only (NOTF-02)
         if (notifData?.worker?.profile?.email) {
           sendShiftCancellationEmail({
             workerEmail: notifData.worker.profile.email,
             workerName: notifData.worker.profile.first_name,
             participantName: notifData.participant
               ? `${notifData.participant.first_name} ${notifData.participant.last_name}`
               : 'Unknown',
             scheduledStart: notifData.scheduled_start,
             cancellationReason: input.cancellation_reason,
           })
         }

         return data as { id: string }
       }
       ```

    3. onSuccess remains unchanged - no notification logic needed there since email is sent in mutationFn.

    Note: This approach:
    - Keeps return type as { id: string } (no breaking change)
    - Does not require caller (ShiftCancelDialog) to change
    - Handles null email gracefully (just doesn't send)
    - Fire-and-forget pattern (no await on sendShiftCancellationEmail)
  </action>
  <verify>
    1. TypeScript compiles: `npx tsc --noEmit apps/admin/hooks/use-cancel-shift.ts`
    2. sendShiftCancellationEmail appears in mutationFn
    3. Return type still { id: string }
    4. CancelShiftInput interface unchanged (only cancellation_reason)
    5. No changes needed to ShiftCancelDialog callers
  </verify>
  <done>
    - use-cancel-shift imports from @/lib/notifications
    - mutationFn fetches worker email after update
    - mutationFn sends cancellation email to worker only (NOTF-02)
    - Email is fire-and-forget (no await)
    - Existing mutation signature preserved (callers unaffected)
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit apps/admin/hooks/use-create-shift.ts apps/admin/hooks/use-cancel-shift.ts`
2. Grep for `sendShiftAssignmentEmail` in use-create-shift.ts - should match
3. Grep for `sendShiftCancellationEmail` in use-cancel-shift.ts - should match
4. Verify no `await` before notification calls (fire-and-forget pattern)
5. CancelShiftInput interface only has `cancellation_reason` (unchanged from current)
6. ShiftCancelDialog component unchanged (no new props needed)
</verification>

<success_criteria>
- [ ] use-create-shift.ts fetches worker/participant data and sends assignment email (NOTF-01)
- [ ] use-cancel-shift.ts fetches notification data internally and sends cancellation email to worker (NOTF-02)
- [ ] All notification calls are fire-and-forget (no await)
- [ ] Existing mutation signatures preserved (callers unaffected)
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-notifications/09-02-SUMMARY.md`
</output>
