---
phase: 09-notifications
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - apps/admin/app/api/invoices/[id]/finalize/route.ts
autonomous: true

must_haves:
  truths:
    - "Finalizing an invoice triggers email to participant"
    - "Email includes invoice number and link to participant portal"
    - "Emergency contact is CC'd if on file"
  artifacts:
    - path: "apps/admin/app/api/invoices/[id]/finalize/route.ts"
      provides: "Invoice finalization with notification trigger"
      contains: "sendInvoiceFinalizedEmail"
  key_links:
    - from: "apps/admin/app/api/invoices/[id]/finalize/route.ts"
      to: "apps/admin/lib/notifications/send-email.ts"
      via: "import and call after DB update"
      pattern: "sendInvoiceFinalizedEmail"
---

<objective>
Wire invoice finalization notification: send email when invoice is finalized.

Purpose: Participants receive timely notification when their invoice is ready, with a link to view it in the portal.

Output: Updated `/api/invoices/[id]/finalize/route.ts` that sends notification email after successful finalization.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-notifications/09-CONTEXT.md
@.planning/phases/09-notifications/09-RESEARCH.md
@.planning/phases/09-notifications/09-01-SUMMARY.md
@apps/admin/app/api/invoices/[id]/finalize/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fetch participant data for notification</name>
  <files>apps/admin/app/api/invoices/[id]/finalize/route.ts</files>
  <action>
    Update the finalize route to fetch participant data needed for notification:

    1. Add import at top: `import { sendInvoiceFinalizedEmail } from '@/lib/notifications'`

    2. Expand the invoice fetch query (step 3 in existing code) to include participant and invoice details:
       ```typescript
       const { data: invoice, error: invoiceError } = await (supabase
         .from('invoices') as any)
         .select(`
           id,
           status,
           invoice_number,
           total_amount,
           participants(
             first_name,
             last_name,
             profiles(email),
             emergency_contact_email
           )
         `)
         .eq('id', invoiceId)
         .single()
       ```

    Note: The participants table has `profile_id` linking to profiles for email, and may have `emergency_contact_email` field. If that field doesn't exist yet, we'll handle it gracefully (null fallback).
  </action>
  <verify>Query syntax is valid TypeScript</verify>
  <done>Invoice fetch includes participant name, email, and emergency contact</done>
</task>

<task type="auto">
  <name>Task 2: Send notification after successful finalization</name>
  <files>apps/admin/app/api/invoices/[id]/finalize/route.ts</files>
  <action>
    Add notification call after the successful update (after step 5, before step 6):

    1. After `if (updateError)` check passes (finalization succeeded), call:
       ```typescript
       // Send notification email (fire-and-forget)
       const participant = invoice.participants
       if (participant?.profiles?.email) {
         sendInvoiceFinalizedEmail({
           participantEmail: participant.profiles.email,
           participantName: `${participant.first_name} ${participant.last_name}`,
           emergencyContactEmail: participant.emergency_contact_email ?? null,
           invoiceNumber: invoice.invoice_number,
           invoiceId: invoiceId,
           total: invoice.total_amount,
         })
       }
       ```

    2. Do NOT await the notification - fire-and-forget pattern.

    3. Handle gracefully if participant email is missing (skip notification, don't fail).
  </action>
  <verify>
    1. TypeScript compiles: `npx tsc --noEmit apps/admin/app/api/invoices/[id]/finalize/route.ts`
    2. sendInvoiceFinalizedEmail called after update success
    3. No await before the notification call
  </verify>
  <done>
    - Route imports sendInvoiceFinalizedEmail
    - Notification sent after successful finalization
    - Fire-and-forget (no await)
    - Graceful handling if participant has no email
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit apps/admin/app/api/invoices/[id]/finalize/route.ts` - compiles
2. Grep for `sendInvoiceFinalizedEmail` - should match
3. Verify no `await` before notification call
4. Query includes participants join with profiles for email
</verification>

<success_criteria>
- [ ] Finalize route fetches participant email and name
- [ ] sendInvoiceFinalizedEmail called after successful update
- [ ] Emergency contact CC'd if available
- [ ] Notification is fire-and-forget
- [ ] Missing email handled gracefully (no failure)
</success_criteria>

<output>
After completion, create `.planning/phases/09-notifications/09-03-SUMMARY.md`
</output>
