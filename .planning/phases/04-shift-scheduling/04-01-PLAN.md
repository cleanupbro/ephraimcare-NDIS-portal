---
phase: 04-shift-scheduling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260124200001_add_shift_scheduling_columns.sql
  - apps/admin/lib/shifts/schemas.ts
  - apps/admin/lib/shifts/constants.ts
  - packages/types/src/domain.ts
autonomous: true

must_haves:
  truths:
    - "Shifts table has a support_type column for matching worker capabilities"
    - "New shifts default to pending status"
    - "Shift validation schemas enforce required fields for create, edit, and cancel"
  artifacts:
    - path: "supabase/migrations/20260124200001_add_shift_scheduling_columns.sql"
      provides: "support_type column, pending/proposed enum values, composite index"
      contains: "support_type"
    - path: "apps/admin/lib/shifts/schemas.ts"
      provides: "Zod schemas for shift create, edit, cancel"
      exports: ["shiftCreateSchema", "shiftEditSchema", "shiftCancelSchema"]
    - path: "apps/admin/lib/shifts/constants.ts"
      provides: "Status colors, duration presets, time slots"
      exports: ["SHIFT_STATUS_COLORS", "DURATION_PRESETS", "TIME_SLOTS"]
    - path: "packages/types/src/domain.ts"
      provides: "ShiftWithRelations type, updated ShiftStatus"
      contains: "ShiftWithRelations"
  key_links:
    - from: "apps/admin/lib/shifts/schemas.ts"
      to: "apps/admin/lib/workers/constants.ts"
      via: "imports SUPPORT_TYPES for enum validation"
      pattern: "SUPPORT_TYPES"
    - from: "apps/admin/lib/shifts/constants.ts"
      to: "packages/types/src/domain.ts"
      via: "ShiftStatus type alignment"
      pattern: "ShiftStatus"
---

<objective>
Create the database migration, Zod validation schemas, and constants required for shift scheduling.

Purpose: Establish the data layer and validation rules that all shift features depend on. The migration adds the support_type column needed for worker-shift matching, extends the status enum with pending/proposed values, and creates a composite index for efficient overlap detection. Schemas enforce form validation. Constants define visual styling and form presets.

Output: Migration file, schemas module, constants module, updated domain types.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-shift-scheduling/04-RESEARCH.md
@apps/admin/lib/workers/constants.ts
@packages/types/src/domain.ts
@supabase/migrations/20260124000010_create_shifts.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for shift scheduling enhancements</name>
  <files>supabase/migrations/20260124200001_add_shift_scheduling_columns.sql</files>
  <action>
Create a migration file that does three things:

1. Add `pending` and `proposed` values to the `shift_status` enum type:
```sql
ALTER TYPE public.shift_status ADD VALUE IF NOT EXISTS 'pending';
ALTER TYPE public.shift_status ADD VALUE IF NOT EXISTS 'proposed';
```

2. Add `support_type` text column to shifts table:
```sql
ALTER TABLE public.shifts ADD COLUMN IF NOT EXISTS support_type text;
```

3. Change the default status for new shifts from 'scheduled' to 'pending':
```sql
ALTER TABLE public.shifts ALTER COLUMN status SET DEFAULT 'pending';
```

4. Create composite index for efficient overlap detection queries:
```sql
CREATE INDEX IF NOT EXISTS idx_shifts_worker_timerange
ON public.shifts(worker_id, scheduled_start, scheduled_end)
WHERE status NOT IN ('cancelled');
```

Do NOT drop existing enum values (scheduled, no_show) -- backward compatibility.
  </action>
  <verify>Check migration file exists and contains ALTER TYPE, ALTER TABLE ADD COLUMN, ALTER COLUMN SET DEFAULT, and CREATE INDEX statements.</verify>
  <done>Migration adds support_type column, pending/proposed enum values, changes default to pending, and creates overlap detection index.</done>
</task>

<task type="auto">
  <name>Task 2: Zod schemas and constants for shift scheduling</name>
  <files>apps/admin/lib/shifts/schemas.ts, apps/admin/lib/shifts/constants.ts</files>
  <action>
Create `apps/admin/lib/shifts/schemas.ts`:
- Import `z` from 'zod' and `SUPPORT_TYPES` from '../workers/constants'
- `shiftCreateSchema`: object with fields:
  - participant_id: z.string().uuid('Participant is required')
  - worker_id: z.string().uuid('Worker is required')
  - support_type: z.string().min(1, 'Support type is required')
  - date: z.string().min(1, 'Date is required')
  - start_time: z.string().min(1, 'Start time is required')
  - duration_hours: z.coerce.number().min(0.25, 'Min 15 minutes').max(24, 'Max 24 hours')
  - notes: z.string().max(2000).optional().or(z.literal(''))
- `shiftEditSchema`: shiftCreateSchema.partial() plus optional status field
- `shiftCancelSchema`: object with cancellation_reason: z.string().min(1, 'Reason required').max(500)
- Export types: ShiftCreateFormData, ShiftEditFormData, ShiftCancelFormData using z.infer

Create `apps/admin/lib/shifts/constants.ts`:
- Import nothing external
- `SHIFT_STATUS_COLORS` record mapping each status (pending, proposed, scheduled, confirmed, in_progress, completed, cancelled, no_show) to an object with `border` (Tailwind border-l-{color} class), `badge` (Tailwind bg + text classes), and `text` (display label) properties. Use colors from research: pending=gray, proposed=blue-300, scheduled=yellow, confirmed=indigo, in_progress=blue-500, completed=green, cancelled=red, no_show=orange
- `DURATION_PRESETS` array of objects: { label: string, hours: number } for 1h, 1.5h, 2h, 3h, 4h, 8h
- `TIME_SLOTS` array of time strings in 15-minute increments from '06:00' to '22:00' (format 'HH:mm')
- `SHIFT_STATUSES` array of all status values for filter dropdowns
- Export type ShiftStatusKey = keyof typeof SHIFT_STATUS_COLORS
  </action>
  <verify>Check both files exist. Verify shiftCreateSchema has all 7 fields. Verify SHIFT_STATUS_COLORS has 8 entries. Verify TIME_SLOTS has correct count ((22-6)*4 = 64 + 1 = 65 entries from 06:00 to 22:00 inclusive).</verify>
  <done>Schemas enforce form validation for create/edit/cancel flows. Constants provide status colors for card styling, duration presets for form buttons, and time slots for start time dropdown.</done>
</task>

<task type="auto">
  <name>Task 3: Update domain types with ShiftWithRelations</name>
  <files>packages/types/src/domain.ts</files>
  <action>
In packages/types/src/domain.ts, add or update:

1. Update `ShiftStatus` type to include all values:
```typescript
export type ShiftStatus = 'pending' | 'proposed' | 'scheduled' | 'confirmed' | 'in_progress' | 'completed' | 'cancelled' | 'no_show'
```

2. Add `support_type` to the existing Shift interface (add after `notes` field):
```typescript
support_type?: string | null
```

3. Add a new `ShiftWithRelations` type:
```typescript
export interface ShiftWithRelations extends Shift {
  participants: {
    id: string
    first_name: string
    last_name: string
  } | null
  workers: {
    id: string
    services_provided: string[] | null
    profiles: {
      first_name: string
      last_name: string
    } | null
  } | null
}
```

4. Add `OverlappingShift` type for conflict detection:
```typescript
export interface OverlappingShift {
  id: string
  scheduled_start: string
  scheduled_end: string
  participants: {
    first_name: string
    last_name: string
  } | null
}
```

Do NOT remove any existing types or fields. Only add/extend.
  </action>
  <verify>Check domain.ts contains ShiftStatus with 'pending', ShiftWithRelations interface, OverlappingShift interface, and support_type field on Shift.</verify>
  <done>Domain types fully describe shift data shapes including relations (participants, workers with profiles) and conflict detection (OverlappingShift).</done>
</task>

</tasks>

<verification>
1. Migration file exists at expected path with all 4 SQL operations
2. schemas.ts exports shiftCreateSchema, shiftEditSchema, shiftCancelSchema with correct fields
3. constants.ts exports SHIFT_STATUS_COLORS (8 entries), DURATION_PRESETS (6 entries), TIME_SLOTS (65 entries)
4. domain.ts has updated ShiftStatus type, support_type on Shift, ShiftWithRelations, OverlappingShift
5. No TypeScript errors in the modified files (run `pnpm --filter admin tsc --noEmit` or check IDE)
</verification>

<success_criteria>
- Shift schemas validate all form inputs with appropriate error messages
- Status colors provide dual visual indicator (border + badge) for all 8 statuses
- Duration presets cover NDIS common shift lengths (1h quick visit to 8h full-day)
- Time slots allow scheduling from 6 AM to 10 PM in 15-minute increments
- ShiftWithRelations type describes the joined query shape for list/detail views
- Migration is additive-only (no breaking changes to existing data)
</success_criteria>

<output>
After completion, create `.planning/phases/04-shift-scheduling/04-01-SUMMARY.md`
</output>
