---
phase: 04-shift-scheduling
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/admin/app/(protected)/shifts/new/page.tsx
  - apps/admin/components/shifts/shift-form.tsx
  - apps/admin/components/shifts/shift-conflict-dialog.tsx
  - apps/admin/hooks/use-create-shift.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create a shift by selecting participant, support type, worker, date, time, and duration"
    - "Worker dropdown only shows workers whose services_provided includes the selected support type"
    - "Overlap with same worker's existing shift shows warning dialog with conflicting shift details"
    - "Scheduling outside participant plan dates shows warning dialog with override option"
    - "Support type mismatch shows warning dialog (not hard block)"
    - "Successful creation redirects to shift list with success toast"
  artifacts:
    - path: "apps/admin/app/(protected)/shifts/new/page.tsx"
      provides: "Create shift route page"
      min_lines: 10
    - path: "apps/admin/components/shifts/shift-form.tsx"
      provides: "Shift creation form with participant-first selection and duration presets"
      exports: ["ShiftForm"]
    - path: "apps/admin/components/shifts/shift-conflict-dialog.tsx"
      provides: "AlertDialog showing conflict warnings with Create Anyway / Cancel buttons"
      exports: ["ShiftConflictDialog"]
    - path: "apps/admin/hooks/use-create-shift.ts"
      provides: "Mutation hook for shift creation with query invalidation"
      exports: ["useCreateShift"]
  key_links:
    - from: "apps/admin/components/shifts/shift-form.tsx"
      to: "apps/admin/components/shifts/shift-conflict-dialog.tsx"
      via: "opens dialog when conflicts detected on submit"
      pattern: "setConflicts|showConflictDialog"
    - from: "apps/admin/components/shifts/shift-form.tsx"
      to: "apps/admin/hooks/use-create-shift.ts"
      via: "calls mutate on confirmed creation"
      pattern: "useCreateShift|mutate"
    - from: "apps/admin/components/shifts/shift-form.tsx"
      to: "supabase shifts/workers/ndis_plans queries"
      via: "conflict detection checks on submit"
      pattern: "checkWorkerOverlaps|checkPlanDates"
---

<objective>
Build the shift creation form with two-step participant-worker selection, duration presets, and conflict detection with override dialogs.

Purpose: Enable admins to schedule shifts with smart validation that warns about conflicts (overlaps, plan dates, support type) but allows override -- balancing safety with operational flexibility.

Output: Create shift page, form component, conflict dialog, mutation hook.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-shift-scheduling/04-RESEARCH.md
@.planning/phases/04-shift-scheduling/04-01-SUMMARY.md
@apps/admin/lib/shifts/schemas.ts
@apps/admin/lib/shifts/constants.ts
@apps/admin/lib/workers/constants.ts
@apps/admin/components/participants/participant-form/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shift creation form component with two-step selection and duration presets</name>
  <files>apps/admin/components/shifts/shift-form.tsx</files>
  <action>
Create `apps/admin/components/shifts/shift-form.tsx`:
- 'use client' directive
- Accept props: `{ mode: 'create' | 'edit', defaultValues?: Partial<ShiftCreateFormData>, shiftId?: string }`
- Use `react-hook-form` with `zodResolver(shiftCreateSchema)`
- State management:
  - `participants`: fetched from supabase (id, first_name, last_name) where is_active = true
  - `workers`: fetched from supabase (id, services_provided, profiles(first_name, last_name)) where is_active = true
  - `filteredWorkers`: computed from workers where services_provided includes form's support_type value
  - `conflicts`: array of conflict warnings (overlap, plan date, support type)
  - `showConflictDialog`: boolean to control dialog visibility

Form layout (single page, vertical stack):
1. **Participant** - Select dropdown (all active participants, display "FirstName LastName")
2. **Support Type** - Select dropdown (SUPPORT_TYPES from workers/constants). When changed, reset worker_id if current worker doesn't match.
3. **Worker** - Select dropdown (only workers whose services_provided includes selected support_type). Disabled until support_type selected. Show "(No matching workers)" if filteredWorkers is empty.
4. **Date** - Native input type="date" with min set to today
5. **Start Time** - Select dropdown with TIME_SLOTS values (display "6:00 AM", "6:15 AM", etc. -- format for display)
6. **Duration** - Row of preset buttons (DURATION_PRESETS) plus "Custom" button. When Custom active, show two number inputs (hours 0-23, minutes 0-59 in 15-min steps). Active preset highlighted with primary color.
7. **End Time** - Calculated display (read-only span): start_time + duration_hours, formatted as time
8. **Notes** - Textarea (optional, max 2000 chars)

On form submit:
1. Validate with Zod schema
2. Calculate scheduledStart and scheduledEnd as ISO timestamps (combine date + start_time, add duration for end, convert to UTC using Sydney timezone)
3. Run conflict checks (see Task 2 for logic within this component):
   a. Check worker overlaps: query shifts for same worker_id where time ranges overlap and status != cancelled
   b. Check plan dates: query ndis_plans for participant where is_current = true, check if shift date is outside plan period
   c. Check support type match: compare worker's services_provided with selected support_type
4. If ANY conflicts found: set conflicts state, show ShiftConflictDialog
5. If no conflicts: call useCreateShift mutation directly

Fetch participants and workers on mount using useEffect + supabase client-side queries.
Use the established supabase client pattern (createBrowserClient from @supabase/ssr or the existing pattern in hooks).

Include a "Back to Shifts" link at the top (ChevronLeft + text) pointing to /shifts.
  </action>
  <verify>Check shift-form.tsx exists with form fields for participant, support_type, worker, date, start_time, duration, notes. Verify worker dropdown filters by support type. Verify duration presets render as buttons.</verify>
  <done>Form allows creating shifts with participant-first selection flow, duration presets, and auto-calculated end time. Worker dropdown correctly filters to matching support types only.</done>
</task>

<task type="auto">
  <name>Task 2: Conflict detection dialog and create mutation hook</name>
  <files>apps/admin/components/shifts/shift-conflict-dialog.tsx, apps/admin/hooks/use-create-shift.ts</files>
  <action>
Create `apps/admin/components/shifts/shift-conflict-dialog.tsx`:
- 'use client' directive
- Accept props:
  ```typescript
  {
    open: boolean
    onClose: () => void
    onOverride: () => void
    conflicts: ConflictWarning[]
  }
  ```
  Where ConflictWarning is:
  ```typescript
  type ConflictWarning = {
    type: 'overlap' | 'plan_dates' | 'support_type'
    message: string
    details?: string
  }
  ```
- Use AlertDialog from @ephraimcare/ui (already exists)
- Dialog content:
  - Title: "Scheduling Conflicts Detected"
  - Description: "The following issues were found. You can still create this shift by clicking 'Create Anyway'."
  - List each conflict with icon (AlertTriangle from lucide-react) and message/details
  - For overlap conflicts: show "Conflicts with: [participant name], [date], [time range]"
  - For plan_dates: show "Shift date is outside participant's plan period ([start] - [end])"
  - For support_type: show "Worker's support types do not include [selected type]"
- Footer buttons: "Cancel" (calls onClose), "Create Anyway" (calls onOverride, destructive style)

Create `apps/admin/hooks/use-create-shift.ts`:
- Accept no constructor params
- Use `useMutation` from TanStack Query
- mutationFn: accepts `{ participant_id, worker_id, support_type, scheduled_start, scheduled_end, notes, organization_id }` and inserts into shifts table via supabase
  - Get organization_id from current user's profile (query profiles table for auth user, get organization_id) -- or use the pattern established in worker creation
  - Use `(as any)` type assertion on insert (established pattern)
- onSuccess: invalidate ['shifts'] queries, show success toast "Shift scheduled successfully", router.push('/shifts')
- onError: show error toast with error.message
- Export the hook

The conflict check logic lives INSIDE shift-form.tsx (not in a separate file) as async functions:
```typescript
async function checkWorkerOverlaps(workerId: string, start: string, end: string, excludeId?: string) {
  // Query shifts table for overlapping times with same worker, status != cancelled
  // Return array of OverlappingShift
}

async function checkPlanDates(participantId: string, shiftDate: string) {
  // Query ndis_plans for current plan, check if date is within period
  // Return { outsidePlan: boolean, planStart?: string, planEnd?: string }
}
```
These use the supabase browser client directly within the component.
  </action>
  <verify>Check conflict dialog renders list of warnings with override button. Check use-create-shift.ts exports useCreateShift with useMutation. Verify dialog uses AlertDialog pattern from existing codebase.</verify>
  <done>Conflict dialog shows all detected issues with details and allows admin to override. Create mutation inserts shift and invalidates cache. Conflict detection functions check overlaps, plan dates, and support type match.</done>
</task>

<task type="auto">
  <name>Task 3: Create shift page route</name>
  <files>apps/admin/app/(protected)/shifts/new/page.tsx</files>
  <action>
Create `apps/admin/app/(protected)/shifts/new/page.tsx`:
- Server component (no 'use client')
- Simple layout wrapper:
  - Container with max-width and padding (match other form pages like participants/new)
  - Heading: "Schedule New Shift"
  - Render `<ShiftForm mode="create" />`
- No server-side data fetching needed (form fetches its own dropdown data client-side)
- Page metadata: title "Schedule Shift | Ephraim Care"
  </action>
  <verify>Check /shifts/new route exists. Verify it renders ShiftForm in create mode. Navigate to URL (dev server) and confirm form renders.</verify>
  <done>Create shift route is accessible at /shifts/new with the ShiftForm component in create mode.</done>
</task>

</tasks>

<verification>
1. /shifts/new page renders the shift creation form
2. Participant dropdown shows all active participants
3. Selecting a support type filters the worker dropdown to matching workers only
4. Duration presets buttons work and auto-calculate end time
5. Submitting with a worker who has conflicting shift shows overlap warning dialog
6. "Create Anyway" button in dialog creates the shift despite warnings
7. Successful creation shows toast and redirects to /shifts
8. Form validation shows errors for missing required fields
9. Worker dropdown is disabled until support type is selected
</verification>

<success_criteria>
- Admin can fill out the form and create a shift that appears in the shift list
- Conflict detection catches overlapping shifts and shows participant name + time range
- Support type mismatch shows as a warning (not a block)
- Plan date warnings show when scheduling outside the participant's active plan period
- All three conflict types can be overridden by clicking "Create Anyway"
- Form follows established patterns (react-hook-form + zod + supabase client)
</success_criteria>

<output>
After completion, create `.planning/phases/04-shift-scheduling/04-03-SUMMARY.md`
</output>
