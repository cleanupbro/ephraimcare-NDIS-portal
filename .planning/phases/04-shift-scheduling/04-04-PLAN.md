---
phase: 04-shift-scheduling
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - apps/admin/components/shifts/shift-filters.tsx
  - apps/admin/components/shifts/shift-detail-sheet.tsx
  - apps/admin/components/shifts/shift-cancel-dialog.tsx
  - apps/admin/hooks/use-update-shift.ts
  - apps/admin/hooks/use-cancel-shift.ts
  - apps/admin/components/shifts/shift-list.tsx
  - apps/admin/components/shifts/shift-card.tsx
  - apps/admin/hooks/use-shifts.ts
autonomous: true

must_haves:
  truths:
    - "Shift list can be filtered by participant, worker, status, and support type simultaneously"
    - "Clicking a shift card opens a side sheet with full details"
    - "Admin can edit shift details from the detail sheet (if not completed/cancelled)"
    - "Admin can cancel a shift with a reason from the detail sheet"
    - "Cancelled shifts only appear when status filter includes cancelled"
    - "Editing a completed or cancelled shift is blocked"
  artifacts:
    - path: "apps/admin/components/shifts/shift-filters.tsx"
      provides: "Horizontal filter bar with participant, worker, status, support type dropdowns"
      exports: ["ShiftFilters"]
    - path: "apps/admin/components/shifts/shift-detail-sheet.tsx"
      provides: "Side sheet showing full shift details with edit/cancel actions"
      exports: ["ShiftDetailSheet"]
    - path: "apps/admin/components/shifts/shift-cancel-dialog.tsx"
      provides: "Cancel confirmation dialog with reason field"
      exports: ["ShiftCancelDialog"]
    - path: "apps/admin/hooks/use-update-shift.ts"
      provides: "Mutation hook for updating shift fields"
      exports: ["useUpdateShift"]
    - path: "apps/admin/hooks/use-cancel-shift.ts"
      provides: "Mutation hook for cancelling a shift"
      exports: ["useCancelShift"]
  key_links:
    - from: "apps/admin/components/shifts/shift-list.tsx"
      to: "apps/admin/components/shifts/shift-filters.tsx"
      via: "filter state passed down, applied to shift data"
      pattern: "ShiftFilters|filters"
    - from: "apps/admin/components/shifts/shift-card.tsx"
      to: "apps/admin/components/shifts/shift-detail-sheet.tsx"
      via: "onClick opens sheet with selected shift"
      pattern: "setSelectedShift|ShiftDetailSheet"
    - from: "apps/admin/components/shifts/shift-detail-sheet.tsx"
      to: "apps/admin/hooks/use-update-shift.ts"
      via: "inline edit fields call update mutation"
      pattern: "useUpdateShift"
    - from: "apps/admin/components/shifts/shift-detail-sheet.tsx"
      to: "apps/admin/components/shifts/shift-cancel-dialog.tsx"
      via: "cancel button opens dialog"
      pattern: "ShiftCancelDialog|showCancel"
---

<objective>
Add filtering, shift detail sheet (side panel), edit capabilities, and cancel flow to complete the shift scheduling feature.

Purpose: Complete the interactive shift management experience: admins can filter shifts, view full details in a side panel, edit non-completed shifts, and cancel shifts with a reason -- all without leaving the list view.

Output: Filter bar, detail sheet, cancel dialog, update/cancel mutation hooks, updated list/card components.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-shift-scheduling/04-RESEARCH.md
@.planning/phases/04-shift-scheduling/04-01-SUMMARY.md
@.planning/phases/04-shift-scheduling/04-02-SUMMARY.md
@.planning/phases/04-shift-scheduling/04-03-SUMMARY.md
@apps/admin/components/shifts/shift-list.tsx
@apps/admin/components/shifts/shift-card.tsx
@apps/admin/hooks/use-shifts.ts
@packages/ui/src/components/sheet.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filter bar and update shift list to support filtering</name>
  <files>apps/admin/components/shifts/shift-filters.tsx, apps/admin/components/shifts/shift-list.tsx, apps/admin/hooks/use-shifts.ts</files>
  <action>
Create `apps/admin/components/shifts/shift-filters.tsx`:
- 'use client' directive
- Accept props:
  ```typescript
  {
    filters: ShiftFilters
    onFiltersChange: (filters: ShiftFilters) => void
    participants: { id: string, first_name: string, last_name: string }[]
    workers: { id: string, profiles: { first_name: string, last_name: string } | null }[]
  }
  ```
  Where ShiftFilters = `{ participantId: string, workerId: string, status: string, supportType: string }`
- Layout: Horizontal row of Select dropdowns (matches participant/worker list filter pattern)
- Dropdowns:
  1. Participant: "All Participants" + list of participant names, value = id
  2. Worker: "All Workers" + list of worker names, value = id
  3. Status: "All Statuses" + SHIFT_STATUSES from constants (exclude 'cancelled' from default options -- add "Cancelled" as last option to make it opt-in)
  4. Support Type: "All Types" + SUPPORT_TYPES
- Each dropdown calls onFiltersChange with updated filter object

Update `apps/admin/components/shifts/shift-list.tsx`:
- Add filter state: `const [filters, setFilters] = useState<ShiftFilters>({ participantId: '', workerId: '', status: '', supportType: '' })`
- Fetch participants and workers for filter dropdowns (simple supabase queries on mount)
- Render ShiftFilters component above the week nav
- Apply filters to the shifts data:
  - Client-side filtering (filter the useShifts result array):
    - participantId: shift.participant_id === filters.participantId
    - workerId: shift.worker_id === filters.workerId
    - status: shift.status === filters.status
    - supportType: shift.support_type === filters.supportType
  - Default behavior (no status filter): exclude cancelled shifts (shift.status !== 'cancelled')
  - When status filter is set to 'cancelled': show only cancelled
  - When status filter is set to a specific non-cancelled status: show only that status
  - When status is empty (All): show all except cancelled
- Add state for selectedShift: `const [selectedShift, setSelectedShift] = useState<ShiftWithRelations | null>(null)`
- Pass onClick to ShiftCard: `() => setSelectedShift(shift)`
- Render ShiftDetailSheet with selectedShift and onClose

Update `apps/admin/hooks/use-shifts.ts`:
- No changes to the query itself (filtering is client-side)
- But ensure the query does NOT exclude cancelled shifts at the query level (so filter can show them)
  </action>
  <verify>Check shift-filters.tsx renders 4 dropdowns. Check shift-list.tsx integrates filters and applies them. Verify cancelled shifts hidden by default but visible when status filter set to 'cancelled'.</verify>
  <done>Filter bar allows simultaneous filtering by participant, worker, status, and support type. Cancelled shifts are hidden by default and visible via explicit status filter selection.</done>
</task>

<task type="auto">
  <name>Task 2: Shift detail sheet with edit and cancel actions</name>
  <files>apps/admin/components/shifts/shift-detail-sheet.tsx, apps/admin/components/shifts/shift-cancel-dialog.tsx, apps/admin/hooks/use-update-shift.ts, apps/admin/hooks/use-cancel-shift.ts</files>
  <action>
Create `apps/admin/hooks/use-update-shift.ts`:
- Accept `shiftId: string` parameter
- Use useMutation
- mutationFn: accepts partial shift data (Partial<{ worker_id, support_type, scheduled_start, scheduled_end, notes, status }>) and updates shifts table via supabase.from('shifts').update(data).eq('id', shiftId)
- Use (as any) type assertion (established pattern)
- onSuccess: invalidate ['shifts'] queries, show success toast "Shift updated"
- onError: toast error

Create `apps/admin/hooks/use-cancel-shift.ts`:
- Accept `shiftId: string` parameter
- Use useMutation
- mutationFn: accepts `{ cancellation_reason: string }` and updates shifts table: status = 'cancelled', cancellation_reason = reason
- onSuccess: invalidate ['shifts'] queries, show success toast "Shift cancelled"
- onError: toast error

Create `apps/admin/components/shifts/shift-cancel-dialog.tsx`:
- 'use client' directive
- Accept props: `{ open: boolean, onClose: () => void, shiftId: string }`
- Use AlertDialog from @ephraimcare/ui
- Content:
  - Title: "Cancel Shift"
  - Description: "This will cancel the shift. The shift data will be preserved but marked as cancelled."
  - Textarea for cancellation_reason (required, validated with shiftCancelSchema)
  - Buttons: "Keep Shift" (close), "Cancel Shift" (destructive, calls useCancelShift mutation)
- On successful cancellation: close dialog, the list will update via query invalidation

Create `apps/admin/components/shifts/shift-detail-sheet.tsx`:
- 'use client' directive
- Accept props: `{ shift: ShiftWithRelations | null, open: boolean, onClose: () => void }`
- Use Sheet from @ephraimcare/ui
- Sheet content layout:
  - **Header**: Participant name (large), Status badge
  - **Details section** (label: value pairs):
    - Worker: name
    - Support Type: type
    - Date: formatted date
    - Time: start - end (Sydney timezone)
    - Duration: calculated hours and minutes
    - Status: badge
    - Notes: text (or "No notes")
    - Cancellation Reason: (only if cancelled)
  - **Actions section** (bottom of sheet):
    - "Edit Shift" button: Opens an inline edit mode within the sheet OR navigates to /shifts/[id]/edit. For simplicity, use inline editing:
      - Toggle between view and edit mode within the sheet
      - Edit mode shows form fields for: worker, date, start time, duration, notes, status (limited to pending/proposed/confirmed)
      - Save calls useUpdateShift mutation
      - Only shown if status is NOT 'completed' or 'cancelled'
    - "Cancel Shift" button (destructive outline): Opens ShiftCancelDialog
      - Only shown if status is NOT 'completed' or 'cancelled'
  - Edit mode uses the same field components as the create form (Select for worker, date input, time select, duration presets)
  - After edit, recalculate scheduled_end from new start + duration before calling mutation
  - Run conflict checks on edit submit (same logic as create: overlap, plan dates) and show ShiftConflictDialog if needed
- When shift is null or open is false, Sheet is not rendered

Update `apps/admin/components/shifts/shift-card.tsx`:
- Add onClick prop handling (pass through from shift-list.tsx, this was already prepared in Plan 02)
- Ensure cursor-pointer styling when onClick is provided
  </action>
  <verify>Check detail sheet renders shift info when a card is clicked. Verify edit mode shows form fields. Verify cancel button opens cancel dialog. Check that completed/cancelled shifts hide edit/cancel actions. Check mutation hooks export correctly.</verify>
  <done>Clicking a shift card opens a detail sheet showing full information. Admin can edit shift details (inline) if not completed/cancelled. Admin can cancel with a reason. Mutations invalidate cache for immediate UI update.</done>
</task>

</tasks>

<verification>
1. Filter dropdowns work independently and simultaneously
2. Cancelled shifts hidden by default, visible when status filter = 'cancelled'
3. Clicking any shift card opens the detail sheet on the right
4. Detail sheet shows all shift fields with correct formatting
5. Edit button appears only for non-completed, non-cancelled shifts
6. Inline edit saves changes and updates the card in the list
7. Cancel button opens dialog, submitting with reason changes status to cancelled
8. After cancellation, shift disappears from default view (reappears with cancelled filter)
9. Conflict checks run on edit submit (overlap, plan dates)
10. Sheet closes properly and list state resets
</verification>

<success_criteria>
- All 4 filter dimensions work simultaneously on the shift list
- Side sheet provides complete shift details without page navigation
- Edit flow validates conflicts before saving (same rules as create)
- Cancel flow preserves shift data but changes status and stores reason
- Completed and cancelled shifts cannot be edited or cancelled again
- UI updates immediately after mutations via query invalidation
</success_criteria>

<output>
After completion, create `.planning/phases/04-shift-scheduling/04-04-SUMMARY.md`
</output>
