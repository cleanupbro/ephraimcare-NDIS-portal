---
phase: 08-participant-portal
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/participant/hooks/use-participant-dashboard.ts
  - apps/participant/components/dashboard/budget-hero.tsx
  - apps/participant/components/dashboard/plan-info-card.tsx
  - apps/participant/components/dashboard/appointments-card.tsx
  - apps/participant/components/dashboard/expired-plan-banner.tsx
  - apps/participant/app/(protected)/dashboard/page.tsx
autonomous: true

must_haves:
  truths:
    - "Participant sees their budget as large progress bar with dollars and percentage"
    - "Participant sees plan period with days remaining countdown"
    - "Participant sees next 3-5 upcoming appointments with worker name and time"
    - "Budget bar color changes: green (<75%), yellow (75-89%), red (>=90%)"
    - "Warning message appears when budget is 90%+ used"
    - "Expired plan shows red banner with contact instruction"
  artifacts:
    - path: "apps/participant/hooks/use-participant-dashboard.ts"
      provides: "Dashboard data fetching hook"
      exports: ["useParticipantDashboard"]
    - path: "apps/participant/components/dashboard/budget-hero.tsx"
      provides: "Large budget progress bar component"
      min_lines: 40
    - path: "apps/participant/components/dashboard/plan-info-card.tsx"
      provides: "Plan period and days remaining card"
      min_lines: 25
    - path: "apps/participant/components/dashboard/appointments-card.tsx"
      provides: "Upcoming appointments list"
      min_lines: 30
    - path: "apps/participant/app/(protected)/dashboard/page.tsx"
      provides: "Dashboard page composing all components"
      min_lines: 40
  key_links:
    - from: "apps/participant/hooks/use-participant-dashboard.ts"
      to: "ndis_plans table"
      via: "Supabase query"
      pattern: "from.*ndis_plans"
    - from: "apps/participant/hooks/use-participant-dashboard.ts"
      to: "shifts table"
      via: "Supabase query for upcoming appointments"
      pattern: "from.*shifts"
    - from: "apps/participant/app/(protected)/dashboard/page.tsx"
      to: "useParticipantDashboard"
      via: "hook import and call"
      pattern: "useParticipantDashboard"
---

<objective>
Implement participant dashboard with budget hero, plan info, and upcoming appointments

Purpose: Give participants clear visibility into their NDIS plan status, budget utilization, and upcoming care appointments - the primary value of the participant portal.

Output:
- useParticipantDashboard hook fetching plan, budget, and appointments data
- BudgetHero component with large progress bar and color thresholds
- PlanInfoCard showing plan period and days remaining
- AppointmentsCard showing next 3-5 shifts with worker names
- ExpiredPlanBanner for plans past end date
- Dashboard page composing all components in two-column layout
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-participant-portal/08-RESEARCH.md
@.planning/phases/08-participant-portal/08-CONTEXT.md
@.planning/phases/08-participant-portal/08-01-SUMMARY.md

Reference patterns:
@apps/admin/components/participants/participant-budget.tsx
@apps/admin/hooks/use-invoices.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useParticipantDashboard hook</name>
  <files>
    apps/participant/hooks/use-participant-dashboard.ts
  </files>
  <action>
Create React Query hook that fetches all dashboard data in a single query:

```typescript
'use client'

import { useQuery } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'

interface DashboardData {
  participant: {
    id: string
    first_name: string
    last_name: string
    ndis_number: string
  }
  plan: {
    id: string
    start_date: string
    end_date: string
    total_budget: number
    used_budget: number
    status: string
  } | null
  upcomingShifts: Array<{
    id: string
    scheduled_start: string
    scheduled_end: string
    support_type: string
    worker: {
      first_name: string
      last_name: string
    } | null
  }>
}

export function useParticipantDashboard() {
  return useQuery<DashboardData>({
    queryKey: ['participant-dashboard'],
    queryFn: async () => {
      const supabase = createClient()
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) throw new Error('Not authenticated')

      // Get participant record (RLS enforces own data only)
      const { data: participant, error: pErr } = await (supabase
        .from('participants')
        .select('id, first_name, last_name, ndis_number')
        .eq('profile_id', user.id)
        .single() as any)

      if (pErr || !participant) throw new Error('No participant record')

      // Get active NDIS plan (may not exist)
      const { data: plan } = await (supabase
        .from('ndis_plans')
        .select('id, start_date, end_date, total_budget, used_budget, status')
        .eq('participant_id', participant.id)
        .eq('status', 'active')
        .maybeSingle() as any)

      // Get upcoming shifts (next 5, status = scheduled/confirmed)
      const { data: shifts } = await (supabase
        .from('shifts')
        .select(`
          id,
          scheduled_start,
          scheduled_end,
          support_type,
          workers!inner(profiles!inner(first_name, last_name))
        `)
        .eq('participant_id', participant.id)
        .in('status', ['scheduled', 'confirmed'])
        .gte('scheduled_start', new Date().toISOString())
        .order('scheduled_start', { ascending: true })
        .limit(5) as any)

      // Transform shifts to flatten worker data
      const upcomingShifts = (shifts || []).map((s: any) => ({
        id: s.id,
        scheduled_start: s.scheduled_start,
        scheduled_end: s.scheduled_end,
        support_type: s.support_type,
        worker: s.workers?.profiles ? {
          first_name: s.workers.profiles.first_name,
          last_name: s.workers.profiles.last_name,
        } : null,
      }))

      return { participant, plan, upcomingShifts }
    },
    staleTime: 60 * 1000, // 1 minute - data is mostly static
  })
}
```

Notes:
- Use `(as any)` for Supabase queries due to PostgREST type mapping issues (established pattern)
- Use `.maybeSingle()` for plan query (participant may not have an active plan)
- Filter shifts by status scheduled/confirmed and future date
- Join workers -> profiles to get worker name
  </action>
  <verify>
Run `pnpm typecheck --filter @ephraimcare/participant` - no TypeScript errors.
  </verify>
  <done>
Hook exists and exports useParticipantDashboard function with proper typing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard components</name>
  <files>
    apps/participant/components/dashboard/budget-hero.tsx
    apps/participant/components/dashboard/plan-info-card.tsx
    apps/participant/components/dashboard/appointments-card.tsx
    apps/participant/components/dashboard/expired-plan-banner.tsx
  </files>
  <action>
Create four dashboard components following the CONTEXT.md decisions:

1. `budget-hero.tsx` - Large budget progress bar (hero section):
```typescript
'use client'

interface BudgetHeroProps {
  allocated: number
  used: number
}

function formatAUD(amount: number): string {
  return new Intl.NumberFormat('en-AU', {
    style: 'currency',
    currency: 'AUD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount)
}

function getBarColor(percentage: number): string {
  if (percentage >= 90) return 'bg-red-500'
  if (percentage >= 75) return 'bg-amber-500'
  return 'bg-green-500'
}

export function BudgetHero({ allocated, used }: BudgetHeroProps) {
  if (allocated <= 0) {
    return (
      <div className="rounded-xl border bg-card p-6 shadow-sm">
        <h2 className="text-sm font-medium text-muted-foreground">Budget Status</h2>
        <p className="mt-4 text-muted-foreground">No budget information available</p>
      </div>
    )
  }

  const percentage = Math.min(Math.round((used / allocated) * 100), 100)
  const remaining = Math.max(allocated - used, 0)
  const barColor = getBarColor(percentage)

  return (
    <div className="rounded-xl border bg-card p-6 shadow-sm">
      <h2 className="text-sm font-medium text-muted-foreground">Budget Status</h2>
      <div className="mt-4 space-y-4">
        <div className="flex items-baseline justify-between">
          <span className="text-3xl font-bold">{formatAUD(used)}</span>
          <span className="text-muted-foreground">of {formatAUD(allocated)} used</span>
        </div>
        <div className="h-4 w-full rounded-full bg-muted">
          <div
            className={`h-full rounded-full transition-all ${barColor}`}
            style={{ width: `${percentage}%` }}
          />
        </div>
        <div className="flex justify-between text-sm">
          <span className={`font-semibold ${percentage >= 90 ? 'text-red-600' : percentage >= 75 ? 'text-amber-600' : 'text-green-600'}`}>
            {percentage}% used
          </span>
          <span className="text-muted-foreground">{formatAUD(remaining)} remaining</span>
        </div>
        {percentage >= 90 && (
          <div className="rounded-md bg-red-50 p-3 text-sm text-red-800">
            Your budget is nearly exhausted. Please contact your coordinator for assistance.
          </div>
        )}
      </div>
    </div>
  )
}
```

2. `plan-info-card.tsx` - Plan period and days remaining:
```typescript
'use client'

import { differenceInDays, format, parseISO, isPast } from 'date-fns'
import { Calendar } from 'lucide-react'

interface PlanInfoCardProps {
  startDate: string
  endDate: string
}

export function PlanInfoCard({ startDate, endDate }: PlanInfoCardProps) {
  const start = parseISO(startDate)
  const end = parseISO(endDate)
  const today = new Date()
  const daysRemaining = differenceInDays(end, today)
  const isExpired = isPast(end)

  return (
    <div className="rounded-xl border bg-card p-6 shadow-sm">
      <div className="flex items-center gap-2">
        <Calendar className="h-4 w-4 text-muted-foreground" />
        <h3 className="text-sm font-medium text-muted-foreground">Plan Period</h3>
      </div>
      <div className="mt-4 space-y-3">
        <div className="text-lg font-semibold">
          {format(start, 'd MMM yyyy')} — {format(end, 'd MMM yyyy')}
        </div>
        {isExpired ? (
          <div className="text-sm font-medium text-red-600">
            Plan expired
          </div>
        ) : (
          <div className={`text-sm font-medium ${daysRemaining <= 30 ? 'text-amber-600' : 'text-muted-foreground'}`}>
            {daysRemaining} days remaining
          </div>
        )}
      </div>
    </div>
  )
}
```

3. `appointments-card.tsx` - Upcoming appointments list:
```typescript
'use client'

import { format, parseISO } from 'date-fns'
import { Clock } from 'lucide-react'

interface Appointment {
  id: string
  scheduled_start: string
  scheduled_end: string
  support_type: string
  worker: { first_name: string; last_name: string } | null
}

interface AppointmentsCardProps {
  appointments: Appointment[]
}

export function AppointmentsCard({ appointments }: AppointmentsCardProps) {
  if (appointments.length === 0) {
    return (
      <div className="rounded-xl border bg-card p-6 shadow-sm">
        <div className="flex items-center gap-2">
          <Clock className="h-4 w-4 text-muted-foreground" />
          <h3 className="text-sm font-medium text-muted-foreground">Upcoming Appointments</h3>
        </div>
        <p className="mt-4 text-sm text-muted-foreground">No upcoming appointments scheduled</p>
      </div>
    )
  }

  return (
    <div className="rounded-xl border bg-card p-6 shadow-sm">
      <div className="flex items-center gap-2">
        <Clock className="h-4 w-4 text-muted-foreground" />
        <h3 className="text-sm font-medium text-muted-foreground">Upcoming Appointments</h3>
      </div>
      <ul className="mt-4 divide-y divide-border">
        {appointments.map((apt) => {
          const start = parseISO(apt.scheduled_start)
          const end = parseISO(apt.scheduled_end)
          const workerName = apt.worker
            ? `${apt.worker.first_name} ${apt.worker.last_name}`
            : 'Worker TBA'

          return (
            <li key={apt.id} className="py-3 first:pt-0 last:pb-0">
              <div className="flex justify-between">
                <div>
                  <p className="font-medium">{format(start, 'EEEE, d MMM')}</p>
                  <p className="text-sm text-muted-foreground">
                    {format(start, 'h:mm a')} — {format(end, 'h:mm a')}
                  </p>
                </div>
                <div className="text-right">
                  <p className="text-sm">{workerName}</p>
                  <p className="text-xs text-muted-foreground">{apt.support_type}</p>
                </div>
              </div>
            </li>
          )
        })}
      </ul>
    </div>
  )
}
```

4. `expired-plan-banner.tsx` - Red alert banner for expired plans:
```typescript
'use client'

import { AlertTriangle } from 'lucide-react'

export function ExpiredPlanBanner() {
  return (
    <div className="rounded-lg border border-red-200 bg-red-50 p-4">
      <div className="flex items-start gap-3">
        <AlertTriangle className="h-5 w-5 text-red-600 flex-shrink-0 mt-0.5" />
        <div>
          <h3 className="font-medium text-red-800">Your NDIS plan has expired</h3>
          <p className="mt-1 text-sm text-red-700">
            Please contact your coordinator or support team to discuss your plan renewal.
          </p>
        </div>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
Run `pnpm typecheck --filter @ephraimcare/participant` - components compile without errors.
  </verify>
  <done>
All four dashboard components exist with proper props and styling.
  </done>
</task>

<task type="auto">
  <name>Task 3: Compose dashboard page</name>
  <files>
    apps/participant/app/(protected)/dashboard/page.tsx
  </files>
  <action>
Create dashboard page that composes all components in the layout described in CONTEXT.md:

```typescript
'use client'

import { useParticipantDashboard } from '@/hooks/use-participant-dashboard'
import { BudgetHero } from '@/components/dashboard/budget-hero'
import { PlanInfoCard } from '@/components/dashboard/plan-info-card'
import { AppointmentsCard } from '@/components/dashboard/appointments-card'
import { ExpiredPlanBanner } from '@/components/dashboard/expired-plan-banner'
import { isPast, parseISO } from 'date-fns'

export default function DashboardPage() {
  const { data, isLoading, error } = useParticipantDashboard()

  if (isLoading) {
    return (
      <div className="space-y-6">
        <h1 className="font-heading text-2xl font-bold">Dashboard</h1>
        <div className="animate-pulse space-y-6">
          <div className="h-48 rounded-xl bg-muted" />
          <div className="grid gap-6 md:grid-cols-2">
            <div className="h-32 rounded-xl bg-muted" />
            <div className="h-32 rounded-xl bg-muted" />
          </div>
        </div>
      </div>
    )
  }

  if (error || !data) {
    return (
      <div className="space-y-6">
        <h1 className="font-heading text-2xl font-bold">Dashboard</h1>
        <div className="rounded-lg border border-destructive/20 bg-destructive/10 p-4 text-destructive">
          Unable to load dashboard data. Please try refreshing the page.
        </div>
      </div>
    )
  }

  const { plan, upcomingShifts } = data
  const isPlanExpired = plan && isPast(parseISO(plan.end_date))
  const hasNoPlan = !plan

  return (
    <div className="space-y-6">
      <h1 className="font-heading text-2xl font-bold">
        Welcome, {data.participant.first_name}
      </h1>

      {/* Expired plan banner - show at top if plan is past end date */}
      {isPlanExpired && <ExpiredPlanBanner />}

      {/* Budget Hero - large progress bar */}
      <BudgetHero
        allocated={plan?.total_budget ?? 0}
        used={plan?.used_budget ?? 0}
      />

      {/* Two column grid: Plan info | Upcoming appointments */}
      <div className="grid gap-6 md:grid-cols-2">
        {plan && !hasNoPlan ? (
          <PlanInfoCard startDate={plan.start_date} endDate={plan.end_date} />
        ) : (
          <div className="rounded-xl border bg-card p-6 shadow-sm">
            <h3 className="text-sm font-medium text-muted-foreground">Plan Period</h3>
            <p className="mt-4 text-sm text-muted-foreground">No active plan on file</p>
          </div>
        )}
        <AppointmentsCard appointments={upcomingShifts} />
      </div>

      {/* OpBros footer */}
      <footer className="pt-8 border-t border-border text-center text-xs text-muted-foreground">
        Powered by{' '}
        <a
          href="https://opbros.online"
          target="_blank"
          rel="noopener noreferrer"
          className="text-secondary hover:underline"
        >
          OpBros
        </a>
      </footer>
    </div>
  )
}
```

Layout follows CONTEXT.md decisions:
- Budget status is the hero section (large progress bar front and center)
- Two-column grid below hero: plan info on left, upcoming appointments on right
- Show next 3-5 appointments inline on dashboard (no separate page needed)
- Expired plan: Red banner at top with contact instruction
  </action>
  <verify>
1. Run `pnpm dev --filter @ephraimcare/participant`
2. Log in as participant and verify dashboard shows:
   - Budget progress bar as hero
   - Plan period with days remaining
   - Upcoming appointments list
  </verify>
  <done>
Dashboard page renders budget hero, plan info, and appointments in two-column layout with loading and error states.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck --filter @ephraimcare/participant` passes
2. Dashboard shows budget progress bar with correct color thresholds
3. Plan info shows dates and days remaining (or expired message)
4. Upcoming appointments shows worker names and times
5. Budget 90%+ warning shows inline message
6. Expired plan shows red banner at top
7. No plan scenario shows "No active plan" message
</verification>

<success_criteria>
1. Participant sees budget as "$X of $Y used (Z%)" with colored progress bar
2. Progress bar is green (<75%), yellow (75-89%), red (>=90%)
3. 90%+ budget shows warning message "Please contact your coordinator"
4. Plan period shows date range and days remaining countdown
5. Upcoming appointments shows next 3-5 shifts with worker names
6. Empty states handled gracefully (no appointments, no plan, no budget)
</success_criteria>

<output>
After completion, create `.planning/phases/08-participant-portal/08-02-SUMMARY.md`
</output>
