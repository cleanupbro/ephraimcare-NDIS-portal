---
phase: 08-participant-portal
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/participant/hooks/use-participant-invoices.ts
  - apps/participant/components/invoices/invoice-table.tsx
  - apps/participant/components/invoices/invoice-preview-modal.tsx
  - apps/participant/app/(protected)/invoices/page.tsx
  - apps/participant/app/api/invoices/[id]/pdf/route.ts
  - apps/participant/components/pdf/InvoicePDF.tsx
autonomous: true

must_haves:
  truths:
    - "Participant sees chronological list of finalized invoices (not drafts)"
    - "Participant can click invoice number to preview line items in modal"
    - "Participant can download invoice PDF from modal or table"
    - "Participant cannot see invoices belonging to other participants (RLS enforced)"
    - "Empty state shows friendly message when no invoices exist"
  artifacts:
    - path: "apps/participant/hooks/use-participant-invoices.ts"
      provides: "Invoice fetching hooks"
      exports: ["useParticipantInvoices", "useParticipantInvoice"]
    - path: "apps/participant/components/invoices/invoice-table.tsx"
      provides: "Invoice list table"
      min_lines: 40
    - path: "apps/participant/components/invoices/invoice-preview-modal.tsx"
      provides: "Invoice detail modal with line items"
      min_lines: 60
    - path: "apps/participant/app/api/invoices/[id]/pdf/route.ts"
      provides: "PDF download endpoint for participants"
      min_lines: 50
  key_links:
    - from: "apps/participant/hooks/use-participant-invoices.ts"
      to: "invoices table"
      via: "Supabase query with RLS"
      pattern: "from.*invoices"
    - from: "apps/participant/app/api/invoices/[id]/pdf/route.ts"
      to: "InvoicePDF component"
      via: "@react-pdf/renderer"
      pattern: "InvoicePDF"
---

<objective>
Implement invoices page with list, preview modal, and PDF download

Purpose: Allow participants to view their finalized invoices, see line item details, and download PDF copies for their records or plan managers.

Output:
- useParticipantInvoices hook for fetching invoice list
- useParticipantInvoice hook for single invoice with line items
- InvoiceTable component showing chronological list
- InvoicePreviewModal showing line items and download button
- PDF API route for participant-scoped downloads
- Copy of InvoicePDF component for participant app
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-participant-portal/08-RESEARCH.md
@.planning/phases/08-participant-portal/08-CONTEXT.md
@.planning/phases/08-participant-portal/08-01-SUMMARY.md

Reference patterns:
@apps/admin/hooks/use-invoices.ts
@apps/admin/app/api/invoices/[id]/pdf/route.ts
@apps/admin/components/pdf/InvoicePDF.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create invoice hooks</name>
  <files>
    apps/participant/hooks/use-participant-invoices.ts
  </files>
  <action>
Create React Query hooks for fetching invoice data:

```typescript
'use client'

import { useQuery } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'

// Invoice list item (no line items needed for list view)
interface InvoiceListItem {
  id: string
  invoice_number: string
  invoice_date: string
  total: number
  status: string
}

// Full invoice with line items for preview
interface InvoiceWithLineItems {
  id: string
  invoice_number: string
  invoice_date: string
  period_start: string
  period_end: string
  subtotal: number
  gst: number
  total: number
  status: string
  line_items: Array<{
    id: string
    service_date: string
    description: string
    support_type: string
    quantity_hours: number
    unit_price: number
    total: number
  }>
}

/**
 * Fetch all finalized invoices for the authenticated participant.
 * RLS enforces that only invoices where participant_id matches the
 * current user's linked participant record are returned.
 */
export function useParticipantInvoices() {
  return useQuery<InvoiceListItem[]>({
    queryKey: ['participant-invoices'],
    queryFn: async () => {
      const supabase = createClient()

      // RLS filters to only this participant's invoices
      // Only show non-draft invoices (submitted, paid, overdue)
      const { data, error } = await (supabase
        .from('invoices')
        .select('id, invoice_number, invoice_date, total, status')
        .neq('status', 'draft')
        .order('invoice_date', { ascending: false }) as any)

      if (error) throw error
      return data ?? []
    },
    staleTime: 60 * 1000, // 1 minute
  })
}

/**
 * Fetch single invoice with line items for preview modal.
 */
export function useParticipantInvoice(invoiceId: string | null) {
  return useQuery<InvoiceWithLineItems>({
    queryKey: ['participant-invoice', invoiceId],
    queryFn: async () => {
      if (!invoiceId) throw new Error('No invoice ID')

      const supabase = createClient()

      // Fetch invoice (RLS enforces participant scope)
      const { data: invoice, error: invoiceError } = await (supabase
        .from('invoices')
        .select('id, invoice_number, invoice_date, period_start, period_end, subtotal, gst, total, status')
        .eq('id', invoiceId)
        .neq('status', 'draft')
        .single() as any)

      if (invoiceError) throw invoiceError

      // Fetch line items
      const { data: lineItems, error: lineItemsError } = await (supabase
        .from('invoice_line_items')
        .select('id, service_date, description, support_type, quantity_hours, unit_price, total')
        .eq('invoice_id', invoiceId)
        .order('service_date', { ascending: true }) as any)

      if (lineItemsError) throw lineItemsError

      return {
        ...invoice,
        line_items: lineItems ?? [],
      }
    },
    enabled: !!invoiceId,
    staleTime: 5 * 60 * 1000, // 5 minutes - invoice data doesn't change
  })
}
```

Notes:
- Filter out draft invoices (participants only see finalized ones)
- Use `(as any)` for PostgREST type compatibility (established pattern)
- Separate hooks for list (no line items) vs detail (with line items) for performance
  </action>
  <verify>
Run `pnpm typecheck --filter @ephraimcare/participant` - no TypeScript errors.
  </verify>
  <done>
Both invoice hooks exist and export correctly typed functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create invoice table and preview modal</name>
  <files>
    apps/participant/components/invoices/invoice-table.tsx
    apps/participant/components/invoices/invoice-preview-modal.tsx
  </files>
  <action>
Create invoice list table and preview modal following CONTEXT.md decisions:

1. `invoice-table.tsx` - Simple table with clickable invoice numbers:
```typescript
'use client'

import { useState } from 'react'
import { format, parseISO } from 'date-fns'
import { Download, FileText } from 'lucide-react'
import { InvoicePreviewModal } from './invoice-preview-modal'

interface Invoice {
  id: string
  invoice_number: string
  invoice_date: string
  total: number
  status: string
}

interface InvoiceTableProps {
  invoices: Invoice[]
}

function formatAUD(amount: number): string {
  return new Intl.NumberFormat('en-AU', {
    style: 'currency',
    currency: 'AUD',
    minimumFractionDigits: 2,
  }).format(amount)
}

export function InvoiceTable({ invoices }: InvoiceTableProps) {
  const [previewInvoiceId, setPreviewInvoiceId] = useState<string | null>(null)

  if (invoices.length === 0) {
    return (
      <div className="rounded-xl border bg-card p-12 text-center">
        <FileText className="mx-auto h-12 w-12 text-muted-foreground/50" />
        <h3 className="mt-4 font-medium">No invoices yet</h3>
        <p className="mt-2 text-sm text-muted-foreground">
          Your invoices will appear here once they have been finalized by your coordinator.
        </p>
      </div>
    )
  }

  return (
    <>
      <div className="rounded-xl border bg-card overflow-hidden">
        <table className="w-full">
          <thead className="border-b bg-muted/50">
            <tr>
              <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Invoice #</th>
              <th className="px-4 py-3 text-left text-sm font-medium text-muted-foreground">Date</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-muted-foreground">Total</th>
              <th className="px-4 py-3 text-right text-sm font-medium text-muted-foreground">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {invoices.map((invoice) => (
              <tr key={invoice.id} className="hover:bg-muted/30">
                <td className="px-4 py-3">
                  <button
                    onClick={() => setPreviewInvoiceId(invoice.id)}
                    className="font-medium text-primary hover:underline"
                  >
                    {invoice.invoice_number}
                  </button>
                </td>
                <td className="px-4 py-3 text-sm">
                  {format(parseISO(invoice.invoice_date), 'd MMM yyyy')}
                </td>
                <td className="px-4 py-3 text-right text-sm font-medium">
                  {formatAUD(invoice.total)}
                </td>
                <td className="px-4 py-3 text-right">
                  <a
                    href={`/api/invoices/${invoice.id}/pdf`}
                    download
                    className="inline-flex items-center gap-1 rounded-md px-2 py-1 text-sm text-muted-foreground hover:bg-muted hover:text-foreground"
                  >
                    <Download className="h-4 w-4" />
                    <span className="sr-only">Download</span>
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <InvoicePreviewModal
        invoiceId={previewInvoiceId}
        onClose={() => setPreviewInvoiceId(null)}
      />
    </>
  )
}
```

2. `invoice-preview-modal.tsx` - Modal with line items and download:
```typescript
'use client'

import { format, parseISO } from 'date-fns'
import { Download, X } from 'lucide-react'
import { useParticipantInvoice } from '@/hooks/use-participant-invoices'

interface InvoicePreviewModalProps {
  invoiceId: string | null
  onClose: () => void
}

function formatAUD(amount: number): string {
  return new Intl.NumberFormat('en-AU', {
    style: 'currency',
    currency: 'AUD',
    minimumFractionDigits: 2,
  }).format(amount)
}

export function InvoicePreviewModal({ invoiceId, onClose }: InvoicePreviewModalProps) {
  const { data: invoice, isLoading, error } = useParticipantInvoice(invoiceId)

  if (!invoiceId) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Backdrop */}
      <div className="absolute inset-0 bg-black/50" onClick={onClose} />

      {/* Modal */}
      <div className="relative z-10 w-full max-w-2xl max-h-[90vh] overflow-auto rounded-xl bg-card p-6 shadow-lg m-4">
        {/* Header */}
        <div className="flex items-center justify-between border-b pb-4">
          <h2 className="font-heading text-xl font-bold">
            {isLoading ? 'Loading...' : invoice?.invoice_number || 'Invoice'}
          </h2>
          <button
            onClick={onClose}
            className="rounded-md p-1 hover:bg-muted"
          >
            <X className="h-5 w-5" />
          </button>
        </div>

        {/* Content */}
        {isLoading ? (
          <div className="py-12 text-center">
            <div className="animate-pulse">Loading invoice details...</div>
          </div>
        ) : error ? (
          <div className="py-12 text-center text-destructive">
            Unable to load invoice details
          </div>
        ) : invoice ? (
          <div className="mt-4 space-y-6">
            {/* Invoice meta */}
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p className="text-muted-foreground">Invoice Date</p>
                <p className="font-medium">{format(parseISO(invoice.invoice_date), 'd MMMM yyyy')}</p>
              </div>
              <div>
                <p className="text-muted-foreground">Period</p>
                <p className="font-medium">
                  {format(parseISO(invoice.period_start), 'd MMM')} — {format(parseISO(invoice.period_end), 'd MMM yyyy')}
                </p>
              </div>
            </div>

            {/* Line items table */}
            <div className="border rounded-lg overflow-hidden">
              <table className="w-full text-sm">
                <thead className="bg-muted/50">
                  <tr>
                    <th className="px-3 py-2 text-left font-medium text-muted-foreground">Date</th>
                    <th className="px-3 py-2 text-left font-medium text-muted-foreground">Service</th>
                    <th className="px-3 py-2 text-right font-medium text-muted-foreground">Hours</th>
                    <th className="px-3 py-2 text-right font-medium text-muted-foreground">Rate</th>
                    <th className="px-3 py-2 text-right font-medium text-muted-foreground">Total</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {invoice.line_items.map((item) => (
                    <tr key={item.id}>
                      <td className="px-3 py-2">{format(parseISO(item.service_date), 'd MMM')}</td>
                      <td className="px-3 py-2">{item.support_type}</td>
                      <td className="px-3 py-2 text-right">{item.quantity_hours.toFixed(2)}</td>
                      <td className="px-3 py-2 text-right">{formatAUD(item.unit_price)}</td>
                      <td className="px-3 py-2 text-right">{formatAUD(item.total)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Totals */}
            <div className="flex justify-end">
              <div className="w-48 space-y-1 text-sm">
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Subtotal</span>
                  <span>{formatAUD(invoice.subtotal)}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-muted-foreground">GST (10%)</span>
                  <span>{formatAUD(invoice.gst)}</span>
                </div>
                <div className="flex justify-between border-t pt-1 font-bold">
                  <span>Total</span>
                  <span>{formatAUD(invoice.total)}</span>
                </div>
              </div>
            </div>

            {/* Download button */}
            <div className="flex justify-end border-t pt-4">
              <a
                href={`/api/invoices/${invoice.id}/pdf`}
                download
                className="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-primary/90"
              >
                <Download className="h-4 w-4" />
                Download PDF
              </a>
            </div>
          </div>
        ) : null}
      </div>
    </div>
  )
}
```

CONTEXT.md decisions implemented:
- Simple table presentation: Invoice #, Date, Total amount, Download button
- Click invoice to preview line items in modal, then download from there
- No filtering — chronological list (participants typically have few invoices)
  </action>
  <verify>
Run `pnpm typecheck --filter @ephraimcare/participant` - components compile without errors.
  </verify>
  <done>
Invoice table and preview modal components exist with proper styling and functionality.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PDF route and component</name>
  <files>
    apps/participant/components/pdf/InvoicePDF.tsx
    apps/participant/app/api/invoices/[id]/pdf/route.ts
  </files>
  <action>
Create participant-scoped PDF download endpoint and copy the InvoicePDF component:

1. First, copy InvoicePDF component from admin app (read apps/admin/components/pdf/InvoicePDF.tsx and duplicate to participant app):

The component should be identical - it renders a branded PDF with:
- Ephraim Care logo and business details
- Participant name and NDIS number
- Invoice details, line items table
- Subtotal, GST, Total
- Footer with "Powered by OpBros"

2. Create `app/api/invoices/[id]/pdf/route.ts` - Participant-scoped PDF route:
```typescript
import { NextResponse } from 'next/server'
import { pdf } from '@react-pdf/renderer'
import { createClient } from '@/lib/supabase/server'
import { InvoicePDF } from '@/components/pdf/InvoicePDF'

// CRITICAL: Must use Node.js runtime for @react-pdf/renderer (not edge)
export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

/**
 * GET /api/invoices/[id]/pdf
 *
 * Generates and returns a PDF for the specified invoice.
 * Only accessible to authenticated participants.
 * RLS enforces that participant can only access their own invoices.
 */
export async function GET(
  _request: Request,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id: invoiceId } = await params

    // 1. Verify caller is authenticated
    const supabase = await createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()

    if (authError || !user) {
      return NextResponse.json(
        { error: 'Authentication required' },
        { status: 401 }
      )
    }

    // 2. Verify caller is a participant
    const { data: profile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single()

    const profileData = profile as { role: string } | null

    if (!profileData || profileData.role !== 'participant') {
      return NextResponse.json(
        { error: 'Access denied' },
        { status: 403 }
      )
    }

    // 3. Fetch invoice with line items and participant details
    // RLS policy ensures participant can only access their own invoices
    const { data: invoice, error: invoiceError } = await (supabase
      .from('invoices')
      .select(`
        *,
        invoice_line_items (*),
        participants (
          first_name,
          last_name,
          ndis_number
        )
      `)
      .eq('id', invoiceId)
      .neq('status', 'draft')
      .single() as any)

    if (invoiceError || !invoice) {
      console.error('Invoice fetch error:', invoiceError)
      return NextResponse.json(
        { error: 'Invoice not found' },
        { status: 404 }
      )
    }

    // 4. Transform the data to match InvoicePDF props
    const invoiceData = {
      ...invoice,
      line_items: invoice.invoice_line_items || [],
    }

    // 5. Generate PDF blob
    let pdfBlob: Blob
    try {
      const documentElement = InvoicePDF({ invoice: invoiceData })
      const pdfDocument = pdf(documentElement)
      pdfBlob = await pdfDocument.toBlob()
    } catch (pdfError) {
      console.error('PDF generation failed:', pdfError)
      return NextResponse.json(
        { error: 'Failed to generate PDF' },
        { status: 500 }
      )
    }

    // 6. Convert blob to ArrayBuffer for Response
    const arrayBuffer = await pdfBlob.arrayBuffer()

    // 7. Return PDF with proper headers
    const filename = `${invoice.invoice_number}.pdf`

    return new Response(arrayBuffer, {
      status: 200,
      headers: {
        'Content-Type': 'application/pdf',
        'Content-Disposition': `attachment; filename="${filename}"`,
        'Content-Length': arrayBuffer.byteLength.toString(),
        'Cache-Control': 'no-store, no-cache, must-revalidate',
      },
    })
  } catch (error) {
    console.error('PDF export error:', error)
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

Key differences from admin route:
- Checks for `participant` role instead of `admin/coordinator`
- Excludes draft invoices (participants can't see drafts)
- RLS handles data isolation (participant can only access their own invoices)

Need to add @react-pdf/renderer to participant package.json:
- Add "@react-pdf/renderer": "^4.1.6" to dependencies
- Run `pnpm install` in monorepo root
  </action>
  <verify>
1. Add @react-pdf/renderer to apps/participant/package.json and run pnpm install
2. Run `pnpm typecheck --filter @ephraimcare/participant`
3. Test PDF download by logging in as participant and clicking download on an invoice
  </verify>
  <done>
PDF route and component exist, @react-pdf/renderer is installed, and PDF downloads work for participants.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create invoices page</name>
  <files>
    apps/participant/app/(protected)/invoices/page.tsx
  </files>
  <action>
Create invoices page that uses the table component:

```typescript
'use client'

import { useParticipantInvoices } from '@/hooks/use-participant-invoices'
import { InvoiceTable } from '@/components/invoices/invoice-table'

export default function InvoicesPage() {
  const { data: invoices, isLoading, error } = useParticipantInvoices()

  return (
    <div className="space-y-6">
      <div>
        <h1 className="font-heading text-2xl font-bold">Invoices</h1>
        <p className="mt-1 text-sm text-muted-foreground">
          View and download your finalized invoices
        </p>
      </div>

      {isLoading ? (
        <div className="animate-pulse space-y-4">
          <div className="h-12 rounded-lg bg-muted" />
          <div className="h-12 rounded-lg bg-muted" />
          <div className="h-12 rounded-lg bg-muted" />
        </div>
      ) : error ? (
        <div className="rounded-lg border border-destructive/20 bg-destructive/10 p-4 text-destructive">
          Unable to load invoices. Please try refreshing the page.
        </div>
      ) : (
        <InvoiceTable invoices={invoices || []} />
      )}

      {/* OpBros footer */}
      <footer className="pt-8 border-t border-border text-center text-xs text-muted-foreground">
        Powered by{' '}
        <a
          href="https://opbros.online"
          target="_blank"
          rel="noopener noreferrer"
          className="text-secondary hover:underline"
        >
          OpBros
        </a>
      </footer>
    </div>
  )
}
```

This page:
- Fetches invoices using useParticipantInvoices hook
- Renders InvoiceTable component
- Shows loading skeleton during fetch
- Shows error state if fetch fails
- Includes OpBros footer
  </action>
  <verify>
1. Navigate to http://localhost:3001/invoices
2. Verify invoice list shows (or empty state if no invoices)
3. Click an invoice number to see preview modal
4. Click download to download PDF
  </verify>
  <done>
Invoices page renders table with clickable invoice numbers and download buttons.
  </done>
</task>

</tasks>

<verification>
1. `pnpm typecheck --filter @ephraimcare/participant` passes
2. Invoices page shows chronological list of finalized invoices
3. Clicking invoice number opens modal with line items
4. Download button in table downloads PDF
5. Download button in modal downloads PDF
6. Empty state shows friendly message when no invoices
7. Participant cannot see other participants' invoices (RLS test)
</verification>

<success_criteria>
1. Participant sees list with Invoice #, Date, Total, Download button
2. Clicking invoice number opens modal with line item details
3. Modal shows date, period, line items table, subtotal, GST, total
4. Download button downloads properly named PDF (INV-YYYY-NNN.pdf)
5. Empty state shows "No invoices yet" with friendly message
6. Only finalized invoices shown (no drafts)
</success_criteria>

<output>
After completion, create `.planning/phases/08-participant-portal/08-03-SUMMARY.md`
</output>
