---
phase: 08-participant-portal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/participant/lib/supabase/client.ts
  - apps/participant/lib/supabase/server.ts
  - apps/participant/app/(auth)/layout.tsx
  - apps/participant/app/(auth)/login/page.tsx
  - apps/participant/app/(protected)/layout.tsx
  - apps/participant/app/layout.tsx
  - apps/participant/app/unauthorized/page.tsx
autonomous: true

must_haves:
  truths:
    - "Participant can visit /login and see email/password form"
    - "Participant can log in with valid credentials and be redirected to dashboard"
    - "Participant with non-participant role is redirected to /unauthorized"
    - "Unauthenticated user accessing protected routes is redirected to /login"
    - "Sidebar shows Dashboard, Invoices, Profile navigation links"
  artifacts:
    - path: "apps/participant/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
    - path: "apps/participant/lib/supabase/server.ts"
      provides: "Server Supabase client"
      exports: ["createClient"]
    - path: "apps/participant/app/(auth)/login/page.tsx"
      provides: "Login form with email/password"
      min_lines: 50
    - path: "apps/participant/app/(protected)/layout.tsx"
      provides: "Protected layout with sidebar and role check"
      min_lines: 60
  key_links:
    - from: "apps/participant/app/(auth)/login/page.tsx"
      to: "supabase.auth.signInWithPassword"
      via: "client-side auth call"
      pattern: "signInWithPassword"
    - from: "apps/participant/app/(protected)/layout.tsx"
      to: "profiles table"
      via: "role verification query"
      pattern: "role.*participant"
---

<objective>
Set up authentication and protected layout for participant portal

Purpose: Establish the foundational authentication flow and navigation shell so that participants can securely access their portal and subsequent pages have a consistent layout.

Output:
- Supabase client setup for browser and server
- Login page with email/password form
- Protected layout with participant role verification
- Sidebar navigation (Dashboard, Invoices, Profile)
- Unauthorized page for non-participant users
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-participant-portal/08-RESEARCH.md
@.planning/phases/08-participant-portal/08-CONTEXT.md

Reference patterns:
@apps/admin/lib/supabase/client.ts
@apps/admin/lib/supabase/server.ts
@apps/admin/app/(auth)/layout.tsx
@apps/admin/app/(auth)/login/page.tsx
@apps/admin/app/(protected)/layout.tsx
@apps/participant/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase client utilities</name>
  <files>
    apps/participant/lib/supabase/client.ts
    apps/participant/lib/supabase/server.ts
  </files>
  <action>
Create two Supabase client files following the exact pattern from apps/admin/lib/supabase/:

1. `client.ts` - Browser client:
   - Import createBrowserClient from @supabase/ssr
   - Import Database type from @ephraimcare/types
   - Export createClient function that returns typed browser client

2. `server.ts` - Server client:
   - Import createServerClient from @supabase/ssr
   - Import cookies from next/headers
   - Import Database type from @ephraimcare/types
   - Define CookieToSet type for explicit typing
   - Export async createClient function with cookie handlers (getAll, setAll)
   - Handle setAll errors in try/catch (Server Components can't set cookies)

Both files use environment variables NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY.
  </action>
  <verify>
Run `pnpm typecheck --filter @ephraimcare/participant` to verify TypeScript compiles without errors.
  </verify>
  <done>
Both Supabase client files exist and TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth layout and login page</name>
  <files>
    apps/participant/app/(auth)/layout.tsx
    apps/participant/app/(auth)/login/page.tsx
  </files>
  <action>
Create auth route group with centered layout and login page:

1. `(auth)/layout.tsx`:
   - Server component (no 'use client')
   - Flex container centered both directions (min-h-screen items-center justify-center)
   - Max-width card container (max-w-md w-full space-y-6 p-8)

2. `(auth)/login/page.tsx`:
   - Client component ('use client')
   - State: email, password, error, loading
   - Form with:
     - Heading "Ephraim Care" (text-3xl font-bold text-primary font-heading)
     - Subtitle "Participant Portal â€” Sign in to continue"
     - Error display (bg-destructive/10 rounded-md p-3 text-sm text-destructive)
     - Email input (type="email", required)
     - Password input (type="password", required)
     - Submit button (bg-primary, full width, disabled during loading)
   - On submit:
     - Call supabase.auth.signInWithPassword({ email, password })
     - On error: Show user-friendly message ("Invalid email or password. Please try again.")
     - On success: router.push('/dashboard'), router.refresh()

Do NOT include "Forgot password" link (participant portal doesn't need self-service password reset).
  </action>
  <verify>
Navigate to http://localhost:3001/login and verify the login form renders with email and password fields.
  </verify>
  <done>
Login page displays centered form with Ephraim Care branding and email/password inputs.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create protected layout with sidebar and role verification</name>
  <files>
    apps/participant/app/(protected)/layout.tsx
    apps/participant/app/(protected)/page.tsx
    apps/participant/app/(protected)/dashboard/page.tsx
    apps/participant/app/unauthorized/page.tsx
    apps/participant/app/layout.tsx
  </files>
  <action>
Create protected layout that verifies participant role and renders sidebar:

1. `(protected)/layout.tsx` (Server Component):
   - Fetch user with createClient().auth.getUser()
   - If no user: redirect('/login')
   - Fetch profile: .from('profiles').select('role, first_name, last_name').eq('id', user.id).single()
   - If profile.role !== 'participant': redirect('/unauthorized')
   - Fetch linked participant record: .from('participants').select('id, first_name, last_name, ndis_number').eq('profile_id', user.id).single()
   - If no participant record: redirect('/unauthorized')
   - Render layout:
     ```
     <div className="flex min-h-screen">
       <aside className="w-64 border-r border-border bg-card p-6">
         <div className="mb-8">
           <h2 className="font-heading text-lg font-bold text-primary">Ephraim Care</h2>
           <p className="text-xs text-muted-foreground">Participant Portal</p>
         </div>
         <nav className="space-y-1">
           <a href="/dashboard">Dashboard</a>
           <a href="/invoices">Invoices</a>
           <a href="/profile">Profile</a>
         </nav>
         <div className="mt-auto pt-6 border-t border-border">
           <p className="text-xs text-muted-foreground">{participant.first_name} {participant.last_name}</p>
           <p className="text-xs font-medium text-secondary">NDIS: {participant.ndis_number}</p>
         </div>
       </aside>
       <main className="flex-1 p-8">{children}</main>
     </div>
     ```
   - Nav links use same styling as admin portal (rounded-md px-3 py-2 text-sm hover:bg-accent)

2. `(protected)/page.tsx`:
   - Redirect to /dashboard (single line: redirect('/dashboard'))

3. `(protected)/dashboard/page.tsx`:
   - Placeholder for now: "Dashboard coming soon" (Plan 02 will implement)

4. `unauthorized/page.tsx`:
   - Simple error page explaining access denied
   - Link to /login with "Try a different account"
   - Centered layout with error icon

5. Update `app/layout.tsx`:
   - Add QueryClientProvider for React Query
   - Import QueryClient, QueryClientProvider from @tanstack/react-query
   - Create queryClient with useState
   - Wrap children in QueryClientProvider

Use type assertion for profile query result to avoid PostgREST type issues: `as { data: { role: string; first_name: string; last_name: string } | null }`.
  </action>
  <verify>
1. Log in as a participant user and verify sidebar appears with Dashboard, Invoices, Profile links
2. Log in as an admin user and verify redirect to /unauthorized page
  </verify>
  <done>
Protected layout renders sidebar navigation for authenticated participants, and non-participants are redirected to /unauthorized.
  </done>
</task>

</tasks>

<verification>
1. Run `pnpm typecheck --filter @ephraimcare/participant` - no errors
2. Run `pnpm dev --filter @ephraimcare/participant` - server starts on port 3001
3. Visit http://localhost:3001/login - see login form
4. Log in with participant credentials - redirected to dashboard with sidebar
5. Visit http://localhost:3001/unauthorized - see access denied message
</verification>

<success_criteria>
1. Participant can log in and see sidebar with Dashboard, Invoices, Profile links
2. Non-participant users (admin, coordinator, worker) are redirected to /unauthorized
3. Unauthenticated users accessing /dashboard are redirected to /login
4. Sidebar displays participant's name and NDIS number at bottom
5. All TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-participant-portal/08-01-SUMMARY.md`
</output>
