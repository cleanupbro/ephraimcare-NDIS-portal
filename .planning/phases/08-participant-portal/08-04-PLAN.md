---
phase: 08-participant-portal
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - apps/participant/app/(protected)/profile/page.tsx
  - apps/participant/hooks/use-participant-profile.ts
  - apps/participant/components/layout/sidebar.tsx
  - apps/participant/app/(protected)/layout.tsx
autonomous: false

must_haves:
  truths:
    - "Participant sees read-only profile page with personal info and NDIS number"
    - "Profile page has NO edit buttons or forms (purely read-only)"
    - "Sidebar shows logout button that signs out and redirects to login"
    - "Active navigation link is visually highlighted"
    - "Portal works correctly for participant with linked profile"
  artifacts:
    - path: "apps/participant/app/(protected)/profile/page.tsx"
      provides: "Read-only profile display"
      min_lines: 40
    - path: "apps/participant/hooks/use-participant-profile.ts"
      provides: "Profile data fetching hook"
      exports: ["useParticipantProfile"]
    - path: "apps/participant/components/layout/sidebar.tsx"
      provides: "Extracted sidebar component with logout"
      min_lines: 50
  key_links:
    - from: "apps/participant/components/layout/sidebar.tsx"
      to: "supabase.auth.signOut"
      via: "logout button handler"
      pattern: "signOut"
---

<objective>
Complete participant portal with profile page, logout, and verification checkpoint

Purpose: Finalize the participant portal by adding the read-only profile page, extracting the sidebar into a reusable component with logout functionality, and verifying the complete portal meets all success criteria.

Output:
- Read-only profile page showing participant info
- Extracted Sidebar component with active link highlighting and logout
- useParticipantProfile hook for profile data
- Human verification checkpoint to confirm all portal features work
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-participant-portal/08-RESEARCH.md
@.planning/phases/08-participant-portal/08-CONTEXT.md
@.planning/phases/08-participant-portal/08-01-SUMMARY.md
@.planning/phases/08-participant-portal/08-02-SUMMARY.md
@.planning/phases/08-participant-portal/08-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create profile hook and page</name>
  <files>
    apps/participant/hooks/use-participant-profile.ts
    apps/participant/app/(protected)/profile/page.tsx
  </files>
  <action>
Create profile data hook and read-only profile page:

1. `hooks/use-participant-profile.ts`:
```typescript
'use client'

import { useQuery } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'

interface ParticipantProfile {
  id: string
  first_name: string
  last_name: string
  ndis_number: string
  date_of_birth: string | null
  phone: string | null
  email: string | null
  address: string | null
  suburb: string | null
  state: string | null
  postcode: string | null
  emergency_contact_name: string | null
  emergency_contact_phone: string | null
  emergency_contact_relationship: string | null
  medical_notes: string | null
  support_needs: string | null
}

export function useParticipantProfile() {
  return useQuery<ParticipantProfile>({
    queryKey: ['participant-profile'],
    queryFn: async () => {
      const supabase = createClient()
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) throw new Error('Not authenticated')

      // RLS enforces own data only
      const { data, error } = await (supabase
        .from('participants')
        .select(`
          id, first_name, last_name, ndis_number,
          date_of_birth, phone, email, address, suburb, state, postcode,
          emergency_contact_name, emergency_contact_phone, emergency_contact_relationship,
          medical_notes, support_needs
        `)
        .eq('profile_id', user.id)
        .single() as any)

      if (error) throw error
      return data
    },
    staleTime: 5 * 60 * 1000, // 5 minutes - profile rarely changes
  })
}
```

2. `app/(protected)/profile/page.tsx`:
```typescript
'use client'

import { useParticipantProfile } from '@/hooks/use-participant-profile'
import { format, parseISO } from 'date-fns'
import { User, Phone, MapPin, AlertCircle, Heart } from 'lucide-react'

export default function ProfilePage() {
  const { data: profile, isLoading, error } = useParticipantProfile()

  if (isLoading) {
    return (
      <div className="space-y-6">
        <h1 className="font-heading text-2xl font-bold">Profile</h1>
        <div className="animate-pulse space-y-4">
          <div className="h-32 rounded-xl bg-muted" />
          <div className="h-32 rounded-xl bg-muted" />
        </div>
      </div>
    )
  }

  if (error || !profile) {
    return (
      <div className="space-y-6">
        <h1 className="font-heading text-2xl font-bold">Profile</h1>
        <div className="rounded-lg border border-destructive/20 bg-destructive/10 p-4 text-destructive">
          Unable to load profile. Please try refreshing the page.
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="font-heading text-2xl font-bold">Profile</h1>
        <p className="mt-1 text-sm text-muted-foreground">
          Your personal information (read-only)
        </p>
      </div>

      {/* Personal Information */}
      <div className="rounded-xl border bg-card p-6">
        <div className="flex items-center gap-2 mb-4">
          <User className="h-5 w-5 text-muted-foreground" />
          <h2 className="font-medium">Personal Information</h2>
        </div>
        <dl className="grid gap-4 sm:grid-cols-2">
          <div>
            <dt className="text-sm text-muted-foreground">Full Name</dt>
            <dd className="font-medium">{profile.first_name} {profile.last_name}</dd>
          </div>
          <div>
            <dt className="text-sm text-muted-foreground">NDIS Number</dt>
            <dd className="font-medium font-mono">{profile.ndis_number}</dd>
          </div>
          {profile.date_of_birth && (
            <div>
              <dt className="text-sm text-muted-foreground">Date of Birth</dt>
              <dd className="font-medium">{format(parseISO(profile.date_of_birth), 'd MMMM yyyy')}</dd>
            </div>
          )}
          {profile.email && (
            <div>
              <dt className="text-sm text-muted-foreground">Email</dt>
              <dd className="font-medium">{profile.email}</dd>
            </div>
          )}
        </dl>
      </div>

      {/* Contact Information */}
      <div className="rounded-xl border bg-card p-6">
        <div className="flex items-center gap-2 mb-4">
          <Phone className="h-5 w-5 text-muted-foreground" />
          <h2 className="font-medium">Contact Information</h2>
        </div>
        <dl className="grid gap-4 sm:grid-cols-2">
          {profile.phone && (
            <div>
              <dt className="text-sm text-muted-foreground">Phone</dt>
              <dd className="font-medium">{profile.phone}</dd>
            </div>
          )}
          {profile.address && (
            <div className="sm:col-span-2">
              <dt className="text-sm text-muted-foreground">Address</dt>
              <dd className="font-medium">
                {profile.address}
                {profile.suburb && `, ${profile.suburb}`}
                {profile.state && ` ${profile.state}`}
                {profile.postcode && ` ${profile.postcode}`}
              </dd>
            </div>
          )}
        </dl>
      </div>

      {/* Emergency Contact */}
      {profile.emergency_contact_name && (
        <div className="rounded-xl border bg-card p-6">
          <div className="flex items-center gap-2 mb-4">
            <AlertCircle className="h-5 w-5 text-muted-foreground" />
            <h2 className="font-medium">Emergency Contact</h2>
          </div>
          <dl className="grid gap-4 sm:grid-cols-2">
            <div>
              <dt className="text-sm text-muted-foreground">Name</dt>
              <dd className="font-medium">{profile.emergency_contact_name}</dd>
            </div>
            {profile.emergency_contact_phone && (
              <div>
                <dt className="text-sm text-muted-foreground">Phone</dt>
                <dd className="font-medium">{profile.emergency_contact_phone}</dd>
              </div>
            )}
            {profile.emergency_contact_relationship && (
              <div>
                <dt className="text-sm text-muted-foreground">Relationship</dt>
                <dd className="font-medium">{profile.emergency_contact_relationship}</dd>
              </div>
            )}
          </dl>
        </div>
      )}

      {/* Support Needs (if populated) */}
      {profile.support_needs && (
        <div className="rounded-xl border bg-card p-6">
          <div className="flex items-center gap-2 mb-4">
            <Heart className="h-5 w-5 text-muted-foreground" />
            <h2 className="font-medium">Support Needs</h2>
          </div>
          <p className="text-sm whitespace-pre-wrap">{profile.support_needs}</p>
        </div>
      )}

      {/* Read-only notice */}
      <div className="rounded-lg border border-muted bg-muted/50 p-4 text-sm text-muted-foreground">
        <p>
          To update your information, please contact your coordinator or support team.
        </p>
      </div>

      {/* OpBros footer */}
      <footer className="pt-8 border-t border-border text-center text-xs text-muted-foreground">
        Powered by{' '}
        <a
          href="https://opbros.online"
          target="_blank"
          rel="noopener noreferrer"
          className="text-secondary hover:underline"
        >
          OpBros
        </a>
      </footer>
    </div>
  )
}
```

Key features:
- Purely read-only display (NO edit buttons)
- Organized into logical sections with icons
- Graceful handling of null/empty fields
- Note at bottom explaining how to update info
  </action>
  <verify>
Run `pnpm typecheck --filter @ephraimcare/participant` - no TypeScript errors.
  </verify>
  <done>
Profile page displays participant information in read-only format with organized sections.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract sidebar with logout and active state</name>
  <files>
    apps/participant/components/layout/sidebar.tsx
    apps/participant/app/(protected)/layout.tsx
  </files>
  <action>
Extract sidebar into reusable component with logout and active link highlighting:

1. `components/layout/sidebar.tsx`:
```typescript
'use client'

import { usePathname, useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'
import { LayoutDashboard, FileText, User, LogOut } from 'lucide-react'

interface Participant {
  first_name: string
  last_name: string
  ndis_number: string
}

interface SidebarProps {
  participant: Participant
}

const navItems = [
  { href: '/dashboard', label: 'Dashboard', icon: LayoutDashboard },
  { href: '/invoices', label: 'Invoices', icon: FileText },
  { href: '/profile', label: 'Profile', icon: User },
]

export function Sidebar({ participant }: SidebarProps) {
  const pathname = usePathname()
  const router = useRouter()

  const handleLogout = async () => {
    const supabase = createClient()
    await supabase.auth.signOut()
    router.push('/login')
    router.refresh()
  }

  return (
    <aside className="flex w-64 flex-col border-r border-border bg-card">
      {/* Logo and portal name */}
      <div className="p-6">
        <h2 className="font-heading text-lg font-bold text-primary">Ephraim Care</h2>
        <p className="text-xs text-muted-foreground">Participant Portal</p>
      </div>

      {/* Navigation */}
      <nav className="flex-1 space-y-1 px-4">
        {navItems.map((item) => {
          const isActive = pathname === item.href || pathname.startsWith(item.href + '/')
          const Icon = item.icon

          return (
            <a
              key={item.href}
              href={item.href}
              className={`flex items-center gap-3 rounded-md px-3 py-2 text-sm transition-colors ${
                isActive
                  ? 'bg-primary/10 text-primary font-medium'
                  : 'text-muted-foreground hover:bg-accent hover:text-foreground'
              }`}
            >
              <Icon className="h-4 w-4" />
              {item.label}
            </a>
          )
        })}
      </nav>

      {/* User info and logout */}
      <div className="border-t border-border p-4">
        <div className="mb-3">
          <p className="text-sm font-medium">{participant.first_name} {participant.last_name}</p>
          <p className="text-xs text-muted-foreground font-mono">NDIS: {participant.ndis_number}</p>
        </div>
        <button
          onClick={handleLogout}
          className="flex w-full items-center gap-2 rounded-md px-3 py-2 text-sm text-muted-foreground hover:bg-destructive/10 hover:text-destructive transition-colors"
        >
          <LogOut className="h-4 w-4" />
          Sign out
        </button>
      </div>
    </aside>
  )
}
```

2. Update `app/(protected)/layout.tsx` to use the Sidebar component:
```typescript
import { redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { Sidebar } from '@/components/layout/sidebar'

export default async function ProtectedLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    redirect('/login')
  }

  const { data: profile } = await supabase
    .from('profiles')
    .select('role, first_name, last_name')
    .eq('id', user.id)
    .single() as { data: { role: string; first_name: string; last_name: string } | null }

  if (!profile || profile.role !== 'participant') {
    redirect('/unauthorized')
  }

  // Get linked participant record
  const { data: participant } = await (supabase
    .from('participants')
    .select('id, first_name, last_name, ndis_number')
    .eq('profile_id', user.id)
    .single() as any)

  if (!participant) {
    redirect('/unauthorized')
  }

  return (
    <div className="flex min-h-screen">
      <Sidebar participant={participant} />
      <main className="flex-1 p-8">
        {children}
      </main>
    </div>
  )
}
```

Features:
- Active link highlighting with primary color
- Icons for each navigation item
- Logout button with confirmation-free signOut
- User info at bottom (name + NDIS number)
  </action>
  <verify>
1. Navigate between pages and verify active link is highlighted
2. Click Sign out and verify redirect to /login
3. Try to access /dashboard after logout and verify redirect to /login
  </verify>
  <done>
Sidebar component extracted with working logout and active state highlighting.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete participant portal with:
- Login page with email/password authentication
- Dashboard showing budget status (progress bar with color thresholds), plan period (days remaining), and upcoming appointments
- Invoices page with list view, preview modal, and PDF download
- Profile page showing read-only personal information
- Sidebar navigation with active highlighting and logout
- RLS-enforced data isolation (participant sees only their own data)
  </what-built>
  <how-to-verify>
**Full portal verification:**

1. **Start the participant app:**
   ```bash
   pnpm dev --filter @ephraimcare/participant
   ```
   Visit http://localhost:3001

2. **Test login flow:**
   - Visit /login - see email/password form
   - Enter invalid credentials - see error message
   - Enter valid participant credentials - redirected to dashboard
   - (Optional) Try admin credentials - should redirect to /unauthorized

3. **Test dashboard (PTPL-01, PTPL-02):**
   - Budget progress bar visible with amount and percentage
   - Progress bar color: green (<75%), yellow (75-89%), red (>=90%)
   - Plan period shows date range and days remaining
   - Upcoming appointments list shows worker names and times
   - If budget is 90%+, warning message appears

4. **Test invoices (PTPL-03):**
   - Navigate to Invoices via sidebar
   - See list of finalized invoices (or empty state message)
   - Click invoice number - preview modal opens with line items
   - Click Download PDF button - PDF downloads with correct name

5. **Test profile:**
   - Navigate to Profile via sidebar
   - See personal information displayed (read-only)
   - NO edit buttons or forms visible
   - Note at bottom explains how to update info

6. **Test navigation:**
   - Active link is highlighted in sidebar
   - Click between Dashboard, Invoices, Profile
   - All pages load correctly

7. **Test logout:**
   - Click Sign out in sidebar
   - Redirected to /login
   - Try accessing /dashboard - redirected back to /login

8. **Test data isolation (PTPL-04):**
   - (If possible) Log in as different participant
   - Verify they see their own data, not the first participant's

9. **Verify read-only (PTPL-05):**
   - Search entire portal for edit/create/delete buttons
   - Confirm none exist (purely informational)

**Expected results:**
- All navigation works
- Data displays correctly
- PDF downloads work
- No edit capabilities visible
- Logout works
  </how-to-verify>
  <resume-signal>
Type "approved" if all checks pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. `pnpm typecheck --filter @ephraimcare/participant` passes
2. Login flow works for participant users
3. Dashboard shows budget, plan, and appointments
4. Invoices page shows list with preview and PDF download
5. Profile page shows read-only information
6. Sidebar has active state and working logout
7. Human verification checkpoint confirms all requirements met
</verification>

<success_criteria>
Per ROADMAP.md Phase 8 Success Criteria:
1. Participant logs in and sees plan period, days remaining, and budget progress bar on dashboard - VERIFIED
2. Participant can see finalized invoices list and download any one as PDF - VERIFIED
3. Participant cannot see data belonging to other participants (RLS) - VERIFIED
4. Portal has no edit, create, or delete actions anywhere (purely read-only) - VERIFIED
</success_criteria>

<output>
After completion, create `.planning/phases/08-participant-portal/08-04-SUMMARY.md`
</output>
