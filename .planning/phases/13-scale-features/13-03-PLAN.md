---
phase: 13-scale-features
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - supabase/migrations/20260127000002_organization_credentials.sql
  - apps/admin/app/(protected)/settings/integrations/page.tsx
  - apps/admin/hooks/use-organization.ts
  - packages/types/src/database.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view organization integration settings page"
    - "Settings page shows Twilio, Xero connection status"
    - "Twilio credentials can be saved (Account SID, Auth Token, Phone Number)"
    - "Credentials are stored encrypted in organization settings JSONB"
  artifacts:
    - path: "supabase/migrations/20260127000002_organization_credentials.sql"
      provides: "Credential storage columns for Twilio and Xero"
      contains: "twilio_account_sid"
    - path: "apps/admin/app/(protected)/settings/integrations/page.tsx"
      provides: "Integration settings UI with forms"
      min_lines: 100
    - path: "apps/admin/hooks/use-organization.ts"
      provides: "Organization settings hook with update mutation"
      exports: ["useOrganization", "useUpdateOrganizationSettings"]
  key_links:
    - from: "apps/admin/app/(protected)/settings/integrations/page.tsx"
      to: "/api/organizations/settings"
      via: "mutation hook"
      pattern: "useUpdateOrganizationSettings"
---

<objective>
Create the organization settings page for managing integration credentials (Twilio, Xero).

Purpose: Allow each organization to configure their own external service credentials securely, enabling SMS and accounting sync features.

Output: Migration for credential columns, settings page UI, organization hooks for reading/updating settings.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-scale-features/13-RESEARCH.md

# Existing settings patterns
@apps/admin/app/(protected)/settings/rates/page.tsx
@apps/admin/hooks/use-invoices.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create organization credentials migration</name>
  <files>supabase/migrations/20260127000002_organization_credentials.sql</files>
  <action>
Create migration for storing integration credentials:

```sql
-- Organization integration credentials
-- Stored separately from settings for security (can add column-level encryption later)

ALTER TABLE organizations
ADD COLUMN IF NOT EXISTS twilio_account_sid text,
ADD COLUMN IF NOT EXISTS twilio_auth_token text,
ADD COLUMN IF NOT EXISTS twilio_phone_number text,
ADD COLUMN IF NOT EXISTS xero_client_id text,
ADD COLUMN IF NOT EXISTS xero_client_secret text,
ADD COLUMN IF NOT EXISTS xero_tenant_id text,
ADD COLUMN IF NOT EXISTS xero_token_set jsonb;

-- SMS notification preferences on profiles
ALTER TABLE profiles
ADD COLUMN IF NOT EXISTS sms_notifications_enabled boolean DEFAULT true,
ADD COLUMN IF NOT EXISTS phone text;

-- SMS log table for auditing
CREATE TABLE IF NOT EXISTS sms_logs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id uuid REFERENCES organizations(id) NOT NULL,
  to_phone text NOT NULL,
  message_body text NOT NULL,
  twilio_sid text,
  status text DEFAULT 'queued' CHECK (status IN ('queued', 'sent', 'delivered', 'failed')),
  error_message text,
  related_shift_id uuid REFERENCES shifts(id),
  related_worker_id uuid REFERENCES workers(id),
  related_participant_id uuid REFERENCES participants(id),
  created_at timestamptz DEFAULT now()
);

-- RLS for sms_logs
ALTER TABLE sms_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "org_members_view_sms_logs"
  ON sms_logs FOR SELECT
  TO authenticated
  USING (organization_id = get_user_organization_id() OR is_platform_admin());

CREATE POLICY "system_insert_sms_logs"
  ON sms_logs FOR INSERT
  TO authenticated
  WITH CHECK (organization_id = get_user_organization_id());

-- Index for querying logs
CREATE INDEX IF NOT EXISTS idx_sms_logs_org_created
  ON sms_logs (organization_id, created_at DESC);
```

Key decisions:
- Credentials as separate columns (not nested in settings) for future encryption
- SMS logs table for auditing and delivery tracking
- Profile phone number for SMS notifications
  </action>
  <verify>
Run migration against local Supabase. Columns and table created.
  </verify>
  <done>
Migration creates credential storage columns and SMS audit log table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create organization hooks</name>
  <files>apps/admin/hooks/use-organization.ts</files>
  <action>
Create hooks for organization data and settings updates:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'

export interface OrganizationSettings {
  id: string
  name: string
  abn: string | null
  settings: {
    sms_enabled: boolean
    xero_connected: boolean
    ndia_registered: boolean
  } | null
  twilio_account_sid: string | null
  twilio_phone_number: string | null
  // Auth token not returned for security
}

/**
 * Fetch current user's organization with settings
 */
export function useOrganization() {
  const supabase = createClient()

  return useQuery({
    queryKey: ['organization'],
    queryFn: async (): Promise<OrganizationSettings | null> => {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) return null

      // Get user's org ID from profile
      const { data: profile } = await supabase
        .from('profiles')
        .select('organization_id')
        .eq('id', user.id)
        .single()

      if (!profile?.organization_id) return null

      const { data, error } = await supabase
        .from('organizations')
        .select(`
          id,
          name,
          abn,
          settings,
          twilio_account_sid,
          twilio_phone_number
        `)
        .eq('id', profile.organization_id)
        .single()

      if (error) throw error
      return data as OrganizationSettings
    },
  })
}

export interface UpdateOrganizationSettingsInput {
  twilio_account_sid?: string
  twilio_auth_token?: string
  twilio_phone_number?: string
  settings?: {
    sms_enabled?: boolean
    xero_connected?: boolean
    ndia_registered?: boolean
  }
}

/**
 * Update organization settings (admin only)
 */
export function useUpdateOrganizationSettings() {
  const supabase = createClient()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (input: UpdateOrganizationSettingsInput) => {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) throw new Error('Not authenticated')

      const { data: profile } = await supabase
        .from('profiles')
        .select('organization_id, role')
        .eq('id', user.id)
        .single()

      if (!profile?.organization_id) throw new Error('No organization')
      if (profile.role !== 'admin') throw new Error('Admin access required')

      // Build update object
      const updateData: Record<string, any> = {}

      if (input.twilio_account_sid !== undefined) {
        updateData.twilio_account_sid = input.twilio_account_sid
      }
      if (input.twilio_auth_token !== undefined) {
        updateData.twilio_auth_token = input.twilio_auth_token
      }
      if (input.twilio_phone_number !== undefined) {
        updateData.twilio_phone_number = input.twilio_phone_number
      }
      if (input.settings) {
        // Merge with existing settings
        const { data: org } = await supabase
          .from('organizations')
          .select('settings')
          .eq('id', profile.organization_id)
          .single()

        updateData.settings = {
          ...(org?.settings as object || {}),
          ...input.settings,
        }
      }

      const { error } = await supabase
        .from('organizations')
        .update(updateData as any)
        .eq('id', profile.organization_id)

      if (error) throw error
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['organization'] })
    },
  })
}

/**
 * Test Twilio credentials by sending a test SMS
 */
export function useTestTwilioCredentials() {
  return useMutation({
    mutationFn: async (testPhone: string) => {
      const response = await fetch('/api/sms/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ testPhone }),
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.message || 'Failed to send test SMS')
      }

      return response.json()
    },
  })
}
```

Exports:
- useOrganization: Read organization settings
- useUpdateOrganizationSettings: Update credentials and feature flags
- useTestTwilioCredentials: Test SMS configuration
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin. Hooks compile without errors.
  </verify>
  <done>
Organization hooks provide read/update access to settings and credentials.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create integrations settings page</name>
  <files>apps/admin/app/(protected)/settings/integrations/page.tsx</files>
  <action>
Create the integrations settings page:

```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@ephraimcare/ui/components/card'
import { Button } from '@ephraimcare/ui/components/button'
import { Input } from '@ephraimcare/ui/components/input'
import { Label } from '@ephraimcare/ui/components/label'
import { Badge } from '@ephraimcare/ui/components/badge'
import { Alert, AlertDescription } from '@ephraimcare/ui/components/alert'
import { Loader2, CheckCircle, XCircle, ExternalLink } from 'lucide-react'

import { useOrganization, useUpdateOrganizationSettings, useTestTwilioCredentials } from '@/hooks/use-organization'
import { showToast } from '@/lib/toast'

export default function IntegrationsPage() {
  const { data: organization, isLoading } = useOrganization()
  const updateSettings = useUpdateOrganizationSettings()
  const testTwilio = useTestTwilioCredentials()

  const [testPhone, setTestPhone] = useState('')

  const twilioForm = useForm({
    defaultValues: {
      accountSid: '',
      authToken: '',
      phoneNumber: '',
    },
  })

  // Set defaults when org loads
  if (organization && !twilioForm.formState.isDirty) {
    twilioForm.reset({
      accountSid: organization.twilio_account_sid || '',
      authToken: '',
      phoneNumber: organization.twilio_phone_number || '',
    })
  }

  const handleTwilioSave = async (data: typeof twilioForm.formState.defaultValues) => {
    try {
      await updateSettings.mutateAsync({
        twilio_account_sid: data.accountSid,
        twilio_auth_token: data.authToken || undefined,
        twilio_phone_number: data.phoneNumber,
        settings: { sms_enabled: true },
      })
      showToast.success('Twilio settings saved')
    } catch (error) {
      showToast.error('Failed to save Twilio settings')
    }
  }

  const handleTestSms = async () => {
    if (!testPhone) {
      showToast.error('Enter a phone number to test')
      return
    }
    try {
      await testTwilio.mutateAsync(testPhone)
      showToast.success('Test SMS sent! Check your phone.')
    } catch (error) {
      showToast.error(error instanceof Error ? error.message : 'Test failed')
    }
  }

  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-8">
        <Loader2 className="h-6 w-6 animate-spin" />
      </div>
    )
  }

  const smsEnabled = organization?.settings?.sms_enabled
  const xeroConnected = organization?.settings?.xero_connected

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Integrations</h1>
        <p className="text-muted-foreground">
          Connect external services for SMS notifications and accounting sync
        </p>
      </div>

      {/* Twilio SMS */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>SMS Notifications (Twilio)</CardTitle>
              <CardDescription>
                Send shift reminders to workers and participants via SMS
              </CardDescription>
            </div>
            <Badge variant={smsEnabled ? 'default' : 'secondary'}>
              {smsEnabled ? (
                <><CheckCircle className="mr-1 h-3 w-3" /> Enabled</>
              ) : (
                <><XCircle className="mr-1 h-3 w-3" /> Not configured</>
              )}
            </Badge>
          </div>
        </CardHeader>
        <CardContent>
          <form onSubmit={twilioForm.handleSubmit(handleTwilioSave)} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="accountSid">Account SID</Label>
              <Input
                id="accountSid"
                placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                {...twilioForm.register('accountSid')}
              />
              <p className="text-xs text-muted-foreground">
                Found in your{' '}
                <a
                  href="https://console.twilio.com"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-primary hover:underline"
                >
                  Twilio Console <ExternalLink className="inline h-3 w-3" />
                </a>
              </p>
            </div>

            <div className="space-y-2">
              <Label htmlFor="authToken">Auth Token</Label>
              <Input
                id="authToken"
                type="password"
                placeholder="Enter new token to update"
                {...twilioForm.register('authToken')}
              />
              <p className="text-xs text-muted-foreground">
                Leave blank to keep existing token
              </p>
            </div>

            <div className="space-y-2">
              <Label htmlFor="phoneNumber">Twilio Phone Number</Label>
              <Input
                id="phoneNumber"
                placeholder="+61xxxxxxxxx"
                {...twilioForm.register('phoneNumber')}
              />
              <p className="text-xs text-muted-foreground">
                Australian number in E.164 format (e.g., +61412345678)
              </p>
            </div>

            <div className="flex gap-2">
              <Button type="submit" disabled={updateSettings.isPending}>
                {updateSettings.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Save Twilio Settings
              </Button>
            </div>
          </form>

          {smsEnabled && (
            <div className="mt-6 pt-6 border-t">
              <h4 className="font-medium mb-2">Test SMS</h4>
              <div className="flex gap-2">
                <Input
                  placeholder="+61412345678"
                  value={testPhone}
                  onChange={(e) => setTestPhone(e.target.value)}
                  className="max-w-xs"
                />
                <Button
                  variant="outline"
                  onClick={handleTestSms}
                  disabled={testTwilio.isPending}
                >
                  {testTwilio.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                  Send Test
                </Button>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Xero Accounting */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Xero Accounting</CardTitle>
              <CardDescription>
                Automatically sync invoices to your Xero account
              </CardDescription>
            </div>
            <Badge variant={xeroConnected ? 'default' : 'secondary'}>
              {xeroConnected ? (
                <><CheckCircle className="mr-1 h-3 w-3" /> Connected</>
              ) : (
                <><XCircle className="mr-1 h-3 w-3" /> Not connected</>
              )}
            </Badge>
          </div>
        </CardHeader>
        <CardContent>
          {xeroConnected ? (
            <div className="space-y-4">
              <Alert>
                <CheckCircle className="h-4 w-4" />
                <AlertDescription>
                  Xero is connected. Invoices will automatically sync when finalized.
                </AlertDescription>
              </Alert>
              <Button variant="outline" onClick={() => window.location.href = '/api/xero/disconnect'}>
                Disconnect Xero
              </Button>
            </div>
          ) : (
            <div className="space-y-4">
              <p className="text-sm text-muted-foreground">
                Connect your Xero account to automatically create invoices in Xero
                when you finalize invoices in this system.
              </p>
              <Button onClick={() => window.location.href = '/api/xero/connect'}>
                Connect to Xero
              </Button>
            </div>
          )}
        </CardContent>
      </Card>

      {/* NDIA Integration */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>NDIA Claims</CardTitle>
              <CardDescription>
                Generate PACE-compliant CSV files for bulk claim submission
              </CardDescription>
            </div>
            <Badge variant="secondary">
              <CheckCircle className="mr-1 h-3 w-3" /> Available
            </Badge>
          </div>
        </CardHeader>
        <CardContent>
          <Alert>
            <AlertDescription>
              NDIA bulk claims are submitted via CSV upload to the myplace portal.
              Generate PACE-compliant CSV files from the Invoices page when ready to submit.
            </AlertDescription>
          </Alert>
        </CardContent>
      </Card>
    </div>
  )
}
```

Key features:
- Status badges showing connection state
- Twilio form with Account SID, Auth Token (password field), Phone Number
- Test SMS functionality
- Xero connect/disconnect buttons (OAuth flow in later plan)
- NDIA info card explaining CSV approach
  </action>
  <verify>
Run `pnpm dev` and navigate to /settings/integrations.
Page displays Twilio form, Xero section, NDIA info.
  </verify>
  <done>
Integrations page allows admin to configure Twilio credentials and view integration status.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /settings/integrations - page displays all three sections
2. Enter Twilio credentials and save - success toast appears
3. Refresh page - Account SID and phone number are populated (token hidden)
4. sms_enabled in settings becomes true after saving Twilio credentials
5. Xero shows connect button when not connected
</verification>

<success_criteria>
- Integrations settings page accessible at /settings/integrations
- Twilio credentials can be saved and retrieved (except auth token which is write-only)
- sms_enabled flag updates in organization settings
- SMS logs table created for audit trail
- Xero section shows connection status
</success_criteria>

<output>
After completion, create `.planning/phases/13-scale-features/13-03-SUMMARY.md`
</output>
