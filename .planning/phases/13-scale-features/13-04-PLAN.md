---
phase: 13-scale-features
plan: 04
type: execute
wave: 2
depends_on: ["13-03"]
files_modified:
  - apps/admin/package.json
  - apps/admin/lib/sms/send-sms.ts
  - apps/admin/lib/sms/templates.ts
  - apps/admin/app/api/sms/test/route.ts
autonomous: true

user_setup:
  - service: twilio
    why: "SMS notifications for shift reminders"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account -> Account SID"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account -> Auth Token"
    dashboard_config:
      - task: "Purchase Australian phone number"
        location: "Twilio Console -> Phone Numbers -> Buy a Number"

must_haves:
  truths:
    - "sendSms function sends SMS via Twilio API"
    - "SMS is logged to sms_logs table for audit"
    - "Test SMS API endpoint sends message to specified phone"
    - "SMS templates format shift reminder messages correctly"
  artifacts:
    - path: "apps/admin/lib/sms/send-sms.ts"
      provides: "Twilio SMS sending function"
      exports: ["sendSms"]
    - path: "apps/admin/lib/sms/templates.ts"
      provides: "SMS message templates"
      exports: ["shiftReminder24h", "shiftReminder2h", "invoiceFinalizedSms"]
    - path: "apps/admin/app/api/sms/test/route.ts"
      provides: "Test SMS endpoint"
      exports: ["POST"]
  key_links:
    - from: "apps/admin/lib/sms/send-sms.ts"
      to: "sms_logs table"
      via: "Supabase insert"
      pattern: "sms_logs"
---

<objective>
Create the SMS infrastructure for sending notifications via Twilio.

Purpose: Enable shift reminders and notifications to be sent via SMS to workers and participants who have opted in.

Output: Twilio SDK integration, send-sms helper with logging, message templates, test endpoint.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-scale-features/13-RESEARCH.md

# Existing notification patterns
@apps/admin/lib/notifications/send-email.ts
@apps/admin/lib/notifications/templates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Twilio SDK</name>
  <files>apps/admin/package.json</files>
  <action>
Add Twilio to admin app dependencies:

```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
pnpm add twilio
```

This installs twilio v5.x with Promise-based API and ES modules support.
  </action>
  <verify>
`pnpm list twilio` shows twilio installed in apps/admin.
  </verify>
  <done>
Twilio SDK available for SMS sending.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SMS sending function with logging</name>
  <files>apps/admin/lib/sms/send-sms.ts</files>
  <action>
Create the core SMS sending function:

```typescript
import twilio from 'twilio'
import { createClient } from '@supabase/supabase-js'

export interface SendSmsParams {
  to: string // E.164 format: +614xxxxxxxx
  body: string
  organizationId: string
  relatedShiftId?: string
  relatedWorkerId?: string
  relatedParticipantId?: string
}

export interface SendSmsResult {
  success: boolean
  sid?: string
  error?: string
}

/**
 * Send SMS via Twilio using organization's credentials
 * Logs all SMS to sms_logs table for audit
 */
export async function sendSms(params: SendSmsParams): Promise<SendSmsResult> {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  )

  // Fetch organization's Twilio credentials
  const { data: org, error: orgError } = await supabase
    .from('organizations')
    .select('twilio_account_sid, twilio_auth_token, twilio_phone_number, settings')
    .eq('id', params.organizationId)
    .single()

  if (orgError || !org) {
    console.error('Failed to fetch org credentials:', orgError)
    return { success: false, error: 'Organization not found' }
  }

  // Check if SMS is enabled
  const settings = org.settings as { sms_enabled?: boolean } | null
  if (!settings?.sms_enabled) {
    console.log('SMS not enabled for organization:', params.organizationId)
    return { success: false, error: 'SMS not enabled for this organization' }
  }

  if (!org.twilio_account_sid || !org.twilio_auth_token || !org.twilio_phone_number) {
    return { success: false, error: 'Twilio credentials not configured' }
  }

  // Create Twilio client with org credentials
  const client = twilio(org.twilio_account_sid, org.twilio_auth_token)

  try {
    const message = await client.messages.create({
      body: params.body,
      to: params.to,
      from: org.twilio_phone_number,
    })

    // Log successful send
    await supabase.from('sms_logs').insert({
      organization_id: params.organizationId,
      to_phone: params.to,
      message_body: params.body,
      twilio_sid: message.sid,
      status: 'sent',
      related_shift_id: params.relatedShiftId || null,
      related_worker_id: params.relatedWorkerId || null,
      related_participant_id: params.relatedParticipantId || null,
    } as any)

    return { success: true, sid: message.sid }
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : 'Unknown error'
    console.error('Twilio send failed:', error)

    // Log failed attempt
    await supabase.from('sms_logs').insert({
      organization_id: params.organizationId,
      to_phone: params.to,
      message_body: params.body,
      status: 'failed',
      error_message: errorMessage,
      related_shift_id: params.relatedShiftId || null,
      related_worker_id: params.relatedWorkerId || null,
      related_participant_id: params.relatedParticipantId || null,
    } as any)

    return { success: false, error: errorMessage }
  }
}

/**
 * Validate phone number format (E.164)
 */
export function isValidPhoneNumber(phone: string): boolean {
  // Australian mobile: +614xxxxxxxx (12 chars)
  // Australian landline: +612xxxxxxxx, +613xxxxxxxx, etc.
  return /^\+61[2-9]\d{8}$/.test(phone)
}

/**
 * Format Australian phone number to E.164
 * Accepts: 0412345678, 04 1234 5678, +61412345678
 */
export function formatToE164(phone: string): string {
  // Remove spaces, dashes, parentheses
  const cleaned = phone.replace(/[\s\-\(\)]/g, '')

  // If starts with 0, replace with +61
  if (cleaned.startsWith('0')) {
    return '+61' + cleaned.slice(1)
  }

  // If doesn't start with +, add +61
  if (!cleaned.startsWith('+')) {
    return '+61' + cleaned
  }

  return cleaned
}
```

Key patterns:
- Uses org's own Twilio credentials (not platform-level)
- Checks sms_enabled before sending
- Logs all SMS (success and failure) to sms_logs table
- Includes related entity IDs for audit trail
- E.164 format validation and conversion
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin. No errors.
  </verify>
  <done>
SMS sending function with credential lookup and audit logging.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SMS message templates</name>
  <files>apps/admin/lib/sms/templates.ts</files>
  <action>
Create SMS templates for different notification types:

```typescript
import { format } from 'date-fns'

export interface ShiftReminderParams {
  workerName: string
  participantName: string
  date: Date
  startTime: string // e.g., "9:00 AM"
  organizationName: string
}

/**
 * 24-hour shift reminder for workers
 */
export function shiftReminder24h(params: ShiftReminderParams): string {
  const dateStr = format(params.date, 'EEE d MMM')
  return `Hi ${params.workerName}, reminder: You have a shift with ${params.participantName} tomorrow (${dateStr}) at ${params.startTime}. - ${params.organizationName}`
}

/**
 * 2-hour shift reminder for workers
 */
export function shiftReminder2h(params: ShiftReminderParams): string {
  return `Hi ${params.workerName}, your shift with ${params.participantName} starts in 2 hours at ${params.startTime}. - ${params.organizationName}`
}

export interface ParticipantReminderParams {
  participantName: string
  workerName: string
  date: Date
  startTime: string
  organizationName: string
}

/**
 * 24-hour shift reminder for participants
 */
export function participantReminder24h(params: ParticipantReminderParams): string {
  const dateStr = format(params.date, 'EEE d MMM')
  return `Hi ${params.participantName}, reminder: ${params.workerName} will visit you tomorrow (${dateStr}) at ${params.startTime}. - ${params.organizationName}`
}

export interface InvoiceSmsParams {
  participantName: string
  invoiceNumber: string
  amount: string
  organizationName: string
}

/**
 * Invoice finalized notification for participants
 */
export function invoiceFinalizedSms(params: InvoiceSmsParams): string {
  return `Hi ${params.participantName}, invoice ${params.invoiceNumber} for ${params.amount} is ready. Log in to view details. - ${params.organizationName}`
}

export interface ShiftCancelledSmsParams {
  workerName: string
  participantName: string
  date: Date
  startTime: string
  reason?: string
  organizationName: string
}

/**
 * Shift cancellation notification for workers
 */
export function shiftCancelledWorkerSms(params: ShiftCancelledSmsParams): string {
  const dateStr = format(params.date, 'EEE d MMM')
  let message = `Hi ${params.workerName}, your shift with ${params.participantName} on ${dateStr} at ${params.startTime} has been cancelled.`
  if (params.reason) {
    message += ` Reason: ${params.reason}`
  }
  message += ` - ${params.organizationName}`
  return message
}

/**
 * Test SMS template
 */
export function testSms(organizationName: string): string {
  return `Test SMS from ${organizationName}. If you received this, your Twilio integration is working correctly!`
}
```

Templates follow CONTEXT.md decisions:
- Workers get 24h and 2h reminders
- Participants get 24h reminders and invoice notifications
- Messages include organization name for multi-tenant clarity
- Kept short for SMS character limits (~160 chars)
  </action>
  <verify>
Run `pnpm typecheck`. Template functions export correctly.
  </verify>
  <done>
SMS templates for shift reminders, cancellations, and invoice notifications.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create test SMS API endpoint</name>
  <files>apps/admin/app/api/sms/test/route.ts</files>
  <action>
Create endpoint to test Twilio configuration:

```typescript
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { sendSms, formatToE164, isValidPhoneNumber } from '@/lib/sms/send-sms'
import { testSms } from '@/lib/sms/templates'

export async function POST(request: Request) {
  try {
    const supabase = await createClient()

    // Verify authentication
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Get user's profile and org
    const { data: profile } = await supabase
      .from('profiles')
      .select('organization_id, role')
      .eq('id', user.id)
      .single()

    if (!profile?.organization_id) {
      return NextResponse.json({ error: 'No organization' }, { status: 400 })
    }

    if (profile.role !== 'admin') {
      return NextResponse.json({ error: 'Admin access required' }, { status: 403 })
    }

    // Get organization name
    const { data: org } = await supabase
      .from('organizations')
      .select('name')
      .eq('id', profile.organization_id)
      .single()

    // Parse request
    const { testPhone } = await request.json()

    if (!testPhone) {
      return NextResponse.json({ error: 'Phone number required' }, { status: 400 })
    }

    const formattedPhone = formatToE164(testPhone)

    if (!isValidPhoneNumber(formattedPhone)) {
      return NextResponse.json(
        { error: 'Invalid phone number format. Use Australian format: 0412345678 or +61412345678' },
        { status: 400 }
      )
    }

    // Send test SMS
    const result = await sendSms({
      to: formattedPhone,
      body: testSms(org?.name || 'Ephraim Care'),
      organizationId: profile.organization_id,
    })

    if (!result.success) {
      return NextResponse.json(
        { error: result.error || 'Failed to send SMS' },
        { status: 500 }
      )
    }

    return NextResponse.json({
      success: true,
      message: `Test SMS sent to ${formattedPhone}`,
      sid: result.sid,
    })
  } catch (error) {
    console.error('Test SMS error:', error)
    return NextResponse.json(
      { error: 'Failed to send test SMS' },
      { status: 500 }
    )
  }
}
```

Key features:
- Requires admin role
- Validates phone format
- Uses organization's Twilio credentials
- Returns Twilio SID on success
  </action>
  <verify>
Run `pnpm typecheck`. API route compiles without errors.
  </verify>
  <done>
Test SMS endpoint allows admin to verify Twilio configuration.
  </done>
</task>

</tasks>

<verification>
1. Twilio SDK installed in apps/admin
2. sendSms function compiles and exports correctly
3. SMS templates generate correct message text
4. Test endpoint requires admin role
5. SMS logs are written to database on send
</verification>

<success_criteria>
- Twilio SDK installed and importable
- sendSms function sends via Twilio and logs to sms_logs
- Phone number validation accepts Australian formats
- Test SMS endpoint available at /api/sms/test
- Templates generate appropriately short messages
</success_criteria>

<output>
After completion, create `.planning/phases/13-scale-features/13-04-SUMMARY.md`
</output>
