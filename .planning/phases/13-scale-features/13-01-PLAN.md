---
phase: 13-scale-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260127000001_multi_org_foundation.sql
  - packages/types/src/database.ts
  - apps/admin/lib/supabase/helpers.ts
autonomous: true

must_haves:
  truths:
    - "profiles table has is_platform_admin column with default false"
    - "organizations table has settings JSONB column for feature flags"
    - "is_platform_admin() SQL function returns true only for platform admins"
    - "RLS policies allow platform admin to read all organizations"
  artifacts:
    - path: "supabase/migrations/20260127000001_multi_org_foundation.sql"
      provides: "Multi-org schema extensions and platform admin support"
      contains: "is_platform_admin"
    - path: "packages/types/src/database.ts"
      provides: "Updated TypeScript types for new columns"
      contains: "is_platform_admin"
    - path: "apps/admin/lib/supabase/helpers.ts"
      provides: "isPlatformAdmin helper function"
      exports: ["isPlatformAdmin"]
  key_links:
    - from: "apps/admin/lib/supabase/helpers.ts"
      to: "profiles.is_platform_admin"
      via: "Supabase query"
      pattern: "is_platform_admin"
---

<objective>
Create the database schema extensions and helper functions needed for multi-organization support.

Purpose: Enable multiple NDIS providers to operate on the platform with complete data isolation while allowing platform administrators cross-org visibility for support and management.

Output: Migration file with platform admin column, settings JSONB, RLS policy updates, and TypeScript helper functions.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-scale-features/13-RESEARCH.md

# Existing patterns
@supabase/migrations/20260124000016_create_rls_policies.sql
@packages/types/src/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-org foundation migration</name>
  <files>supabase/migrations/20260127000001_multi_org_foundation.sql</files>
  <action>
Create migration with:

1. Add is_platform_admin column to profiles:
   ```sql
   ALTER TABLE profiles ADD COLUMN is_platform_admin boolean DEFAULT false;
   ```

2. Add settings JSONB to organizations (if not exists):
   ```sql
   ALTER TABLE organizations
   ADD COLUMN IF NOT EXISTS settings jsonb DEFAULT '{
     "sms_enabled": false,
     "xero_connected": false,
     "ndia_registered": false
   }'::jsonb;
   ```

3. Add reminder tracking columns to shifts (for SMS):
   ```sql
   ALTER TABLE shifts
   ADD COLUMN IF NOT EXISTS reminder_24h_sent boolean DEFAULT false,
   ADD COLUMN IF NOT EXISTS reminder_2h_sent boolean DEFAULT false;
   ```

4. Create is_platform_admin() function:
   ```sql
   CREATE OR REPLACE FUNCTION is_platform_admin()
   RETURNS boolean
   LANGUAGE sql
   STABLE
   SECURITY DEFINER
   AS $$
     SELECT COALESCE(
       (SELECT is_platform_admin FROM profiles WHERE id = auth.uid()),
       false
     );
   $$;
   ```

5. Create RLS policy for platform admin to read all organizations:
   ```sql
   CREATE POLICY "platform_admin_read_all_organizations"
     ON organizations FOR SELECT
     TO authenticated
     USING (
       organization_id = get_user_organization_id()
       OR is_platform_admin()
     );
   ```

6. Update existing RLS policies on key tables to allow platform admin read access:
   - participants: add OR is_platform_admin() to SELECT policy
   - workers: add OR is_platform_admin() to SELECT policy
   - shifts: add OR is_platform_admin() to SELECT policy
   - invoices: add OR is_platform_admin() to SELECT policy

Use DROP POLICY IF EXISTS + CREATE POLICY pattern to safely update policies.
  </action>
  <verify>
Run `pnpm supabase db push --local` or validate migration syntax.
Confirm is_platform_admin() function exists and returns false by default.
  </verify>
  <done>
Migration creates platform admin infrastructure. Policies allow platform admin cross-org read access while maintaining org isolation for regular users.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types for new columns</name>
  <files>packages/types/src/database.ts</files>
  <action>
Add the new columns to the Database type interface:

1. In profiles table type, add:
   - is_platform_admin: boolean | null (Row)
   - is_platform_admin?: boolean | null (Insert/Update)

2. In organizations table type, add (if not present):
   - settings: Json | null (Row)
   - settings?: Json | null (Insert/Update)

3. In shifts table type, add:
   - reminder_24h_sent: boolean | null
   - reminder_2h_sent: boolean | null

Follow the existing pattern in database.ts for column type definitions.
  </action>
  <verify>
Run `pnpm typecheck` from monorepo root. No type errors.
  </verify>
  <done>
TypeScript types reflect new schema columns for platform admin and SMS reminders.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create platform admin helper function</name>
  <files>apps/admin/lib/supabase/helpers.ts</files>
  <action>
Create or update helpers.ts with:

```typescript
import { createClient } from './server'

/**
 * Check if current user is a platform admin (cross-org access)
 */
export async function isPlatformAdmin(): Promise<boolean> {
  const supabase = await createClient()

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return false

  const { data: profile } = await supabase
    .from('profiles')
    .select('is_platform_admin')
    .eq('id', user.id)
    .single()

  return profile?.is_platform_admin ?? false
}

/**
 * Get organization settings
 */
export async function getOrganizationSettings(organizationId: string): Promise<{
  sms_enabled: boolean
  xero_connected: boolean
  ndia_registered: boolean
} | null> {
  const supabase = await createClient()

  const { data } = await supabase
    .from('organizations')
    .select('settings')
    .eq('id', organizationId)
    .single()

  return data?.settings as any ?? null
}
```

Export both functions from the file.
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin. No import or type errors.
  </verify>
  <done>
Helper functions provide clean API for checking platform admin status and fetching org settings.
  </done>
</task>

</tasks>

<verification>
1. Migration file exists and is valid SQL
2. TypeScript types compile without errors
3. Helper functions export correctly and types resolve
4. Running migration against local Supabase succeeds
</verification>

<success_criteria>
- is_platform_admin column exists on profiles table
- is_platform_admin() SQL function available and works
- Platform admin RLS policies created for cross-org read access
- TypeScript types updated for new columns
- Helper functions available in apps/admin
</success_criteria>

<output>
After completion, create `.planning/phases/13-scale-features/13-01-SUMMARY.md`
</output>
