---
phase: 13-scale-features
plan: 08
type: execute
wave: 3
depends_on: ["13-01"]
files_modified:
  - supabase/migrations/20260127000005_participant_goals.sql
  - apps/admin/hooks/use-goals.ts
  - apps/admin/app/(protected)/participants/[id]/goals/page.tsx
  - apps/admin/components/goals/GoalCard.tsx
  - apps/admin/components/goals/GoalProgressModal.tsx
  - packages/types/src/database.ts
autonomous: true

must_haves:
  truths:
    - "Admin/coordinator can create goals for participants with title, description, target date, category"
    - "Goals display on participant detail page with progress notes"
    - "Workers can add progress notes linked to shifts"
    - "Progress notes have 1-5 rating scale"
    - "Goals can be marked as achieved or discontinued"
  artifacts:
    - path: "supabase/migrations/20260127000005_participant_goals.sql"
      provides: "Goals and progress notes tables"
      contains: "participant_goals"
    - path: "apps/admin/hooks/use-goals.ts"
      provides: "Goal CRUD hooks"
      exports: ["useParticipantGoals", "useCreateGoal", "useAddProgressNote"]
    - path: "apps/admin/app/(protected)/participants/[id]/goals/page.tsx"
      provides: "Participant goals page"
      min_lines: 80
  key_links:
    - from: "apps/admin/components/goals/GoalProgressModal.tsx"
      to: "goal_progress_notes table"
      via: "Supabase insert"
      pattern: "goal_progress_notes"
---

<objective>
Implement participant goal tracking with progress notes.

Purpose: Enable care planning and progress monitoring by allowing admin/coordinators to set goals for participants and workers to record progress during shifts.

Output: Goals database schema, admin UI for goal management, progress note entry with rating scale.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-scale-features/13-RESEARCH.md

# Existing participant patterns
@apps/admin/app/(protected)/participants/[id]/page.tsx
@apps/admin/hooks/use-participants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create goals database schema</name>
  <files>supabase/migrations/20260127000005_participant_goals.sql</files>
  <action>
Create migration for goal tracking:

```sql
-- Participant Goals Schema
-- For care planning and progress monitoring

-- Goal categories aligned with NDIS domains
CREATE TYPE goal_category AS ENUM (
  'daily_living',
  'community',
  'employment',
  'relationships',
  'health',
  'learning',
  'other'
);

CREATE TYPE goal_status AS ENUM (
  'active',
  'achieved',
  'discontinued'
);

-- Participant goals table
CREATE TABLE IF NOT EXISTS participant_goals (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  participant_id uuid REFERENCES participants(id) ON DELETE CASCADE NOT NULL,
  organization_id uuid REFERENCES organizations(id) NOT NULL,
  title text NOT NULL,
  description text,
  target_date date,
  status goal_status DEFAULT 'active',
  category goal_category DEFAULT 'other',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  created_by uuid REFERENCES profiles(id),
  achieved_at timestamptz,
  discontinued_at timestamptz,
  discontinued_reason text
);

-- Goal progress notes table
CREATE TABLE IF NOT EXISTS goal_progress_notes (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  goal_id uuid REFERENCES participant_goals(id) ON DELETE CASCADE NOT NULL,
  shift_id uuid REFERENCES shifts(id),
  worker_id uuid REFERENCES workers(id),
  organization_id uuid REFERENCES organizations(id) NOT NULL,
  note text NOT NULL,
  progress_rating integer CHECK (progress_rating BETWEEN 1 AND 5),
  created_at timestamptz DEFAULT now(),
  created_by uuid REFERENCES profiles(id)
);

-- RLS policies
ALTER TABLE participant_goals ENABLE ROW LEVEL SECURITY;
ALTER TABLE goal_progress_notes ENABLE ROW LEVEL SECURITY;

-- Goals: Org members can view, admin/coordinator can manage
CREATE POLICY "org_members_view_goals" ON participant_goals
  FOR SELECT TO authenticated
  USING (organization_id = get_user_organization_id() OR is_platform_admin());

CREATE POLICY "admin_coordinator_insert_goals" ON participant_goals
  FOR INSERT TO authenticated
  WITH CHECK (
    organization_id = get_user_organization_id()
    AND is_admin_or_coordinator()
  );

CREATE POLICY "admin_coordinator_update_goals" ON participant_goals
  FOR UPDATE TO authenticated
  USING (
    organization_id = get_user_organization_id()
    AND is_admin_or_coordinator()
  );

CREATE POLICY "admin_coordinator_delete_goals" ON participant_goals
  FOR DELETE TO authenticated
  USING (
    organization_id = get_user_organization_id()
    AND is_admin_or_coordinator()
  );

-- Progress notes: Org members can view, workers can add their own
CREATE POLICY "org_members_view_progress" ON goal_progress_notes
  FOR SELECT TO authenticated
  USING (organization_id = get_user_organization_id() OR is_platform_admin());

CREATE POLICY "workers_add_progress" ON goal_progress_notes
  FOR INSERT TO authenticated
  WITH CHECK (
    organization_id = get_user_organization_id()
    AND (
      -- Worker adding their own note
      worker_id IN (SELECT id FROM workers WHERE profile_id = auth.uid())
      -- Or admin/coordinator adding note
      OR is_admin_or_coordinator()
    )
  );

-- Indexes
CREATE INDEX IF NOT EXISTS idx_goals_participant ON participant_goals(participant_id);
CREATE INDEX IF NOT EXISTS idx_goals_org_status ON participant_goals(organization_id, status);
CREATE INDEX IF NOT EXISTS idx_progress_goal ON goal_progress_notes(goal_id);
CREATE INDEX IF NOT EXISTS idx_progress_shift ON goal_progress_notes(shift_id);

-- Trigger for updated_at
CREATE TRIGGER update_goals_updated_at
  BEFORE UPDATE ON participant_goals
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Comments
COMMENT ON TABLE participant_goals IS 'Care goals for NDIS participants';
COMMENT ON TABLE goal_progress_notes IS 'Progress notes linked to goals and shifts';
COMMENT ON COLUMN goal_progress_notes.progress_rating IS '1=No progress, 5=Excellent progress';
```

Key design decisions:
- Categories aligned with NDIS support domains
- Progress notes linked to shifts when appropriate
- Workers can only add notes for shifts they worked
- 1-5 rating scale per RESEARCH.md
  </action>
  <verify>
Migration syntax is valid SQL.
  </verify>
  <done>
Goals schema created with proper RLS for multi-org isolation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create goals hooks</name>
  <files>apps/admin/hooks/use-goals.ts</files>
  <action>
Create hooks for goal CRUD operations:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'

export type GoalCategory = 'daily_living' | 'community' | 'employment' | 'relationships' | 'health' | 'learning' | 'other'
export type GoalStatus = 'active' | 'achieved' | 'discontinued'

export interface Goal {
  id: string
  participant_id: string
  organization_id: string
  title: string
  description: string | null
  target_date: string | null
  status: GoalStatus
  category: GoalCategory
  created_at: string
  updated_at: string
  created_by: string | null
  achieved_at: string | null
  discontinued_at: string | null
  discontinued_reason: string | null
}

export interface GoalWithProgress extends Goal {
  progress_notes: ProgressNote[]
  latest_rating: number | null
}

export interface ProgressNote {
  id: string
  goal_id: string
  shift_id: string | null
  worker_id: string | null
  note: string
  progress_rating: number | null
  created_at: string
  worker?: {
    profile: {
      first_name: string
      last_name: string
    }
  }
}

/**
 * Fetch goals for a participant
 */
export function useParticipantGoals(participantId: string) {
  const supabase = createClient()

  return useQuery({
    queryKey: ['goals', participantId],
    queryFn: async (): Promise<GoalWithProgress[]> => {
      const { data, error } = await supabase
        .from('participant_goals')
        .select(`
          *,
          progress_notes:goal_progress_notes(
            id,
            goal_id,
            shift_id,
            worker_id,
            note,
            progress_rating,
            created_at,
            worker:workers(
              profile:profiles(first_name, last_name)
            )
          )
        `)
        .eq('participant_id', participantId)
        .order('created_at', { ascending: false })

      if (error) throw error

      // Calculate latest rating for each goal
      return (data || []).map((goal: any) => ({
        ...goal,
        latest_rating: goal.progress_notes?.length > 0
          ? goal.progress_notes
              .filter((n: any) => n.progress_rating)
              .sort((a: any, b: any) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())[0]?.progress_rating || null
          : null,
      }))
    },
    enabled: !!participantId,
  })
}

export interface CreateGoalInput {
  participantId: string
  title: string
  description?: string
  targetDate?: string
  category: GoalCategory
}

/**
 * Create a new goal for a participant
 */
export function useCreateGoal() {
  const supabase = createClient()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (input: CreateGoalInput) => {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) throw new Error('Not authenticated')

      const { data: profile } = await supabase
        .from('profiles')
        .select('organization_id')
        .eq('id', user.id)
        .single()

      if (!profile?.organization_id) throw new Error('No organization')

      const { data, error } = await supabase
        .from('participant_goals')
        .insert({
          participant_id: input.participantId,
          organization_id: profile.organization_id,
          title: input.title,
          description: input.description || null,
          target_date: input.targetDate || null,
          category: input.category,
          status: 'active',
          created_by: user.id,
        } as any)
        .select()
        .single()

      if (error) throw error
      return data
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['goals', variables.participantId] })
    },
  })
}

export interface AddProgressNoteInput {
  goalId: string
  participantId: string // For cache invalidation
  shiftId?: string
  workerId?: string
  note: string
  progressRating: number
}

/**
 * Add a progress note to a goal
 */
export function useAddProgressNote() {
  const supabase = createClient()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (input: AddProgressNoteInput) => {
      const { data: { user } } = await supabase.auth.getUser()
      if (!user) throw new Error('Not authenticated')

      const { data: profile } = await supabase
        .from('profiles')
        .select('organization_id')
        .eq('id', user.id)
        .single()

      if (!profile?.organization_id) throw new Error('No organization')

      const { data, error } = await supabase
        .from('goal_progress_notes')
        .insert({
          goal_id: input.goalId,
          organization_id: profile.organization_id,
          shift_id: input.shiftId || null,
          worker_id: input.workerId || null,
          note: input.note,
          progress_rating: input.progressRating,
          created_by: user.id,
        } as any)
        .select()
        .single()

      if (error) throw error
      return data
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['goals', variables.participantId] })
    },
  })
}

export interface UpdateGoalStatusInput {
  goalId: string
  participantId: string
  status: GoalStatus
  reason?: string // For discontinued
}

/**
 * Update goal status (achieved/discontinued)
 */
export function useUpdateGoalStatus() {
  const supabase = createClient()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (input: UpdateGoalStatusInput) => {
      const updateData: Record<string, any> = {
        status: input.status,
      }

      if (input.status === 'achieved') {
        updateData.achieved_at = new Date().toISOString()
      } else if (input.status === 'discontinued') {
        updateData.discontinued_at = new Date().toISOString()
        updateData.discontinued_reason = input.reason || null
      }

      const { error } = await supabase
        .from('participant_goals')
        .update(updateData as any)
        .eq('id', input.goalId)

      if (error) throw error
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['goals', variables.participantId] })
    },
  })
}

/**
 * Delete a goal (admin only)
 */
export function useDeleteGoal() {
  const supabase = createClient()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({ goalId, participantId }: { goalId: string; participantId: string }) => {
      const { error } = await supabase
        .from('participant_goals')
        .delete()
        .eq('id', goalId)

      if (error) throw error
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: ['goals', variables.participantId] })
    },
  })
}
```

Exports:
- useParticipantGoals: Fetch goals with progress notes
- useCreateGoal: Create new goal
- useAddProgressNote: Add progress note
- useUpdateGoalStatus: Mark achieved/discontinued
- useDeleteGoal: Delete goal
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin.
  </verify>
  <done>
Goal hooks provide CRUD operations for goals and progress notes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create goal card component</name>
  <files>apps/admin/components/goals/GoalCard.tsx</files>
  <action>
Create reusable goal display card:

```typescript
'use client'

import { useState } from 'react'
import { format } from 'date-fns'

import { Card, CardContent, CardHeader, CardTitle } from '@ephraimcare/ui/components/card'
import { Badge } from '@ephraimcare/ui/components/badge'
import { Button } from '@ephraimcare/ui/components/button'
import { Progress } from '@ephraimcare/ui/components/progress'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@ephraimcare/ui/components/dropdown-menu'
import { MoreVertical, Target, CheckCircle, XCircle, Plus } from 'lucide-react'

import type { GoalWithProgress, GoalStatus, GoalCategory } from '@/hooks/use-goals'
import { GoalProgressModal } from './GoalProgressModal'

const categoryLabels: Record<GoalCategory, string> = {
  daily_living: 'Daily Living',
  community: 'Community',
  employment: 'Employment',
  relationships: 'Relationships',
  health: 'Health',
  learning: 'Learning',
  other: 'Other',
}

const statusColors: Record<GoalStatus, string> = {
  active: 'bg-blue-100 text-blue-800',
  achieved: 'bg-green-100 text-green-800',
  discontinued: 'bg-gray-100 text-gray-800',
}

interface GoalCardProps {
  goal: GoalWithProgress
  participantId: string
  onStatusChange: (goalId: string, status: GoalStatus, reason?: string) => void
  onDelete: (goalId: string) => void
  canEdit: boolean
}

export function GoalCard({ goal, participantId, onStatusChange, onDelete, canEdit }: GoalCardProps) {
  const [showProgressModal, setShowProgressModal] = useState(false)

  const progressPercent = goal.latest_rating ? (goal.latest_rating / 5) * 100 : 0

  return (
    <>
      <Card>
        <CardHeader className="pb-2">
          <div className="flex items-start justify-between">
            <div className="flex items-center gap-2">
              <Target className="h-5 w-5 text-muted-foreground" />
              <CardTitle className="text-lg">{goal.title}</CardTitle>
            </div>
            <div className="flex items-center gap-2">
              <Badge variant="outline">{categoryLabels[goal.category]}</Badge>
              <Badge className={statusColors[goal.status]}>
                {goal.status.charAt(0).toUpperCase() + goal.status.slice(1)}
              </Badge>
              {canEdit && (
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="icon">
                      <MoreVertical className="h-4 w-4" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    {goal.status === 'active' && (
                      <>
                        <DropdownMenuItem onClick={() => onStatusChange(goal.id, 'achieved')}>
                          <CheckCircle className="mr-2 h-4 w-4 text-green-600" />
                          Mark Achieved
                        </DropdownMenuItem>
                        <DropdownMenuItem onClick={() => onStatusChange(goal.id, 'discontinued')}>
                          <XCircle className="mr-2 h-4 w-4 text-gray-600" />
                          Discontinue
                        </DropdownMenuItem>
                      </>
                    )}
                    <DropdownMenuItem
                      onClick={() => onDelete(goal.id)}
                      className="text-red-600"
                    >
                      Delete Goal
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              )}
            </div>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {goal.description && (
            <p className="text-sm text-muted-foreground">{goal.description}</p>
          )}

          {goal.target_date && (
            <p className="text-sm">
              <span className="font-medium">Target:</span>{' '}
              {format(new Date(goal.target_date), 'MMM d, yyyy')}
            </p>
          )}

          {/* Progress indicator */}
          {goal.status === 'active' && (
            <div className="space-y-1">
              <div className="flex justify-between text-sm">
                <span>Latest Progress</span>
                <span>{goal.latest_rating ? `${goal.latest_rating}/5` : 'No ratings yet'}</span>
              </div>
              <Progress value={progressPercent} className="h-2" />
            </div>
          )}

          {/* Progress notes summary */}
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <span className="text-sm font-medium">
                Progress Notes ({goal.progress_notes?.length || 0})
              </span>
              {goal.status === 'active' && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setShowProgressModal(true)}
                >
                  <Plus className="mr-1 h-3 w-3" />
                  Add Note
                </Button>
              )}
            </div>

            {/* Recent notes */}
            {goal.progress_notes?.slice(0, 2).map((note) => (
              <div key={note.id} className="rounded-md bg-muted p-3 text-sm">
                <div className="flex justify-between text-xs text-muted-foreground mb-1">
                  <span>
                    {note.worker?.profile
                      ? `${note.worker.profile.first_name} ${note.worker.profile.last_name}`
                      : 'Admin'}
                  </span>
                  <span>{format(new Date(note.created_at), 'MMM d, yyyy')}</span>
                </div>
                <p>{note.note}</p>
                {note.progress_rating && (
                  <div className="mt-1 text-xs">
                    Rating: {note.progress_rating}/5
                  </div>
                )}
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      <GoalProgressModal
        open={showProgressModal}
        onClose={() => setShowProgressModal(false)}
        goalId={goal.id}
        goalTitle={goal.title}
        participantId={participantId}
      />
    </>
  )
}
```

Features:
- Displays goal with category and status badges
- Progress bar based on latest rating
- Recent progress notes inline
- Action dropdown for status changes
- Add note button opens modal
  </action>
  <verify>
Run `pnpm typecheck`. Component compiles.
  </verify>
  <done>
GoalCard component displays goal with progress and actions.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create progress note modal</name>
  <files>apps/admin/components/goals/GoalProgressModal.tsx</files>
  <action>
Create modal for adding progress notes:

```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'

import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@ephraimcare/ui/components/dialog'
import { Button } from '@ephraimcare/ui/components/button'
import { Textarea } from '@ephraimcare/ui/components/textarea'
import { Label } from '@ephraimcare/ui/components/label'
import { Loader2 } from 'lucide-react'

import { useAddProgressNote } from '@/hooks/use-goals'
import { showToast } from '@/lib/toast'

interface GoalProgressModalProps {
  open: boolean
  onClose: () => void
  goalId: string
  goalTitle: string
  participantId: string
  shiftId?: string
  workerId?: string
}

export function GoalProgressModal({
  open,
  onClose,
  goalId,
  goalTitle,
  participantId,
  shiftId,
  workerId,
}: GoalProgressModalProps) {
  const [rating, setRating] = useState<number>(3)
  const addProgress = useAddProgressNote()

  const form = useForm({
    defaultValues: {
      note: '',
    },
  })

  const onSubmit = async (data: { note: string }) => {
    if (data.note.length < 10) {
      showToast.error('Note must be at least 10 characters')
      return
    }

    try {
      await addProgress.mutateAsync({
        goalId,
        participantId,
        shiftId,
        workerId,
        note: data.note,
        progressRating: rating,
      })
      showToast.success('Progress note added')
      form.reset()
      setRating(3)
      onClose()
    } catch (error) {
      showToast.error('Failed to add progress note')
    }
  }

  const ratingLabels = [
    'No progress',
    'Minimal progress',
    'Some progress',
    'Good progress',
    'Excellent progress',
  ]

  return (
    <Dialog open={open} onOpenChange={(open) => !open && onClose()}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>Add Progress Note</DialogTitle>
          <p className="text-sm text-muted-foreground">{goalTitle}</p>
        </DialogHeader>

        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="note">How did the participant progress on this goal?</Label>
            <Textarea
              id="note"
              placeholder="Describe the progress, observations, and any relevant details..."
              className="min-h-[100px]"
              {...form.register('note')}
            />
            <p className="text-xs text-muted-foreground">
              Minimum 10 characters
            </p>
          </div>

          <div className="space-y-2">
            <Label>Progress Rating</Label>
            <div className="flex justify-between gap-2">
              {[1, 2, 3, 4, 5].map((n) => (
                <button
                  key={n}
                  type="button"
                  onClick={() => setRating(n)}
                  className={`
                    flex-1 py-3 rounded-md border text-center transition-colors
                    ${rating === n
                      ? 'bg-primary text-primary-foreground border-primary'
                      : 'bg-background hover:bg-muted border-input'
                    }
                  `}
                >
                  <span className="text-lg font-bold">{n}</span>
                </button>
              ))}
            </div>
            <p className="text-center text-sm text-muted-foreground">
              {ratingLabels[rating - 1]}
            </p>
          </div>

          <DialogFooter>
            <Button type="button" variant="outline" onClick={onClose}>
              Cancel
            </Button>
            <Button type="submit" disabled={addProgress.isPending}>
              {addProgress.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Save Progress
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  )
}
```

Features:
- Text area for progress note
- 1-5 rating buttons with labels
- Minimum 10 character validation
- Optional shift/worker linking
  </action>
  <verify>
Run `pnpm typecheck`. Component compiles.
  </verify>
  <done>
Progress note modal allows adding notes with rating scale.
  </done>
</task>

<task type="auto">
  <name>Task 5: Create participant goals page</name>
  <files>apps/admin/app/(protected)/participants/[id]/goals/page.tsx</files>
  <action>
Create the goals management page:

```typescript
'use client'

import { useState } from 'react'
import { useParams } from 'next/navigation'
import { useForm } from 'react-hook-form'

import { Button } from '@ephraimcare/ui/components/button'
import { Input } from '@ephraimcare/ui/components/input'
import { Textarea } from '@ephraimcare/ui/components/textarea'
import { Label } from '@ephraimcare/ui/components/label'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter,
} from '@ephraimcare/ui/components/dialog'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@ephraimcare/ui/components/select'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@ephraimcare/ui/components/tabs'
import { Loader2, Plus, Target } from 'lucide-react'

import {
  useParticipantGoals,
  useCreateGoal,
  useUpdateGoalStatus,
  useDeleteGoal,
  type GoalCategory,
  type GoalStatus,
} from '@/hooks/use-goals'
import { useParticipant } from '@/hooks/use-participants'
import { useAuth } from '@/hooks/use-auth'
import { GoalCard } from '@/components/goals/GoalCard'
import { showToast } from '@/lib/toast'

const categories: { value: GoalCategory; label: string }[] = [
  { value: 'daily_living', label: 'Daily Living' },
  { value: 'community', label: 'Community Participation' },
  { value: 'employment', label: 'Employment' },
  { value: 'relationships', label: 'Relationships' },
  { value: 'health', label: 'Health & Wellbeing' },
  { value: 'learning', label: 'Learning' },
  { value: 'other', label: 'Other' },
]

export default function ParticipantGoalsPage() {
  const params = useParams()
  const participantId = params.id as string

  const { data: participant, isLoading: participantLoading } = useParticipant(participantId)
  const { data: goals, isLoading: goalsLoading } = useParticipantGoals(participantId)
  const { user, profile } = useAuth()

  const createGoal = useCreateGoal()
  const updateStatus = useUpdateGoalStatus()
  const deleteGoal = useDeleteGoal()

  const [showCreateDialog, setShowCreateDialog] = useState(false)
  const [selectedCategory, setSelectedCategory] = useState<GoalCategory>('daily_living')

  const form = useForm({
    defaultValues: {
      title: '',
      description: '',
      targetDate: '',
    },
  })

  const canEdit = profile?.role === 'admin' || profile?.role === 'coordinator'

  const handleCreateGoal = async (data: typeof form.getValues) => {
    try {
      await createGoal.mutateAsync({
        participantId,
        title: data.title,
        description: data.description || undefined,
        targetDate: data.targetDate || undefined,
        category: selectedCategory,
      })
      showToast.success('Goal created')
      form.reset()
      setShowCreateDialog(false)
    } catch (error) {
      showToast.error('Failed to create goal')
    }
  }

  const handleStatusChange = async (goalId: string, status: GoalStatus, reason?: string) => {
    try {
      await updateStatus.mutateAsync({
        goalId,
        participantId,
        status,
        reason,
      })
      showToast.success(`Goal marked as ${status}`)
    } catch (error) {
      showToast.error('Failed to update goal')
    }
  }

  const handleDelete = async (goalId: string) => {
    if (!confirm('Are you sure you want to delete this goal?')) return

    try {
      await deleteGoal.mutateAsync({ goalId, participantId })
      showToast.success('Goal deleted')
    } catch (error) {
      showToast.error('Failed to delete goal')
    }
  }

  if (participantLoading || goalsLoading) {
    return (
      <div className="flex items-center justify-center p-8">
        <Loader2 className="h-6 w-6 animate-spin" />
      </div>
    )
  }

  const activeGoals = goals?.filter((g) => g.status === 'active') || []
  const achievedGoals = goals?.filter((g) => g.status === 'achieved') || []
  const discontinuedGoals = goals?.filter((g) => g.status === 'discontinued') || []

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">
            Goals for {participant?.first_name} {participant?.last_name}
          </h1>
          <p className="text-muted-foreground">
            Track care goals and monitor progress
          </p>
        </div>
        {canEdit && (
          <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>
            <DialogTrigger asChild>
              <Button>
                <Plus className="mr-2 h-4 w-4" />
                Add Goal
              </Button>
            </DialogTrigger>
            <DialogContent>
              <DialogHeader>
                <DialogTitle>Create New Goal</DialogTitle>
              </DialogHeader>
              <form onSubmit={form.handleSubmit(handleCreateGoal)} className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="title">Goal Title</Label>
                  <Input
                    id="title"
                    placeholder="e.g., Improve morning routine independence"
                    {...form.register('title', { required: true })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="category">Category</Label>
                  <Select
                    value={selectedCategory}
                    onValueChange={(v) => setSelectedCategory(v as GoalCategory)}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {categories.map((cat) => (
                        <SelectItem key={cat.value} value={cat.value}>
                          {cat.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="description">Description (optional)</Label>
                  <Textarea
                    id="description"
                    placeholder="Detailed description of the goal..."
                    {...form.register('description')}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="targetDate">Target Date (optional)</Label>
                  <Input
                    id="targetDate"
                    type="date"
                    {...form.register('targetDate')}
                  />
                </div>

                <DialogFooter>
                  <Button type="button" variant="outline" onClick={() => setShowCreateDialog(false)}>
                    Cancel
                  </Button>
                  <Button type="submit" disabled={createGoal.isPending}>
                    {createGoal.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                    Create Goal
                  </Button>
                </DialogFooter>
              </form>
            </DialogContent>
          </Dialog>
        )}
      </div>

      <Tabs defaultValue="active">
        <TabsList>
          <TabsTrigger value="active">
            Active ({activeGoals.length})
          </TabsTrigger>
          <TabsTrigger value="achieved">
            Achieved ({achievedGoals.length})
          </TabsTrigger>
          <TabsTrigger value="discontinued">
            Discontinued ({discontinuedGoals.length})
          </TabsTrigger>
        </TabsList>

        <TabsContent value="active" className="space-y-4 mt-4">
          {activeGoals.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">
              <Target className="h-12 w-12 mx-auto mb-4 opacity-50" />
              <p>No active goals</p>
              {canEdit && (
                <Button
                  variant="outline"
                  className="mt-4"
                  onClick={() => setShowCreateDialog(true)}
                >
                  Create First Goal
                </Button>
              )}
            </div>
          ) : (
            activeGoals.map((goal) => (
              <GoalCard
                key={goal.id}
                goal={goal}
                participantId={participantId}
                onStatusChange={handleStatusChange}
                onDelete={handleDelete}
                canEdit={canEdit}
              />
            ))
          )}
        </TabsContent>

        <TabsContent value="achieved" className="space-y-4 mt-4">
          {achievedGoals.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">
              <p>No achieved goals yet</p>
            </div>
          ) : (
            achievedGoals.map((goal) => (
              <GoalCard
                key={goal.id}
                goal={goal}
                participantId={participantId}
                onStatusChange={handleStatusChange}
                onDelete={handleDelete}
                canEdit={canEdit}
              />
            ))
          )}
        </TabsContent>

        <TabsContent value="discontinued" className="space-y-4 mt-4">
          {discontinuedGoals.length === 0 ? (
            <div className="text-center py-8 text-muted-foreground">
              <p>No discontinued goals</p>
            </div>
          ) : (
            discontinuedGoals.map((goal) => (
              <GoalCard
                key={goal.id}
                goal={goal}
                participantId={participantId}
                onStatusChange={handleStatusChange}
                onDelete={handleDelete}
                canEdit={canEdit}
              />
            ))
          )}
        </TabsContent>
      </Tabs>
    </div>
  )
}
```

Features:
- Tabs for active/achieved/discontinued goals
- Create goal dialog with category selection
- GoalCard for each goal with actions
- Role-based edit permissions
  </action>
  <verify>
Run `pnpm dev` and navigate to /participants/[id]/goals.
  </verify>
  <done>
Participant goals page provides full goal management UI.
  </done>
</task>

</tasks>

<verification>
1. Navigate to participant goals page - displays empty state
2. Create a goal with title, description, category, target date
3. Goal appears in active tab with progress indicator
4. Add progress note with rating - note appears on goal card
5. Mark goal as achieved - moves to achieved tab
6. Workers can add notes but not create/delete goals
</verification>

<success_criteria>
- Admin/coordinator can create goals with NDIS-aligned categories
- Goals display with progress bar and recent notes
- Workers can add progress notes with 1-5 rating
- Goals can be marked achieved or discontinued
- Proper RLS enforces organization isolation
</success_criteria>

<output>
After completion, create `.planning/phases/13-scale-features/13-08-SUMMARY.md`
</output>
