---
phase: 13-scale-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/app/(auth)/register/page.tsx
  - apps/admin/app/api/organizations/register/route.ts
  - apps/admin/lib/supabase/schemas.ts
autonomous: true

must_haves:
  truths:
    - "New organization can register with name, ABN, and admin email"
    - "Registration creates organization + admin user + profile in single transaction"
    - "New admin receives confirmation email with login link"
    - "Duplicate ABN is rejected with clear error message"
  artifacts:
    - path: "apps/admin/app/(auth)/register/page.tsx"
      provides: "Organization registration form UI"
      min_lines: 80
    - path: "apps/admin/app/api/organizations/register/route.ts"
      provides: "Registration API with service role"
      exports: ["POST"]
    - path: "apps/admin/lib/supabase/schemas.ts"
      provides: "Organization registration Zod schema"
      contains: "organizationRegisterSchema"
  key_links:
    - from: "apps/admin/app/(auth)/register/page.tsx"
      to: "/api/organizations/register"
      via: "fetch POST"
      pattern: "fetch.*api/organizations/register"
---

<objective>
Create the self-service organization registration flow for new NDIS providers.

Purpose: Allow new organizations to sign up and get instant access with isolated data, enabling the platform to serve multiple providers beyond Ephraim Care.

Output: Registration page with form, API route using service role to create org + admin, Zod validation schema.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-scale-features/13-RESEARCH.md

# Existing auth patterns
@apps/admin/app/(auth)/login/page.tsx
@apps/admin/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create organization registration Zod schema</name>
  <files>apps/admin/lib/supabase/schemas.ts</files>
  <action>
Create or update schemas.ts with organization registration schema:

```typescript
import { z } from 'zod'

/**
 * Organization registration schema
 * Used for new NDIS provider signup
 */
export const organizationRegisterSchema = z.object({
  organizationName: z
    .string()
    .min(2, 'Organization name must be at least 2 characters')
    .max(100, 'Organization name must be under 100 characters'),
  abn: z
    .string()
    .regex(/^\d{11}$/, 'ABN must be exactly 11 digits')
    .transform(val => val.replace(/\s/g, '')),
  adminEmail: z
    .string()
    .email('Please enter a valid email address'),
  adminPassword: z
    .string()
    .min(8, 'Password must be at least 8 characters')
    .regex(/[A-Z]/, 'Password must contain at least one uppercase letter')
    .regex(/[0-9]/, 'Password must contain at least one number'),
  adminFirstName: z
    .string()
    .min(1, 'First name is required')
    .max(50, 'First name must be under 50 characters'),
  adminLastName: z
    .string()
    .min(1, 'Last name is required')
    .max(50, 'Last name must be under 50 characters'),
})

export type OrganizationRegisterInput = z.infer<typeof organizationRegisterSchema>
```

Export both schema and type.
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin. Schema exports correctly.
  </verify>
  <done>
Zod schema validates organization registration with ABN format check and password strength rules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create organization registration API route</name>
  <files>apps/admin/app/api/organizations/register/route.ts</files>
  <action>
Create the registration API route using service role:

```typescript
import { createClient } from '@supabase/supabase-js'
import { NextResponse } from 'next/server'
import { organizationRegisterSchema } from '@/lib/supabase/schemas'

export async function POST(request: Request) {
  try {
    const body = await request.json()
    const validatedData = organizationRegisterSchema.parse(body)

    // Use service role for admin operations
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    )

    // Check for duplicate ABN
    const { data: existingOrg } = await supabase
      .from('organizations')
      .select('id')
      .eq('abn', validatedData.abn)
      .single()

    if (existingOrg) {
      return NextResponse.json(
        { error: 'An organization with this ABN already exists' },
        { status: 400 }
      )
    }

    // 1. Create organization
    const { data: org, error: orgError } = await supabase
      .from('organizations')
      .insert({
        name: validatedData.organizationName,
        abn: validatedData.abn,
        status: 'active',
        settings: {
          sms_enabled: false,
          xero_connected: false,
          ndia_registered: false,
        },
      } as any)
      .select()
      .single()

    if (orgError) {
      console.error('Organization creation failed:', orgError)
      return NextResponse.json(
        { error: 'Failed to create organization' },
        { status: 500 }
      )
    }

    // 2. Create admin user via auth API
    const { data: authData, error: authError } = await supabase.auth.admin.createUser({
      email: validatedData.adminEmail,
      password: validatedData.adminPassword,
      email_confirm: true,
    })

    if (authError) {
      // Rollback: delete organization
      await supabase.from('organizations').delete().eq('id', org.id)
      console.error('Admin user creation failed:', authError)
      return NextResponse.json(
        { error: authError.message || 'Failed to create admin user' },
        { status: 400 }
      )
    }

    // 3. Create profile for admin
    const { error: profileError } = await supabase.from('profiles').insert({
      id: authData.user.id,
      email: validatedData.adminEmail,
      first_name: validatedData.adminFirstName,
      last_name: validatedData.adminLastName,
      role: 'admin',
      organization_id: org.id,
      is_platform_admin: false,
    } as any)

    if (profileError) {
      // Rollback: delete user and organization
      await supabase.auth.admin.deleteUser(authData.user.id)
      await supabase.from('organizations').delete().eq('id', org.id)
      console.error('Profile creation failed:', profileError)
      return NextResponse.json(
        { error: 'Failed to create admin profile' },
        { status: 500 }
      )
    }

    // 4. Create user_roles entry
    await supabase.from('user_roles').insert({
      user_id: authData.user.id,
      role: 'admin',
      organization_id: org.id,
    } as any)

    return NextResponse.json({
      success: true,
      organizationId: org.id,
      message: 'Organization registered successfully. You can now log in.',
    })
  } catch (error) {
    if (error instanceof Error && error.name === 'ZodError') {
      return NextResponse.json(
        { error: 'Invalid input data', details: error },
        { status: 400 }
      )
    }
    console.error('Registration error:', error)
    return NextResponse.json(
      { error: 'Registration failed. Please try again.' },
      { status: 500 }
    )
  }
}
```

Key patterns:
- Service role client for admin operations
- Manual rollback on failure (delete org if user fails, delete both if profile fails)
- ABN uniqueness check before creation
- Zod validation with descriptive errors
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin. No import errors.
Test manually with curl to /api/organizations/register.
  </verify>
  <done>
Registration API creates organization + admin user + profile atomically with rollback on failure.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create organization registration page</name>
  <files>apps/admin/app/(auth)/register/page.tsx</files>
  <action>
Create registration form page:

```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import Link from 'next/link'

import { Button } from '@ephraimcare/ui/components/button'
import { Input } from '@ephraimcare/ui/components/input'
import { Label } from '@ephraimcare/ui/components/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@ephraimcare/ui/components/card'
import { Alert, AlertDescription } from '@ephraimcare/ui/components/alert'
import { Loader2 } from 'lucide-react'

import { organizationRegisterSchema, type OrganizationRegisterInput } from '@/lib/supabase/schemas'

export default function RegisterPage() {
  const router = useRouter()
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState(false)

  const form = useForm<OrganizationRegisterInput>({
    resolver: zodResolver(organizationRegisterSchema),
    defaultValues: {
      organizationName: '',
      abn: '',
      adminEmail: '',
      adminPassword: '',
      adminFirstName: '',
      adminLastName: '',
    },
  })

  const onSubmit = async (data: OrganizationRegisterInput) => {
    setIsLoading(true)
    setError(null)

    try {
      const response = await fetch('/api/organizations/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      })

      const result = await response.json()

      if (!response.ok) {
        throw new Error(result.error || 'Registration failed')
      }

      setSuccess(true)
      // Redirect to login after 2 seconds
      setTimeout(() => router.push('/login'), 2000)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Registration failed')
    } finally {
      setIsLoading(false)
    }
  }

  if (success) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-gray-50">
        <Card className="w-full max-w-md">
          <CardHeader className="text-center">
            <CardTitle className="text-2xl text-green-600">Registration Successful!</CardTitle>
            <CardDescription>
              Your organization has been created. Redirecting to login...
            </CardDescription>
          </CardHeader>
        </Card>
      </div>
    )
  }

  return (
    <div className="flex min-h-screen items-center justify-center bg-gray-50 p-4">
      <Card className="w-full max-w-lg">
        <CardHeader className="text-center">
          <CardTitle className="text-2xl">Register Your Organization</CardTitle>
          <CardDescription>
            Create an account for your NDIS provider organization
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            {error && (
              <Alert variant="destructive">
                <AlertDescription>{error}</AlertDescription>
              </Alert>
            )}

            <div className="space-y-2">
              <Label htmlFor="organizationName">Organization Name</Label>
              <Input
                id="organizationName"
                placeholder="Ephraim Care"
                {...form.register('organizationName')}
              />
              {form.formState.errors.organizationName && (
                <p className="text-sm text-red-500">{form.formState.errors.organizationName.message}</p>
              )}
            </div>

            <div className="space-y-2">
              <Label htmlFor="abn">ABN (11 digits)</Label>
              <Input
                id="abn"
                placeholder="12345678901"
                {...form.register('abn')}
              />
              {form.formState.errors.abn && (
                <p className="text-sm text-red-500">{form.formState.errors.abn.message}</p>
              )}
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="adminFirstName">First Name</Label>
                <Input
                  id="adminFirstName"
                  placeholder="John"
                  {...form.register('adminFirstName')}
                />
                {form.formState.errors.adminFirstName && (
                  <p className="text-sm text-red-500">{form.formState.errors.adminFirstName.message}</p>
                )}
              </div>

              <div className="space-y-2">
                <Label htmlFor="adminLastName">Last Name</Label>
                <Input
                  id="adminLastName"
                  placeholder="Smith"
                  {...form.register('adminLastName')}
                />
                {form.formState.errors.adminLastName && (
                  <p className="text-sm text-red-500">{form.formState.errors.adminLastName.message}</p>
                )}
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="adminEmail">Admin Email</Label>
              <Input
                id="adminEmail"
                type="email"
                placeholder="admin@example.com"
                {...form.register('adminEmail')}
              />
              {form.formState.errors.adminEmail && (
                <p className="text-sm text-red-500">{form.formState.errors.adminEmail.message}</p>
              )}
            </div>

            <div className="space-y-2">
              <Label htmlFor="adminPassword">Password</Label>
              <Input
                id="adminPassword"
                type="password"
                placeholder="Min 8 chars, 1 uppercase, 1 number"
                {...form.register('adminPassword')}
              />
              {form.formState.errors.adminPassword && (
                <p className="text-sm text-red-500">{form.formState.errors.adminPassword.message}</p>
              )}
            </div>

            <Button type="submit" className="w-full" disabled={isLoading}>
              {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Register Organization
            </Button>

            <p className="text-center text-sm text-gray-600">
              Already have an account?{' '}
              <Link href="/login" className="text-primary hover:underline">
                Log in
              </Link>
            </p>
          </form>
        </CardContent>
      </Card>
    </div>
  )
}
```

Key features:
- Zod validation with react-hook-form
- Success state with redirect to login
- Error display from API
- Responsive layout with grid for name fields
- Link to login for existing users
  </action>
  <verify>
Run `pnpm dev` and navigate to /register.
Form displays correctly with all fields.
  </verify>
  <done>
Registration page provides self-service signup for new NDIS providers with form validation and success flow.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /register - form displays with all fields
2. Submit with invalid data - validation errors show
3. Submit with duplicate ABN - API returns clear error
4. Submit with valid data - success message, redirect to login
5. Log in with new admin credentials - dashboard loads for new org
</verification>

<success_criteria>
- Organization registration form is accessible at /register
- Zod schema validates ABN format (11 digits) and password strength
- API creates organization + user + profile atomically
- Duplicate ABN is rejected with clear error
- New admin can log in after registration
</success_criteria>

<output>
After completion, create `.planning/phases/13-scale-features/13-02-SUMMARY.md`
</output>
