---
phase: 13-scale-features
plan: 12
type: execute
wave: 3
depends_on: ["13-01"]
files_modified:
  - apps/admin/lib/ndia/generate-claim-csv.ts
  - apps/admin/app/api/ndia/generate-csv/route.ts
  - apps/admin/components/invoices/NdiaCsvExport.tsx
  - apps/admin/app/(protected)/invoices/ndia-export/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can select date range for NDIA claim export"
    - "CSV generated follows PACE bulk upload format"
    - "CSV includes all required fields: Registration Number, NDIS Number, Support Item Number, etc."
    - "One-click download of generated CSV file"
    - "Only finalized invoices with PACE-eligible line items included"
  artifacts:
    - path: "apps/admin/lib/ndia/generate-claim-csv.ts"
      provides: "PACE-compliant CSV generation"
      exports: ["generateNdiaCsv", "validatePaceData"]
    - path: "apps/admin/app/api/ndia/generate-csv/route.ts"
      provides: "CSV download API endpoint"
      exports: ["POST"]
    - path: "apps/admin/components/invoices/NdiaCsvExport.tsx"
      provides: "Export UI with date range selector"
      min_lines: 80
  key_links:
    - from: "apps/admin/components/invoices/NdiaCsvExport.tsx"
      to: "/api/ndia/generate-csv"
      via: "fetch POST"
      pattern: "api/ndia/generate-csv"
---

<objective>
Implement NDIA PACE-compliant CSV generation for bulk claim submission.

Purpose: Enable one-click export of finalized invoices to PACE CSV format for upload to the myplace portal, reducing manual data entry for NDIA claims.

Output: CSV generation library, export UI with date range selection, download endpoint.

Note: Per RESEARCH.md, direct NDIA API integration requires formal DPP partnership. This plan implements CSV generation as the practical immediate path.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-scale-features/13-RESEARCH.md

# Existing invoice patterns
@apps/admin/hooks/use-invoices.ts
@apps/admin/lib/invoices/generate-invoice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NDIA CSV generation library</name>
  <files>apps/admin/lib/ndia/generate-claim-csv.ts</files>
  <action>
Create PACE-compliant CSV generation:

```typescript
import { format } from 'date-fns'

/**
 * PACE Bulk Claim CSV Format
 * Reference: https://www.ndis.gov.au/providers/working-provider/getting-paid/bulk-payments
 */

export interface PaceClaimRow {
  registrationNumber: string // Provider registration number
  ndisNumber: string // Participant NDIS number
  supportItemNumber: string // NDIS support item code
  claimReference: string // Unique claim reference (invoice number)
  dateOfSupport: string // DD/MM/YYYY format
  quantity: number // Hours or units
  hoursOfSupport?: number // Hours if applicable
  unitPrice: number // Price per unit
  totalPrice: number // quantity * unitPrice
  gst: 'Y' | 'N' // GST included (usually N for NDIS)
  claimType: 'STANDARD' | 'CANCELLATION' | 'TRAVEL' // Claim type
  cancellationReason?: string // Required if claim type is CANCELLATION
  serviceBookingId?: string // If applicable
  abn?: string // Provider ABN
}

export interface InvoiceForExport {
  id: string
  invoice_number: string
  invoice_date: string
  participant: {
    ndis_number: string
    first_name: string
    last_name: string
  }
  line_items: {
    id: string
    support_item_number: string
    description: string
    quantity: number
    unit_price: number
    total: number
    service_date: string
  }[]
}

export interface OrganizationDetails {
  registrationNumber: string
  abn: string
  name: string
}

/**
 * Validate PACE data before generating CSV
 */
export function validatePaceData(
  invoices: InvoiceForExport[],
  organization: OrganizationDetails
): { valid: boolean; errors: string[] } {
  const errors: string[] = []

  if (!organization.registrationNumber) {
    errors.push('Organization NDIS registration number is required')
  }

  if (!organization.abn) {
    errors.push('Organization ABN is required')
  }

  for (const invoice of invoices) {
    if (!invoice.participant?.ndis_number) {
      errors.push(`Invoice ${invoice.invoice_number}: Participant NDIS number is missing`)
    }

    for (const item of invoice.line_items) {
      if (!item.support_item_number) {
        errors.push(`Invoice ${invoice.invoice_number}: Support item number missing for "${item.description}"`)
      }

      if (!item.service_date) {
        errors.push(`Invoice ${invoice.invoice_number}: Service date missing for "${item.description}"`)
      }
    }
  }

  return {
    valid: errors.length === 0,
    errors,
  }
}

/**
 * Convert invoices to PACE claim rows
 */
export function invoicesToPaceRows(
  invoices: InvoiceForExport[],
  organization: OrganizationDetails
): PaceClaimRow[] {
  const rows: PaceClaimRow[] = []

  for (const invoice of invoices) {
    for (const item of invoice.line_items) {
      // Skip items without support item numbers (not NDIS claimable)
      if (!item.support_item_number) continue

      rows.push({
        registrationNumber: organization.registrationNumber,
        ndisNumber: invoice.participant.ndis_number,
        supportItemNumber: item.support_item_number,
        claimReference: `${invoice.invoice_number}-${item.id.slice(0, 8)}`,
        dateOfSupport: item.service_date
          ? format(new Date(item.service_date), 'dd/MM/yyyy')
          : format(new Date(invoice.invoice_date), 'dd/MM/yyyy'),
        quantity: item.quantity,
        hoursOfSupport: item.quantity, // Assuming quantity is hours
        unitPrice: item.unit_price,
        totalPrice: item.total,
        gst: 'N', // NDIS services are GST-free
        claimType: 'STANDARD',
        abn: organization.abn,
      })
    }
  }

  return rows
}

/**
 * Generate PACE CSV content
 */
export function generatePaceCsv(rows: PaceClaimRow[]): string {
  // PACE header columns
  const headers = [
    'RegistrationNumber',
    'NDISNumber',
    'SupportItemNumber',
    'ClaimReference',
    'DateOfSupport',
    'Quantity',
    'Hours',
    'UnitPrice',
    'TotalPrice',
    'GST',
    'ClaimType',
    'CancellationReason',
    'ABN',
  ]

  const csvRows = [headers.join(',')]

  for (const row of rows) {
    const csvRow = [
      row.registrationNumber,
      row.ndisNumber,
      row.supportItemNumber,
      row.claimReference,
      row.dateOfSupport,
      row.quantity.toString(),
      row.hoursOfSupport?.toString() || '',
      row.unitPrice.toFixed(2),
      row.totalPrice.toFixed(2),
      row.gst,
      row.claimType,
      row.cancellationReason || '',
      row.abn || '',
    ]

    // Escape fields that might contain commas
    csvRows.push(csvRow.map((field) => escapeCSVField(field)).join(','))
  }

  return csvRows.join('\n')
}

/**
 * Escape CSV field value
 */
function escapeCSVField(field: string): string {
  if (field.includes(',') || field.includes('"') || field.includes('\n')) {
    return `"${field.replace(/"/g, '""')}"`
  }
  return field
}

/**
 * Full export function
 */
export async function generateNdiaCsv(
  invoices: InvoiceForExport[],
  organization: OrganizationDetails
): Promise<{ success: boolean; csv?: string; errors?: string[]; rowCount?: number }> {
  // Validate
  const validation = validatePaceData(invoices, organization)
  if (!validation.valid) {
    return { success: false, errors: validation.errors }
  }

  // Convert to PACE rows
  const rows = invoicesToPaceRows(invoices, organization)

  if (rows.length === 0) {
    return {
      success: false,
      errors: ['No claimable line items found. Ensure invoices have support item numbers.'],
    }
  }

  // Generate CSV
  const csv = generatePaceCsv(rows)

  return {
    success: true,
    csv,
    rowCount: rows.length,
  }
}

/**
 * Calculate export statistics
 */
export function calculateExportStats(rows: PaceClaimRow[]): {
  totalClaims: number
  totalValue: number
  participantCount: number
  dateRange: { start: string; end: string }
} {
  const participants = new Set(rows.map((r) => r.ndisNumber))
  const dates = rows.map((r) => r.dateOfSupport).sort()

  return {
    totalClaims: rows.length,
    totalValue: rows.reduce((sum, r) => sum + r.totalPrice, 0),
    participantCount: participants.size,
    dateRange: {
      start: dates[0] || '',
      end: dates[dates.length - 1] || '',
    },
  }
}
```

Features:
- PACE-compliant CSV format
- Validation before export
- Support item number filtering
- Proper date formatting (DD/MM/YYYY)
- GST handling (N for NDIS)
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin.
  </verify>
  <done>
NDIA CSV generation library produces PACE-compliant output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSV download API endpoint</name>
  <files>apps/admin/app/api/ndia/generate-csv/route.ts</files>
  <action>
Create API endpoint for CSV generation and download:

```typescript
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { createClient as createServiceClient } from '@supabase/supabase-js'
import {
  generateNdiaCsv,
  invoicesToPaceRows,
  calculateExportStats,
  type InvoiceForExport,
  type OrganizationDetails,
} from '@/lib/ndia/generate-claim-csv'
import { format } from 'date-fns'

/**
 * Generate NDIA PACE CSV for download
 * POST /api/ndia/generate-csv
 */
export async function POST(request: Request) {
  try {
    const supabase = await createClient()

    // Verify authentication
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Get user's profile
    const { data: profile } = await supabase
      .from('profiles')
      .select('organization_id, role')
      .eq('id', user.id)
      .single()

    if (!profile?.organization_id || profile.role !== 'admin') {
      return NextResponse.json({ error: 'Admin access required' }, { status: 403 })
    }

    // Parse request body
    const body = await request.json()
    const { startDate, endDate, invoiceIds } = body

    if (!startDate || !endDate) {
      return NextResponse.json({ error: 'Date range required' }, { status: 400 })
    }

    // Use service client for full access
    const serviceClient = createServiceClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!
    )

    // Fetch organization details
    const { data: org, error: orgError } = await serviceClient
      .from('organizations')
      .select('id, name, abn, ndis_registration_number')
      .eq('id', profile.organization_id)
      .single()

    if (orgError || !org) {
      return NextResponse.json({ error: 'Organization not found' }, { status: 404 })
    }

    const organization: OrganizationDetails = {
      registrationNumber: org.ndis_registration_number || '',
      abn: org.abn || '',
      name: org.name,
    }

    // Build invoice query
    let query = serviceClient
      .from('invoices')
      .select(`
        id,
        invoice_number,
        invoice_date,
        participant:participants(
          ndis_number,
          first_name,
          last_name
        ),
        line_items:invoice_line_items(
          id,
          support_item_number,
          description,
          quantity,
          unit_price,
          total,
          service_date
        )
      `)
      .eq('organization_id', profile.organization_id)
      .eq('status', 'finalized')
      .gte('invoice_date', startDate)
      .lte('invoice_date', endDate)

    // If specific invoice IDs provided, filter to those
    if (invoiceIds && invoiceIds.length > 0) {
      query = query.in('id', invoiceIds)
    }

    const { data: invoices, error: invoicesError } = await query

    if (invoicesError) {
      console.error('Failed to fetch invoices:', invoicesError)
      return NextResponse.json({ error: 'Failed to fetch invoices' }, { status: 500 })
    }

    if (!invoices || invoices.length === 0) {
      return NextResponse.json({
        error: 'No finalized invoices found in the selected date range',
      }, { status: 404 })
    }

    // Cast to export format
    const invoicesForExport: InvoiceForExport[] = invoices.map((inv: any) => ({
      id: inv.id,
      invoice_number: inv.invoice_number,
      invoice_date: inv.invoice_date,
      participant: inv.participant,
      line_items: inv.line_items || [],
    }))

    // Generate CSV
    const result = await generateNdiaCsv(invoicesForExport, organization)

    if (!result.success) {
      return NextResponse.json({
        error: 'CSV generation failed',
        validationErrors: result.errors,
      }, { status: 400 })
    }

    // Calculate stats
    const rows = invoicesToPaceRows(invoicesForExport, organization)
    const stats = calculateExportStats(rows)

    // Generate filename
    const filename = `ndia-claims-${format(new Date(startDate), 'yyyyMMdd')}-${format(new Date(endDate), 'yyyyMMdd')}.csv`

    // Return CSV with proper headers for download
    return new Response(result.csv, {
      status: 200,
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="${filename}"`,
        'X-Total-Claims': String(stats.totalClaims),
        'X-Total-Value': String(stats.totalValue.toFixed(2)),
        'X-Participant-Count': String(stats.participantCount),
      },
    })
  } catch (error) {
    console.error('NDIA CSV generation error:', error)
    return NextResponse.json(
      { error: 'Failed to generate CSV' },
      { status: 500 }
    )
  }
}

/**
 * Preview export stats without generating CSV
 * GET /api/ndia/generate-csv?startDate=xxx&endDate=xxx
 */
export async function GET(request: Request) {
  try {
    const url = new URL(request.url)
    const startDate = url.searchParams.get('startDate')
    const endDate = url.searchParams.get('endDate')

    if (!startDate || !endDate) {
      return NextResponse.json({ error: 'Date range required' }, { status: 400 })
    }

    const supabase = await createClient()

    const { data: { user } } = await supabase.auth.getUser()
    if (!user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const { data: profile } = await supabase
      .from('profiles')
      .select('organization_id')
      .eq('id', user.id)
      .single()

    if (!profile?.organization_id) {
      return NextResponse.json({ error: 'No organization' }, { status: 400 })
    }

    // Count matching invoices and line items
    const { data: invoices, error } = await supabase
      .from('invoices')
      .select(`
        id,
        invoice_number,
        participant:participants(ndis_number),
        line_items:invoice_line_items(id, support_item_number, total)
      `)
      .eq('organization_id', profile.organization_id)
      .eq('status', 'finalized')
      .gte('invoice_date', startDate)
      .lte('invoice_date', endDate)

    if (error) throw error

    const claimableItems = invoices?.flatMap((inv: any) =>
      (inv.line_items || []).filter((li: any) => li.support_item_number)
    ) || []

    const participantsWithNdis = invoices?.filter(
      (inv: any) => inv.participant?.ndis_number
    ).length || 0

    return NextResponse.json({
      invoiceCount: invoices?.length || 0,
      claimableLineItems: claimableItems.length,
      totalValue: claimableItems.reduce((sum: number, li: any) => sum + (li.total || 0), 0),
      participantsWithNdis,
      warnings: invoices?.filter((inv: any) => !inv.participant?.ndis_number)
        .map((inv: any) => `Invoice ${inv.invoice_number}: Missing NDIS number`) || [],
    })
  } catch (error) {
    console.error('Preview error:', error)
    return NextResponse.json({ error: 'Failed to preview' }, { status: 500 })
  }
}
```

Features:
- Date range filtering
- Optional specific invoice selection
- Validation before generation
- Proper CSV download headers
- Preview endpoint for stats
  </action>
  <verify>
Run `pnpm typecheck`.
  </verify>
  <done>
CSV download endpoint with validation and proper headers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create NDIA export UI component</name>
  <files>apps/admin/components/invoices/NdiaCsvExport.tsx</files>
  <action>
Create UI for NDIA CSV export:

```typescript
'use client'

import { useState, useEffect } from 'react'
import { format, subDays, startOfMonth, endOfMonth } from 'date-fns'

import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@ephraimcare/ui/components/card'
import { Button } from '@ephraimcare/ui/components/button'
import { Input } from '@ephraimcare/ui/components/input'
import { Label } from '@ephraimcare/ui/components/label'
import { Alert, AlertDescription, AlertTitle } from '@ephraimcare/ui/components/alert'
import { Loader2, Download, FileText, AlertTriangle, CheckCircle } from 'lucide-react'

import { showToast } from '@/lib/toast'

interface ExportPreview {
  invoiceCount: number
  claimableLineItems: number
  totalValue: number
  participantsWithNdis: number
  warnings: string[]
}

interface NdiaCsvExportProps {
  organizationHasRegistration: boolean
}

export function NdiaCsvExport({ organizationHasRegistration }: NdiaCsvExportProps) {
  const [startDate, setStartDate] = useState(
    format(startOfMonth(new Date()), 'yyyy-MM-dd')
  )
  const [endDate, setEndDate] = useState(
    format(endOfMonth(new Date()), 'yyyy-MM-dd')
  )
  const [preview, setPreview] = useState<ExportPreview | null>(null)
  const [isLoadingPreview, setIsLoadingPreview] = useState(false)
  const [isExporting, setIsExporting] = useState(false)

  // Load preview when dates change
  useEffect(() => {
    if (startDate && endDate) {
      loadPreview()
    }
  }, [startDate, endDate])

  const loadPreview = async () => {
    setIsLoadingPreview(true)
    try {
      const response = await fetch(
        `/api/ndia/generate-csv?startDate=${startDate}&endDate=${endDate}`
      )
      if (!response.ok) throw new Error('Failed to load preview')
      const data = await response.json()
      setPreview(data)
    } catch (error) {
      console.error('Preview error:', error)
      setPreview(null)
    }
    setIsLoadingPreview(false)
  }

  const handleExport = async () => {
    setIsExporting(true)
    try {
      const response = await fetch('/api/ndia/generate-csv', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ startDate, endDate }),
      })

      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.error || error.validationErrors?.join(', ') || 'Export failed')
      }

      // Get filename from header or generate default
      const contentDisposition = response.headers.get('Content-Disposition')
      const filenameMatch = contentDisposition?.match(/filename="(.+)"/)
      const filename = filenameMatch?.[1] || `ndia-claims-${startDate}-${endDate}.csv`

      // Download file
      const blob = await response.blob()
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = filename
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      URL.revokeObjectURL(url)

      const totalClaims = response.headers.get('X-Total-Claims')
      const totalValue = response.headers.get('X-Total-Value')

      showToast.success(
        `Exported ${totalClaims} claims ($${totalValue ? parseFloat(totalValue).toLocaleString() : '0'})`
      )
    } catch (error) {
      showToast.error(error instanceof Error ? error.message : 'Export failed')
    }
    setIsExporting(false)
  }

  // Quick date presets
  const setLastMonth = () => {
    const lastMonth = subDays(startOfMonth(new Date()), 1)
    setStartDate(format(startOfMonth(lastMonth), 'yyyy-MM-dd'))
    setEndDate(format(endOfMonth(lastMonth), 'yyyy-MM-dd'))
  }

  const setThisMonth = () => {
    setStartDate(format(startOfMonth(new Date()), 'yyyy-MM-dd'))
    setEndDate(format(endOfMonth(new Date()), 'yyyy-MM-dd'))
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <FileText className="h-5 w-5" />
          NDIA Bulk Claim Export
        </CardTitle>
        <CardDescription>
          Generate PACE-compliant CSV for myplace portal upload
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Registration warning */}
        {!organizationHasRegistration && (
          <Alert variant="warning">
            <AlertTriangle className="h-4 w-4" />
            <AlertTitle>Registration Number Required</AlertTitle>
            <AlertDescription>
              Your organization's NDIS registration number is not set.
              Please update it in Settings before exporting.
            </AlertDescription>
          </Alert>
        )}

        {/* Date range selection */}
        <div className="space-y-4">
          <div className="flex gap-2">
            <Button variant="outline" size="sm" onClick={setThisMonth}>
              This Month
            </Button>
            <Button variant="outline" size="sm" onClick={setLastMonth}>
              Last Month
            </Button>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="startDate">Start Date</Label>
              <Input
                id="startDate"
                type="date"
                value={startDate}
                onChange={(e) => setStartDate(e.target.value)}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="endDate">End Date</Label>
              <Input
                id="endDate"
                type="date"
                value={endDate}
                onChange={(e) => setEndDate(e.target.value)}
              />
            </div>
          </div>
        </div>

        {/* Preview stats */}
        {isLoadingPreview ? (
          <div className="flex items-center justify-center py-4">
            <Loader2 className="h-6 w-6 animate-spin" />
          </div>
        ) : preview ? (
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div className="rounded-lg border p-3">
                <div className="text-2xl font-bold">{preview.invoiceCount}</div>
                <div className="text-muted-foreground">Finalized Invoices</div>
              </div>
              <div className="rounded-lg border p-3">
                <div className="text-2xl font-bold">{preview.claimableLineItems}</div>
                <div className="text-muted-foreground">Claimable Items</div>
              </div>
              <div className="rounded-lg border p-3">
                <div className="text-2xl font-bold">
                  ${preview.totalValue.toLocaleString(undefined, { minimumFractionDigits: 2 })}
                </div>
                <div className="text-muted-foreground">Total Value</div>
              </div>
              <div className="rounded-lg border p-3">
                <div className="text-2xl font-bold">{preview.participantsWithNdis}</div>
                <div className="text-muted-foreground">Participants</div>
              </div>
            </div>

            {/* Warnings */}
            {preview.warnings.length > 0 && (
              <Alert>
                <AlertTriangle className="h-4 w-4" />
                <AlertTitle>Warnings</AlertTitle>
                <AlertDescription>
                  <ul className="list-disc list-inside text-sm">
                    {preview.warnings.slice(0, 5).map((w, i) => (
                      <li key={i}>{w}</li>
                    ))}
                    {preview.warnings.length > 5 && (
                      <li>...and {preview.warnings.length - 5} more</li>
                    )}
                  </ul>
                </AlertDescription>
              </Alert>
            )}

            {/* Export button */}
            <Button
              className="w-full"
              onClick={handleExport}
              disabled={isExporting || !organizationHasRegistration || preview.claimableLineItems === 0}
            >
              {isExporting ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Generating CSV...
                </>
              ) : (
                <>
                  <Download className="mr-2 h-4 w-4" />
                  Download PACE CSV ({preview.claimableLineItems} claims)
                </>
              )}
            </Button>
          </div>
        ) : (
          <div className="text-center py-4 text-muted-foreground">
            No data available for selected date range
          </div>
        )}

        {/* Instructions */}
        <div className="text-sm text-muted-foreground space-y-1 pt-4 border-t">
          <p className="font-medium">How to submit:</p>
          <ol className="list-decimal list-inside space-y-1">
            <li>Download the CSV file using the button above</li>
            <li>Log in to the myplace provider portal</li>
            <li>Navigate to Payment Requests &gt; Bulk Upload</li>
            <li>Upload the downloaded CSV file</li>
            <li>Review and submit the claims</li>
          </ol>
        </div>
      </CardContent>
    </Card>
  )
}
```

Features:
- Date range selection with presets
- Preview stats before export
- Validation warnings display
- One-click download
- Submission instructions
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin.
  </verify>
  <done>
NDIA export UI provides intuitive one-click CSV download.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create NDIA export page</name>
  <files>apps/admin/app/(protected)/invoices/ndia-export/page.tsx</files>
  <action>
Create page for NDIA CSV export:

```typescript
'use client'

import { useOrganization } from '@/hooks/use-organization'
import { NdiaCsvExport } from '@/components/invoices/NdiaCsvExport'
import { Loader2 } from 'lucide-react'

export default function NdiaExportPage() {
  const { data: organization, isLoading } = useOrganization()

  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-8">
        <Loader2 className="h-6 w-6 animate-spin" />
      </div>
    )
  }

  const hasRegistration = !!(organization as any)?.ndis_registration_number

  return (
    <div className="container py-8 max-w-3xl">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">NDIA Claim Export</h1>
        <p className="text-muted-foreground">
          Export finalized invoices to PACE CSV format for myplace portal submission
        </p>
      </div>

      <NdiaCsvExport organizationHasRegistration={hasRegistration} />
    </div>
  )
}
```

Simple page wrapper providing organization context.
  </action>
  <verify>
Run `pnpm dev` and navigate to /invoices/ndia-export.
  </verify>
  <done>
NDIA export page provides entry point for claim CSV generation.
  </done>
</task>

<task type="auto">
  <name>Task 5: Add NDIS registration number to organization</name>
  <files>supabase/migrations/20260127000007_org_ndis_registration.sql</files>
  <action>
Create migration for NDIS registration number:

```sql
-- Add NDIS registration number to organizations

ALTER TABLE organizations
ADD COLUMN IF NOT EXISTS ndis_registration_number text;

-- Index for lookup
CREATE INDEX IF NOT EXISTS idx_org_ndis_reg ON organizations(ndis_registration_number)
WHERE ndis_registration_number IS NOT NULL;

COMMENT ON COLUMN organizations.ndis_registration_number IS 'NDIS provider registration number for PACE claims';
```

This enables the PACE CSV to include the provider registration number.
  </action>
  <verify>
Migration syntax is valid SQL.
  </verify>
  <done>
Organizations can store NDIS registration number for PACE claims.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /invoices/ndia-export - page displays
2. Select date range - preview shows invoice/claim counts
3. Missing NDIS numbers show as warnings
4. Click Download - CSV file downloads
5. CSV contains correct PACE format columns
6. Only finalized invoices with support item numbers included
</verification>

<success_criteria>
- Admin can select date range for export
- Preview shows claim counts and total value
- Validation errors prevent invalid exports
- CSV follows PACE bulk upload format exactly
- One-click download with proper filename
- Instructions for myplace portal submission
</success_criteria>

<output>
After completion, create `.planning/phases/13-scale-features/13-12-SUMMARY.md`
</output>
