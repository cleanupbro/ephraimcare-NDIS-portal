---
phase: 13-scale-features
plan: 05
type: execute
wave: 3
depends_on: ["13-04"]
files_modified:
  - apps/admin/app/api/cron/send-shift-reminders/route.ts
  - supabase/migrations/20260127000003_cron_shift_reminders.sql
  - apps/admin/lib/shifts/send-shift-notifications.ts
autonomous: true

must_haves:
  truths:
    - "Cron endpoint finds shifts needing 24h reminders and sends SMS"
    - "Cron endpoint finds shifts needing 2h reminders and sends SMS"
    - "Workers with sms_notifications_enabled=false do not receive SMS"
    - "Participants with sms_notifications_enabled=false do not receive SMS"
    - "Shifts are marked with reminder_24h_sent and reminder_2h_sent after sending"
  artifacts:
    - path: "apps/admin/app/api/cron/send-shift-reminders/route.ts"
      provides: "Cron job endpoint for shift reminders"
      exports: ["POST"]
    - path: "apps/admin/lib/shifts/send-shift-notifications.ts"
      provides: "Helper to send shift reminders"
      exports: ["sendShiftReminders"]
    - path: "supabase/migrations/20260127000003_cron_shift_reminders.sql"
      provides: "pg_cron schedule for hourly reminders"
      contains: "cron.schedule"
  key_links:
    - from: "apps/admin/app/api/cron/send-shift-reminders/route.ts"
      to: "sendSms"
      via: "function call"
      pattern: "sendSms"
---

<objective>
Create the cron job and logic for sending shift SMS reminders at 24h and 2h before shifts.

Purpose: Workers and participants receive timely SMS reminders about upcoming shifts, reducing no-shows and improving communication.

Output: Cron API endpoint, pg_cron schedule, reminder sending logic with opt-out checking.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-scale-features/13-RESEARCH.md
@.planning/phases/13-scale-features/13-04-PLAN.md

# Existing cron patterns
@supabase/migrations/20260124300001_add_shift_check_ins.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shift reminder helper function</name>
  <files>apps/admin/lib/shifts/send-shift-notifications.ts</files>
  <action>
Create helper for sending shift reminders:

```typescript
import { createClient } from '@supabase/supabase-js'
import { sendSms, formatToE164, isValidPhoneNumber } from '../sms/send-sms'
import {
  shiftReminder24h,
  shiftReminder2h,
  participantReminder24h,
} from '../sms/templates'
import { format } from 'date-fns'

interface ShiftWithDetails {
  id: string
  scheduled_start: string
  organization_id: string
  reminder_24h_sent: boolean
  reminder_2h_sent: boolean
  worker: {
    id: string
    profile: {
      first_name: string
      phone: string | null
      sms_notifications_enabled: boolean
    }
  }
  participant: {
    id: string
    first_name: string
    last_name: string
    phone: string | null
    sms_notifications_enabled: boolean
  }
  organization: {
    name: string
  }
}

interface ReminderResult {
  shiftsProcessed: number
  workerSmsSent: number
  participantSmsSent: number
  errors: string[]
}

/**
 * Send shift reminders for a specific time window
 * @param reminderType - '24h' or '2h'
 */
export async function sendShiftReminders(
  reminderType: '24h' | '2h'
): Promise<ReminderResult> {
  const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  )

  const now = new Date()
  let windowStart: Date
  let windowEnd: Date
  let sentColumn: 'reminder_24h_sent' | 'reminder_2h_sent'

  if (reminderType === '24h') {
    // 24h reminder: shifts starting 23-25 hours from now
    windowStart = new Date(now.getTime() + 23 * 60 * 60 * 1000)
    windowEnd = new Date(now.getTime() + 25 * 60 * 60 * 1000)
    sentColumn = 'reminder_24h_sent'
  } else {
    // 2h reminder: shifts starting 1.5-2.5 hours from now
    windowStart = new Date(now.getTime() + 1.5 * 60 * 60 * 1000)
    windowEnd = new Date(now.getTime() + 2.5 * 60 * 60 * 1000)
    sentColumn = 'reminder_2h_sent'
  }

  // Find shifts needing reminders
  const { data: shifts, error } = await supabase
    .from('shifts')
    .select(`
      id,
      scheduled_start,
      organization_id,
      reminder_24h_sent,
      reminder_2h_sent,
      worker:workers!inner(
        id,
        profile:profiles!inner(
          first_name,
          phone,
          sms_notifications_enabled
        )
      ),
      participant:participants!inner(
        id,
        first_name,
        last_name,
        phone,
        sms_notifications_enabled
      ),
      organization:organizations!inner(
        name
      )
    `)
    .gte('scheduled_start', windowStart.toISOString())
    .lte('scheduled_start', windowEnd.toISOString())
    .eq(sentColumn, false)
    .in('status', ['pending', 'confirmed'])

  if (error) {
    console.error('Error fetching shifts for reminders:', error)
    return {
      shiftsProcessed: 0,
      workerSmsSent: 0,
      participantSmsSent: 0,
      errors: [error.message],
    }
  }

  const result: ReminderResult = {
    shiftsProcessed: 0,
    workerSmsSent: 0,
    participantSmsSent: 0,
    errors: [],
  }

  for (const shift of (shifts as unknown as ShiftWithDetails[]) || []) {
    result.shiftsProcessed++

    const shiftDate = new Date(shift.scheduled_start)
    const startTime = format(shiftDate, 'h:mm a')

    // Send to worker if opted in and has phone
    const workerProfile = shift.worker?.profile
    if (workerProfile?.sms_notifications_enabled && workerProfile?.phone) {
      const formattedPhone = formatToE164(workerProfile.phone)

      if (isValidPhoneNumber(formattedPhone)) {
        const message = reminderType === '24h'
          ? shiftReminder24h({
              workerName: workerProfile.first_name,
              participantName: `${shift.participant.first_name} ${shift.participant.last_name}`,
              date: shiftDate,
              startTime,
              organizationName: shift.organization.name,
            })
          : shiftReminder2h({
              workerName: workerProfile.first_name,
              participantName: `${shift.participant.first_name} ${shift.participant.last_name}`,
              date: shiftDate,
              startTime,
              organizationName: shift.organization.name,
            })

        const smsResult = await sendSms({
          to: formattedPhone,
          body: message,
          organizationId: shift.organization_id,
          relatedShiftId: shift.id,
          relatedWorkerId: shift.worker.id,
        })

        if (smsResult.success) {
          result.workerSmsSent++
        } else {
          result.errors.push(`Worker SMS failed for shift ${shift.id}: ${smsResult.error}`)
        }
      }
    }

    // Send to participant if opted in, has phone, and is 24h reminder
    // (Participants only get 24h reminders per CONTEXT.md)
    if (reminderType === '24h') {
      const participant = shift.participant
      if (participant?.sms_notifications_enabled && participant?.phone) {
        const formattedPhone = formatToE164(participant.phone)

        if (isValidPhoneNumber(formattedPhone)) {
          const message = participantReminder24h({
            participantName: participant.first_name,
            workerName: workerProfile?.first_name || 'Your support worker',
            date: shiftDate,
            startTime,
            organizationName: shift.organization.name,
          })

          const smsResult = await sendSms({
            to: formattedPhone,
            body: message,
            organizationId: shift.organization_id,
            relatedShiftId: shift.id,
            relatedParticipantId: participant.id,
          })

          if (smsResult.success) {
            result.participantSmsSent++
          } else {
            result.errors.push(`Participant SMS failed for shift ${shift.id}: ${smsResult.error}`)
          }
        }
      }
    }

    // Mark reminder as sent
    await supabase
      .from('shifts')
      .update({ [sentColumn]: true } as any)
      .eq('id', shift.id)
  }

  return result
}
```

Key patterns:
- Time window approach (avoids sending duplicate reminders)
- Checks sms_notifications_enabled on both worker and participant
- Validates phone number format before sending
- Logs related entities for audit trail
- Marks shifts as reminded after processing
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin.
  </verify>
  <done>
Shift reminder helper processes upcoming shifts and sends SMS to opted-in recipients.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cron API endpoint</name>
  <files>apps/admin/app/api/cron/send-shift-reminders/route.ts</files>
  <action>
Create the cron endpoint:

```typescript
import { NextResponse } from 'next/server'
import { sendShiftReminders } from '@/lib/shifts/send-shift-notifications'

/**
 * Cron endpoint for sending shift SMS reminders
 * Called hourly by pg_cron or external scheduler
 *
 * POST /api/cron/send-shift-reminders
 * Authorization: Bearer {CRON_SECRET}
 */
export async function POST(request: Request) {
  // Verify cron secret
  const authHeader = request.headers.get('authorization')
  const expectedToken = `Bearer ${process.env.CRON_SECRET}`

  if (!authHeader || authHeader !== expectedToken) {
    console.error('Unauthorized cron request')
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  console.log('[CRON] Starting shift reminder job...')

  try {
    // Send 24h reminders
    const result24h = await sendShiftReminders('24h')
    console.log('[CRON] 24h reminders:', {
      shifts: result24h.shiftsProcessed,
      workerSms: result24h.workerSmsSent,
      participantSms: result24h.participantSmsSent,
      errors: result24h.errors.length,
    })

    // Send 2h reminders
    const result2h = await sendShiftReminders('2h')
    console.log('[CRON] 2h reminders:', {
      shifts: result2h.shiftsProcessed,
      workerSms: result2h.workerSmsSent,
      errors: result2h.errors.length,
    })

    return NextResponse.json({
      success: true,
      results: {
        '24h': {
          shiftsProcessed: result24h.shiftsProcessed,
          workerSmsSent: result24h.workerSmsSent,
          participantSmsSent: result24h.participantSmsSent,
          errors: result24h.errors,
        },
        '2h': {
          shiftsProcessed: result2h.shiftsProcessed,
          workerSmsSent: result2h.workerSmsSent,
          participantSmsSent: result2h.participantSmsSent,
          errors: result2h.errors,
        },
      },
    })
  } catch (error) {
    console.error('[CRON] Shift reminder job failed:', error)
    return NextResponse.json(
      { error: 'Cron job failed', details: error instanceof Error ? error.message : 'Unknown error' },
      { status: 500 }
    )
  }
}

// Allow GET for manual testing in development
export async function GET(request: Request) {
  if (process.env.NODE_ENV !== 'development') {
    return NextResponse.json({ error: 'Not allowed in production' }, { status: 403 })
  }

  // In dev, just run without auth check
  return POST(request)
}
```

Key features:
- Cron secret authentication
- Runs both 24h and 2h reminder jobs
- Returns detailed results for monitoring
- GET method for dev testing only
  </action>
  <verify>
Run `pnpm typecheck`. Endpoint compiles.
  </verify>
  <done>
Cron endpoint processes shift reminders when called hourly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create pg_cron schedule migration</name>
  <files>supabase/migrations/20260127000003_cron_shift_reminders.sql</files>
  <action>
Create migration to schedule the cron job:

```sql
-- SMS Shift Reminders Cron Job
-- Runs every hour to check for shifts needing reminders

-- Enable pg_cron extension if not already enabled
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- Schedule hourly reminder job
-- Uses Supabase's net extension for HTTP calls
SELECT cron.schedule(
  'shift-sms-reminders',
  '0 * * * *', -- Every hour on the hour
  $$
  SELECT net.http_post(
    url := current_setting('app.api_url') || '/api/cron/send-shift-reminders',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer ' || current_setting('app.cron_secret')
    ),
    body := '{}'::jsonb,
    timeout_milliseconds := 30000
  );
  $$
);

-- Grant execute permissions
GRANT USAGE ON SCHEMA cron TO postgres;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA cron TO postgres;

-- Add comment for documentation
COMMENT ON TABLE cron.job IS 'Scheduled cron jobs including shift SMS reminders';

-- Create app settings if not exists
-- These should be set in Supabase dashboard under Database > Extensions > Configuration
-- Or via ALTER SYSTEM SET / SET app.api_url = 'https://your-app.vercel.app'

-- Note: If pg_cron or net extensions are not available on your Supabase plan,
-- use an external scheduler like Vercel Cron or GitHub Actions to call the endpoint.

/*
Alternative: Vercel Cron (add to vercel.json)
{
  "crons": [{
    "path": "/api/cron/send-shift-reminders",
    "schedule": "0 * * * *"
  }]
}
*/
```

Note: pg_cron requires configuration in Supabase dashboard.
If not available, use Vercel Cron or external scheduler.
  </action>
  <verify>
Migration file is valid SQL syntax.
  </verify>
  <done>
pg_cron schedule created for hourly shift reminder processing.
  </done>
</task>

</tasks>

<verification>
1. Cron endpoint returns 401 without CRON_SECRET
2. With correct secret, endpoint processes shifts and returns results
3. Shifts in 24h window get reminder_24h_sent = true after processing
4. Workers with sms_notifications_enabled = false are skipped
5. sms_logs table has records for sent messages
</verification>

<success_criteria>
- Cron endpoint authenticates with CRON_SECRET
- 24h reminders sent to workers and participants
- 2h reminders sent to workers only (per CONTEXT.md)
- opt-out preference respected for both
- Shifts marked as reminded after processing
</success_criteria>

<output>
After completion, create `.planning/phases/13-scale-features/13-05-SUMMARY.md`
</output>
