---
phase: 13-scale-features
plan: 11
type: execute
wave: 3
depends_on: ["13-01"]
files_modified:
  - apps/admin/hooks/use-bulk-shifts.ts
  - apps/admin/components/shifts/BulkShiftWizard.tsx
  - apps/admin/components/shifts/BulkShiftPreview.tsx
  - apps/admin/app/(protected)/shifts/bulk/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can create recurring shifts (e.g., 3x per week for 4 weeks)"
    - "Preview shows all shifts to be created with dates and times"
    - "Conflicts with existing shifts are detected and highlighted"
    - "User can remove individual shifts from preview before creating"
    - "Single summary notification sent, not per-shift notifications"
  artifacts:
    - path: "apps/admin/hooks/use-bulk-shifts.ts"
      provides: "Bulk shift generation and creation logic"
      exports: ["generateBulkShiftPreview", "useBulkCreateShifts"]
    - path: "apps/admin/components/shifts/BulkShiftWizard.tsx"
      provides: "Multi-step bulk shift form"
      min_lines: 100
    - path: "apps/admin/app/(protected)/shifts/bulk/page.tsx"
      provides: "Bulk shift creation page"
      min_lines: 50
  key_links:
    - from: "apps/admin/components/shifts/BulkShiftPreview.tsx"
      to: "generateBulkShiftPreview"
      via: "function call"
      pattern: "generateBulkShiftPreview"
---

<objective>
Implement bulk shift creation with preview and conflict detection.

Purpose: Allow admins to quickly schedule recurring shifts (e.g., "3 times per week for a month") with a visual preview and the ability to edit before creating.

Output: Bulk shift wizard, preview with conflict detection, batch creation with summary notification.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-scale-features/13-RESEARCH.md

# Existing shift patterns
@apps/admin/hooks/use-shifts.ts
@apps/admin/components/shifts/ShiftForm.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bulk shift generation hook</name>
  <files>apps/admin/hooks/use-bulk-shifts.ts</files>
  <action>
Create the logic for generating and creating bulk shifts:

```typescript
import { useMutation, useQueryClient, useQuery } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'
import { addWeeks, addDays, setHours, setMinutes, isBefore, format } from 'date-fns'
import { v4 as uuid } from 'uuid'

export interface BulkShiftTemplate {
  participantId: string
  workerId: string
  supportType: string
  daysOfWeek: number[] // 0=Sunday, 1=Monday, etc.
  startHour: number
  startMinute: number
  durationMinutes: number
  notes: string | null
  weeksToGenerate: number
  startDate: Date
}

export interface PreviewShift {
  id: string // Temporary ID for preview
  scheduledStart: Date
  scheduledEnd: Date
  dayName: string
  participantId: string
  workerId: string
  supportType: string
  notes: string | null
  hasConflict: boolean
  conflictReason?: string
  selected: boolean // Can be deselected by user
}

const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']

/**
 * Fetch existing shifts for conflict detection
 */
export function useExistingShifts(
  workerId: string,
  startDate: Date,
  endDate: Date,
  enabled: boolean
) {
  const supabase = createClient()

  return useQuery({
    queryKey: ['existing-shifts', workerId, startDate.toISOString(), endDate.toISOString()],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('shifts')
        .select('id, worker_id, scheduled_start, scheduled_end')
        .eq('worker_id', workerId)
        .gte('scheduled_start', startDate.toISOString())
        .lte('scheduled_end', endDate.toISOString())
        .not('status', 'eq', 'cancelled')

      if (error) throw error
      return data || []
    },
    enabled,
  })
}

/**
 * Generate preview of shifts to be created
 */
export function generateBulkShiftPreview(
  template: BulkShiftTemplate,
  existingShifts: { worker_id: string; scheduled_start: string; scheduled_end: string }[]
): PreviewShift[] {
  const preview: PreviewShift[] = []

  let currentWeekStart = new Date(template.startDate)
  // Adjust to start of week (Sunday)
  const dayOffset = currentWeekStart.getDay()
  currentWeekStart = addDays(currentWeekStart, -dayOffset)

  for (let week = 0; week < template.weeksToGenerate; week++) {
    for (const dayOfWeek of template.daysOfWeek) {
      // Calculate date for this day
      const shiftDate = addDays(currentWeekStart, dayOfWeek)

      // Skip if before start date
      if (isBefore(shiftDate, template.startDate)) continue

      // Set time
      let scheduledStart = setHours(shiftDate, template.startHour)
      scheduledStart = setMinutes(scheduledStart, template.startMinute)
      const scheduledEnd = new Date(
        scheduledStart.getTime() + template.durationMinutes * 60 * 1000
      )

      // Check for conflicts with existing shifts
      const conflict = existingShifts.find((es) => {
        if (es.worker_id !== template.workerId) return false

        const existingStart = new Date(es.scheduled_start)
        const existingEnd = new Date(es.scheduled_end)

        // Check overlap
        return (
          (scheduledStart >= existingStart && scheduledStart < existingEnd) ||
          (scheduledEnd > existingStart && scheduledEnd <= existingEnd) ||
          (scheduledStart <= existingStart && scheduledEnd >= existingEnd)
        )
      })

      preview.push({
        id: uuid(),
        scheduledStart,
        scheduledEnd,
        dayName: DAY_NAMES[dayOfWeek],
        participantId: template.participantId,
        workerId: template.workerId,
        supportType: template.supportType,
        notes: template.notes,
        hasConflict: !!conflict,
        conflictReason: conflict ? 'Worker has overlapping shift' : undefined,
        selected: !conflict, // Auto-deselect conflicting shifts
      })
    }

    currentWeekStart = addWeeks(currentWeekStart, 1)
  }

  return preview.sort((a, b) => a.scheduledStart.getTime() - b.scheduledStart.getTime())
}

/**
 * Create multiple shifts from preview
 */
export function useBulkCreateShifts() {
  const supabase = createClient()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({
      shifts,
      organizationId,
      sendNotification = true,
    }: {
      shifts: PreviewShift[]
      organizationId: string
      sendNotification?: boolean
    }) => {
      // Only create selected, non-conflicting shifts
      const shiftsToCreate = shifts.filter((s) => s.selected && !s.hasConflict)

      if (shiftsToCreate.length === 0) {
        throw new Error('No shifts selected')
      }

      // Batch insert shifts
      const { data, error } = await supabase
        .from('shifts')
        .insert(
          shiftsToCreate.map((shift) => ({
            participant_id: shift.participantId,
            worker_id: shift.workerId,
            support_type: shift.supportType,
            scheduled_start: shift.scheduledStart.toISOString(),
            scheduled_end: shift.scheduledEnd.toISOString(),
            notes: shift.notes,
            organization_id: organizationId,
            status: 'pending',
            bulk_created: true, // Flag for audit
          })) as any
        )
        .select('id')

      if (error) throw error

      // Send single summary notification (not per-shift)
      if (sendNotification && data && data.length > 0) {
        const firstShift = shiftsToCreate[0]
        const lastShift = shiftsToCreate[shiftsToCreate.length - 1]

        // Get worker email
        const { data: worker } = await supabase
          .from('workers')
          .select('profile:profiles(email, first_name)')
          .eq('id', firstShift.workerId)
          .single()

        if (worker?.profile?.email) {
          // Send summary email via API
          await fetch('/api/notifications/bulk-shifts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              workerEmail: worker.profile.email,
              workerName: (worker.profile as any).first_name,
              shiftCount: data.length,
              startDate: format(firstShift.scheduledStart, 'MMM d, yyyy'),
              endDate: format(lastShift.scheduledStart, 'MMM d, yyyy'),
            }),
          })
        }
      }

      return {
        created: data?.length || 0,
        total: shiftsToCreate.length,
      }
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['shifts'] })
    },
  })
}

/**
 * Calculate summary statistics for preview
 */
export function calculatePreviewStats(preview: PreviewShift[]): {
  total: number
  selected: number
  conflicts: number
  totalHours: number
} {
  const selected = preview.filter((s) => s.selected)
  const conflicts = preview.filter((s) => s.hasConflict)

  const totalMinutes = selected.reduce((acc, shift) => {
    const duration = (shift.scheduledEnd.getTime() - shift.scheduledStart.getTime()) / 60000
    return acc + duration
  }, 0)

  return {
    total: preview.length,
    selected: selected.length,
    conflicts: conflicts.length,
    totalHours: Math.round(totalMinutes / 60 * 10) / 10,
  }
}
```

Features:
- Generates preview from template
- Detects conflicts with existing shifts
- Auto-deselects conflicting shifts
- Batch insert with bulk_created flag
- Single summary notification
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin.
  </verify>
  <done>
Bulk shift hook provides preview generation and batch creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bulk shift preview component</name>
  <files>apps/admin/components/shifts/BulkShiftPreview.tsx</files>
  <action>
Create preview table component:

```typescript
'use client'

import { format } from 'date-fns'

import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@ephraimcare/ui/components/table'
import { Checkbox } from '@ephraimcare/ui/components/checkbox'
import { Badge } from '@ephraimcare/ui/components/badge'
import { Alert, AlertDescription } from '@ephraimcare/ui/components/alert'
import { AlertTriangle, Clock, Calendar } from 'lucide-react'

import type { PreviewShift } from '@/hooks/use-bulk-shifts'
import { calculatePreviewStats } from '@/hooks/use-bulk-shifts'

interface BulkShiftPreviewProps {
  shifts: PreviewShift[]
  onToggleShift: (shiftId: string) => void
  onToggleAll: (selected: boolean) => void
}

export function BulkShiftPreview({
  shifts,
  onToggleShift,
  onToggleAll,
}: BulkShiftPreviewProps) {
  const stats = calculatePreviewStats(shifts)
  const allSelected = shifts.every((s) => s.selected || s.hasConflict)

  return (
    <div className="space-y-4">
      {/* Stats summary */}
      <div className="grid grid-cols-4 gap-4">
        <div className="rounded-lg border p-4">
          <div className="text-2xl font-bold">{stats.total}</div>
          <div className="text-sm text-muted-foreground">Total Shifts</div>
        </div>
        <div className="rounded-lg border p-4">
          <div className="text-2xl font-bold text-green-600">{stats.selected}</div>
          <div className="text-sm text-muted-foreground">Selected</div>
        </div>
        <div className="rounded-lg border p-4">
          <div className="text-2xl font-bold text-orange-600">{stats.conflicts}</div>
          <div className="text-sm text-muted-foreground">Conflicts</div>
        </div>
        <div className="rounded-lg border p-4">
          <div className="text-2xl font-bold">{stats.totalHours}h</div>
          <div className="text-sm text-muted-foreground">Total Hours</div>
        </div>
      </div>

      {/* Conflict warning */}
      {stats.conflicts > 0 && (
        <Alert variant="warning">
          <AlertTriangle className="h-4 w-4" />
          <AlertDescription>
            {stats.conflicts} shift{stats.conflicts > 1 ? 's' : ''} conflict with existing
            schedules and will be skipped. You can still select them if needed.
          </AlertDescription>
        </Alert>
      )}

      {/* Preview table */}
      <div className="rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-12">
                <Checkbox
                  checked={allSelected}
                  onCheckedChange={(checked) => onToggleAll(!!checked)}
                />
              </TableHead>
              <TableHead>Date</TableHead>
              <TableHead>Day</TableHead>
              <TableHead>Time</TableHead>
              <TableHead>Duration</TableHead>
              <TableHead>Status</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {shifts.map((shift) => {
              const duration = Math.round(
                (shift.scheduledEnd.getTime() - shift.scheduledStart.getTime()) / 60000
              )
              const hours = Math.floor(duration / 60)
              const minutes = duration % 60

              return (
                <TableRow
                  key={shift.id}
                  className={shift.hasConflict ? 'bg-orange-50' : ''}
                >
                  <TableCell>
                    <Checkbox
                      checked={shift.selected}
                      onCheckedChange={() => onToggleShift(shift.id)}
                    />
                  </TableCell>
                  <TableCell>
                    <div className="flex items-center gap-2">
                      <Calendar className="h-4 w-4 text-muted-foreground" />
                      {format(shift.scheduledStart, 'MMM d, yyyy')}
                    </div>
                  </TableCell>
                  <TableCell>{shift.dayName}</TableCell>
                  <TableCell>
                    <div className="flex items-center gap-2">
                      <Clock className="h-4 w-4 text-muted-foreground" />
                      {format(shift.scheduledStart, 'h:mm a')} -{' '}
                      {format(shift.scheduledEnd, 'h:mm a')}
                    </div>
                  </TableCell>
                  <TableCell>
                    {hours}h {minutes > 0 ? `${minutes}m` : ''}
                  </TableCell>
                  <TableCell>
                    {shift.hasConflict ? (
                      <Badge variant="warning">
                        <AlertTriangle className="mr-1 h-3 w-3" />
                        Conflict
                      </Badge>
                    ) : shift.selected ? (
                      <Badge variant="default">Ready</Badge>
                    ) : (
                      <Badge variant="secondary">Skipped</Badge>
                    )}
                  </TableCell>
                </TableRow>
              )
            })}
          </TableBody>
        </Table>
      </div>
    </div>
  )
}
```

Features:
- Summary statistics at top
- Conflict warning alert
- Table with checkbox selection
- Visual conflict highlighting
- Duration calculation
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin.
  </verify>
  <done>
Preview component displays shifts with selection and conflict indication.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create bulk shift wizard component</name>
  <files>apps/admin/components/shifts/BulkShiftWizard.tsx</files>
  <action>
Create multi-step wizard for bulk shift creation:

```typescript
'use client'

import { useState, useMemo } from 'react'
import { useForm } from 'react-hook-form'
import { addWeeks } from 'date-fns'

import { Card, CardContent, CardHeader, CardTitle, CardFooter } from '@ephraimcare/ui/components/card'
import { Button } from '@ephraimcare/ui/components/button'
import { Label } from '@ephraimcare/ui/components/label'
import { Input } from '@ephraimcare/ui/components/input'
import { Textarea } from '@ephraimcare/ui/components/textarea'
import { Checkbox } from '@ephraimcare/ui/components/checkbox'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@ephraimcare/ui/components/select'
import { Progress } from '@ephraimcare/ui/components/progress'
import { Loader2, ArrowLeft, ArrowRight, Check } from 'lucide-react'

import { useParticipants } from '@/hooks/use-participants'
import { useWorkers } from '@/hooks/use-workers'
import { useSupportTypes } from '@/hooks/use-support-types'
import {
  generateBulkShiftPreview,
  useExistingShifts,
  useBulkCreateShifts,
  type BulkShiftTemplate,
  type PreviewShift,
} from '@/hooks/use-bulk-shifts'
import { BulkShiftPreview } from './BulkShiftPreview'
import { showToast } from '@/lib/toast'

const DAYS_OF_WEEK = [
  { value: 0, label: 'Sunday' },
  { value: 1, label: 'Monday' },
  { value: 2, label: 'Tuesday' },
  { value: 3, label: 'Wednesday' },
  { value: 4, label: 'Thursday' },
  { value: 5, label: 'Friday' },
  { value: 6, label: 'Saturday' },
]

const WEEKS_OPTIONS = [1, 2, 3, 4, 6, 8, 12]

interface BulkShiftWizardProps {
  organizationId: string
  onComplete?: () => void
  onCancel?: () => void
}

export function BulkShiftWizard({ organizationId, onComplete, onCancel }: BulkShiftWizardProps) {
  const [step, setStep] = useState<'config' | 'preview' | 'complete'>('config')
  const [preview, setPreview] = useState<PreviewShift[]>([])

  const { data: participants } = useParticipants()
  const { data: workers } = useWorkers()
  const { data: supportTypes } = useSupportTypes()

  const createShifts = useBulkCreateShifts()

  const form = useForm<{
    participantId: string
    workerId: string
    supportType: string
    daysOfWeek: number[]
    startTime: string
    durationMinutes: number
    weeksToGenerate: number
    startDate: string
    notes: string
  }>({
    defaultValues: {
      participantId: '',
      workerId: '',
      supportType: '',
      daysOfWeek: [1, 3, 5], // Mon, Wed, Fri default
      startTime: '09:00',
      durationMinutes: 120,
      weeksToGenerate: 4,
      startDate: new Date().toISOString().split('T')[0],
      notes: '',
    },
  })

  const watchedValues = form.watch()
  const endDate = useMemo(() => {
    if (!watchedValues.startDate) return new Date()
    return addWeeks(new Date(watchedValues.startDate), watchedValues.weeksToGenerate)
  }, [watchedValues.startDate, watchedValues.weeksToGenerate])

  // Fetch existing shifts for conflict detection
  const { data: existingShifts } = useExistingShifts(
    watchedValues.workerId,
    new Date(watchedValues.startDate || new Date()),
    endDate,
    !!watchedValues.workerId && step === 'config'
  )

  const handleGeneratePreview = () => {
    const [hour, minute] = watchedValues.startTime.split(':').map(Number)

    const template: BulkShiftTemplate = {
      participantId: watchedValues.participantId,
      workerId: watchedValues.workerId,
      supportType: watchedValues.supportType,
      daysOfWeek: watchedValues.daysOfWeek,
      startHour: hour,
      startMinute: minute,
      durationMinutes: watchedValues.durationMinutes,
      weeksToGenerate: watchedValues.weeksToGenerate,
      startDate: new Date(watchedValues.startDate),
      notes: watchedValues.notes || null,
    }

    const generatedPreview = generateBulkShiftPreview(template, existingShifts || [])
    setPreview(generatedPreview)
    setStep('preview')
  }

  const handleToggleShift = (shiftId: string) => {
    setPreview((prev) =>
      prev.map((s) => (s.id === shiftId ? { ...s, selected: !s.selected } : s))
    )
  }

  const handleToggleAll = (selected: boolean) => {
    setPreview((prev) =>
      prev.map((s) => (s.hasConflict ? s : { ...s, selected }))
    )
  }

  const handleCreate = async () => {
    try {
      const result = await createShifts.mutateAsync({
        shifts: preview,
        organizationId,
        sendNotification: true,
      })

      showToast.success(`Created ${result.created} shifts`)
      setStep('complete')
    } catch (error) {
      showToast.error(error instanceof Error ? error.message : 'Failed to create shifts')
    }
  }

  const isConfigValid =
    watchedValues.participantId &&
    watchedValues.workerId &&
    watchedValues.supportType &&
    watchedValues.daysOfWeek.length > 0 &&
    watchedValues.startDate

  return (
    <Card className="max-w-4xl mx-auto">
      <CardHeader>
        <CardTitle>Create Recurring Shifts</CardTitle>
        <Progress
          value={step === 'config' ? 33 : step === 'preview' ? 66 : 100}
          className="h-2"
        />
      </CardHeader>

      <CardContent>
        {step === 'config' && (
          <div className="space-y-6">
            {/* Participant & Worker */}
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Participant</Label>
                <Select
                  value={watchedValues.participantId}
                  onValueChange={(v) => form.setValue('participantId', v)}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select participant" />
                  </SelectTrigger>
                  <SelectContent>
                    {participants?.map((p) => (
                      <SelectItem key={p.id} value={p.id}>
                        {p.first_name} {p.last_name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label>Worker</Label>
                <Select
                  value={watchedValues.workerId}
                  onValueChange={(v) => form.setValue('workerId', v)}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select worker" />
                  </SelectTrigger>
                  <SelectContent>
                    {workers?.map((w) => (
                      <SelectItem key={w.id} value={w.id}>
                        {w.profile?.first_name} {w.profile?.last_name}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Support Type */}
            <div className="space-y-2">
              <Label>Support Type</Label>
              <Select
                value={watchedValues.supportType}
                onValueChange={(v) => form.setValue('supportType', v)}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Select support type" />
                </SelectTrigger>
                <SelectContent>
                  {supportTypes?.map((st) => (
                    <SelectItem key={st.id} value={st.id}>
                      {st.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Days of Week */}
            <div className="space-y-2">
              <Label>Days of Week</Label>
              <div className="flex flex-wrap gap-2">
                {DAYS_OF_WEEK.map((day) => (
                  <label
                    key={day.value}
                    className="flex items-center gap-2 cursor-pointer"
                  >
                    <Checkbox
                      checked={watchedValues.daysOfWeek.includes(day.value)}
                      onCheckedChange={(checked) => {
                        const current = watchedValues.daysOfWeek
                        const updated = checked
                          ? [...current, day.value]
                          : current.filter((d) => d !== day.value)
                        form.setValue('daysOfWeek', updated.sort())
                      }}
                    />
                    <span className="text-sm">{day.label}</span>
                  </label>
                ))}
              </div>
            </div>

            {/* Time & Duration */}
            <div className="grid grid-cols-3 gap-4">
              <div className="space-y-2">
                <Label>Start Time</Label>
                <Input type="time" {...form.register('startTime')} />
              </div>

              <div className="space-y-2">
                <Label>Duration (minutes)</Label>
                <Input
                  type="number"
                  min={30}
                  max={480}
                  step={30}
                  {...form.register('durationMinutes', { valueAsNumber: true })}
                />
              </div>

              <div className="space-y-2">
                <Label>Weeks to Generate</Label>
                <Select
                  value={String(watchedValues.weeksToGenerate)}
                  onValueChange={(v) => form.setValue('weeksToGenerate', Number(v))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {WEEKS_OPTIONS.map((w) => (
                      <SelectItem key={w} value={String(w)}>
                        {w} week{w > 1 ? 's' : ''}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* Start Date */}
            <div className="space-y-2">
              <Label>Start Date</Label>
              <Input type="date" {...form.register('startDate')} />
            </div>

            {/* Notes */}
            <div className="space-y-2">
              <Label>Notes (optional)</Label>
              <Textarea
                placeholder="Notes for all shifts..."
                {...form.register('notes')}
              />
            </div>
          </div>
        )}

        {step === 'preview' && (
          <BulkShiftPreview
            shifts={preview}
            onToggleShift={handleToggleShift}
            onToggleAll={handleToggleAll}
          />
        )}

        {step === 'complete' && (
          <div className="text-center py-8">
            <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 mb-4">
              <Check className="h-8 w-8 text-green-600" />
            </div>
            <h3 className="text-xl font-semibold mb-2">Shifts Created!</h3>
            <p className="text-muted-foreground">
              The worker will receive a summary notification.
            </p>
          </div>
        )}
      </CardContent>

      <CardFooter className="justify-between">
        {step === 'config' && (
          <>
            <Button variant="outline" onClick={onCancel}>
              Cancel
            </Button>
            <Button onClick={handleGeneratePreview} disabled={!isConfigValid}>
              Generate Preview
              <ArrowRight className="ml-2 h-4 w-4" />
            </Button>
          </>
        )}

        {step === 'preview' && (
          <>
            <Button variant="outline" onClick={() => setStep('config')}>
              <ArrowLeft className="mr-2 h-4 w-4" />
              Back
            </Button>
            <Button
              onClick={handleCreate}
              disabled={createShifts.isPending || preview.filter((s) => s.selected).length === 0}
            >
              {createShifts.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
              Create {preview.filter((s) => s.selected && !s.hasConflict).length} Shifts
            </Button>
          </>
        )}

        {step === 'complete' && (
          <Button className="ml-auto" onClick={onComplete}>
            Done
          </Button>
        )}
      </CardFooter>
    </Card>
  )
}
```

Features:
- Multi-step wizard (config -> preview -> complete)
- Day of week selection
- Time and duration inputs
- Weeks to generate selector
- Progress indicator
  </action>
  <verify>
Run `pnpm typecheck` from apps/admin.
  </verify>
  <done>
Bulk shift wizard guides user through recurring shift setup.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create bulk shifts page</name>
  <files>apps/admin/app/(protected)/shifts/bulk/page.tsx</files>
  <action>
Create the bulk shift creation page:

```typescript
'use client'

import { useRouter } from 'next/navigation'
import { BulkShiftWizard } from '@/components/shifts/BulkShiftWizard'
import { useAuth } from '@/hooks/use-auth'

export default function BulkShiftsPage() {
  const router = useRouter()
  const { profile } = useAuth()

  if (!profile?.organization_id) {
    return null
  }

  return (
    <div className="container py-8">
      <div className="mb-6">
        <h1 className="text-2xl font-bold">Create Recurring Shifts</h1>
        <p className="text-muted-foreground">
          Schedule multiple shifts at once with pattern-based creation
        </p>
      </div>

      <BulkShiftWizard
        organizationId={profile.organization_id}
        onComplete={() => router.push('/shifts')}
        onCancel={() => router.back()}
      />
    </div>
  )
}
```

Simple page wrapper that provides organization context to the wizard.
  </action>
  <verify>
Run `pnpm dev` and navigate to /shifts/bulk.
  </verify>
  <done>
Bulk shifts page provides entry point for recurring shift creation.
  </done>
</task>

<task type="auto">
  <name>Task 5: Create bulk shift notification API</name>
  <files>apps/admin/app/api/notifications/bulk-shifts/route.ts</files>
  <action>
Create endpoint for sending bulk shift summary notification:

```typescript
import { NextResponse } from 'next/server'

/**
 * Send summary notification for bulk shift creation
 * POST /api/notifications/bulk-shifts
 */
export async function POST(request: Request) {
  try {
    const { workerEmail, workerName, shiftCount, startDate, endDate } = await request.json()

    if (!workerEmail || !shiftCount) {
      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 })
    }

    // Send email using existing email infrastructure
    // This would use Resend or similar
    // For now, just log and return success
    console.log('Bulk shift notification:', {
      to: workerEmail,
      subject: `${shiftCount} new shifts scheduled`,
      message: `Hi ${workerName}, you have ${shiftCount} new shifts scheduled from ${startDate} to ${endDate}.`,
    })

    // TODO: Implement actual email sending
    // await sendEmail({
    //   to: workerEmail,
    //   subject: `${shiftCount} new shifts scheduled - Ephraim Care`,
    //   template: 'bulk-shifts-assigned',
    //   data: { workerName, shiftCount, startDate, endDate },
    // })

    return NextResponse.json({ success: true })
  } catch (error) {
    console.error('Bulk notification error:', error)
    return NextResponse.json({ error: 'Failed to send notification' }, { status: 500 })
  }
}
```

Key: Sends single summary notification, not per-shift (per CONTEXT.md and RESEARCH.md pitfalls).
  </action>
  <verify>
Run `pnpm typecheck`.
  </verify>
  <done>
Summary notification API prevents notification storm.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /shifts/bulk - wizard displays
2. Select participant, worker, days, time - form validates
3. Click Generate Preview - shifts displayed in table
4. Conflicts highlighted with warning badge
5. Toggle individual shifts - selection updates
6. Click Create - shifts created in database
7. Single notification sent to worker (not per-shift)
</verification>

<success_criteria>
- Wizard allows configuring recurring schedule pattern
- Preview shows all shifts with dates and conflict status
- Conflicts auto-deselected but can be manually selected
- Batch creation with bulk_created flag
- Single summary notification sent to worker
</success_criteria>

<output>
After completion, create `.planning/phases/13-scale-features/13-11-SUMMARY.md`
</output>
