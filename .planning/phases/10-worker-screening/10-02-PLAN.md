---
phase: 10-worker-screening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/components/dashboard/compliance-widget.tsx
  - apps/admin/app/(protected)/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin dashboard displays a widget showing workers with expired or expiring checks"
    - "Widget shows worker name, expiry date, and status (expired/expiring)"
    - "Clicking a worker in the widget navigates to their detail page"
    - "Widget shows positive message when all workers are compliant"
  artifacts:
    - path: "apps/admin/components/dashboard/compliance-widget.tsx"
      provides: "Compliance widget component"
      exports: ["ComplianceWidget"]
    - path: "apps/admin/app/(protected)/page.tsx"
      provides: "Dashboard with compliance widget integration"
      contains: "ComplianceWidget"
  key_links:
    - from: "apps/admin/app/(protected)/page.tsx"
      to: "apps/admin/components/dashboard/compliance-widget.tsx"
      via: "import and render"
      pattern: "ComplianceWidget"
    - from: "apps/admin/components/dashboard/compliance-widget.tsx"
      to: "apps/admin/lib/workers/constants.ts"
      via: "getComplianceStatus import"
      pattern: "getComplianceStatus"
---

<objective>
Add a compliance widget to the admin dashboard showing workers with expired or expiring NDIS checks.

Purpose: Give administrators visibility into compliance issues at a glance, enabling proactive management of worker screening renewals before they expire.

Output: ComplianceWidget component displayed on the dashboard, listing workers with compliance issues and linking to their detail pages.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-worker-screening/10-RESEARCH.md

Key files:
@apps/admin/app/(protected)/page.tsx
@apps/admin/lib/workers/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ComplianceWidget component</name>
  <files>apps/admin/components/dashboard/compliance-widget.tsx</files>
  <action>
Create new file at apps/admin/components/dashboard/compliance-widget.tsx:

```typescript
import Link from 'next/link'
import { Shield, AlertTriangle } from 'lucide-react'
import { format, parseISO } from 'date-fns'
import { Badge } from '@ephraimcare/ui'
import { getComplianceStatus } from '@/lib/workers/constants'

interface ComplianceWorker {
  id: string
  ndis_check_expiry: string | null
  wwcc_expiry: string | null
  profiles: {
    first_name: string
    last_name: string
  }
}

interface ComplianceWidgetProps {
  workers: ComplianceWorker[]
}

export function ComplianceWidget({ workers }: ComplianceWidgetProps) {
  if (workers.length === 0) {
    return (
      <div className="rounded-lg border border-border p-6">
        <h2 className="font-heading text-lg font-semibold mb-3 flex items-center gap-2">
          <Shield className="h-5 w-5 text-green-600" />
          Compliance Status
        </h2>
        <p className="text-sm text-muted-foreground">
          All workers have valid screening checks.
        </p>
      </div>
    )
  }

  return (
    <div className="rounded-lg border border-border p-6">
      <h2 className="font-heading text-lg font-semibold mb-3 flex items-center gap-2">
        <AlertTriangle className="h-5 w-5 text-amber-500" />
        Compliance Alerts
      </h2>
      <p className="text-sm text-muted-foreground mb-4">
        {workers.length} worker{workers.length !== 1 ? 's' : ''} with screening checks requiring attention
      </p>
      <div className="space-y-2">
        {workers.map((worker) => {
          const ndisStatus = getComplianceStatus(worker.ndis_check_expiry)
          const isExpired = ndisStatus === 'expired'
          return (
            <Link
              key={worker.id}
              href={`/workers/${worker.id}`}
              className="flex items-center justify-between rounded-md border border-border px-4 py-3 hover:bg-muted/50 transition-colors"
            >
              <div>
                <p className="text-sm font-medium">
                  {worker.profiles.first_name} {worker.profiles.last_name}
                </p>
                <p className="text-xs text-muted-foreground">
                  NDIS check {isExpired ? 'expired' : 'expires'}:{' '}
                  {worker.ndis_check_expiry
                    ? format(parseISO(worker.ndis_check_expiry), 'd MMM yyyy')
                    : 'Not set'}
                </p>
              </div>
              <Badge variant={isExpired ? 'destructive' : 'secondary'}>
                {isExpired ? 'Expired' : 'Expiring'}
              </Badge>
            </Link>
          )
        })}
      </div>
    </div>
  )
}
```

The component:
- Shows positive message when no compliance issues
- Lists workers with expired (red badge) or expiring (secondary badge) NDIS checks
- Links each worker to their detail page for action
- Matches existing dashboard card styling (rounded-lg border)
  </action>
  <verify>TypeScript compilation: `cd apps/admin && pnpm tsc --noEmit`</verify>
  <done>ComplianceWidget component created with proper typing and styling</done>
</task>

<task type="auto">
  <name>Task 2: Add compliance query and widget to dashboard</name>
  <files>apps/admin/app/(protected)/page.tsx</files>
  <action>
Update apps/admin/app/(protected)/page.tsx to fetch compliance workers and render the widget.

Add import at top:

```typescript
import { addDays } from 'date-fns'
import { ComplianceWidget } from '@/components/dashboard/compliance-widget'
```

After the todayShifts query (before the return statement), add the compliance workers query:

```typescript
// Compliance check - workers with expired or expiring NDIS checks
const today = new Date().toISOString().split('T')[0]
const ninetyDaysFromNow = addDays(new Date(), 90).toISOString().split('T')[0]

const { data: complianceWorkers } = await supabase
  .from('workers')
  .select('id, ndis_check_expiry, wwcc_expiry, profiles!inner(first_name, last_name)')
  .eq('is_active', true)
  .or(`ndis_check_expiry.lt.${today},ndis_check_expiry.lte.${ninetyDaysFromNow}`)
  .order('ndis_check_expiry', { ascending: true, nullsFirst: false })
  .limit(10)
```

Note: The query uses .or() to get workers where:
- ndis_check_expiry is in the past (expired), OR
- ndis_check_expiry is within the next 90 days (expiring)

Update the grid layout in JSX to add the compliance widget. Replace the existing second grid section:

```tsx
<div className="grid gap-4 md:grid-cols-2">
  <div className="rounded-lg border border-border p-6">
    <h2 className="font-heading text-lg font-semibold mb-3">Quick Actions</h2>
    <div className="space-y-2">
      <a href="/shifts" className="block rounded-md border border-border px-4 py-3 text-sm hover:bg-muted">
        Schedule a new shift
      </a>
      <a href="/participants" className="block rounded-md border border-border px-4 py-3 text-sm hover:bg-muted">
        Add a participant
      </a>
      <a href="/invoices" className="block rounded-md border border-border px-4 py-3 text-sm hover:bg-muted">
        Create an invoice
      </a>
    </div>
  </div>

  <ComplianceWidget workers={(complianceWorkers ?? []) as any} />
</div>

<div className="grid gap-4 md:grid-cols-2">
  <div className="rounded-lg border border-border p-6">
    <h2 className="font-heading text-lg font-semibold mb-3">Upcoming Shifts</h2>
    <p className="text-sm text-muted-foreground">
      {(shifts.count ?? 0)} scheduled shifts remaining
    </p>
  </div>
</div>
```

This places the compliance widget in the first row next to Quick Actions, and Upcoming Shifts in a second row.
  </action>
  <verify>Start dev server: `cd apps/admin && pnpm dev`, visit http://localhost:3000 and verify widget appears</verify>
  <done>Dashboard shows ComplianceWidget with worker compliance alerts</done>
</task>

</tasks>

<verification>
1. Start admin app: `cd apps/admin && pnpm dev`
2. Navigate to dashboard (/)
3. If all workers have valid NDIS checks (> 90 days out), widget should show "All workers have valid screening checks"
4. Create/update a worker with NDIS check expiring in 60 days
5. Dashboard should show that worker with yellow "Expiring" badge
6. Create/update a worker with NDIS check in the past
7. Dashboard should show that worker with red "Expired" badge
8. Click a worker in the widget - should navigate to /workers/{id}
</verification>

<success_criteria>
- ComplianceWidget component created at apps/admin/components/dashboard/compliance-widget.tsx
- Dashboard page imports and renders ComplianceWidget
- Widget shows workers with expired (red badge) or expiring (secondary badge) NDIS checks
- Clicking a worker navigates to their detail page
- When no compliance issues exist, widget shows positive message with green shield icon
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-worker-screening/10-02-SUMMARY.md`
</output>
