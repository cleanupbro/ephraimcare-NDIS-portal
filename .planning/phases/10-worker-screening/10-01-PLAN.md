---
phase: 10-worker-screening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/components/shifts/shift-form.tsx
  - apps/admin/components/shifts/shift-conflict-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Assigning a worker with expired NDIS check fails with clear error message"
    - "Assigning a worker whose NDIS check expires within 90 days shows yellow warning"
    - "User can override the 90-day warning and create the shift anyway"
  artifacts:
    - path: "apps/admin/components/shifts/shift-form.tsx"
      provides: "NDIS expiry validation in onSubmit"
      contains: "getComplianceStatus"
    - path: "apps/admin/components/shifts/shift-conflict-dialog.tsx"
      provides: "screening_expiring conflict type"
      contains: "screening_expiring"
  key_links:
    - from: "apps/admin/components/shifts/shift-form.tsx"
      to: "apps/admin/lib/workers/constants.ts"
      via: "import getComplianceStatus"
      pattern: "getComplianceStatus"
---

<objective>
Enforce NDIS compliance in shift assignment by blocking expired checks and warning on expiring checks.

Purpose: Prevent regulatory violations by ensuring workers with expired NDIS screening cannot be assigned to new shifts, while alerting admins about upcoming expirations.

Output: Updated shift form with hard blocking for expired NDIS checks and overridable warning dialog for checks expiring within 90 days.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-worker-screening/10-RESEARCH.md

Key files:
@apps/admin/components/shifts/shift-form.tsx
@apps/admin/components/shifts/shift-conflict-dialog.tsx
@apps/admin/lib/workers/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Worker interface and query in shift-form.tsx</name>
  <files>apps/admin/components/shifts/shift-form.tsx</files>
  <action>
Update the Worker interface in shift-form.tsx to include ndis_check_expiry:

```typescript
interface Worker {
  id: string
  services_provided: string[] | null
  ndis_check_expiry: string | null  // ADD THIS
  profiles: { first_name: string; last_name: string } | null
}
```

Update the workers query in fetchData() to include ndis_check_expiry:

```typescript
supabase
  .from('workers')
  .select('id, services_provided, ndis_check_expiry, profiles(first_name, last_name)')  // ADD ndis_check_expiry
  .eq('is_active', true)
  .order('created_at'),
```

Add import for getComplianceStatus and format from date-fns:

```typescript
import { getComplianceStatus } from '@/lib/workers/constants'
import { format, parseISO } from 'date-fns'
```

Add helper function for formatting expiry dates:

```typescript
function formatExpiryDate(dateStr: string | null | undefined): string {
  if (!dateStr) return 'Not set'
  try {
    return format(parseISO(dateStr), 'd MMM yyyy')
  } catch {
    return 'Invalid date'
  }
}
```
  </action>
  <verify>TypeScript compilation passes: `cd apps/admin && pnpm tsc --noEmit`</verify>
  <done>Worker interface includes ndis_check_expiry and query fetches the field</done>
</task>

<task type="auto">
  <name>Task 2: Add NDIS expiry validation to onSubmit</name>
  <files>apps/admin/components/shifts/shift-form.tsx</files>
  <action>
In the onSubmit function, after the existing support type validation and before setIsChecking(true), add NDIS expiry check:

```typescript
async function onSubmit(data: ShiftCreateFormData) {
  // EXISTING: Hard validation for support type mismatch
  const selectedWorker = workers.find((w) => w.id === data.worker_id)
  if (selectedWorker && !selectedWorker.services_provided?.includes(data.support_type)) {
    setError('worker_id', {
      message: `Worker does not provide "${data.support_type}" support. Select a qualified worker.`,
    })
    return
  }

  // NEW: Hard validation for expired NDIS check (SCRN-01)
  const ndisStatus = getComplianceStatus(selectedWorker?.ndis_check_expiry ?? null)
  if (ndisStatus === 'expired') {
    setError('worker_id', {
      message: `Worker's NDIS check has expired (${formatExpiryDate(selectedWorker?.ndis_check_expiry)}). Cannot assign to new shifts until renewed.`,
    })
    return
  }

  setIsChecking(true)
  try {
    const detected = await checkConflicts(data)

    // NEW: Add expiring NDIS check warning (SCRN-02)
    if (ndisStatus === 'expiring') {
      detected.push({
        type: 'screening_expiring',
        message: `Worker's NDIS check expires soon`,
        details: `Expiry date: ${formatExpiryDate(selectedWorker?.ndis_check_expiry)}. Consider scheduling check renewal.`,
      })
    }

    if (detected.length > 0) {
      setConflicts(detected)
      setShowConflictDialog(true)
      return
    }

    await createShiftFromData(data)
  } finally {
    setIsChecking(false)
  }
}
```

Note: The 'screening_expiring' type will be defined in Task 3.
  </action>
  <verify>Run development server and attempt to create a shift (visual verification)</verify>
  <done>Expired NDIS check shows inline error, expiring NDIS check triggers conflict dialog</done>
</task>

<task type="auto">
  <name>Task 3: Extend ShiftConflictDialog with screening_expiring type</name>
  <files>apps/admin/components/shifts/shift-conflict-dialog.tsx</files>
  <action>
Update the ConflictWarning type to include the new screening type:

```typescript
export type ConflictWarning = {
  type: 'overlap' | 'plan_dates' | 'support_type' | 'screening_expiring'  // ADD screening_expiring
  message: string
  details?: string
}
```

Add the label and color for the new type:

```typescript
const CONFLICT_LABELS: Record<ConflictWarning['type'], string> = {
  overlap: 'Schedule Overlap',
  plan_dates: 'Plan Period',
  support_type: 'Service Mismatch',
  screening_expiring: 'Compliance Warning',  // ADD
}

const CONFLICT_COLORS: Record<ConflictWarning['type'], string> = {
  overlap: 'text-red-600',
  plan_dates: 'text-amber-600',
  support_type: 'text-orange-600',
  screening_expiring: 'text-amber-500',  // ADD - amber for warning
}
```
  </action>
  <verify>TypeScript compilation passes: `cd apps/admin && pnpm tsc --noEmit`</verify>
  <done>ConflictWarning type includes screening_expiring with amber warning color</done>
</task>

</tasks>

<verification>
1. Start admin app: `cd apps/admin && pnpm dev`
2. Navigate to /shifts and click "New Shift"
3. Create a test worker with an expired NDIS check date (past date)
4. Try to create a shift with that worker - should see inline error on worker field
5. Create a test worker with NDIS check expiring in 60 days
6. Try to create a shift with that worker - should see warning dialog with "Create Anyway" option
7. Click "Create Anyway" - shift should be created successfully
</verification>

<success_criteria>
- Selecting a worker with expired NDIS check shows: "Worker's NDIS check has expired (DATE). Cannot assign to new shifts until renewed."
- Selecting a worker with NDIS check expiring within 90 days shows yellow warning dialog with override option
- The warning dialog allows creating the shift via "Create Anyway" button
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-worker-screening/10-01-SUMMARY.md`
</output>
