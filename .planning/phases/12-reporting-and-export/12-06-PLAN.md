---
phase: 12-reporting-and-export
plan: 06
type: execute
wave: 4
depends_on: [12-01]
files_modified:
  - apps/admin/lib/reports/accounting-formats.ts
  - apps/admin/app/(protected)/reports/accounting-exports/page.tsx
  - apps/admin/app/api/reports/export/invoices/route.ts
  - apps/admin/app/api/reports/export/participants/route.ts
  - apps/admin/app/api/reports/export/worker-hours/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can export invoices to Xero-compatible CSV format"
    - "Admin can export invoices to MYOB-compatible CSV format"
    - "Admin can export participant list to CSV"
    - "Admin can export worker hours to CSV for payroll"
    - "All exports follow proper date format (DD/MM/YYYY for Australia)"
  artifacts:
    - path: "apps/admin/lib/reports/accounting-formats.ts"
      provides: "Xero and MYOB CSV formatters"
      exports: ["generateXeroInvoiceCsv", "generateMyobInvoiceCsv"]
    - path: "apps/admin/app/(protected)/reports/accounting-exports/page.tsx"
      provides: "Accounting exports dashboard"
      min_lines: 100
    - path: "apps/admin/app/api/reports/export/invoices/route.ts"
      provides: "Invoice export API with Xero/MYOB formats"
      min_lines: 60
  key_links:
    - from: "apps/admin/app/(protected)/reports/accounting-exports/page.tsx"
      to: "apps/admin/app/api/reports/export/invoices/route.ts"
      via: "fetch POST request"
      pattern: "fetch.*api/reports/export"
---

<objective>
Build accounting export page with Xero/MYOB invoice formats, participant list export, and worker hours export for payroll integration.

Purpose: Enable seamless data transfer from Ephraim Care platform to external accounting and payroll systems. Supports accounting workflows and reduces manual data entry (EXPRT-01, EXPRT-02, EXPRT-03).

Output: Accounting exports page, Xero/MYOB formatters, API routes for entity exports, CSV downloads with proper formatting.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-reporting-and-export/12-RESEARCH.md
@.planning/phases/12-reporting-and-export/12-01-SUMMARY.md
@apps/admin/lib/invoices/csv-export.ts
@apps/admin/lib/reports/csv-export.ts
@apps/admin/hooks/use-invoices.ts
@apps/admin/hooks/use-participants.ts
</context>

<tasks>

<task type="auto">
  <name>Create Xero and MYOB CSV formatters</name>
  <files>apps/admin/lib/reports/accounting-formats.ts</files>
  <action>
Create accounting-specific CSV formatters following research examples:

```typescript
import { format } from 'date-fns'

// ─── Xero Invoice CSV ─────────────────────────────────────────────────────

export const XERO_INVOICE_COLUMNS = [
  'ContactName',
  'InvoiceNumber',
  'InvoiceDate',
  'DueDate',
  'Description',
  'Quantity',
  'UnitAmount',
  'AccountCode',
  'TaxType',
] as const

interface XeroInvoiceLineItem {
  contactName: string
  invoiceNumber: string
  invoiceDate: string
  dueDate: string
  description: string
  quantity: number
  unitAmount: number
}

export function generateXeroInvoiceCsv(items: XeroInvoiceLineItem[]): string {
  const headers = XERO_INVOICE_COLUMNS.join(',')
  const rows: string[] = []

  for (const item of items) {
    const row = [
      item.contactName,
      item.invoiceNumber,
      formatDateForXero(item.invoiceDate),
      formatDateForXero(item.dueDate),
      item.description,
      item.quantity.toFixed(2),
      item.unitAmount.toFixed(2),
      '200', // Sales account code (configurable in settings)
      'GST on Income', // Must match Xero tax type exactly
    ]

    rows.push(row.map(escapeXeroCsv).join(','))
  }

  return [headers, ...rows].join('\n')
}

function formatDateForXero(dateStr: string): string {
  if (!dateStr) return ''
  const date = new Date(dateStr + 'T00:00:00')
  return format(date, 'dd/MM/yyyy') // Xero requires DD/MM/YYYY for Australia
}

function escapeXeroCsv(value: string): string {
  if (value.includes(',') || value.includes('"') || value.includes('\n')) {
    return `"${value.replace(/"/g, '""')}"`
  }
  return value
}

// ─── MYOB Invoice CSV ─────────────────────────────────────────────────────

export const MYOB_INVOICE_COLUMNS = [
  'Co./Last Name',
  'First Name',
  'Inv#',
  'Date',
  'Terms',
  'Due Date',
  'Item Number',
  'Description',
  'Quantity',
  'Unit Price',
  'Tax Code',
] as const

interface MyobInvoiceLineItem {
  lastName: string
  firstName: string
  invoiceNumber: string
  invoiceDate: string
  dueDate: string
  itemNumber: string
  description: string
  quantity: number
  unitPrice: number
}

export function generateMyobInvoiceCsv(items: MyobInvoiceLineItem[]): string {
  const headers = MYOB_INVOICE_COLUMNS.join(',')
  const rows: string[] = []

  for (const item of items) {
    const row = [
      item.lastName,
      item.firstName,
      item.invoiceNumber,
      formatDateForMyob(item.invoiceDate),
      'Net 30',
      formatDateForMyob(item.dueDate),
      item.itemNumber || '',
      item.description,
      item.quantity.toFixed(2),
      item.unitPrice.toFixed(2),
      'GST', // MYOB tax code
    ]

    rows.push(row.map(escapeXeroCsv).join(','))
  }

  return [headers, ...rows].join('\n')
}

function formatDateForMyob(dateStr: string): string {
  if (!dateStr) return ''
  const date = new Date(dateStr + 'T00:00:00')
  return format(date, 'dd/MM/yyyy') // MYOB uses DD/MM/YYYY
}
```

Exact column names from research. Date format DD/MM/YYYY for Australian accounting software.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export function generate(Xero|Myob)InvoiceCsv" lib/reports/accounting-formats.ts
grep -E "dd/MM/yyyy" lib/reports/accounting-formats.ts
```

Should show both export functions and Australian date format.
  </verify>
  <done>accounting-formats.ts provides generateXeroInvoiceCsv and generateMyobInvoiceCsv with correct column names and DD/MM/YYYY dates</done>
</task>

<task type="auto">
  <name>Create invoice export API route</name>
  <files>apps/admin/app/api/reports/export/invoices/route.ts</files>
  <action>
Create API route for invoice CSV export in accounting formats:

```typescript
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { generateXeroInvoiceCsv, generateMyobInvoiceCsv } from '@/lib/reports/accounting-formats'

export const runtime = 'nodejs'

export async function POST(request: Request) {
  try {
    // 1. Authenticate
    const supabase = await createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()

    if (authError || !user) {
      return NextResponse.json({ error: 'Authentication required' }, { status: 401 })
    }

    // 2. Check permissions
    const { data: profile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single()

    if (!profile || !['admin', 'coordinator'].includes(profile.role)) {
      return NextResponse.json({ error: 'Insufficient permissions' }, { status: 403 })
    }

    // 3. Parse request
    const body = await request.json()
    const { format, dateFrom, dateTo } = body

    if (!['xero', 'myob'].includes(format)) {
      return NextResponse.json({ error: 'Invalid format' }, { status: 400 })
    }

    // 4. Fetch invoices with line items
    let query = supabase
      .from('invoices')
      .select(`
        invoice_number,
        invoice_date,
        due_date,
        participants(first_name, last_name),
        invoice_line_items(
          support_type,
          day_type,
          ndis_item_number,
          billable_minutes,
          unit_price
        )
      `)
      .in('status', ['submitted', 'paid'])

    if (dateFrom) {
      query = query.gte('invoice_date', dateFrom)
    }
    if (dateTo) {
      query = query.lte('invoice_date', dateTo)
    }

    const { data: invoices, error } = await query

    if (error) throw error

    // 5. Transform to format-specific structure
    if (format === 'xero') {
      const xeroItems = []
      for (const invoice of invoices ?? []) {
        const contactName = `${invoice.participants?.first_name} ${invoice.participants?.last_name}`
        for (const item of invoice.invoice_line_items ?? []) {
          xeroItems.push({
            contactName,
            invoiceNumber: invoice.invoice_number,
            invoiceDate: invoice.invoice_date,
            dueDate: invoice.due_date || invoice.invoice_date,
            description: `${item.support_type} - ${item.day_type}`,
            quantity: item.billable_minutes / 60,
            unitAmount: item.unit_price,
          })
        }
      }

      const csv = generateXeroInvoiceCsv(xeroItems)
      return new Response(csv, {
        headers: {
          'Content-Type': 'text/csv',
          'Content-Disposition': `attachment; filename="xero-invoices-${Date.now()}.csv"`,
        },
      })
    }

    if (format === 'myob') {
      const myobItems = []
      for (const invoice of invoices ?? []) {
        const participant = invoice.participants
        for (const item of invoice.invoice_line_items ?? []) {
          myobItems.push({
            lastName: participant?.last_name || '',
            firstName: participant?.first_name || '',
            invoiceNumber: invoice.invoice_number,
            invoiceDate: invoice.invoice_date,
            dueDate: invoice.due_date || invoice.invoice_date,
            itemNumber: item.ndis_item_number || '',
            description: `${item.support_type} - ${item.day_type}`,
            quantity: item.billable_minutes / 60,
            unitPrice: item.unit_price,
          })
        }
      }

      const csv = generateMyobInvoiceCsv(myobItems)
      return new Response(csv, {
        headers: {
          'Content-Type': 'text/csv',
          'Content-Disposition': `attachment; filename="myob-invoices-${Date.now()}.csv"`,
        },
      })
    }

    return NextResponse.json({ error: 'Invalid format' }, { status: 400 })
  } catch (error) {
    console.error('Export error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

Server-side export with RLS enforcement. Follows pattern from existing invoice export API.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export.*function POST" app/api/reports/export/invoices/route.ts
grep -E "generateXeroInvoiceCsv|generateMyobInvoiceCsv" app/api/reports/export/invoices/route.ts
```

Should show POST handler and formatter usage.
  </verify>
  <done>Invoice export API route handles Xero and MYOB formats with date filtering and RLS enforcement</done>
</task>

<task type="auto">
  <name>Create participant and worker hours export API routes</name>
  <files>
    apps/admin/app/api/reports/export/participants/route.ts
    apps/admin/app/api/reports/export/worker-hours/route.ts
  </files>
  <action>
Create participants export API:

```typescript
// apps/admin/app/api/reports/export/participants/route.ts
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { generateCsv } from '@/lib/reports/csv-export'

export const runtime = 'nodejs'

export async function POST(request: Request) {
  try {
    const supabase = await createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()

    if (authError || !user) {
      return NextResponse.json({ error: 'Authentication required' }, { status: 401 })
    }

    const { data: profile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single()

    if (!profile || !['admin', 'coordinator'].includes(profile.role)) {
      return NextResponse.json({ error: 'Insufficient permissions' }, { status: 403 })
    }

    const { data: participants, error } = await supabase
      .from('participants')
      .select('*')
      .order('last_name', { ascending: true })

    if (error) throw error

    const csv = generateCsv(participants ?? [], [
      { header: 'NDIS Number', key: 'ndis_number' },
      { header: 'First Name', key: 'first_name' },
      { header: 'Last Name', key: 'last_name' },
      { header: 'Email', key: 'email' },
      { header: 'Phone', key: 'phone' },
      { header: 'Address', key: 'address_line_1' },
      { header: 'Suburb', key: 'suburb' },
      { header: 'State', key: 'state' },
      { header: 'Postcode', key: 'postcode' },
    ])

    return new Response(csv, {
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="participants-${Date.now()}.csv"`,
      },
    })
  } catch (error) {
    console.error('Export error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

Create worker hours export API:

```typescript
// apps/admin/app/api/reports/export/worker-hours/route.ts
import { NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { generateCsv } from '@/lib/reports/csv-export'
import { format } from 'date-fns'

export const runtime = 'nodejs'

export async function POST(request: Request) {
  try {
    const supabase = await createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()

    if (authError || !user) {
      return NextResponse.json({ error: 'Authentication required' }, { status: 401 })
    }

    const { data: profile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single()

    if (!profile || !['admin', 'coordinator'].includes(profile.role)) {
      return NextResponse.json({ error: 'Insufficient permissions' }, { status: 403 })
    }

    const body = await request.json()
    const { dateFrom, dateTo } = body

    let query = supabase
      .from('shifts')
      .select(`
        scheduled_start,
        actual_start,
        actual_end,
        support_type,
        workers!inner(id, profile:profiles!inner(first_name, last_name)),
        participants!inner(first_name, last_name)
      `)
      .eq('status', 'completed')

    if (dateFrom) {
      query = query.gte('scheduled_start', dateFrom)
    }
    if (dateTo) {
      query = query.lte('scheduled_start', dateTo)
    }

    const { data: shifts, error } = await query

    if (error) throw error

    // Transform to payroll format
    const rows = (shifts ?? []).map((shift) => {
      const start = new Date(shift.actual_start!)
      const end = new Date(shift.actual_end!)
      const hours = (end.getTime() - start.getTime()) / (1000 * 60 * 60)

      return {
        workerName: `${shift.workers.profile.first_name} ${shift.workers.profile.last_name}`,
        shiftDate: format(new Date(shift.scheduled_start), 'dd/MM/yyyy'),
        participantName: `${shift.participants.first_name} ${shift.participants.last_name}`,
        supportType: shift.support_type,
        actualHours: hours.toFixed(2),
      }
    })

    const csv = generateCsv(rows, [
      { header: 'Worker Name', key: 'workerName' },
      { header: 'Shift Date', key: 'shiftDate' },
      { header: 'Participant', key: 'participantName' },
      { header: 'Support Type', key: 'supportType' },
      { header: 'Actual Hours', key: 'actualHours' },
    ])

    return new Response(csv, {
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="worker-hours-${Date.now()}.csv"`,
      },
    })
  } catch (error) {
    console.error('Export error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

Both routes use server-side generation with RLS.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export.*function POST" app/api/reports/export/participants/route.ts
grep -E "export.*function POST" app/api/reports/export/worker-hours/route.ts
```

Should show POST handlers.
  </verify>
  <done>Participants and worker hours export API routes generate CSV with proper formatting</done>
</task>

<task type="auto">
  <name>Create accounting exports dashboard page</name>
  <files>apps/admin/app/(protected)/reports/accounting-exports/page.tsx</files>
  <action>
Create accounting exports page with export buttons for each format:

```typescript
'use client'

import { useState } from 'react'
import { startOfMonth, endOfMonth, format } from 'date-fns'
import { FileSpreadsheet, Users, Clock } from 'lucide-react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { DateRangePicker } from '@/components/reports/DateRangePicker'
import { toast } from 'sonner'

export default function AccountingExportsPage() {
  const [dateRange, setDateRange] = useState({
    from: startOfMonth(new Date()),
    to: endOfMonth(new Date()),
  })
  const [isExporting, setIsExporting] = useState(false)

  const handleExportInvoices = async (format: 'xero' | 'myob') => {
    try {
      setIsExporting(true)

      const response = await fetch('/api/reports/export/invoices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          format,
          dateFrom: format(dateRange.from, 'yyyy-MM-dd'),
          dateTo: format(dateRange.to, 'yyyy-MM-dd'),
        }),
      })

      if (!response.ok) {
        throw new Error('Export failed')
      }

      const blob = await response.blob()
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = `${format}-invoices-${format(new Date(), 'yyyy-MM-dd')}.csv`
      link.click()
      URL.revokeObjectURL(url)

      toast.success(`Exported to ${format.toUpperCase()} format`)
    } catch (error) {
      console.error('Export error:', error)
      toast.error('Export failed')
    } finally {
      setIsExporting(false)
    }
  }

  const handleExportParticipants = async () => {
    try {
      setIsExporting(true)

      const response = await fetch('/api/reports/export/participants', {
        method: 'POST',
      })

      if (!response.ok) {
        throw new Error('Export failed')
      }

      const blob = await response.blob()
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = `participants-${format(new Date(), 'yyyy-MM-dd')}.csv`
      link.click()
      URL.revokeObjectURL(url)

      toast.success('Participants exported')
    } catch (error) {
      console.error('Export error:', error)
      toast.error('Export failed')
    } finally {
      setIsExporting(false)
    }
  }

  const handleExportWorkerHours = async () => {
    try {
      setIsExporting(true)

      const response = await fetch('/api/reports/export/worker-hours', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          dateFrom: format(dateRange.from, 'yyyy-MM-dd'),
          dateTo: format(dateRange.to, 'yyyy-MM-dd'),
        }),
      })

      if (!response.ok) {
        throw new Error('Export failed')
      }

      const blob = await response.blob()
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = `worker-hours-${format(new Date(), 'yyyy-MM-dd')}.csv`
      link.click()
      URL.revokeObjectURL(url)

      toast.success('Worker hours exported')
    } catch (error) {
      console.error('Export error:', error)
      toast.error('Export failed')
    } finally {
      setIsExporting(false)
    }
  }

  return (
    <div className="space-y-6">
      <div>
        <h1 className="font-heading text-2xl font-bold">Accounting Exports</h1>
        <p className="text-sm text-muted-foreground">
          Export data for Xero, MYOB, and payroll systems
        </p>
      </div>

      <div>
        <p className="text-sm text-muted-foreground mb-3">Date Range (for invoices and worker hours)</p>
        <DateRangePicker value={dateRange} onChange={setDateRange} />
      </div>

      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {/* Invoice Exports */}
        <Card>
          <CardHeader>
            <FileSpreadsheet className="h-8 w-8 mb-2 text-brand-teal" />
            <CardTitle className="text-lg">Xero Invoices</CardTitle>
            <CardDescription className="text-xs">
              Export invoices in Xero-compatible CSV format
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button
              onClick={() => handleExportInvoices('xero')}
              disabled={isExporting}
              size="sm"
              className="w-full"
            >
              Export Xero CSV
            </Button>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <FileSpreadsheet className="h-8 w-8 mb-2 text-brand-green" />
            <CardTitle className="text-lg">MYOB Invoices</CardTitle>
            <CardDescription className="text-xs">
              Export invoices in MYOB-compatible CSV format
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button
              onClick={() => handleExportInvoices('myob')}
              disabled={isExporting}
              size="sm"
              className="w-full"
            >
              Export MYOB CSV
            </Button>
          </CardContent>
        </Card>

        {/* Participant Export */}
        <Card>
          <CardHeader>
            <Users className="h-8 w-8 mb-2 text-brand-teal" />
            <CardTitle className="text-lg">Participant List</CardTitle>
            <CardDescription className="text-xs">
              Export all participant contact details
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button
              onClick={handleExportParticipants}
              disabled={isExporting}
              size="sm"
              className="w-full"
            >
              Export CSV
            </Button>
          </CardContent>
        </Card>

        {/* Worker Hours Export */}
        <Card>
          <CardHeader>
            <Clock className="h-8 w-8 mb-2 text-brand-green" />
            <CardTitle className="text-lg">Worker Hours</CardTitle>
            <CardDescription className="text-xs">
              Export worker hours for payroll processing
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button
              onClick={handleExportWorkerHours}
              disabled={isExporting}
              size="sm"
              className="w-full"
            >
              Export CSV
            </Button>
          </CardContent>
        </Card>
      </div>

      {/* Documentation */}
      <Card>
        <CardHeader>
          <CardTitle className="text-base">Import Instructions</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4 text-sm">
          <div>
            <h4 className="font-medium mb-1">Xero:</h4>
            <ol className="list-decimal ml-5 space-y-1 text-muted-foreground">
              <li>Go to Business → Invoices → Import</li>
              <li>Upload the exported CSV file</li>
              <li>Map columns (usually auto-detected)</li>
              <li>Ensure GST tax code exists in your Xero settings</li>
            </ol>
          </div>
          <div>
            <h4 className="font-medium mb-1">MYOB:</h4>
            <ol className="list-decimal ml-5 space-y-1 text-muted-foreground">
              <li>Go to Sales → Import Data → Sales</li>
              <li>Upload the exported CSV file</li>
              <li>Review imported invoices before saving</li>
            </ol>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
```

Simple dashboard with export cards. Documentation helps admin use exports correctly.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "handleExportInvoices|handleExportParticipants|handleExportWorkerHours" app/\(protected\)/reports/accounting-exports/page.tsx
```

Should show all 3 export handlers.
  </verify>
  <done>Accounting exports page provides buttons for Xero, MYOB, participant list, and worker hours CSV exports with import documentation</done>
</task>

</tasks>

<verification>
1. Visit /reports/accounting-exports
2. Export Xero invoices CSV and verify column names match Xero format
3. Export MYOB invoices CSV and verify column names match MYOB format
4. Verify dates use DD/MM/YYYY format (Australian standard)
5. Export participant list and verify all contact fields present
6. Export worker hours and verify hours calculation correct
7. TypeScript compiles without errors
</verification>

<success_criteria>
1. Xero invoice export produces CSV with correct column names (ContactName, InvoiceNumber, etc.)
2. MYOB invoice export produces CSV with correct column names (Co./Last Name, First Name, etc.)
3. All dates use DD/MM/YYYY format for Australian accounting software compatibility
4. Participant list export includes all contact fields (name, email, phone, address)
5. Worker hours export shows shift date, participant, hours for payroll processing
</success_criteria>

<output>
After completion, create `.planning/phases/12-reporting-and-export/12-06-SUMMARY.md`
</output>
