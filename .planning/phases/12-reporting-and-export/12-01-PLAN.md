---
phase: 12-reporting-and-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/package.json
  - apps/admin/components/reports/ReportLayout.tsx
  - apps/admin/components/reports/DateRangePicker.tsx
  - apps/admin/components/reports/ReportFilters.tsx
  - apps/admin/components/reports/ExportButtons.tsx
  - apps/admin/lib/reports/types.ts
  - apps/admin/lib/reports/constants.ts
  - apps/admin/lib/reports/csv-export.ts
  - apps/admin/app/(protected)/reports/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can access /reports page showing overview of available reports"
    - "Date range picker shows presets (This Month, Last Month, This Quarter)"
    - "CSV export helper can transform any data array to CSV format"
  artifacts:
    - path: "apps/admin/package.json"
      provides: "recharts and xlsx dependencies"
      contains: "recharts"
    - path: "apps/admin/components/reports/ReportLayout.tsx"
      provides: "Shared report page layout with filters and export UI"
      min_lines: 80
    - path: "apps/admin/components/reports/DateRangePicker.tsx"
      provides: "Date range filter with common presets"
      min_lines: 60
    - path: "apps/admin/lib/reports/csv-export.ts"
      provides: "Generic CSV export function"
      exports: ["generateCsv"]
  key_links:
    - from: "apps/admin/components/reports/DateRangePicker.tsx"
      to: "date-fns"
      via: "startOfMonth, endOfMonth, subMonths imports"
      pattern: "import.*from 'date-fns'"
    - from: "apps/admin/lib/reports/csv-export.ts"
      to: "CSV escaping"
      via: "escape commas/quotes/newlines"
      pattern: 'formatted\\.includes.*"'
---

<objective>
Establish report infrastructure foundation with dependencies, shared UI components, and generic export helpers.

Purpose: Create reusable building blocks that all specific reports will extend. This foundation enables parallel development of individual report types in subsequent plans.

Output: Dependencies installed, ReportLayout/DateRangePicker/ExportButtons components created, generic CSV export helper, reports landing page, shared types and constants.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-reporting-and-export/12-RESEARCH.md
@apps/admin/lib/invoices/csv-export.ts
@apps/admin/components/pdf/pdf-styles.ts
@apps/admin/components/invoices/ExportCsvButton.tsx
</context>

<tasks>

<task type="auto">
  <name>Install reporting dependencies</name>
  <files>apps/admin/package.json</files>
  <action>
Install recharts and xlsx via pnpm:

```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026
pnpm add recharts xlsx --filter @ephraimcare/admin
```

Versions from research:
- recharts: ^2.15.0 (React 19 compatible, declarative charting)
- xlsx: ^0.18.5 (SheetJS for Excel export)

These libraries are the standard stack for React data visualization and Excel export.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E '"(recharts|xlsx)"' package.json
```

Should show both dependencies with correct versions.
  </verify>
  <done>recharts and xlsx appear in apps/admin/package.json with ^2.15.0 and ^0.18.5 versions</done>
</task>

<task type="auto">
  <name>Create shared report types and constants</name>
  <files>
    apps/admin/lib/reports/types.ts
    apps/admin/lib/reports/constants.ts
  </files>
  <action>
Create types.ts with shared report interfaces:

```typescript
// Common filter types
export interface DateRangeFilter {
  from: Date
  to: Date
}

export interface ReportFilters {
  dateRange: DateRangeFilter
  participantId?: string
  workerId?: string
  supportType?: string
}

// Export format types
export type ExportFormat = 'csv' | 'excel' | 'pdf'

// Common report data shapes
export interface BudgetReportRow {
  participantId: string
  participantName: string
  ndisNumber: string
  allocatedBudget: number
  usedBudget: number
  remainingBudget: number
  utilizationPercent: number
  alert: 'ok' | 'warning' | 'critical'
}

export interface RevenueReportRow {
  month: string
  invoiceCount: number
  totalRevenue: number
  subtotal: number
  gst: number
}

export interface WorkerHoursRow {
  workerId: string
  workerName: string
  shiftCount: number
  totalHours: number
  averageHoursPerShift: number
}

export interface ParticipantActivityRow {
  participantId: string
  participantName: string
  shiftCount: number
  totalHours: number
  lastShiftDate: string | null
}

// CSV column definition
export interface CsvColumn<T> {
  header: string
  key: keyof T
  format?: (value: any) => string
}
```

Create constants.ts with report configuration:

```typescript
// Date range presets
export const DATE_RANGE_PRESETS = [
  { label: 'This Month', days: 30 },
  { label: 'Last Month', days: 60 },
  { label: 'This Quarter', days: 90 },
  { label: 'Last 3 Months', days: 90 },
  { label: 'This Year', days: 365 },
] as const

// Alert thresholds
export const BUDGET_WARNING_THRESHOLD = 75 // 75% utilization
export const BUDGET_CRITICAL_THRESHOLD = 90 // 90% utilization

// Export limits
export const MAX_EXPORT_ROWS = 5000 // Prevent browser crashes on large datasets
```

Both files use TypeScript strict mode with no external dependencies.
  </action>
  <verify>
```bash
cat /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin/lib/reports/types.ts | grep -E "export (interface|type)"
cat /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin/lib/reports/constants.ts | grep -E "export const"
```

Should show all exported types and constants.
  </verify>
  <done>types.ts exports all report data types and CsvColumn interface; constants.ts exports DATE_RANGE_PRESETS, thresholds, and MAX_EXPORT_ROWS</done>
</task>

<task type="auto">
  <name>Create generic CSV export helper</name>
  <files>apps/admin/lib/reports/csv-export.ts</files>
  <action>
Create generic CSV export helper extending the pattern from apps/admin/lib/invoices/csv-export.ts:

```typescript
import type { CsvColumn } from './types'

/**
 * Generate CSV from any data array with column configuration.
 * Handles proper CSV escaping (commas, quotes, newlines).
 *
 * @param data - Array of objects to export
 * @param columns - Column definitions with headers and formatting
 * @returns CSV string (header + data rows)
 */
export function generateCsv<T>(
  data: T[],
  columns: CsvColumn<T>[]
): string {
  const headers = columns.map(col => col.header).join(',')

  const rows = data.map(row =>
    columns.map(col => {
      const value = row[col.key]
      const formatted = col.format ? col.format(value) : String(value ?? '')

      // Escape commas, quotes, and newlines in CSV
      if (formatted.includes(',') || formatted.includes('"') || formatted.includes('\n')) {
        return `"${formatted.replace(/"/g, '""')}"`
      }
      return formatted
    }).join(',')
  )

  return [headers, ...rows].join('\n')
}

/**
 * Trigger browser download of CSV file.
 *
 * @param content - CSV string content
 * @param filename - Download filename (without .csv extension)
 */
export function downloadCsv(content: string, filename: string): void {
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' })
  const url = URL.createObjectURL(blob)

  const link = document.createElement('a')
  link.setAttribute('href', url)
  link.setAttribute('download', `${filename}.csv`)
  link.style.visibility = 'hidden'

  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)

  URL.revokeObjectURL(url)
}
```

Pattern matches existing csv-export.ts from invoicing phase. Reusable across all report types.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export function (generateCsv|downloadCsv)" lib/reports/csv-export.ts
```

Should show both exported functions.
  </verify>
  <done>csv-export.ts exports generateCsv and downloadCsv functions with proper CSV escaping logic</done>
</task>

<task type="auto">
  <name>Create ReportLayout and DateRangePicker components</name>
  <files>
    apps/admin/components/reports/ReportLayout.tsx
    apps/admin/components/reports/DateRangePicker.tsx
  </files>
  <action>
Create ReportLayout.tsx as shared container:

```typescript
'use client'

import type { ReactNode } from 'react'
import { Skeleton } from '@/components/ui/skeleton'

interface ReportLayoutProps {
  title: string
  description: string
  filters: ReactNode
  exportButtons: ReactNode
  children: ReactNode
  isLoading?: boolean
  summary?: { label: string; value: string | number }[]
}

export function ReportLayout({
  title,
  description,
  filters,
  exportButtons,
  children,
  isLoading = false,
  summary,
}: ReportLayoutProps) {
  return (
    <div className="space-y-6">
      {/* Header with title and export */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="font-heading text-2xl font-bold">{title}</h1>
          <p className="text-sm text-muted-foreground">{description}</p>
        </div>
        <div className="flex items-center gap-3">
          {exportButtons}
        </div>
      </div>

      {/* Filters */}
      <div className="flex flex-wrap items-center gap-3">
        {filters}
      </div>

      {/* Summary stats */}
      {summary && (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {summary.map((stat) => (
            <div key={stat.label} className="rounded-lg border p-4">
              <p className="text-sm text-muted-foreground">{stat.label}</p>
              <p className="text-2xl font-bold">{stat.value}</p>
            </div>
          ))}
        </div>
      )}

      {/* Report content */}
      {isLoading ? (
        <div className="space-y-4">
          <Skeleton className="h-12 w-full" />
          <Skeleton className="h-64 w-full" />
        </div>
      ) : (
        children
      )}
    </div>
  )
}
```

Create DateRangePicker.tsx with presets:

```typescript
'use client'

import { useState } from 'react'
import { format, startOfMonth, endOfMonth, subMonths, startOfQuarter, endOfQuarter, subDays } from 'date-fns'
import { Calendar as CalendarIcon } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Calendar } from '@/components/ui/calendar'
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover'
import { cn } from '@/lib/utils'
import type { DateRange } from 'react-day-picker'

interface DateRangePickerProps {
  value: { from: Date; to: Date }
  onChange: (range: { from: Date; to: Date }) => void
  className?: string
}

const PRESETS = [
  {
    label: 'This Month',
    getValue: () => ({
      from: startOfMonth(new Date()),
      to: endOfMonth(new Date())
    })
  },
  {
    label: 'Last Month',
    getValue: () => ({
      from: startOfMonth(subMonths(new Date(), 1)),
      to: endOfMonth(subMonths(new Date(), 1))
    })
  },
  {
    label: 'This Quarter',
    getValue: () => ({
      from: startOfQuarter(new Date()),
      to: endOfQuarter(new Date())
    })
  },
  {
    label: 'Last 3 Months',
    getValue: () => ({
      from: subDays(new Date(), 90),
      to: new Date()
    })
  },
]

export function DateRangePicker({ value, onChange, className }: DateRangePickerProps) {
  const [isOpen, setIsOpen] = useState(false)

  const handlePresetClick = (getValue: () => { from: Date; to: Date }) => {
    const range = getValue()
    onChange(range)
    setIsOpen(false)
  }

  const handleCalendarSelect = (range: DateRange | undefined) => {
    if (range?.from && range?.to) {
      onChange({ from: range.from, to: range.to })
    }
  }

  return (
    <Popover open={isOpen} onOpenChange={setIsOpen}>
      <PopoverTrigger asChild>
        <Button
          variant="outline"
          className={cn('w-[300px] justify-start text-left font-normal', className)}
        >
          <CalendarIcon className="mr-2 h-4 w-4" />
          {format(value.from, 'MMM d, yyyy')} - {format(value.to, 'MMM d, yyyy')}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-auto p-0" align="start">
        <div className="flex">
          {/* Presets sidebar */}
          <div className="border-r p-3 space-y-1">
            {PRESETS.map((preset) => (
              <Button
                key={preset.label}
                variant="ghost"
                size="sm"
                className="w-full justify-start"
                onClick={() => handlePresetClick(preset.getValue)}
              >
                {preset.label}
              </Button>
            ))}
          </div>
          {/* Calendar */}
          <Calendar
            mode="range"
            selected={{ from: value.from, to: value.to }}
            onSelect={handleCalendarSelect}
            numberOfMonths={2}
            className="p-3"
          />
        </div>
      </PopoverContent>
    </Popover>
  )
}
```

Both components follow existing shadcn/ui patterns from admin app.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export function (ReportLayout|DateRangePicker)" components/reports/*.tsx
```

Should show both component exports.
  </verify>
  <done>ReportLayout.tsx provides shared layout with filters/export/summary; DateRangePicker.tsx shows calendar with 4 presets</done>
</task>

<task type="auto">
  <name>Create ReportFilters and ExportButtons components</name>
  <files>
    apps/admin/components/reports/ReportFilters.tsx
    apps/admin/components/reports/ExportButtons.tsx
  </files>
  <action>
Create ReportFilters.tsx for entity filtering:

```typescript
'use client'

import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Label } from '@/components/ui/label'

interface Participant {
  id: string
  first_name: string
  last_name: string
}

interface Worker {
  id: string
  profile: { first_name: string; last_name: string }
}

interface ReportFiltersProps {
  participants?: Participant[]
  workers?: Worker[]
  supportTypes?: string[]
  selectedParticipant?: string
  selectedWorker?: string
  selectedSupportType?: string
  onParticipantChange?: (value: string) => void
  onWorkerChange?: (value: string) => void
  onSupportTypeChange?: (value: string) => void
}

export function ReportFilters({
  participants,
  workers,
  supportTypes,
  selectedParticipant,
  selectedWorker,
  selectedSupportType,
  onParticipantChange,
  onWorkerChange,
  onSupportTypeChange,
}: ReportFiltersProps) {
  return (
    <>
      {participants && onParticipantChange && (
        <div className="flex items-center gap-2">
          <Label className="text-xs text-muted-foreground whitespace-nowrap">Participant</Label>
          <Select value={selectedParticipant} onValueChange={onParticipantChange}>
            <SelectTrigger className="w-[200px]">
              <SelectValue placeholder="All participants" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All participants</SelectItem>
              {participants.map((p) => (
                <SelectItem key={p.id} value={p.id}>
                  {p.first_name} {p.last_name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      )}

      {workers && onWorkerChange && (
        <div className="flex items-center gap-2">
          <Label className="text-xs text-muted-foreground whitespace-nowrap">Worker</Label>
          <Select value={selectedWorker} onValueChange={onWorkerChange}>
            <SelectTrigger className="w-[200px]">
              <SelectValue placeholder="All workers" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All workers</SelectItem>
              {workers.map((w) => (
                <SelectItem key={w.id} value={w.id}>
                  {w.profile.first_name} {w.profile.last_name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      )}

      {supportTypes && onSupportTypeChange && (
        <div className="flex items-center gap-2">
          <Label className="text-xs text-muted-foreground whitespace-nowrap">Support Type</Label>
          <Select value={selectedSupportType} onValueChange={onSupportTypeChange}>
            <SelectTrigger className="w-[200px]">
              <SelectValue placeholder="All types" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All types</SelectItem>
              {supportTypes.map((type) => (
                <SelectItem key={type} value={type}>
                  {type}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>
      )}
    </>
  )
}
```

Create ExportButtons.tsx for export UI:

```typescript
'use client'

import { useState } from 'react'
import { Download, FileSpreadsheet, FileText } from 'lucide-react'
import { Button } from '@/components/ui/button'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { toast } from 'sonner'

interface ExportButtonsProps {
  onExportCsv: () => void
  onExportExcel: () => void
  onExportPdf: () => void
  disabled?: boolean
}

export function ExportButtons({
  onExportCsv,
  onExportExcel,
  onExportPdf,
  disabled = false,
}: ExportButtonsProps) {
  const [isExporting, setIsExporting] = useState(false)

  const handleExport = async (exportFn: () => void | Promise<void>, format: string) => {
    try {
      setIsExporting(true)
      await exportFn()
      toast.success(`Exported as ${format}`)
    } catch (error) {
      console.error('Export error:', error)
      toast.error('Export failed')
    } finally {
      setIsExporting(false)
    }
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" size="sm" disabled={disabled || isExporting}>
          <Download className="mr-2 h-4 w-4" />
          Export
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem onClick={() => handleExport(onExportCsv, 'CSV')}>
          <FileText className="mr-2 h-4 w-4" />
          CSV
        </DropdownMenuItem>
        <DropdownMenuItem onClick={() => handleExport(onExportExcel, 'Excel')}>
          <FileSpreadsheet className="mr-2 h-4 w-4" />
          Excel
        </DropdownMenuItem>
        <DropdownMenuItem onClick={() => handleExport(onExportPdf, 'PDF')}>
          <FileText className="mr-2 h-4 w-4" />
          PDF
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

Both components follow existing patterns from shift filters and invoice export buttons.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export function (ReportFilters|ExportButtons)" components/reports/*.tsx
```

Should show both component exports.
  </verify>
  <done>ReportFilters.tsx provides Select dropdowns for participant/worker/support type; ExportButtons.tsx provides dropdown with CSV/Excel/PDF options</done>
</task>

<task type="auto">
  <name>Create reports landing page</name>
  <files>apps/admin/app/(protected)/reports/page.tsx</files>
  <action>
Create reports overview page linking to specific report types:

```typescript
import Link from 'next/link'
import { FileBarChart2, TrendingUp, Clock, User } from 'lucide-react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

const REPORTS = [
  {
    title: 'Budget Utilization',
    description: 'View participant budget allocation, usage, and remaining amounts',
    icon: FileBarChart2,
    href: '/reports/budget',
    color: 'text-brand-green',
  },
  {
    title: 'Revenue Trends',
    description: 'Monthly revenue breakdown with support type analysis',
    icon: TrendingUp,
    href: '/reports/revenue',
    color: 'text-brand-teal',
  },
  {
    title: 'Worker Hours',
    description: 'Worker shift statistics and hours worked per period',
    icon: Clock,
    href: '/reports/worker-hours',
    color: 'text-brand-green',
  },
  {
    title: 'Participant Activity',
    description: 'Shift history and activity summary per participant',
    icon: User,
    href: '/reports/participant-activity',
    color: 'text-brand-teal',
  },
]

export default function ReportsPage() {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="font-heading text-2xl font-bold">Reports & Export</h1>
        <p className="text-sm text-muted-foreground">
          Generate reports for budgets, revenue, worker hours, and participant activity
        </p>
      </div>

      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        {REPORTS.map((report) => {
          const Icon = report.icon
          return (
            <Link key={report.href} href={report.href}>
              <Card className="transition-shadow hover:shadow-md">
                <CardHeader className="pb-3">
                  <Icon className={`h-8 w-8 mb-2 ${report.color}`} />
                  <CardTitle className="text-lg">{report.title}</CardTitle>
                  <CardDescription className="text-xs line-clamp-2">
                    {report.description}
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <p className="text-xs text-brand-teal font-medium">View Report â†’</p>
                </CardContent>
              </Card>
            </Link>
          )
        })}
      </div>
    </div>
  )
}
```

Server component pattern matches existing admin pages. Provides navigation to 4 report types.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
cat app/\(protected\)/reports/page.tsx | grep -E "(Budget|Revenue|Worker|Participant)"
```

Should show all 4 report links.
  </verify>
  <done>/reports page shows 4 report cards linking to budget, revenue, worker-hours, and participant-activity</done>
</task>

</tasks>

<verification>
1. Run `pnpm install` to install recharts and xlsx dependencies
2. Check apps/admin/package.json contains both dependencies with correct versions
3. Verify ReportLayout component exports and accepts all required props
4. Verify DateRangePicker shows calendar with 4 preset buttons
5. Verify csv-export.ts exports generateCsv and downloadCsv functions
6. Visit /reports and see 4 report cards displayed
7. All files compile without TypeScript errors
</verification>

<success_criteria>
1. apps/admin/package.json includes recharts ^2.15.0 and xlsx ^0.18.5
2. ReportLayout.tsx provides reusable container with filters/export/summary sections
3. DateRangePicker.tsx shows calendar with "This Month", "Last Month", "This Quarter", "Last 3 Months" presets
4. generateCsv helper can transform any data array to CSV with proper escaping
5. /reports landing page displays 4 report type cards with navigation links
</success_criteria>

<output>
After completion, create `.planning/phases/12-reporting-and-export/12-01-SUMMARY.md`
</output>
