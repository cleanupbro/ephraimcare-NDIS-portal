---
phase: 12-reporting-and-export
plan: 02
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - apps/admin/hooks/use-budget-report.ts
  - apps/admin/components/reports/charts/BudgetBarChart.tsx
  - apps/admin/components/reports/charts/ChartCard.tsx
  - apps/admin/app/(protected)/reports/budget/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view budget utilization by participant with used/remaining amounts"
    - "Budget bar chart shows allocated vs used budget visually"
    - "Alert status shows warning (75-90%) or critical (>90%) utilization"
    - "Report can be filtered by date range and exported as CSV"
  artifacts:
    - path: "apps/admin/hooks/use-budget-report.ts"
      provides: "Budget data fetching and aggregation"
      exports: ["useBudgetReport"]
    - path: "apps/admin/components/reports/charts/BudgetBarChart.tsx"
      provides: "Recharts bar chart for budget visualization"
      min_lines: 40
    - path: "apps/admin/app/(protected)/reports/budget/page.tsx"
      provides: "Budget utilization report page"
      min_lines: 80
  key_links:
    - from: "apps/admin/app/(protected)/reports/budget/page.tsx"
      to: "apps/admin/hooks/use-budget-report.ts"
      via: "useBudgetReport hook call"
      pattern: "useBudgetReport"
    - from: "apps/admin/components/reports/charts/BudgetBarChart.tsx"
      to: "recharts"
      via: "ResponsiveContainer, BarChart imports"
      pattern: "from 'recharts'"
    - from: "apps/admin/hooks/use-budget-report.ts"
      to: "@supabase/supabase-js"
      via: "plan_budgets query"
      pattern: "\\.from\\('plan_budgets'\\)"
---

<objective>
Build budget utilization report showing each participant's allocated, used, and remaining budget with visual chart and alert status.

Purpose: Provide admin with clear view of budget utilization to identify participants nearing budget limits. Supports financial planning and NDIS audit requirements (REPT-01).

Output: Budget report page with bar chart, alert indicators (green/yellow/red), CSV export, date range filtering, and participant filtering.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-reporting-and-export/12-RESEARCH.md
@.planning/phases/12-reporting-and-export/12-01-SUMMARY.md
@apps/admin/hooks/use-invoices.ts
@apps/admin/lib/reports/types.ts
@apps/admin/lib/reports/constants.ts
@apps/admin/lib/reports/csv-export.ts
</context>

<tasks>

<task type="auto">
  <name>Create budget report data hook</name>
  <files>apps/admin/hooks/use-budget-report.ts</files>
  <action>
Create TanStack Query hook to fetch and aggregate budget data:

```typescript
'use client'

import { useQuery } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'
import type { BudgetReportRow } from '@/lib/reports/types'
import { BUDGET_WARNING_THRESHOLD, BUDGET_CRITICAL_THRESHOLD } from '@/lib/reports/constants'

interface BudgetReportFilters {
  dateFrom?: Date
  dateTo?: Date
  participantId?: string
  category?: string
}

interface BudgetReportData {
  participants: BudgetReportRow[]
  totals: {
    totalAllocated: number
    totalUsed: number
    overallUtilization: number
  }
}

export function useBudgetReport(filters: BudgetReportFilters) {
  return useQuery<BudgetReportData>({
    queryKey: ['budget-report', filters],
    queryFn: async () => {
      const supabase = createClient()

      // Fetch plan budgets with participant info
      let query = supabase
        .from('plan_budgets')
        .select(`
          allocated_amount,
          used_amount,
          category,
          ndis_plans!inner(
            participant_id,
            is_current,
            participants(id, first_name, last_name, ndis_number)
          )
        `)
        .eq('ndis_plans.is_current', true)

      // Apply filters
      if (filters.participantId && filters.participantId !== 'all') {
        query = query.eq('ndis_plans.participant_id', filters.participantId)
      }
      if (filters.category) {
        query = query.eq('category', filters.category)
      }

      const { data, error } = await query

      if (error) throw error

      // Aggregate by participant (client-side)
      const participantMap = new Map<string, {
        id: string
        name: string
        ndisNumber: string
        allocated: number
        used: number
      }>()

      for (const budget of data ?? []) {
        const participant = budget.ndis_plans?.participants
        if (!participant) continue

        const key = participant.id
        const existing = participantMap.get(key) || {
          id: participant.id,
          name: `${participant.first_name} ${participant.last_name}`,
          ndisNumber: participant.ndis_number,
          allocated: 0,
          used: 0,
        }

        existing.allocated += Number(budget.allocated_amount) || 0
        existing.used += Number(budget.used_amount) || 0
        participantMap.set(key, existing)
      }

      // Transform to report format with alert status
      const participants: BudgetReportRow[] = Array.from(participantMap.values()).map((p) => {
        const utilization = p.allocated > 0 ? (p.used / p.allocated) * 100 : 0
        return {
          participantId: p.id,
          participantName: p.name,
          ndisNumber: p.ndisNumber,
          allocatedBudget: p.allocated,
          usedBudget: p.used,
          remainingBudget: p.allocated - p.used,
          utilizationPercent: Math.round(utilization * 10) / 10, // Round to 1 decimal
          alert: utilization >= BUDGET_CRITICAL_THRESHOLD
            ? 'critical'
            : utilization >= BUDGET_WARNING_THRESHOLD
            ? 'warning'
            : 'ok',
        }
      })

      // Sort by utilization descending (most urgent first)
      participants.sort((a, b) => b.utilizationPercent - a.utilizationPercent)

      // Calculate totals
      const totals = participants.reduce(
        (acc, p) => ({
          totalAllocated: acc.totalAllocated + p.allocatedBudget,
          totalUsed: acc.totalUsed + p.usedBudget,
          overallUtilization: 0,
        }),
        { totalAllocated: 0, totalUsed: 0, overallUtilization: 0 }
      )
      totals.overallUtilization =
        totals.totalAllocated > 0
          ? Math.round((totals.totalUsed / totals.totalAllocated) * 1000) / 10
          : 0

      return { participants, totals }
    },
    staleTime: 5 * 60 * 1000, // 5 minutes cache
  })
}
```

Pattern matches existing use-invoices.ts structure. Uses PostgREST join with (as any) assertion for type compatibility.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export function useBudgetReport" hooks/use-budget-report.ts
grep -E "alert.*critical.*warning.*ok" hooks/use-budget-report.ts
```

Should show hook export and alert logic.
  </verify>
  <done>useBudgetReport hook fetches plan_budgets, aggregates by participant, calculates utilization %, and assigns alert status</done>
</task>

<task type="auto">
  <name>Create budget bar chart and chart card wrapper</name>
  <files>
    apps/admin/components/reports/charts/BudgetBarChart.tsx
    apps/admin/components/reports/charts/ChartCard.tsx
  </files>
  <action>
Create BudgetBarChart.tsx using Recharts:

```typescript
'use client' // IMPORTANT: Charts must be client components

import { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts'
import type { BudgetReportRow } from '@/lib/reports/types'

interface BudgetBarChartProps {
  data: BudgetReportRow[]
}

export function BudgetBarChart({ data }: BudgetBarChartProps) {
  // Transform for Recharts
  const chartData = data.slice(0, 10).map((row) => ({
    participant: row.participantName,
    allocated: row.allocatedBudget,
    used: row.usedBudget,
  }))

  return (
    <ResponsiveContainer width="100%" height={400}>
      <BarChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 60 }}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis
          dataKey="participant"
          angle={-45}
          textAnchor="end"
          height={100}
          style={{ fontSize: '12px' }}
        />
        <YAxis
          tickFormatter={(value: number) => `$${(value / 1000).toFixed(0)}k`}
          style={{ fontSize: '12px' }}
        />
        <Tooltip
          formatter={(value: number) => `$${value.toLocaleString()}`}
          contentStyle={{ fontSize: '12px' }}
        />
        <Legend wrapperStyle={{ fontSize: '12px', paddingTop: '20px' }} />
        <Bar dataKey="allocated" name="Allocated Budget" fill="#00BFA5" />
        <Bar dataKey="used" name="Used Budget" fill="#66BB6A" />
      </BarChart>
    </ResponsiveContainer>
  )
}
```

Create ChartCard.tsx as reusable wrapper:

```typescript
import type { ReactNode } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

interface ChartCardProps {
  title: string
  description?: string
  children: ReactNode
}

export function ChartCard({ title, description, children }: ChartCardProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-lg">{title}</CardTitle>
        {description && <CardDescription>{description}</CardDescription>}
      </CardHeader>
      <CardContent>{children}</CardContent>
    </Card>
  )
}
```

Chart uses Ephraim Care brand colors from pdf-styles.ts. Limits to top 10 participants for readability.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep "'use client'" components/reports/charts/BudgetBarChart.tsx
grep -E "from 'recharts'" components/reports/charts/BudgetBarChart.tsx
```

Should show 'use client' directive and recharts imports.
  </verify>
  <done>BudgetBarChart.tsx renders responsive bar chart with allocated vs used budget; ChartCard.tsx provides reusable card wrapper</done>
</task>

<task type="auto">
  <name>Create budget utilization report page</name>
  <files>apps/admin/app/(protected)/reports/budget/page.tsx</files>
  <action>
Create budget report page with filters and export:

```typescript
'use client'

import { useState } from 'react'
import { startOfMonth, endOfMonth } from 'date-fns'
import { ReportLayout } from '@/components/reports/ReportLayout'
import { DateRangePicker } from '@/components/reports/DateRangePicker'
import { ReportFilters } from '@/components/reports/ReportFilters'
import { ExportButtons } from '@/components/reports/ExportButtons'
import { BudgetBarChart } from '@/components/reports/charts/BudgetBarChart'
import { ChartCard } from '@/components/reports/charts/ChartCard'
import { useBudgetReport } from '@/hooks/use-budget-report'
import { generateCsv, downloadCsv } from '@/lib/reports/csv-export'
import { Badge } from '@/components/ui/badge'
import { format } from 'date-fns'

export default function BudgetReportPage() {
  const [dateRange, setDateRange] = useState({
    from: startOfMonth(new Date()),
    to: endOfMonth(new Date()),
  })
  const [selectedParticipant, setSelectedParticipant] = useState<string>('all')

  const { data, isLoading, error } = useBudgetReport({
    dateFrom: dateRange.from,
    dateTo: dateRange.to,
    participantId: selectedParticipant,
  })

  const handleExportCsv = () => {
    if (!data) return

    const csv = generateCsv(data.participants, [
      { header: 'Participant Name', key: 'participantName' },
      { header: 'NDIS Number', key: 'ndisNumber' },
      { header: 'Allocated Budget', key: 'allocatedBudget', format: (v) => `$${v.toFixed(2)}` },
      { header: 'Used Budget', key: 'usedBudget', format: (v) => `$${v.toFixed(2)}` },
      { header: 'Remaining Budget', key: 'remainingBudget', format: (v) => `$${v.toFixed(2)}` },
      { header: 'Utilization %', key: 'utilizationPercent', format: (v) => `${v.toFixed(1)}%` },
      { header: 'Alert Status', key: 'alert' },
    ])

    const filename = `budget-report-${format(new Date(), 'yyyy-MM-dd')}`
    downloadCsv(csv, filename)
  }

  const handleExportExcel = () => {
    // Placeholder - will be implemented in plan 03
    console.log('Excel export not yet implemented')
  }

  const handleExportPdf = () => {
    // Placeholder - will be implemented in plan 03
    console.log('PDF export not yet implemented')
  }

  const summary = data
    ? [
        {
          label: 'Total Allocated',
          value: `$${data.totals.totalAllocated.toLocaleString()}`,
        },
        {
          label: 'Total Used',
          value: `$${data.totals.totalUsed.toLocaleString()}`,
        },
        {
          label: 'Overall Utilization',
          value: `${data.totals.overallUtilization.toFixed(1)}%`,
        },
        {
          label: 'Participants',
          value: data.participants.length,
        },
      ]
    : undefined

  return (
    <ReportLayout
      title="Budget Utilization Report"
      description="View participant budget allocation, usage, and remaining amounts"
      isLoading={isLoading}
      summary={summary}
      filters={
        <>
          <DateRangePicker value={dateRange} onChange={setDateRange} />
          <ReportFilters
            selectedParticipant={selectedParticipant}
            onParticipantChange={setSelectedParticipant}
          />
        </>
      }
      exportButtons={
        <ExportButtons
          onExportCsv={handleExportCsv}
          onExportExcel={handleExportExcel}
          onExportPdf={handleExportPdf}
          disabled={!data || data.participants.length === 0}
        />
      }
    >
      {error && (
        <div className="text-sm text-destructive">
          Error loading report: {error.message}
        </div>
      )}

      {data && (
        <div className="space-y-6">
          {/* Chart */}
          <ChartCard
            title="Budget Utilization by Participant"
            description="Top 10 participants by budget utilization"
          >
            <BudgetBarChart data={data.participants} />
          </ChartCard>

          {/* Table */}
          <div className="rounded-lg border">
            <table className="w-full text-sm">
              <thead className="border-b bg-muted/50">
                <tr>
                  <th className="p-3 text-left font-medium">Participant</th>
                  <th className="p-3 text-left font-medium">NDIS Number</th>
                  <th className="p-3 text-right font-medium">Allocated</th>
                  <th className="p-3 text-right font-medium">Used</th>
                  <th className="p-3 text-right font-medium">Remaining</th>
                  <th className="p-3 text-right font-medium">Utilization</th>
                  <th className="p-3 text-center font-medium">Alert</th>
                </tr>
              </thead>
              <tbody>
                {data.participants.map((row) => (
                  <tr key={row.participantId} className="border-b hover:bg-muted/20">
                    <td className="p-3">{row.participantName}</td>
                    <td className="p-3">{row.ndisNumber}</td>
                    <td className="p-3 text-right">
                      ${row.allocatedBudget.toLocaleString()}
                    </td>
                    <td className="p-3 text-right">
                      ${row.usedBudget.toLocaleString()}
                    </td>
                    <td className="p-3 text-right">
                      ${row.remainingBudget.toLocaleString()}
                    </td>
                    <td className="p-3 text-right">
                      {row.utilizationPercent.toFixed(1)}%
                    </td>
                    <td className="p-3 text-center">
                      <Badge
                        variant={
                          row.alert === 'critical'
                            ? 'destructive'
                            : row.alert === 'warning'
                            ? 'secondary'
                            : 'outline'
                        }
                      >
                        {row.alert === 'critical'
                          ? 'Critical'
                          : row.alert === 'warning'
                          ? 'Warning'
                          : 'OK'}
                      </Badge>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </ReportLayout>
  )
}
```

Client component pattern with ReportLayout. CSV export fully implemented, Excel/PDF placeholders for plan 03.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "useBudgetReport" app/\(protected\)/reports/budget/page.tsx
grep -E "handleExportCsv" app/\(protected\)/reports/budget/page.tsx
```

Should show hook usage and CSV export handler.
  </verify>
  <done>Budget report page shows bar chart, summary stats, data table, CSV export, date range filter, and participant filter</done>
</task>

</tasks>

<verification>
1. Visit /reports/budget and see budget utilization chart and table
2. Filter by date range and see data update
3. Click Export -> CSV and download budget report CSV
4. Verify participants with >90% utilization show red "Critical" badge
5. Verify participants with 75-90% utilization show amber "Warning" badge
6. Verify summary cards show total allocated, used, utilization %, and count
7. TypeScript compiles without errors
</verification>

<success_criteria>
1. Budget report displays allocated vs used budget for each participant with bar chart
2. Alert status correctly shows green (OK), amber (warning 75-90%), red (critical >90%)
3. Date range filter updates report data when changed
4. CSV export downloads file with all participant budget data
5. Summary cards show aggregated totals across all participants
</success_criteria>

<output>
After completion, create `.planning/phases/12-reporting-and-export/12-02-SUMMARY.md`
</output>
