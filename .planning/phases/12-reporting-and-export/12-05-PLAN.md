---
phase: 12-reporting-and-export
plan: 05
type: execute
wave: 3
depends_on: [12-02, 12-03, 12-04]
files_modified:
  - apps/admin/lib/reports/excel-export.ts
  - apps/admin/lib/reports/pdf-export.ts
  - apps/admin/components/reports/pdf/ReportPdfDocument.tsx
  - apps/admin/app/(protected)/reports/budget/page.tsx
  - apps/admin/app/(protected)/reports/revenue/page.tsx
  - apps/admin/app/(protected)/reports/worker-hours/page.tsx
  - apps/admin/app/(protected)/reports/participant-activity/page.tsx
autonomous: true

must_haves:
  truths:
    - "All reports can be exported as Excel with proper column formatting"
    - "All reports can be exported as PDF with Ephraim Care branding"
    - "Excel files download with .xlsx extension"
    - "PDF files display correctly with tables and brand colors"
  artifacts:
    - path: "apps/admin/lib/reports/excel-export.ts"
      provides: "SheetJS Excel export helper"
      exports: ["exportToExcel"]
    - path: "apps/admin/lib/reports/pdf-export.ts"
      provides: "PDF generation utilities"
      exports: ["generateReportPdf"]
    - path: "apps/admin/components/reports/pdf/ReportPdfDocument.tsx"
      provides: "Generic PDF report template"
      min_lines: 80
  key_links:
    - from: "apps/admin/lib/reports/excel-export.ts"
      to: "xlsx"
      via: "SheetJS XLSX.utils import"
      pattern: "from 'xlsx'"
    - from: "apps/admin/components/reports/pdf/ReportPdfDocument.tsx"
      to: "@react-pdf/renderer"
      via: "Document, Page, View, Text imports"
      pattern: "from '@react-pdf/renderer'"
---

<objective>
Implement Excel and PDF export for all report types using SheetJS and @react-pdf/renderer.

Purpose: Enable admin to download reports in multiple formats for accounting workflows, record keeping, and NDIS audit submissions (REPT-06, REPT-07).

Output: Generic Excel export helper, PDF report template extending existing pdf-styles.ts, all 4 reports updated with working Excel/PDF export.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-reporting-and-export/12-RESEARCH.md
@.planning/phases/12-reporting-and-export/12-01-SUMMARY.md
@.planning/phases/12-reporting-and-export/12-02-SUMMARY.md
@.planning/phases/12-reporting-and-export/12-03-SUMMARY.md
@.planning/phases/12-reporting-and-export/12-04-SUMMARY.md
@apps/admin/components/pdf/pdf-styles.ts
@apps/admin/lib/reports/csv-export.ts
</context>

<tasks>

<task type="auto">
  <name>Create Excel export helper</name>
  <files>apps/admin/lib/reports/excel-export.ts</files>
  <action>
Create SheetJS Excel export helper:

```typescript
import * as XLSX from 'xlsx'
import type { CsvColumn } from './types'

interface ExportToExcelOptions<T> {
  data: T[]
  columns: CsvColumn<T>[]
  filename: string
  sheetName?: string
}

/**
 * Export data to Excel (.xlsx) file using SheetJS.
 * Creates properly formatted Excel file with auto-sized columns.
 *
 * @param options - Export configuration
 * @param options.data - Array of objects to export
 * @param options.columns - Column definitions with headers and formatting
 * @param options.filename - Download filename (without .xlsx extension)
 * @param options.sheetName - Sheet name (default: "Report")
 */
export function exportToExcel<T>({
  data,
  columns,
  filename,
  sheetName = 'Report',
}: ExportToExcelOptions<T>): void {
  // Transform data to array of arrays with headers
  const headers = columns.map((col) => col.header)
  const rows = data.map((row) =>
    columns.map((col) => {
      const value = row[col.key]
      return col.format ? col.format(value) : value
    })
  )

  // Create worksheet and workbook
  const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows])
  const workbook = XLSX.utils.book_new()

  // Auto-width columns based on content
  const maxWidth = headers.map((h, i) =>
    Math.max(
      h.length,
      ...rows.map((r) => String(r[i] || '').length)
    )
  )
  worksheet['!cols'] = maxWidth.map((w) => ({ wch: Math.min(w + 2, 50) })) // Cap at 50 chars

  XLSX.utils.book_append_sheet(workbook, worksheet, sheetName)

  // Trigger download
  XLSX.writeFile(workbook, `${filename}.xlsx`)
}
```

Pattern matches research example. Uses same CsvColumn interface for consistency.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export function exportToExcel" lib/reports/excel-export.ts
grep -E "from 'xlsx'" lib/reports/excel-export.ts
```

Should show function export and xlsx import.
  </verify>
  <done>excel-export.ts exports exportToExcel function using SheetJS with auto-column sizing</done>
</task>

<task type="auto">
  <name>Create PDF report template and utilities</name>
  <files>
    apps/admin/lib/reports/pdf-export.ts
    apps/admin/components/reports/pdf/ReportPdfDocument.tsx
  </files>
  <action>
Create pdf-export.ts utilities:

```typescript
import { renderToBuffer } from '@react-pdf/renderer'
import type { ReactElement } from 'react'

/**
 * Generate PDF buffer from React PDF document.
 * Call registerFonts() before using this function.
 *
 * @param document - React PDF Document element
 * @returns Promise resolving to PDF buffer
 */
export async function generateReportPdf(document: ReactElement): Promise<Buffer> {
  return renderToBuffer(document) as Promise<Buffer>
}

/**
 * Trigger browser download of PDF file.
 *
 * @param pdfBuffer - PDF data as Buffer or Blob
 * @param filename - Download filename (without .pdf extension)
 */
export function downloadPdf(pdfBuffer: Buffer | Blob, filename: string): void {
  const blob = pdfBuffer instanceof Blob
    ? pdfBuffer
    : new Blob([pdfBuffer], { type: 'application/pdf' })

  const url = URL.createObjectURL(blob)

  const link = document.createElement('a')
  link.setAttribute('href', url)
  link.setAttribute('download', `${filename}.pdf`)
  link.style.visibility = 'hidden'

  document.body.appendChild(link)
  link.click()
  document.body.removeChild(link)

  URL.revokeObjectURL(url)
}
```

Create ReportPdfDocument.tsx generic template:

```typescript
import { Document, Page, View, Text, StyleSheet } from '@react-pdf/renderer'
import { styles as baseStyles, registerFonts } from '../../pdf/pdf-styles'

// Register fonts before rendering
registerFonts()

const BRAND_TEAL = '#00BFA5'
const BRAND_GREEN = '#66BB6A'

// Extend base styles for reports
const styles = StyleSheet.create({
  ...baseStyles,
  reportTitle: {
    fontSize: 20,
    fontWeight: 700,
    marginBottom: 10,
    color: BRAND_TEAL,
  },
  dateRange: {
    fontSize: 10,
    color: '#666',
    marginBottom: 20,
  },
  summaryRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    paddingVertical: 8,
    borderBottomWidth: 0.5,
    borderBottomColor: '#eee',
  },
  summaryLabel: {
    fontSize: 10,
    color: '#666',
  },
  summaryValue: {
    fontSize: 10,
    fontWeight: 700,
    color: '#333',
  },
})

interface ReportPdfDocumentProps {
  title: string
  dateRange: string
  summary: Array<{ label: string; value: string | number }>
  children: React.ReactNode
}

export function ReportPdfDocument({
  title,
  dateRange,
  summary,
  children,
}: ReportPdfDocumentProps) {
  return (
    <Document>
      <Page size="A4" style={baseStyles.page}>
        {/* Header */}
        <View style={baseStyles.header}>
          <Text style={baseStyles.companyName}>Ephraim Care</Text>
          <View>
            <Text style={styles.reportTitle}>{title}</Text>
            <Text style={styles.dateRange}>Period: {dateRange}</Text>
          </View>
        </View>

        {/* Summary Stats */}
        <View style={baseStyles.section}>
          {summary.map((stat, index) => (
            <View key={index} style={styles.summaryRow}>
              <Text style={styles.summaryLabel}>{stat.label}</Text>
              <Text style={styles.summaryValue}>{stat.value}</Text>
            </View>
          ))}
        </View>

        {/* Report Content */}
        {children}

        {/* Footer */}
        <Text style={baseStyles.footer}>
          Generated by Ephraim Care â€¢ Powered by OpBros
        </Text>
      </Page>
    </Document>
  )
}
```

Reuses existing pdf-styles.ts brand colors and fonts. Generic template for all reports.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export (async )?function (generateReportPdf|downloadPdf)" lib/reports/pdf-export.ts
grep -E "export function ReportPdfDocument" components/reports/pdf/ReportPdfDocument.tsx
```

Should show all function exports.
  </verify>
  <done>pdf-export.ts provides generateReportPdf and downloadPdf utilities; ReportPdfDocument.tsx provides generic PDF template with branding</done>
</task>

<task type="auto">
  <name>Wire Excel/PDF export to budget and revenue reports</name>
  <files>
    apps/admin/app/(protected)/reports/budget/page.tsx
    apps/admin/app/(protected)/reports/revenue/page.tsx
  </files>
  <action>
Update budget report page to replace Excel/PDF placeholders:

In budget/page.tsx, add imports:
```typescript
import { exportToExcel } from '@/lib/reports/excel-export'
import { generateReportPdf, downloadPdf } from '@/lib/reports/pdf-export'
import { ReportPdfDocument } from '@/components/reports/pdf/ReportPdfDocument'
import { View, Text } from '@react-pdf/renderer'
```

Replace handleExportExcel:
```typescript
const handleExportExcel = () => {
  if (!data) return

  exportToExcel({
    data: data.participants,
    columns: [
      { header: 'Participant Name', key: 'participantName' },
      { header: 'NDIS Number', key: 'ndisNumber' },
      { header: 'Allocated Budget', key: 'allocatedBudget', format: (v) => `$${v.toFixed(2)}` },
      { header: 'Used Budget', key: 'usedBudget', format: (v) => `$${v.toFixed(2)}` },
      { header: 'Remaining Budget', key: 'remainingBudget', format: (v) => `$${v.toFixed(2)}` },
      { header: 'Utilization %', key: 'utilizationPercent', format: (v) => `${v.toFixed(1)}%` },
      { header: 'Alert Status', key: 'alert' },
    ],
    filename: `budget-report-${format(new Date(), 'yyyy-MM-dd')}`,
    sheetName: 'Budget Utilization',
  })
}
```

Replace handleExportPdf:
```typescript
const handleExportPdf = async () => {
  if (!data) return

  const pdfDocument = (
    <ReportPdfDocument
      title="Budget Utilization Report"
      dateRange={`${format(dateRange.from, 'MMM d, yyyy')} - ${format(dateRange.to, 'MMM d, yyyy')}`}
      summary={summary!}
    >
      <View style={{ marginTop: 20 }}>
        {data.participants.slice(0, 20).map((row, index) => (
          <View key={index} style={{
            flexDirection: 'row',
            justifyContent: 'space-between',
            paddingVertical: 4,
            borderBottomWidth: 0.5,
            borderBottomColor: '#eee',
          }}>
            <Text style={{ fontSize: 9, width: '30%' }}>{row.participantName}</Text>
            <Text style={{ fontSize: 9, width: '20%', textAlign: 'right' }}>
              ${row.allocatedBudget.toLocaleString()}
            </Text>
            <Text style={{ fontSize: 9, width: '20%', textAlign: 'right' }}>
              ${row.usedBudget.toLocaleString()}
            </Text>
            <Text style={{ fontSize: 9, width: '15%', textAlign: 'right' }}>
              {row.utilizationPercent.toFixed(1)}%
            </Text>
            <Text style={{ fontSize: 9, width: '15%', textAlign: 'center' }}>
              {row.alert}
            </Text>
          </View>
        ))}
      </View>
    </ReportPdfDocument>
  )

  const pdfBuffer = await generateReportPdf(pdfDocument)
  const filename = `budget-report-${format(new Date(), 'yyyy-MM-dd')}`
  downloadPdf(pdfBuffer, filename)
}
```

Apply same pattern to revenue report page (revenue/page.tsx) with monthly data structure.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "exportToExcel|generateReportPdf" app/\(protected\)/reports/budget/page.tsx
grep -E "exportToExcel|generateReportPdf" app/\(protected\)/reports/revenue/page.tsx
```

Should show export function usage in both files.
  </verify>
  <done>Budget and revenue report pages have working Excel and PDF export</done>
</task>

<task type="auto">
  <name>Wire Excel/PDF export to worker hours and participant activity reports</name>
  <files>
    apps/admin/app/(protected)/reports/worker-hours/page.tsx
    apps/admin/app/(protected)/reports/participant-activity/page.tsx
  </files>
  <action>
Apply same Excel/PDF export pattern to worker-hours/page.tsx and participant-activity/page.tsx:

Add imports, replace placeholder functions with exportToExcel and generateReportPdf calls.

For worker-hours:
```typescript
const handleExportExcel = () => {
  if (!data) return

  exportToExcel({
    data,
    columns: [
      { header: 'Worker Name', key: 'workerName' },
      { header: 'Shift Count', key: 'shiftCount' },
      { header: 'Total Hours', key: 'totalHours', format: (v) => v.toFixed(2) },
      { header: 'Avg Hours/Shift', key: 'averageHoursPerShift', format: (v) => v.toFixed(2) },
    ],
    filename: `worker-hours-${format(new Date(), 'yyyy-MM-dd')}`,
    sheetName: 'Worker Hours',
  })
}
```

For participant-activity:
```typescript
const handleExportExcel = () => {
  if (!data) return

  exportToExcel({
    data,
    columns: [
      { header: 'Participant Name', key: 'participantName' },
      { header: 'Shift Count', key: 'shiftCount' },
      { header: 'Total Hours', key: 'totalHours', format: (v) => v.toFixed(2) },
      { header: 'Last Shift Date', key: 'lastShiftDate' },
    ],
    filename: `participant-activity-${format(new Date(), 'yyyy-MM-dd')}`,
    sheetName: 'Participant Activity',
  })
}
```

PDF export follows same ReportPdfDocument pattern as budget report.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "exportToExcel" app/\(protected\)/reports/worker-hours/page.tsx
grep -E "exportToExcel" app/\(protected\)/reports/participant-activity/page.tsx
```

Should show export function usage.
  </verify>
  <done>Worker hours and participant activity reports have working Excel and PDF export</done>
</task>

</tasks>

<verification>
1. Visit each report page (budget, revenue, worker-hours, participant-activity)
2. Click Export -> Excel and verify .xlsx file downloads
3. Open Excel file and verify columns, formatting, and data integrity
4. Click Export -> PDF and verify PDF downloads
5. Open PDF and verify Ephraim Care branding, report title, date range, data table
6. Verify PDF uses Inter fonts and brand colors (teal/green)
7. TypeScript compiles without errors
</verification>

<success_criteria>
1. All 4 reports can export to Excel with proper .xlsx format
2. Excel files have auto-sized columns and formatted values
3. All 4 reports can export to PDF with Ephraim Care branding
4. PDFs display report title, date range, summary stats, and data table
5. PDF uses established brand colors and Inter fonts
</success_criteria>

<output>
After completion, create `.planning/phases/12-reporting-and-export/12-05-SUMMARY.md`
</output>
