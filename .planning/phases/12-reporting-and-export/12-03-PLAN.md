---
phase: 12-reporting-and-export
plan: 03
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - apps/admin/hooks/use-revenue-report.ts
  - apps/admin/components/reports/charts/RevenueLineChart.tsx
  - apps/admin/app/(protected)/reports/revenue/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view monthly revenue trends with line chart"
    - "Revenue report shows support type breakdown"
    - "Report displays invoice count and GST separately"
    - "Report can be filtered by date range and exported as CSV"
  artifacts:
    - path: "apps/admin/hooks/use-revenue-report.ts"
      provides: "Revenue data aggregation by month"
      exports: ["useRevenueReport"]
    - path: "apps/admin/components/reports/charts/RevenueLineChart.tsx"
      provides: "Recharts line chart for revenue trends"
      min_lines: 40
    - path: "apps/admin/app/(protected)/reports/revenue/page.tsx"
      provides: "Revenue report page with chart and table"
      min_lines: 100
  key_links:
    - from: "apps/admin/hooks/use-revenue-report.ts"
      to: "invoices table"
      via: "Supabase query with date aggregation"
      pattern: "\\.from\\('invoices'\\)"
---

<objective>
Build revenue trends report showing monthly revenue breakdown with line chart and support type analysis.

Purpose: Provide admin with financial overview of invoice revenue trends over time. Supports accounting workflows and financial reporting (REPT-02).

Output: Revenue report page with line chart, monthly breakdown table, support type analysis, CSV export, date range filtering.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-reporting-and-export/12-RESEARCH.md
@.planning/phases/12-reporting-and-export/12-01-SUMMARY.md
@apps/admin/hooks/use-invoices.ts
@apps/admin/lib/reports/types.ts
</context>

<tasks>

<task type="auto">
  <name>Create revenue report data hook</name>
  <files>apps/admin/hooks/use-revenue-report.ts</files>
  <action>
Create TanStack Query hook to aggregate invoice revenue by month:

```typescript
'use client'

import { useQuery } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'
import { format, startOfMonth, eachMonthOfInterval } from 'date-fns'
import type { RevenueReportRow } from '@/lib/reports/types'

interface RevenueReportFilters {
  dateFrom?: Date
  dateTo?: Date
  supportType?: string
}

interface RevenueReportData {
  months: RevenueReportRow[]
  supportTypeBreakdown: Array<{
    supportType: string
    revenue: number
    percentage: number
  }>
  totals: {
    totalRevenue: number
    totalInvoices: number
    totalGst: number
  }
}

export function useRevenueReport(filters: RevenueReportFilters) {
  return useQuery<RevenueReportData>({
    queryKey: ['revenue-report', filters],
    queryFn: async () => {
      const supabase = createClient()

      // Fetch finalized invoices with line items
      let query = supabase
        .from('invoices')
        .select(`
          id,
          invoice_date,
          total,
          subtotal,
          gst,
          invoice_line_items(support_type, line_total)
        `)
        .in('status', ['submitted', 'paid'])

      if (filters.dateFrom) {
        query = query.gte('invoice_date', format(filters.dateFrom, 'yyyy-MM-dd'))
      }
      if (filters.dateTo) {
        query = query.lte('invoice_date', format(filters.dateTo, 'yyyy-MM-dd'))
      }

      const { data, error } = await query

      if (error) throw error

      // Generate all months in range (even if no data)
      const monthsInRange = filters.dateFrom && filters.dateTo
        ? eachMonthOfInterval({ start: filters.dateFrom, end: filters.dateTo })
        : [startOfMonth(new Date())]

      // Aggregate by month
      const monthMap = new Map<string, { count: number; total: number; subtotal: number; gst: number }>()

      for (const invoice of data ?? []) {
        const monthKey = format(new Date(invoice.invoice_date + 'T00:00:00'), 'yyyy-MM')
        const existing = monthMap.get(monthKey) || { count: 0, total: 0, subtotal: 0, gst: 0 }

        existing.count += 1
        existing.total += Number(invoice.total) || 0
        existing.subtotal += Number(invoice.subtotal) || 0
        existing.gst += Number(invoice.gst) || 0

        monthMap.set(monthKey, existing)
      }

      // Transform to report format
      const months: RevenueReportRow[] = monthsInRange.map((date) => {
        const monthKey = format(date, 'yyyy-MM')
        const monthData = monthMap.get(monthKey) || { count: 0, total: 0, subtotal: 0, gst: 0 }

        return {
          month: format(date, 'MMM yyyy'),
          invoiceCount: monthData.count,
          totalRevenue: monthData.total,
          subtotal: monthData.subtotal,
          gst: monthData.gst,
        }
      })

      // Support type breakdown
      const supportTypeMap = new Map<string, number>()
      for (const invoice of data ?? []) {
        for (const item of invoice.invoice_line_items ?? []) {
          const existing = supportTypeMap.get(item.support_type) || 0
          supportTypeMap.set(item.support_type, existing + (Number(item.line_total) || 0))
        }
      }

      const totalRevenue = Array.from(supportTypeMap.values()).reduce((sum, val) => sum + val, 0)
      const supportTypeBreakdown = Array.from(supportTypeMap.entries())
        .map(([supportType, revenue]) => ({
          supportType,
          revenue,
          percentage: totalRevenue > 0 ? Math.round((revenue / totalRevenue) * 1000) / 10 : 0,
        }))
        .sort((a, b) => b.revenue - a.revenue)

      // Calculate totals
      const totals = months.reduce(
        (acc, m) => ({
          totalRevenue: acc.totalRevenue + m.totalRevenue,
          totalInvoices: acc.totalInvoices + m.invoiceCount,
          totalGst: acc.totalGst + m.gst,
        }),
        { totalRevenue: 0, totalInvoices: 0, totalGst: 0 }
      )

      return { months, supportTypeBreakdown, totals }
    },
    staleTime: 5 * 60 * 1000, // 5 minutes
  })
}
```

Pattern matches budget report hook. Generates all months in range even if no invoices (shows $0).
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export function useRevenueReport" hooks/use-revenue-report.ts
grep -E "supportTypeBreakdown" hooks/use-revenue-report.ts
```

Should show hook export and support type breakdown logic.
  </verify>
  <done>useRevenueReport hook aggregates invoices by month, calculates support type breakdown, and returns totals</done>
</task>

<task type="auto">
  <name>Create revenue line chart component</name>
  <files>apps/admin/components/reports/charts/RevenueLineChart.tsx</files>
  <action>
Create line chart for revenue trends:

```typescript
'use client'

import { ResponsiveContainer, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts'
import type { RevenueReportRow } from '@/lib/reports/types'

interface RevenueLineChartProps {
  data: RevenueReportRow[]
}

export function RevenueLineChart({ data }: RevenueLineChartProps) {
  // Transform for Recharts
  const chartData = data.map((row) => ({
    month: row.month,
    revenue: row.totalRevenue,
    subtotal: row.subtotal,
    gst: row.gst,
  }))

  return (
    <ResponsiveContainer width="100%" height={400}>
      <LineChart data={chartData} margin={{ top: 20, right: 30, left: 20, bottom: 5 }}>
        <CartesianGrid strokeDasharray="3 3" />
        <XAxis
          dataKey="month"
          style={{ fontSize: '12px' }}
        />
        <YAxis
          tickFormatter={(value: number) => `$${(value / 1000).toFixed(0)}k`}
          style={{ fontSize: '12px' }}
        />
        <Tooltip
          formatter={(value: number) => `$${value.toLocaleString()}`}
          contentStyle={{ fontSize: '12px' }}
        />
        <Legend wrapperStyle={{ fontSize: '12px', paddingTop: '20px' }} />
        <Line
          type="monotone"
          dataKey="revenue"
          name="Total Revenue"
          stroke="#00BFA5"
          strokeWidth={3}
          dot={{ r: 4 }}
        />
        <Line
          type="monotone"
          dataKey="subtotal"
          name="Subtotal (ex GST)"
          stroke="#66BB6A"
          strokeWidth={2}
          dot={{ r: 3 }}
        />
      </LineChart>
    </ResponsiveContainer>
  )
}
```

Uses brand colors. Shows total revenue as primary line, subtotal as secondary.
  </action>
  <verify>
```bash
grep "'use client'" /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin/components/reports/charts/RevenueLineChart.tsx
grep -E "LineChart.*from 'recharts'" /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin/components/reports/charts/RevenueLineChart.tsx
```

Should show client directive and LineChart import.
  </verify>
  <done>RevenueLineChart.tsx renders line chart with total revenue and subtotal trends over months</done>
</task>

<task type="auto">
  <name>Create revenue report page</name>
  <files>apps/admin/app/(protected)/reports/revenue/page.tsx</files>
  <action>
Create revenue report page with monthly breakdown and support type analysis:

```typescript
'use client'

import { useState } from 'react'
import { subMonths, startOfMonth, endOfMonth } from 'date-fns'
import { ReportLayout } from '@/components/reports/ReportLayout'
import { DateRangePicker } from '@/components/reports/DateRangePicker'
import { ExportButtons } from '@/components/reports/ExportButtons'
import { RevenueLineChart } from '@/components/reports/charts/RevenueLineChart'
import { ChartCard } from '@/components/reports/charts/ChartCard'
import { useRevenueReport } from '@/hooks/use-revenue-report'
import { generateCsv, downloadCsv } from '@/lib/reports/csv-export'
import { format } from 'date-fns'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

export default function RevenueReportPage() {
  const [dateRange, setDateRange] = useState({
    from: subMonths(startOfMonth(new Date()), 6), // Last 6 months
    to: endOfMonth(new Date()),
  })

  const { data, isLoading, error } = useRevenueReport({
    dateFrom: dateRange.from,
    dateTo: dateRange.to,
  })

  const handleExportCsv = () => {
    if (!data) return

    const csv = generateCsv(data.months, [
      { header: 'Month', key: 'month' },
      { header: 'Invoice Count', key: 'invoiceCount' },
      { header: 'Total Revenue', key: 'totalRevenue', format: (v) => `$${v.toFixed(2)}` },
      { header: 'Subtotal (ex GST)', key: 'subtotal', format: (v) => `$${v.toFixed(2)}` },
      { header: 'GST', key: 'gst', format: (v) => `$${v.toFixed(2)}` },
    ])

    const filename = `revenue-report-${format(new Date(), 'yyyy-MM-dd')}`
    downloadCsv(csv, filename)
  }

  const summary = data
    ? [
        {
          label: 'Total Revenue',
          value: `$${data.totals.totalRevenue.toLocaleString()}`,
        },
        {
          label: 'Total Invoices',
          value: data.totals.totalInvoices,
        },
        {
          label: 'Total GST',
          value: `$${data.totals.totalGst.toLocaleString()}`,
        },
        {
          label: 'Months',
          value: data.months.length,
        },
      ]
    : undefined

  return (
    <ReportLayout
      title="Revenue Trends Report"
      description="Monthly revenue breakdown with support type analysis"
      isLoading={isLoading}
      summary={summary}
      filters={<DateRangePicker value={dateRange} onChange={setDateRange} />}
      exportButtons={
        <ExportButtons
          onExportCsv={handleExportCsv}
          onExportExcel={() => console.log('Excel not yet implemented')}
          onExportPdf={() => console.log('PDF not yet implemented')}
          disabled={!data || data.months.length === 0}
        />
      }
    >
      {error && (
        <div className="text-sm text-destructive">
          Error loading report: {error.message}
        </div>
      )}

      {data && (
        <div className="space-y-6">
          {/* Line Chart */}
          <ChartCard
            title="Revenue Trend"
            description="Monthly revenue over selected period"
          >
            <RevenueLineChart data={data.months} />
          </ChartCard>

          {/* Support Type Breakdown */}
          <Card>
            <CardHeader>
              <CardTitle>Revenue by Support Type</CardTitle>
              <CardDescription>Total revenue breakdown by service category</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-2">
                {data.supportTypeBreakdown.map((row) => (
                  <div key={row.supportType} className="flex items-center justify-between">
                    <span className="text-sm">{row.supportType}</span>
                    <div className="flex items-center gap-4">
                      <span className="text-sm text-muted-foreground">
                        {row.percentage.toFixed(1)}%
                      </span>
                      <span className="text-sm font-medium">
                        ${row.revenue.toLocaleString()}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>

          {/* Monthly Table */}
          <div className="rounded-lg border">
            <table className="w-full text-sm">
              <thead className="border-b bg-muted/50">
                <tr>
                  <th className="p-3 text-left font-medium">Month</th>
                  <th className="p-3 text-right font-medium">Invoices</th>
                  <th className="p-3 text-right font-medium">Total Revenue</th>
                  <th className="p-3 text-right font-medium">Subtotal</th>
                  <th className="p-3 text-right font-medium">GST</th>
                </tr>
              </thead>
              <tbody>
                {data.months.map((row) => (
                  <tr key={row.month} className="border-b hover:bg-muted/20">
                    <td className="p-3">{row.month}</td>
                    <td className="p-3 text-right">{row.invoiceCount}</td>
                    <td className="p-3 text-right">
                      ${row.totalRevenue.toLocaleString()}
                    </td>
                    <td className="p-3 text-right">
                      ${row.subtotal.toLocaleString()}
                    </td>
                    <td className="p-3 text-right">
                      ${row.gst.toLocaleString()}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </ReportLayout>
  )
}
```

Defaults to 6-month view. Shows support type breakdown as separate card.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "useRevenueReport" app/\(protected\)/reports/revenue/page.tsx
grep -E "supportTypeBreakdown" app/\(protected\)/reports/revenue/page.tsx
```

Should show hook usage and support type breakdown rendering.
  </verify>
  <done>Revenue report page shows line chart, support type breakdown card, monthly table, CSV export, and date range filter</done>
</task>

</tasks>

<verification>
1. Visit /reports/revenue and see revenue line chart
2. Change date range and see chart update
3. Click Export -> CSV and download revenue report
4. Verify support type breakdown shows percentages and totals
5. Verify monthly table shows invoice count, revenue, subtotal, GST
6. TypeScript compiles without errors
</verification>

<success_criteria>
1. Revenue report displays monthly revenue trends in line chart
2. Support type breakdown shows revenue and percentage per category
3. Monthly table displays invoice count, revenue, subtotal, and GST
4. Date range filter updates report when changed
5. CSV export downloads file with all monthly data
</success_criteria>

<output>
After completion, create `.planning/phases/12-reporting-and-export/12-03-SUMMARY.md`
</output>
