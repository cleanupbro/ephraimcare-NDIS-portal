---
phase: 12-reporting-and-export
plan: 04
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - apps/admin/hooks/use-worker-hours-report.ts
  - apps/admin/hooks/use-participant-activity-report.ts
  - apps/admin/app/(protected)/reports/worker-hours/page.tsx
  - apps/admin/app/(protected)/reports/participant-activity/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view worker hours with per-worker statistics"
    - "Admin can view participant activity with shift history"
    - "Both reports show total hours and shift counts"
    - "Reports can be filtered by date range and exported as CSV"
  artifacts:
    - path: "apps/admin/hooks/use-worker-hours-report.ts"
      provides: "Worker hours aggregation"
      exports: ["useWorkerHoursReport"]
    - path: "apps/admin/hooks/use-participant-activity-report.ts"
      provides: "Participant activity aggregation"
      exports: ["useParticipantActivityReport"]
    - path: "apps/admin/app/(protected)/reports/worker-hours/page.tsx"
      provides: "Worker hours report page"
      min_lines: 80
    - path: "apps/admin/app/(protected)/reports/participant-activity/page.tsx"
      provides: "Participant activity report page"
      min_lines: 80
  key_links:
    - from: "apps/admin/hooks/use-worker-hours-report.ts"
      to: "shifts table"
      via: "Supabase query with worker join"
      pattern: "\\.from\\('shifts'\\)"
---

<objective>
Build worker hours and participant activity reports showing shift-level statistics for operational oversight.

Purpose: Provide admin with visibility into worker hours worked and participant service utilization. Supports payroll workflows and participant engagement tracking (REPT-03, REPT-04).

Output: Two report pages (worker hours, participant activity) with CSV export, filtering, summary stats, and tabular data.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-reporting-and-export/12-RESEARCH.md
@.planning/phases/12-reporting-and-export/12-01-SUMMARY.md
@apps/admin/hooks/use-shifts.ts
@apps/admin/lib/reports/types.ts
</context>

<tasks>

<task type="auto">
  <name>Create worker hours and participant activity hooks</name>
  <files>
    apps/admin/hooks/use-worker-hours-report.ts
    apps/admin/hooks/use-participant-activity-report.ts
  </files>
  <action>
Create use-worker-hours-report.ts:

```typescript
'use client'

import { useQuery } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'
import { format } from 'date-fns'
import type { WorkerHoursRow } from '@/lib/reports/types'

interface WorkerHoursFilters {
  dateFrom?: Date
  dateTo?: Date
  workerId?: string
}

export function useWorkerHoursReport(filters: WorkerHoursFilters) {
  return useQuery({
    queryKey: ['worker-hours-report', filters],
    queryFn: async () => {
      const supabase = createClient()

      let query = supabase
        .from('shifts')
        .select(`
          id,
          scheduled_start,
          scheduled_end,
          actual_start,
          actual_end,
          workers!inner(id, profile:profiles!inner(first_name, last_name))
        `)
        .eq('status', 'completed')

      if (filters.dateFrom) {
        query = query.gte('scheduled_start', filters.dateFrom.toISOString())
      }
      if (filters.dateTo) {
        query = query.lte('scheduled_end', filters.dateTo.toISOString())
      }
      if (filters.workerId && filters.workerId !== 'all') {
        query = query.eq('worker_id', filters.workerId)
      }

      const { data, error } = await query

      if (error) throw error

      // Aggregate by worker
      const workerMap = new Map<string, {
        name: string
        shiftCount: number
        totalHours: number
      }>()

      for (const shift of data ?? []) {
        const worker = shift.workers
        if (!worker || !shift.actual_start || !shift.actual_end) continue

        const workerId = worker.id
        const existing = workerMap.get(workerId) || {
          name: `${worker.profile.first_name} ${worker.profile.last_name}`,
          shiftCount: 0,
          totalHours: 0,
        }

        const start = new Date(shift.actual_start)
        const end = new Date(shift.actual_end)
        const hours = (end.getTime() - start.getTime()) / (1000 * 60 * 60)

        existing.shiftCount += 1
        existing.totalHours += hours

        workerMap.set(workerId, existing)
      }

      // Transform to report format
      const workers: WorkerHoursRow[] = Array.from(workerMap.entries()).map(([id, w]) => ({
        workerId: id,
        workerName: w.name,
        shiftCount: w.shiftCount,
        totalHours: Math.round(w.totalHours * 100) / 100,
        averageHoursPerShift: Math.round((w.totalHours / w.shiftCount) * 100) / 100,
      }))

      // Sort by total hours descending
      workers.sort((a, b) => b.totalHours - a.totalHours)

      return workers
    },
    staleTime: 10 * 60 * 1000, // 10 minutes
  })
}
```

Create use-participant-activity-report.ts:

```typescript
'use client'

import { useQuery } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'
import { format } from 'date-fns'
import type { ParticipantActivityRow } from '@/lib/reports/types'

interface ParticipantActivityFilters {
  dateFrom?: Date
  dateTo?: Date
  participantId?: string
}

export function useParticipantActivityReport(filters: ParticipantActivityFilters) {
  return useQuery({
    queryKey: ['participant-activity-report', filters],
    queryFn: async () => {
      const supabase = createClient()

      let query = supabase
        .from('shifts')
        .select(`
          id,
          scheduled_start,
          actual_start,
          actual_end,
          participants!inner(id, first_name, last_name)
        `)
        .eq('status', 'completed')

      if (filters.dateFrom) {
        query = query.gte('scheduled_start', filters.dateFrom.toISOString())
      }
      if (filters.dateTo) {
        query = query.lte('scheduled_start', filters.dateTo.toISOString())
      }
      if (filters.participantId && filters.participantId !== 'all') {
        query = query.eq('participant_id', filters.participantId)
      }

      const { data, error } = await query

      if (error) throw error

      // Aggregate by participant
      const participantMap = new Map<string, {
        name: string
        shiftCount: number
        totalHours: number
        lastShiftDate: Date | null
      }>()

      for (const shift of data ?? []) {
        const participant = shift.participants
        if (!participant) continue

        const participantId = participant.id
        const existing = participantMap.get(participantId) || {
          name: `${participant.first_name} ${participant.last_name}`,
          shiftCount: 0,
          totalHours: 0,
          lastShiftDate: null,
        }

        existing.shiftCount += 1

        if (shift.actual_start && shift.actual_end) {
          const start = new Date(shift.actual_start)
          const end = new Date(shift.actual_end)
          const hours = (end.getTime() - start.getTime()) / (1000 * 60 * 60)
          existing.totalHours += hours
        }

        const shiftDate = new Date(shift.scheduled_start)
        if (!existing.lastShiftDate || shiftDate > existing.lastShiftDate) {
          existing.lastShiftDate = shiftDate
        }

        participantMap.set(participantId, existing)
      }

      // Transform to report format
      const participants: ParticipantActivityRow[] = Array.from(participantMap.entries()).map(([id, p]) => ({
        participantId: id,
        participantName: p.name,
        shiftCount: p.shiftCount,
        totalHours: Math.round(p.totalHours * 100) / 100,
        lastShiftDate: p.lastShiftDate ? format(p.lastShiftDate, 'yyyy-MM-dd') : null,
      }))

      // Sort by shift count descending
      participants.sort((a, b) => b.shiftCount - a.shiftCount)

      return participants
    },
    staleTime: 10 * 60 * 1000, // 10 minutes
  })
}
```

Both hooks aggregate shift data by entity (worker or participant).
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "export function use(WorkerHours|ParticipantActivity)Report" hooks/use-*-report.ts
```

Should show both hook exports.
  </verify>
  <done>useWorkerHoursReport aggregates completed shifts by worker; useParticipantActivityReport aggregates by participant</done>
</task>

<task type="auto">
  <name>Create worker hours report page</name>
  <files>apps/admin/app/(protected)/reports/worker-hours/page.tsx</files>
  <action>
Create worker hours report page:

```typescript
'use client'

import { useState } from 'react'
import { startOfMonth, endOfMonth } from 'date-fns'
import { ReportLayout } from '@/components/reports/ReportLayout'
import { DateRangePicker } from '@/components/reports/DateRangePicker'
import { ReportFilters } from '@/components/reports/ReportFilters'
import { ExportButtons } from '@/components/reports/ExportButtons'
import { useWorkerHoursReport } from '@/hooks/use-worker-hours-report'
import { generateCsv, downloadCsv } from '@/lib/reports/csv-export'
import { format } from 'date-fns'

export default function WorkerHoursReportPage() {
  const [dateRange, setDateRange] = useState({
    from: startOfMonth(new Date()),
    to: endOfMonth(new Date()),
  })
  const [selectedWorker, setSelectedWorker] = useState<string>('all')

  const { data, isLoading, error } = useWorkerHoursReport({
    dateFrom: dateRange.from,
    dateTo: dateRange.to,
    workerId: selectedWorker,
  })

  const handleExportCsv = () => {
    if (!data) return

    const csv = generateCsv(data, [
      { header: 'Worker Name', key: 'workerName' },
      { header: 'Shift Count', key: 'shiftCount' },
      { header: 'Total Hours', key: 'totalHours', format: (v) => v.toFixed(2) },
      { header: 'Avg Hours/Shift', key: 'averageHoursPerShift', format: (v) => v.toFixed(2) },
    ])

    const filename = `worker-hours-${format(new Date(), 'yyyy-MM-dd')}`
    downloadCsv(csv, filename)
  }

  const totals = data
    ? {
        totalShifts: data.reduce((sum, w) => sum + w.shiftCount, 0),
        totalHours: data.reduce((sum, w) => sum + w.totalHours, 0),
        avgHours: data.length > 0
          ? data.reduce((sum, w) => sum + w.totalHours, 0) / data.length
          : 0,
      }
    : null

  const summary = totals
    ? [
        { label: 'Total Workers', value: data?.length || 0 },
        { label: 'Total Shifts', value: totals.totalShifts },
        { label: 'Total Hours', value: `${totals.totalHours.toFixed(1)}h` },
        { label: 'Avg Hours/Worker', value: `${totals.avgHours.toFixed(1)}h` },
      ]
    : undefined

  return (
    <ReportLayout
      title="Worker Hours Report"
      description="Worker shift statistics and hours worked per period"
      isLoading={isLoading}
      summary={summary}
      filters={
        <>
          <DateRangePicker value={dateRange} onChange={setDateRange} />
          <ReportFilters
            selectedWorker={selectedWorker}
            onWorkerChange={setSelectedWorker}
          />
        </>
      }
      exportButtons={
        <ExportButtons
          onExportCsv={handleExportCsv}
          onExportExcel={() => console.log('Excel not implemented')}
          onExportPdf={() => console.log('PDF not implemented')}
          disabled={!data || data.length === 0}
        />
      }
    >
      {error && (
        <div className="text-sm text-destructive">
          Error loading report: {error.message}
        </div>
      )}

      {data && (
        <div className="rounded-lg border">
          <table className="w-full text-sm">
            <thead className="border-b bg-muted/50">
              <tr>
                <th className="p-3 text-left font-medium">Worker Name</th>
                <th className="p-3 text-right font-medium">Shift Count</th>
                <th className="p-3 text-right font-medium">Total Hours</th>
                <th className="p-3 text-right font-medium">Avg Hours/Shift</th>
              </tr>
            </thead>
            <tbody>
              {data.map((row) => (
                <tr key={row.workerId} className="border-b hover:bg-muted/20">
                  <td className="p-3">{row.workerName}</td>
                  <td className="p-3 text-right">{row.shiftCount}</td>
                  <td className="p-3 text-right">{row.totalHours.toFixed(2)}</td>
                  <td className="p-3 text-right">{row.averageHoursPerShift.toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </ReportLayout>
  )
}
```

Simple tabular report. No chart needed for worker hours (line items already clear).
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "useWorkerHoursReport" app/\(protected\)/reports/worker-hours/page.tsx
```

Should show hook usage.
  </verify>
  <done>Worker hours report page shows table with worker name, shift count, total hours, average hours per shift</done>
</task>

<task type="auto">
  <name>Create participant activity report page</name>
  <files>apps/admin/app/(protected)/reports/participant-activity/page.tsx</files>
  <action>
Create participant activity report page:

```typescript
'use client'

import { useState } from 'react'
import { startOfMonth, endOfMonth } from 'date-fns'
import { ReportLayout } from '@/components/reports/ReportLayout'
import { DateRangePicker } from '@/components/reports/DateRangePicker'
import { ReportFilters } from '@/components/reports/ReportFilters'
import { ExportButtons } from '@/components/reports/ExportButtons'
import { useParticipantActivityReport } from '@/hooks/use-participant-activity-report'
import { generateCsv, downloadCsv } from '@/lib/reports/csv-export'
import { format } from 'date-fns'

export default function ParticipantActivityReportPage() {
  const [dateRange, setDateRange] = useState({
    from: startOfMonth(new Date()),
    to: endOfMonth(new Date()),
  })
  const [selectedParticipant, setSelectedParticipant] = useState<string>('all')

  const { data, isLoading, error } = useParticipantActivityReport({
    dateFrom: dateRange.from,
    dateTo: dateRange.to,
    participantId: selectedParticipant,
  })

  const handleExportCsv = () => {
    if (!data) return

    const csv = generateCsv(data, [
      { header: 'Participant Name', key: 'participantName' },
      { header: 'Shift Count', key: 'shiftCount' },
      { header: 'Total Hours', key: 'totalHours', format: (v) => v.toFixed(2) },
      { header: 'Last Shift Date', key: 'lastShiftDate' },
    ])

    const filename = `participant-activity-${format(new Date(), 'yyyy-MM-dd')}`
    downloadCsv(csv, filename)
  }

  const totals = data
    ? {
        totalShifts: data.reduce((sum, p) => sum + p.shiftCount, 0),
        totalHours: data.reduce((sum, p) => sum + p.totalHours, 0),
      }
    : null

  const summary = totals
    ? [
        { label: 'Total Participants', value: data?.length || 0 },
        { label: 'Total Shifts', value: totals.totalShifts },
        { label: 'Total Hours', value: `${totals.totalHours.toFixed(1)}h` },
        { label: 'Avg Shifts/Participant', value: data && data.length > 0 ? (totals.totalShifts / data.length).toFixed(1) : '0' },
      ]
    : undefined

  return (
    <ReportLayout
      title="Participant Activity Report"
      description="Shift history and activity summary per participant"
      isLoading={isLoading}
      summary={summary}
      filters={
        <>
          <DateRangePicker value={dateRange} onChange={setDateRange} />
          <ReportFilters
            selectedParticipant={selectedParticipant}
            onParticipantChange={setSelectedParticipant}
          />
        </>
      }
      exportButtons={
        <ExportButtons
          onExportCsv={handleExportCsv}
          onExportExcel={() => console.log('Excel not implemented')}
          onExportPdf={() => console.log('PDF not implemented')}
          disabled={!data || data.length === 0}
        />
      }
    >
      {error && (
        <div className="text-sm text-destructive">
          Error loading report: {error.message}
        </div>
      )}

      {data && (
        <div className="rounded-lg border">
          <table className="w-full text-sm">
            <thead className="border-b bg-muted/50">
              <tr>
                <th className="p-3 text-left font-medium">Participant Name</th>
                <th className="p-3 text-right font-medium">Shift Count</th>
                <th className="p-3 text-right font-medium">Total Hours</th>
                <th className="p-3 text-left font-medium">Last Shift Date</th>
              </tr>
            </thead>
            <tbody>
              {data.map((row) => (
                <tr key={row.participantId} className="border-b hover:bg-muted/20">
                  <td className="p-3">{row.participantName}</td>
                  <td className="p-3 text-right">{row.shiftCount}</td>
                  <td className="p-3 text-right">{row.totalHours.toFixed(2)}</td>
                  <td className="p-3">{row.lastShiftDate || 'N/A'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </ReportLayout>
  )
}
```

Shows last shift date for participant engagement tracking.
  </action>
  <verify>
```bash
cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026/apps/admin
grep -E "useParticipantActivityReport" app/\(protected\)/reports/participant-activity/page.tsx
```

Should show hook usage.
  </verify>
  <done>Participant activity report page shows table with participant name, shift count, total hours, last shift date</done>
</task>

</tasks>

<verification>
1. Visit /reports/worker-hours and see worker hours table
2. Visit /reports/participant-activity and see participant activity table
3. Export both reports as CSV and verify data integrity
4. Filter by date range and see updated results
5. Verify summary stats calculate correctly
6. TypeScript compiles without errors
</verification>

<success_criteria>
1. Worker hours report shows shift count, total hours, and average hours per shift for each worker
2. Participant activity report shows shift count, total hours, and last shift date for each participant
3. Both reports can be filtered by date range and entity (worker/participant)
4. CSV export works for both reports
5. Summary statistics display correct aggregated totals
</success_criteria>

<output>
After completion, create `.planning/phases/12-reporting-and-export/12-04-SUMMARY.md`
</output>
