---
phase: 06-case-notes
plan: 04
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - apps/worker-mobile/hooks/usePendingNoteShifts.ts
  - apps/worker-mobile/hooks/useEditCaseNote.ts
  - apps/worker-mobile/app/(tabs)/notes.tsx
  - apps/worker-mobile/app/(tabs)/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "My Notes tab shows completed shifts within 24 hours that do not yet have a case note"
    - "Tapping a pending shift item opens the CaseNoteModal for that shift"
    - "Worker can edit an existing note within the 24-hour window"
    - "Tab bar badge shows the count of pending shifts needing notes"
    - "Shifts older than 24 hours do not appear in the pending list"
    - "After writing a note, the shift disappears from the pending list"
  artifacts:
    - path: "apps/worker-mobile/hooks/usePendingNoteShifts.ts"
      provides: "Query for completed shifts within 24h without case notes"
      exports: ["usePendingNoteShifts"]
    - path: "apps/worker-mobile/hooks/useEditCaseNote.ts"
      provides: "Mutation for updating existing case notes within 24h window"
      exports: ["useEditCaseNote"]
    - path: "apps/worker-mobile/app/(tabs)/notes.tsx"
      provides: "My Notes tab with pending shifts list and note creation/edit flow"
      contains: "PendingNoteShifts"
    - path: "apps/worker-mobile/app/(tabs)/_layout.tsx"
      provides: "Tab bar badge for pending notes count"
      contains: "tabBarBadge"
  key_links:
    - from: "apps/worker-mobile/app/(tabs)/notes.tsx"
      to: "apps/worker-mobile/hooks/usePendingNoteShifts.ts"
      via: "usePendingNoteShifts hook for pending list data"
      pattern: "usePendingNoteShifts"
    - from: "apps/worker-mobile/app/(tabs)/notes.tsx"
      to: "apps/worker-mobile/components/CaseNoteModal.tsx"
      via: "Modal shown when pending shift is tapped"
      pattern: "CaseNoteModal"
    - from: "apps/worker-mobile/app/(tabs)/_layout.tsx"
      to: "apps/worker-mobile/hooks/usePendingNoteShifts.ts"
      via: "Badge count from pending shifts query"
      pattern: "tabBarBadge"
---

<objective>
Build the My Notes tab showing pending shifts that need case notes (within 24h window) with tab bar badge, and add edit capability for existing notes.

Purpose: Workers who skip the case note at checkout need a way to come back and write it within the 24-hour window. The badge provides a visual reminder that notes are pending.
Output: Working My Notes tab with pending shift list, tap-to-create flow, edit existing notes, and badge count.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-case-notes/06-02-SUMMARY.md
@apps/worker-mobile/app/(tabs)/notes.tsx
@apps/worker-mobile/app/(tabs)/_layout.tsx
@apps/worker-mobile/hooks/useCreateCaseNote.ts
@apps/worker-mobile/components/CaseNoteModal.tsx
@apps/worker-mobile/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePendingNoteShifts and useEditCaseNote hooks</name>
  <files>apps/worker-mobile/hooks/usePendingNoteShifts.ts, apps/worker-mobile/hooks/useEditCaseNote.ts</files>
  <action>
**usePendingNoteShifts.ts:**

Create a hook that fetches completed shifts within the 24-hour window that do not yet have a case note:

```typescript
import { useQuery } from '@tanstack/react-query'
import { supabase } from '../lib/supabase'

interface PendingNoteShift {
  shiftId: string
  participantId: string
  participantName: string
  checkOutTime: string
  durationMinutes: number
  scheduledStart: string
  scheduledEnd: string
  organizationId: string
  existingNote?: {
    id: string
    content: string
    concernFlag: boolean
    concernText?: string
  }
}

export function usePendingNoteShifts(workerId: string | undefined) {
  return useQuery({
    queryKey: ['case-notes', 'pending', workerId],
    queryFn: async (): Promise<PendingNoteShift[]> => {
      if (!workerId) return []

      const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()

      // Step 1: Get completed shifts with checkout in last 24h
      const { data: checkIns, error: checkInError } = await supabase
        .from('shift_check_ins')
        .select(`
          shift_id,
          check_out_time,
          duration_minutes,
          shifts!inner (
            id, participant_id, worker_id, scheduled_start, scheduled_end, organization_id,
            participants (first_name, last_name)
          )
        ` as any)
        .not('check_out_time', 'is', null)
        .gte('check_out_time', twentyFourHoursAgo)

      if (checkInError) throw checkInError
      if (!checkIns || checkIns.length === 0) return []

      // Filter to only this worker's shifts
      const workerCheckIns = (checkIns as any[]).filter(
        (ci) => ci.shifts?.worker_id === workerId
      )
      if (workerCheckIns.length === 0) return []

      const shiftIds = workerCheckIns.map((ci) => ci.shift_id)

      // Step 2: Get existing notes for these shifts
      const { data: existingNotes } = await supabase
        .from('case_notes')
        .select('id, shift_id, content, concern_flag, concern_text')
        .in('shift_id', shiftIds)
        .eq('worker_id', workerId)

      const notesByShift = new Map(
        (existingNotes ?? []).map((n) => [n.shift_id, n])
      )

      // Step 3: Build pending list (shifts without notes OR with editable notes)
      return workerCheckIns.map((ci) => {
        const shift = ci.shifts as any
        const participant = shift?.participants
        const note = notesByShift.get(ci.shift_id)

        return {
          shiftId: ci.shift_id,
          participantId: shift.participant_id,
          participantName: participant
            ? `${participant.first_name} ${participant.last_name}`
            : 'Unknown',
          checkOutTime: ci.check_out_time,
          durationMinutes: ci.duration_minutes,
          scheduledStart: shift.scheduled_start,
          scheduledEnd: shift.scheduled_end,
          organizationId: shift.organization_id,
          existingNote: note
            ? {
                id: note.id,
                content: note.content,
                concernFlag: note.concern_flag,
                concernText: note.concern_text ?? undefined,
              }
            : undefined,
        }
      }).filter((item) => !item.existingNote) // Only show shifts WITHOUT notes (pending)
    },
    enabled: !!workerId,
    staleTime: 2 * 60 * 1000, // 2 minutes
    refetchInterval: 5 * 60 * 1000, // Refetch every 5 min to catch window expiry
  })
}
```

Key decisions:
- Only shows shifts WITHOUT notes (pending) per context: "My Notes tab shows ONLY pending shifts that need notes"
- 24h window calculated client-side (DB also enforces via RLS)
- Includes participant name for display
- refetchInterval catches window expiry (shifts disappear after 24h)

**useEditCaseNote.ts:**

Create a mutation hook for editing existing notes within the 24h window:

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { supabase } from '../lib/supabase'

interface EditCaseNoteInput {
  noteId: string
  content: string
  concernFlag: boolean
  concernText?: string
}

export function useEditCaseNote() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (input: EditCaseNoteInput) => {
      const { data, error } = await supabase
        .from('case_notes')
        .update({
          content: input.content,
          concern_flag: input.concernFlag,
          concern_text: input.concernText ?? null,
        } as any)
        .eq('id', input.noteId)
        .select()
        .single()

      if (error) throw error
      return data
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['case-notes'] })
    },
  })
}
```

Note: The RLS policy enforces the 24h window server-side. If the update fails with a policy violation, the UI should show "Note editing window has expired."
  </action>
  <verify>
Run `grep -n "export function" apps/worker-mobile/hooks/usePendingNoteShifts.ts apps/worker-mobile/hooks/useEditCaseNote.ts` and confirm both hooks are exported.
  </verify>
  <done>usePendingNoteShifts fetches completed shifts within 24h without notes. useEditCaseNote provides update mutation respecting the 24h RLS policy.</done>
</task>

<task type="auto">
  <name>Task 2: Build My Notes tab with pending shifts list and note creation flow</name>
  <files>apps/worker-mobile/app/(tabs)/notes.tsx</files>
  <action>
Replace the existing placeholder content in notes.tsx with a working pending shifts list:

1. Import usePendingNoteShifts from `../../hooks/usePendingNoteShifts`
2. Import CaseNoteModal from `../../components/CaseNoteModal`
3. Import useSessionStore or auth context to get current workerId
4. Import date-fns for formatting (formatDistanceToNow, format)
5. Import react-native-paper components: Card, Text, Button, ActivityIndicator

6. Component structure:
   ```
   Screen:
   ├── Header: "My Notes" title
   ├── Subtext: "Complete notes for recent shifts" (or empty state)
   ├── FlatList of pending shifts:
   │   └── Each item (PendingShiftCard):
   │       ├── Participant name (bold)
   │       ├── Shift date/time (formatted from scheduledStart)
   │       ├── Duration: "Xh Ym"
   │       ├── Time remaining: "Xh remaining" (calculated from checkOutTime + 24h - now)
   │       └── "Write Note" button → opens CaseNoteModal
   ├── Empty state: Icon + "All caught up!" + "No pending notes" when list empty
   └── CaseNoteModal (conditionally visible)
   ```

7. State:
   - `selectedShift` - the pending shift item tapped (null when no modal)
   - `modalVisible` - boolean for CaseNoteModal visibility

8. When "Write Note" is tapped:
   - Set selectedShift to the tapped item
   - Set modalVisible to true

9. When CaseNoteModal dismisses (onDismiss):
   - Set modalVisible to false
   - Set selectedShift to null
   - The usePendingNoteShifts query will refetch and the shift will disappear from the list (since it now has a note)

10. Pass to CaseNoteModal:
    - visible: modalVisible
    - onDismiss: dismiss handler
    - shiftId: selectedShift.shiftId
    - participantId: selectedShift.participantId
    - participantName: selectedShift.participantName
    - workerId: current worker ID
    - organizationId: selectedShift.organizationId
    - durationMinutes: selectedShift.durationMinutes

11. Show loading spinner while query is loading
12. Show pull-to-refresh on FlatList (onRefresh + refreshing)

Time remaining calculation:
```typescript
const hoursRemaining = Math.max(0,
  24 - (Date.now() - new Date(item.checkOutTime).getTime()) / (1000 * 60 * 60)
)
const displayRemaining = hoursRemaining > 1
  ? `${Math.floor(hoursRemaining)}h remaining`
  : `${Math.floor(hoursRemaining * 60)}m remaining`
```

Use react-native-paper theme colors. Match existing tab styling from home.tsx or schedule.tsx.
  </action>
  <verify>
Run `grep -n "usePendingNoteShifts\|CaseNoteModal\|FlatList\|Write Note\|remaining" apps/worker-mobile/app/\(tabs\)/notes.tsx` and confirm the pending list renders with time remaining and modal trigger.
  </verify>
  <done>My Notes tab shows pending shifts with participant name, duration, time remaining, and a "Write Note" button that opens CaseNoteModal. List refreshes after note submission.</done>
</task>

<task type="auto">
  <name>Task 3: Add tab bar badge for pending notes count</name>
  <files>apps/worker-mobile/app/(tabs)/_layout.tsx</files>
  <action>
Modify the existing _layout.tsx to show a badge on the My Notes tab:

1. Import `usePendingNoteShifts` from `../../hooks/usePendingNoteShifts`
2. Get the current worker ID from the session/auth context (same pattern used in other tabs)
3. Call `usePendingNoteShifts(workerId)` at the layout level to get the pending count
4. On the `notes` Tabs.Screen, set `tabBarBadge`:

```typescript
<Tabs.Screen
  name="notes"
  options={{
    title: 'My Notes',
    tabBarBadge: pendingData && pendingData.length > 0 ? pendingData.length : undefined,
    tabBarBadgeStyle: { backgroundColor: '#EF4444', fontSize: 10 },
    tabBarIcon: ({ color, size }) => (
      <MaterialCommunityIcons name="note-text" size={size} color={color} />
    ),
  }}
/>
```

Key details:
- Badge shows the count of pending shifts (e.g., "3")
- Badge is red background with white text (matches urgency of pending documentation)
- Badge disappears when count is 0 (set to undefined)
- The hook has staleTime of 2 min, so badge updates reasonably quickly after note submission
- If workerId is not yet available (loading), pendingData is undefined (no badge shown)

Do NOT change other tabs or the TimerBar. Only modify the notes tab Screen options and add the hook call at the layout component level.
  </action>
  <verify>
Run `grep -n "tabBarBadge\|usePendingNoteShifts\|pendingData" apps/worker-mobile/app/\(tabs\)/_layout.tsx` and confirm the badge is wired to the pending count.
  </verify>
  <done>Tab bar shows a red badge with pending notes count on the My Notes tab, disappearing when all notes are written.</done>
</task>

</tasks>

<verification>
1. My Notes tab shows a list of completed shifts from the last 24 hours that lack case notes
2. Each item shows participant name, shift time, duration, and hours remaining
3. Tapping "Write Note" opens CaseNoteModal pre-filled with shift context
4. After submitting a note, the shift disappears from the pending list
5. Tab bar badge shows the count of pending shifts (or no badge when 0)
6. Shifts older than 24 hours do not appear in the list
7. Pull-to-refresh works on the FlatList
8. Empty state shows when no pending notes exist
</verification>

<success_criteria>
- Worker who skipped note at checkout sees the shift in My Notes tab with time remaining
- Worker can write the note from My Notes tab and it persists correctly
- Badge provides visual reminder without being intrusive
- After 24h, pending shifts automatically disappear (refetch interval + client filter)
</success_criteria>

<output>
After completion, create `.planning/phases/06-case-notes/06-04-SUMMARY.md`
</output>
