---
phase: 06-case-notes
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - apps/admin/components/participants/case-notes-tab.tsx
  - apps/admin/components/participants/case-note-card.tsx
  - apps/admin/hooks/use-case-notes.ts
  - apps/admin/components/participants/participant-detail.tsx
  - apps/admin/app/(protected)/participants/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Participant detail page shows a 'Case Notes' tab alongside the existing detail content"
    - "Case notes list displays each note with worker name, timestamp, and content"
    - "Notes with flagged concerns show a visible red/orange badge"
    - "Admin can filter notes by date range (from/to) and by specific worker"
    - "Admin can mark a note as 'reviewed' with a button click"
    - "Admin can add a private comment that is stored in case_note_admin_comments table"
  artifacts:
    - path: "apps/admin/components/participants/case-notes-tab.tsx"
      provides: "Case notes list with date/worker filters and review actions"
      contains: "CaseNotesTab"
    - path: "apps/admin/components/participants/case-note-card.tsx"
      provides: "Individual case note display with concern badge and admin actions"
      contains: "CaseNoteCard"
    - path: "apps/admin/hooks/use-case-notes.ts"
      provides: "Fetch, filter, review, and comment mutations for case notes"
      exports: ["useParticipantCaseNotes", "useReviewCaseNote", "useAddAdminComment"]
  key_links:
    - from: "apps/admin/components/participants/case-notes-tab.tsx"
      to: "apps/admin/hooks/use-case-notes.ts"
      via: "useParticipantCaseNotes hook for data fetching"
      pattern: "useParticipantCaseNotes"
    - from: "apps/admin/hooks/use-case-notes.ts"
      to: "supabase.from('case_notes')"
      via: "Supabase query with date/worker filters"
      pattern: "from\\('case_notes'\\)"
    - from: "apps/admin/components/participants/participant-detail.tsx"
      to: "apps/admin/components/participants/case-notes-tab.tsx"
      via: "Tabs component rendering CaseNotesTab"
      pattern: "CaseNotesTab"
---

<objective>
Build the admin case notes review experience as a tab on the participant detail page with date/worker filters, concern badges, review acknowledgement, and private comments.

Purpose: Admin needs to review care documentation for NDIS compliance. Filters by date and worker enable efficient auditing, and the review/comment system provides an acknowledgement trail.
Output: Tabbed participant detail page with fully functional case notes list, filters, and admin actions.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-case-notes/06-01-SUMMARY.md
@apps/admin/components/participants/participant-detail.tsx
@apps/admin/app/(protected)/participants/[id]/page.tsx
@apps/admin/hooks/use-shifts.ts
@apps/admin/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create use-case-notes hook with fetch, review, and comment mutations</name>
  <files>apps/admin/hooks/use-case-notes.ts</files>
  <action>
Create `apps/admin/hooks/use-case-notes.ts` with three exports:

1. **useParticipantCaseNotes(participantId, filters)** - TanStack Query hook:
   ```typescript
   interface CaseNoteFilters {
     dateFrom?: string  // ISO date string YYYY-MM-DD
     dateTo?: string
     workerId?: string
   }
   ```
   - Query key: `['case-notes', participantId, filters]`
   - Supabase query:
     - `.from('case_notes')` with `.select('*, shifts(scheduled_start, scheduled_end, shift_check_ins(duration_minutes, check_in_time, check_out_time))')` -- use `(as any)` on the query builder per established pattern
     - Also join worker profile info: workers need to be joined to get name. Use `.select('*, workers!inner(id, profiles(first_name, last_name)), shifts(...)')`
     - Filter by `.eq('participant_id', participantId)`
     - If `dateFrom`: `.gte('note_date', dateFrom)`
     - If `dateTo`: `.lte('note_date', dateTo)`
     - If `workerId`: `.eq('worker_id', workerId)`
     - Order by `.order('created_at', { ascending: false })`
   - enabled: `!!participantId`
   - staleTime: 30 seconds

2. **useReviewCaseNote()** - Mutation hook:
   - mutationFn: Updates case_notes row with `reviewed_at: new Date().toISOString()` and `reviewed_by: currentUser.id`
   - Get current user via `supabase.auth.getUser()`
   - On success: invalidate `['case-notes']` queries

3. **useAddAdminComment()** - Mutation hook:
   - mutationFn: Inserts into `case_note_admin_comments` table with case_note_id, admin_id (current user), comment text, organization_id
   - On success: invalidate `['case-notes']` queries (to refetch with comments)

4. **useAdminComments(caseNoteId)** - Query hook:
   - Fetches from `case_note_admin_comments` filtered by case_note_id
   - Joins profiles for admin name
   - Order by created_at descending

Also export a **useCaseNoteWorkers(participantId)** helper query that fetches distinct workers who have written notes for this participant (for the worker filter dropdown):
   - `.from('case_notes').select('worker_id, workers!inner(id, profiles(first_name, last_name))')` filtered by participant_id
   - Deduplicate by worker_id in the transform

Use createClient() from '@/lib/supabase/client' (existing pattern for admin hooks).
  </action>
  <verify>Run `grep -n "export function" apps/admin/hooks/use-case-notes.ts` and confirm all 5 hooks are exported: useParticipantCaseNotes, useReviewCaseNote, useAddAdminComment, useAdminComments, useCaseNoteWorkers.</verify>
  <done>All admin case note data fetching and mutation hooks are created with server-side filtering, review tracking, and private comment support.</done>
</task>

<task type="auto">
  <name>Task 2: Create CaseNoteCard and CaseNotesTab components</name>
  <files>apps/admin/components/participants/case-note-card.tsx, apps/admin/components/participants/case-notes-tab.tsx</files>
  <action>
**case-note-card.tsx:**

Create a card component that displays a single case note:
- Props: `{ note: CaseNote; onReview: () => void; onAddComment: (comment: string) => void }`
- Layout:
  - Header: Worker name (first + last from joined profiles) + note_date formatted (e.g., "15 Jan 2026, 2:30 PM")
  - If `concern_flag === true`: Show a Badge with "Concern" in destructive/red variant next to the header
  - Body: note content text (full display, not truncated)
  - If `concern_text`: Show concern description in a highlighted box (light red/amber background)
  - Footer row:
    - Shift duration: "Duration: Xh Ym" (from joined shift_check_ins.duration_minutes)
    - If `reviewed_at`: Show "Reviewed" with a green check icon and reviewer name + date
    - If NOT reviewed: Show "Mark as Reviewed" button (outline variant)
  - Admin comment section:
    - Show existing comments (from separate query or passed as prop)
    - "Add Comment" button that reveals a TextInput + Save button inline
    - Comments show admin name + timestamp + comment text

Use shadcn/ui components: Card, CardContent, CardHeader, Badge, Button, Textarea.
Use Tailwind for layout. Follow existing component patterns in the participants folder.

**case-notes-tab.tsx:**

Create the tab content component:
- Props: `{ participantId: string }`
- State: `dateFrom`, `dateTo`, `workerId` filter values
- Uses `useParticipantCaseNotes(participantId, { dateFrom, dateTo, workerId })` for data
- Uses `useCaseNoteWorkers(participantId)` for worker filter dropdown options
- Uses `useReviewCaseNote()` and `useAddAdminComment()` for actions

Layout:
1. Filter bar at top:
   - Date from: `<Input type="date" />` with label "From"
   - Date to: `<Input type="date" />` with label "To"
   - Worker: `<Select>` dropdown with worker names (from useCaseNoteWorkers) + "All workers" option
   - "Clear filters" button (resets all to undefined)
2. Notes count: "X case notes" text
3. Notes list: Map over case notes, render CaseNoteCard for each
4. Empty state: "No case notes found" message when list is empty
5. Loading state: Skeleton or spinner while fetching

Handle the review and comment callbacks by calling the respective mutations and passing note IDs.
  </action>
  <verify>
Run `grep -n "export\|CaseNoteCard\|CaseNotesTab\|useParticipantCaseNotes\|concern_flag\|reviewed" apps/admin/components/participants/case-note-card.tsx apps/admin/components/participants/case-notes-tab.tsx` and confirm both components render properly with filter controls and concern badges.
  </verify>
  <done>CaseNoteCard displays note content with concern badge and admin actions. CaseNotesTab provides filtered list with date range and worker selectors.</done>
</task>

<task type="auto">
  <name>Task 3: Add Case Notes tab to participant detail page</name>
  <files>apps/admin/components/participants/participant-detail.tsx, apps/admin/app/(protected)/participants/[id]/page.tsx</files>
  <action>
Wrap the existing participant detail content in a shadcn/ui Tabs component:

1. **participant-detail.tsx modifications:**
   - Import `Tabs, TabsContent, TabsList, TabsTrigger` from the UI components (check if Tabs is already installed in the project's shadcn components, if not create it manually following the established pattern)
   - Wrap the existing detail content in a `<TabsContent value="details">` block
   - Add a second `<TabsContent value="case-notes">` block containing `<CaseNotesTab participantId={participant.id} />`
   - The TabsList should have two triggers: "Details" (default) and "Case Notes"
   - Import CaseNotesTab from './case-notes-tab'

2. **page.tsx modifications (if needed):**
   - The participant detail page likely already passes the participant object to participant-detail.tsx
   - Verify the participant.id is accessible in the detail component
   - No changes needed if participant-detail already receives the full participant object

3. **Tabs component (if missing):**
   - Check if `apps/admin/components/ui/tabs.tsx` exists
   - If not, create it manually following the shadcn/ui Tabs pattern (Radix UI Tabs primitive with Tailwind classes)
   - The component needs: Tabs (root), TabsList (container), TabsTrigger (button), TabsContent (panel)

The Tabs should render inline on the detail page, replacing the single-view layout with a tabbed interface. The "Details" tab shows everything that currently exists. The "Case Notes" tab shows the new CaseNotesTab component.
  </action>
  <verify>
Run `grep -n "TabsContent\|TabsTrigger\|CaseNotesTab\|case-notes" apps/admin/components/participants/participant-detail.tsx` and confirm the tabbed structure is in place.
  </verify>
  <done>Participant detail page has two tabs: "Details" (existing content) and "Case Notes" (new CaseNotesTab with filters and admin actions).</done>
</task>

</tasks>

<verification>
1. Participant detail page shows "Details" and "Case Notes" tabs
2. Clicking "Case Notes" tab shows the notes list with filters
3. Date range filters narrow down displayed notes (server-side query)
4. Worker dropdown filter shows only workers who have written notes for this participant
5. Notes with concern_flag show a red/orange "Concern" badge
6. Admin can click "Mark as Reviewed" and the note shows reviewed status
7. Admin can add a private comment that persists to case_note_admin_comments
8. Empty state displays when no notes match filters
</verification>

<success_criteria>
- Admin can navigate to participant detail, switch to Case Notes tab, and see all case notes
- Filters work server-side (date range narrows results, worker dropdown narrows to specific worker)
- Concern badges are immediately visible in the list
- Review and comment actions persist to the database
</success_criteria>

<output>
After completion, create `.planning/phases/06-case-notes/06-03-SUMMARY.md`
</output>
