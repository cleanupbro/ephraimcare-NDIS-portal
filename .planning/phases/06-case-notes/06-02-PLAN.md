---
phase: 06-case-notes
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - apps/worker-mobile/components/CaseNoteModal.tsx
  - apps/worker-mobile/hooks/useCreateCaseNote.ts
  - apps/worker-mobile/stores/syncStore.ts
autonomous: true

must_haves:
  truths:
    - "Worker taps 'Write Note' in CaseNoteModal and can type a note with min 10 chars validation"
    - "Concern flag toggle reveals a secondary text input for concern description"
    - "Saving a note inserts into case_notes table with shift_id, participant_id, worker_id, content, concern_flag"
    - "If offline, note creation queues in syncStore and syncs when connection returns"
    - "After successful save, queries are invalidated and modal dismisses"
  artifacts:
    - path: "apps/worker-mobile/components/CaseNoteModal.tsx"
      provides: "Case note creation form with concern flag toggle and save logic"
      contains: "caseNoteSchema"
    - path: "apps/worker-mobile/hooks/useCreateCaseNote.ts"
      provides: "TanStack Query mutation for case note insert with offline fallback"
      exports: ["useCreateCaseNote"]
    - path: "apps/worker-mobile/stores/syncStore.ts"
      provides: "Extended sync queue with case_note action type"
      contains: "case_note"
  key_links:
    - from: "apps/worker-mobile/components/CaseNoteModal.tsx"
      to: "apps/worker-mobile/hooks/useCreateCaseNote.ts"
      via: "useCreateCaseNote hook call on form submit"
      pattern: "useCreateCaseNote"
    - from: "apps/worker-mobile/hooks/useCreateCaseNote.ts"
      to: "supabase.from('case_notes')"
      via: "Supabase insert mutation"
      pattern: "from\\('case_notes'\\)"
    - from: "apps/worker-mobile/hooks/useCreateCaseNote.ts"
      to: "apps/worker-mobile/stores/syncStore.ts"
      via: "addPendingAction on network error"
      pattern: "addPendingAction"
---

<objective>
Wire the existing CaseNoteModal to actually persist case notes to Supabase with concern flag support and offline fallback via the sync queue.

Purpose: This is the core case note creation flow -- the worker's primary way to document care after a shift. Without this, no case notes can be created.
Output: Working CaseNoteModal with form validation, Supabase persistence, and offline resilience.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-case-notes/06-01-SUMMARY.md
@apps/worker-mobile/components/CaseNoteModal.tsx
@apps/worker-mobile/stores/syncStore.ts
@apps/worker-mobile/hooks/useCheckOut.ts
@apps/worker-mobile/lib/schemas/case-note.ts
@apps/worker-mobile/lib/supabase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend syncStore with case_note action type</name>
  <files>apps/worker-mobile/stores/syncStore.ts</files>
  <action>
Modify the existing syncStore.ts to support case_note actions:

1. Update the PendingAction type union to include `'case_note'` in the type field.
2. Add an optional `payload` field to PendingAction (type: `Record<string, unknown>`) for storing note content, concern flag, etc.
3. In the sync processing logic (the function that replays queued actions), add a case for `'case_note'` type that calls:
   ```typescript
   case 'case_note': {
     const { data, error } = await supabase
       .from('case_notes')
       .upsert({
         shift_id: action.shiftId,
         participant_id: action.payload?.participantId,
         worker_id: action.payload?.workerId,
         organization_id: action.payload?.organizationId,
         content: action.payload?.content,
         concern_flag: action.payload?.concernFlag ?? false,
         concern_text: action.payload?.concernText ?? null,
         note_date: action.payload?.noteDate ?? new Date().toISOString().split('T')[0],
         is_draft: false,
       }, { onConflict: 'shift_id,worker_id' })
       .select()
       .single()
     if (error) throw error
     break
   }
   ```

Use upsert with onConflict to handle the unique constraint (prevents duplicate notes if sync replays).

Keep the existing check_in and check_out cases unchanged. The sync queue processes FIFO and breaks on first failure (existing behavior, do not change).
  </action>
  <verify>Run `grep -n "case_note" apps/worker-mobile/stores/syncStore.ts` and confirm the type is in the union and the upsert case exists.</verify>
  <done>syncStore handles case_note actions with upsert (onConflict prevents duplicates), maintaining FIFO order with existing check-in/check-out actions.</done>
</task>

<task type="auto">
  <name>Task 2: Create useCreateCaseNote hook</name>
  <files>apps/worker-mobile/hooks/useCreateCaseNote.ts</files>
  <action>
Create a new hook file at `apps/worker-mobile/hooks/useCreateCaseNote.ts`:

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { supabase } from '../lib/supabase'
import { useSyncStore } from '../stores/syncStore'
import type { CreateCaseNoteInput } from '../lib/schemas/case-note'

export function useCreateCaseNote() {
  const addPendingAction = useSyncStore((s) => s.addPendingAction)
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (input: CreateCaseNoteInput) => {
      const { data, error } = await supabase
        .from('case_notes')
        .upsert({
          shift_id: input.shiftId,
          participant_id: input.participantId,
          worker_id: input.workerId,
          organization_id: input.organizationId,
          content: input.content,
          concern_flag: input.concernFlag,
          concern_text: input.concernText ?? null,
          note_date: new Date().toISOString().split('T')[0],
          is_draft: false,
        } as any, { onConflict: 'shift_id,worker_id' })
        .select()
        .single()
      if (error) throw error
      return data
    },
    onError: (_error, variables) => {
      // Queue for offline sync
      addPendingAction({
        id: `note-${variables.shiftId}-${Date.now()}`,
        type: 'case_note',
        shiftId: variables.shiftId,
        timestamp: new Date().toISOString(),
        latitude: 0,
        longitude: 0,
        createdAt: new Date().toISOString(),
        payload: {
          participantId: variables.participantId,
          workerId: variables.workerId,
          organizationId: variables.organizationId,
          content: variables.content,
          concernFlag: variables.concernFlag,
          concernText: variables.concernText,
          noteDate: new Date().toISOString().split('T')[0],
        },
      })
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['case-notes'] })
      queryClient.invalidateQueries({ queryKey: ['shifts'] })
    },
  })
}
```

Key design decisions:
- Uses upsert with onConflict: 'shift_id,worker_id' to prevent duplicates (matches unique constraint from migration)
- Uses `as any` type assertion on the insert object (matches established PostgREST pattern from STATE.md decisions)
- On error (network failure), queues to syncStore for later replay
- On success, invalidates both case-notes and shifts queries (shift may show "has note" indicator)
- Sets is_draft = false always (per research: draft concept replaced by 24h window)
  </action>
  <verify>Run `cat apps/worker-mobile/hooks/useCreateCaseNote.ts` and confirm it exports useCreateCaseNote with Supabase upsert + syncStore fallback.</verify>
  <done>Hook provides case note creation with online Supabase insert and offline syncStore fallback, using upsert to prevent duplicates.</done>
</task>

<task type="auto">
  <name>Task 3: Enhance CaseNoteModal with form validation and save logic</name>
  <files>apps/worker-mobile/components/CaseNoteModal.tsx</files>
  <action>
Rewrite the existing CaseNoteModal.tsx (currently a placeholder with TextInput and Skip/Write buttons) to include:

1. Import and use the `caseNoteSchema` from `../lib/schemas/case-note` for validation
2. Import and use `useCreateCaseNote` from `../hooks/useCreateCaseNote`
3. Import react-hook-form's `useForm` and zodResolver

4. Form state:
   - `content` TextInput (multiline, 4+ lines visible) with placeholder: "Activities performed... Participant mood... Changes noticed..."
   - `concernFlag` Switch/Toggle from react-native-paper with label "Flag a concern"
   - `concernText` TextInput (multiline, 2 lines) -- only visible when concernFlag is true, placeholder: "Describe the concern..."
   - Character count shown below content field (e.g., "12/10 min")

5. Props interface (keep existing props pattern):
   ```typescript
   interface CaseNoteModalProps {
     visible: boolean
     onDismiss: () => void
     shiftId: string
     participantId: string
     participantName: string
     workerId: string
     organizationId: string
     durationMinutes: number
   }
   ```

6. On "Save Note" button press:
   - Validate form with zodResolver
   - If valid, call createCaseNote.mutate() with the input
   - Show loading state on button during mutation
   - On success: show brief success feedback (e.g., Snackbar or Alert), then call onDismiss()
   - On error: show error message but keep modal open (data queued offline)

7. On "Skip" button press:
   - Call onDismiss() directly (no save)

8. Keep existing visual structure: "Shift Complete" header with participant name and duration display
9. Add form fields below the header
10. Disable save button if content < 10 chars or mutation is pending
11. Use react-native-paper components: TextInput, Switch, Button, Text

Note: The modal is already rendered in shift/[id].tsx after checkout. Ensure the props interface matches what's passed from that screen (check existing usage and update the caller if needed to pass the new required props like organizationId).
  </action>
  <verify>
Run `grep -n "caseNoteSchema\|useCreateCaseNote\|concernFlag\|onDismiss" apps/worker-mobile/components/CaseNoteModal.tsx` and confirm all key integrations are present.
Also run `grep -n "CaseNoteModal" apps/worker-mobile/app/shift/\[id\].tsx` to verify the caller passes required props.
  </verify>
  <done>CaseNoteModal validates input (min 10 chars), shows concern flag toggle, saves to Supabase via useCreateCaseNote, and falls back to offline queue on network failure.</done>
</task>

</tasks>

<verification>
1. CaseNoteModal renders form with content TextInput, concern flag Switch, and conditional concern text input
2. Saving with valid content (10+ chars) calls Supabase upsert on case_notes table
3. Saving while offline queues the action in syncStore with type 'case_note'
4. syncStore processes case_note actions with upsert (onConflict prevents duplicates)
5. Form validation prevents save when content < 10 characters
6. Concern flag toggle shows/hides the concern text field
</verification>

<success_criteria>
- Worker can write a case note in the modal after checkout and it persists to the database
- Concern flag toggle works and concern text is saved when flagged
- Offline creation queues properly and syncs when back online
- Form validation enforces 10-character minimum
</success_criteria>

<output>
After completion, create `.planning/phases/06-case-notes/06-02-SUMMARY.md`
</output>
