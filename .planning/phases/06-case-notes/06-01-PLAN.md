---
phase: 06-case-notes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260125000001_case_notes_phase6.sql
  - apps/worker-mobile/lib/schemas/case-note.ts
autonomous: true

must_haves:
  truths:
    - "case_notes table has concern_flag boolean and concern_text columns"
    - "Unique constraint prevents duplicate notes per shift per worker"
    - "Participant visibility RLS policy is dropped (participants cannot see case notes)"
    - "Worker update policy enforces 24-hour window based on shift checkout time"
    - "case_note_admin_comments table exists with admin-only RLS"
    - "DB trigger inserts notification when concern_flag is true on case note insert"
  artifacts:
    - path: "supabase/migrations/20260125000001_case_notes_phase6.sql"
      provides: "Schema changes, RLS updates, notification trigger"
      contains: "concern_flag"
    - path: "apps/worker-mobile/lib/schemas/case-note.ts"
      provides: "Zod validation schema for case note form"
      contains: "caseNoteSchema"
  key_links:
    - from: "supabase/migrations/20260125000001_case_notes_phase6.sql"
      to: "public.notifications"
      via: "trigger function notify_concern_flag"
      pattern: "insert into public.notifications"
---

<objective>
Add concern flag columns, admin comments table, RLS policy updates, and concern notification trigger to the case_notes infrastructure. Create Zod schema for mobile form validation.

Purpose: Provides the database foundation that all other phase 6 plans build upon -- new columns for concern tracking, admin review, proper RLS isolation, and 24-hour edit window enforcement at the DB level.
Output: Migration file with all schema changes + Zod schema file for case note validation.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/20260124000011_create_case_notes.sql
@supabase/migrations/20260124000016_create_rls_policies.sql
@supabase/migrations/20260124000014_create_notifications.sql
@supabase/migrations/20260124000002_create_types.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for case notes phase 6</name>
  <files>supabase/migrations/20260125000001_case_notes_phase6.sql</files>
  <action>
Create a new migration file that performs all of the following in order:

1. Add columns to case_notes table:
   - `concern_flag boolean default false`
   - `concern_text text`
   - `reviewed_at timestamptz`
   - `reviewed_by uuid references profiles(id)`

2. Add unique constraint: `unique(shift_id, worker_id)` on case_notes (prevents duplicate notes per shift per worker)

3. Drop the participant visibility policy (NOTE-05):
   `DROP POLICY IF EXISTS "Participants can view their own case notes (not drafts)" ON case_notes;`

4. Drop the old worker update policy:
   `DROP POLICY IF EXISTS "Workers can update their own drafts" ON case_notes;`

5. Create new worker update policy enforcing 24-hour window based on shift checkout time (not is_draft):
   ```sql
   CREATE POLICY "Workers can update their own notes within 24h"
     ON case_notes FOR UPDATE
     TO authenticated
     USING (
       worker_id IN (SELECT id FROM workers WHERE profile_id = auth.uid())
       AND organization_id = get_user_organization_id()
       AND EXISTS (
         SELECT 1 FROM shift_check_ins sci
         WHERE sci.shift_id = case_notes.shift_id
         AND sci.check_out_time > now() - interval '24 hours'
       )
     );
   ```

6. Update worker INSERT policy to also enforce 24-hour window:
   ```sql
   DROP POLICY IF EXISTS "Workers can insert case notes" ON case_notes;
   CREATE POLICY "Workers can insert case notes within 24h"
     ON case_notes FOR INSERT
     TO authenticated
     WITH CHECK (
       worker_id IN (SELECT id FROM workers WHERE profile_id = auth.uid())
       AND organization_id = get_user_organization_id()
       AND EXISTS (
         SELECT 1 FROM shift_check_ins sci
         WHERE sci.shift_id = shift_id
         AND sci.check_out_time > now() - interval '24 hours'
       )
     );
   ```

7. Create case_note_admin_comments table (separate from case_notes for RLS isolation -- workers cannot see admin private comments):
   ```sql
   CREATE TABLE public.case_note_admin_comments (
     id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
     case_note_id uuid NOT NULL REFERENCES case_notes(id) ON DELETE CASCADE,
     admin_id uuid NOT NULL REFERENCES profiles(id),
     comment text NOT NULL,
     organization_id uuid NOT NULL,
     created_at timestamptz DEFAULT now()
   );

   CREATE INDEX idx_admin_comments_note ON case_note_admin_comments(case_note_id);

   ALTER TABLE case_note_admin_comments ENABLE ROW LEVEL SECURITY;

   CREATE POLICY "Admin/coordinator can manage admin comments"
     ON case_note_admin_comments FOR ALL
     TO authenticated
     USING (
       is_admin_or_coordinator()
       AND organization_id = get_user_organization_id()
     );
   ```

8. Create concern notification trigger function and trigger:
   ```sql
   CREATE OR REPLACE FUNCTION public.notify_concern_flag()
   RETURNS trigger
   LANGUAGE plpgsql
   SECURITY DEFINER
   AS $$
   BEGIN
     IF NEW.concern_flag = true THEN
       INSERT INTO public.notifications (recipient_id, type, title, body, data, sent_at)
       SELECT p.id, 'case_note_added', 'Concern Flagged',
         'A worker flagged a concern for ' ||
           (SELECT first_name || '' '' || last_name FROM participants WHERE id = NEW.participant_id),
         jsonb_build_object('case_note_id', NEW.id, 'participant_id', NEW.participant_id, 'shift_id', NEW.shift_id),
         now()
       FROM profiles p
       WHERE p.organization_id = NEW.organization_id
         AND p.role = 'admin';
     END IF;
     RETURN NEW;
   END;
   $$;

   CREATE TRIGGER case_note_concern_notification
     AFTER INSERT ON public.case_notes
     FOR EACH ROW
     WHEN (NEW.concern_flag = true)
     EXECUTE FUNCTION public.notify_concern_flag();
   ```

Use `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` for safety. Use `DROP POLICY IF EXISTS` before creating replacements.
  </action>
  <verify>
Run `cat supabase/migrations/20260125000001_case_notes_phase6.sql` and confirm:
- concern_flag and concern_text columns added
- reviewed_at and reviewed_by columns added
- unique constraint on (shift_id, worker_id)
- Participant policy dropped
- Worker update policy references shift_check_ins.check_out_time with 24h interval
- Worker insert policy also enforces 24h window
- case_note_admin_comments table created with admin-only RLS
- notify_concern_flag trigger function and trigger created
  </verify>
  <done>Migration file creates all required schema changes, RLS updates, and notification trigger in a single atomic migration.</done>
</task>

<task type="auto">
  <name>Task 2: Zod schema for case note validation</name>
  <files>apps/worker-mobile/lib/schemas/case-note.ts</files>
  <action>
Create the Zod schema file at `apps/worker-mobile/lib/schemas/case-note.ts`. If the `lib/schemas/` directory does not exist, create it.

Contents:
```typescript
import { z } from 'zod'

export const caseNoteSchema = z.object({
  content: z.string().min(10, 'Note must be at least 10 characters'),
  concernFlag: z.boolean().default(false),
  concernText: z.string().optional().refine(
    (val) => val === undefined || val.length === 0 || val.length >= 5,
    'Concern description must be at least 5 characters if provided'
  ),
})

export type CaseNoteFormData = z.infer<typeof caseNoteSchema>

export interface CreateCaseNoteInput {
  shiftId: string
  participantId: string
  workerId: string
  organizationId: string
  content: string
  concernFlag: boolean
  concernText?: string
}
```

The schema enforces:
- content: minimum 10 characters (from requirements)
- concernFlag: boolean toggle, defaults to false
- concernText: optional, but if provided must be at least 5 characters (meaningful description)

The CreateCaseNoteInput interface defines the full mutation input shape used by useCreateCaseNote hook in Plan 02.
  </action>
  <verify>Run `cat apps/worker-mobile/lib/schemas/case-note.ts` and confirm the file exports caseNoteSchema, CaseNoteFormData type, and CreateCaseNoteInput interface.</verify>
  <done>Zod schema validates case note content (min 10 chars) and concern text (min 5 chars if provided), with TypeScript types exported for hook consumers.</done>
</task>

</tasks>

<verification>
1. Migration file exists at `supabase/migrations/20260125000001_case_notes_phase6.sql`
2. File contains ALTER TABLE for concern_flag, concern_text, reviewed_at, reviewed_by
3. File contains DROP POLICY for participant visibility and old worker update policy
4. File contains CREATE POLICY for 24h-window-based worker insert and update
5. File contains CREATE TABLE case_note_admin_comments with admin-only RLS
6. File contains trigger function and trigger for concern notifications
7. Zod schema file exists with proper exports
</verification>

<success_criteria>
- Database migration is complete and internally consistent (no missing references)
- RLS policies correctly enforce: workers own their notes, 24h edit window, no participant visibility, admin-only comments table
- Zod schema provides type-safe validation for mobile form
- All subsequent plans (02, 03, 04) can depend on these artifacts existing
</success_criteria>

<output>
After completion, create `.planning/phases/06-case-notes/06-01-SUMMARY.md`
</output>
