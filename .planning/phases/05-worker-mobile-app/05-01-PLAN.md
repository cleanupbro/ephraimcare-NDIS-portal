---
phase: 05-worker-mobile-app
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260124300001_add_shift_check_ins.sql
  - apps/worker-mobile/package.json
  - apps/worker-mobile/app.json
  - apps/worker-mobile/lib/supabase.ts
  - apps/worker-mobile/constants/config.ts
autonomous: true

must_haves:
  truths:
    - "shift_check_ins table exists with check_in/out time, GPS coordinates, and check_out_type columns"
    - "worker_push_tokens table exists for push notification token storage"
    - "participants table has latitude and longitude columns for proximity checking"
    - "Supabase client uses expo-sqlite/localStorage for unlimited session storage"
    - "RLS policies allow workers to read their own shifts and write their own check-ins"
  artifacts:
    - path: "supabase/migrations/20260124300001_add_shift_check_ins.sql"
      provides: "shift_check_ins table, worker_push_tokens table, participant geo columns, RLS policies, pg_cron auto-checkout job"
      contains: "shift_check_ins"
    - path: "apps/worker-mobile/lib/supabase.ts"
      provides: "Typed Supabase client with expo-sqlite localStorage adapter"
      contains: "expo-sqlite/localStorage/install"
    - path: "apps/worker-mobile/constants/config.ts"
      provides: "App configuration constants (radius, timeouts, etc.)"
      contains: "CHECK_IN_RADIUS_METERS"
  key_links:
    - from: "apps/worker-mobile/lib/supabase.ts"
      to: "expo-sqlite/localStorage"
      via: "storage adapter import"
      pattern: "expo-sqlite/localStorage/install"
---

<objective>
Database migration, package installation, and Supabase client setup for the worker mobile app.

Purpose: Creates the data layer foundation (shift_check_ins table, push tokens, geo columns, RLS policies) and configures the mobile Supabase client with proper session persistence -- everything downstream plans depend on.

Output: Migration file, configured Supabase client, app constants, updated package.json with all required dependencies.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-worker-mobile-app/05-RESEARCH.md
@supabase/migrations/20260124200001_add_shift_scheduling_columns.sql
@apps/worker-mobile/package.json
@apps/worker-mobile/app.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for check-ins, push tokens, and geo columns</name>
  <files>supabase/migrations/20260124300001_add_shift_check_ins.sql</files>
  <action>
Create migration file with:

1. **shift_check_ins table:**
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - shift_id UUID NOT NULL REFERENCES shifts(id) ON DELETE CASCADE
   - check_in_time TIMESTAMPTZ NOT NULL
   - check_in_latitude DOUBLE PRECISION NOT NULL
   - check_in_longitude DOUBLE PRECISION NOT NULL
   - check_out_time TIMESTAMPTZ (nullable -- filled on checkout)
   - check_out_latitude DOUBLE PRECISION (nullable)
   - check_out_longitude DOUBLE PRECISION (nullable)
   - check_out_type TEXT DEFAULT 'manual' CHECK (check_out_type IN ('manual', 'auto', 'admin_override'))
   - duration_minutes INTEGER (nullable -- calculated on checkout)
   - synced_from_offline BOOLEAN DEFAULT FALSE
   - organization_id UUID NOT NULL REFERENCES organizations(id)
   - created_at TIMESTAMPTZ DEFAULT now()
   - updated_at TIMESTAMPTZ DEFAULT now()
   - UNIQUE(shift_id) -- one check-in record per shift

2. **worker_push_tokens table:**
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - worker_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE
   - token TEXT NOT NULL
   - platform TEXT NOT NULL CHECK (platform IN ('ios', 'android'))
   - organization_id UUID NOT NULL REFERENCES organizations(id)
   - created_at TIMESTAMPTZ DEFAULT now()
   - updated_at TIMESTAMPTZ DEFAULT now()
   - UNIQUE(worker_id, platform) -- one token per worker per platform

3. **Add to participants table:**
   - ALTER TABLE participants ADD COLUMN latitude DOUBLE PRECISION;
   - ALTER TABLE participants ADD COLUMN longitude DOUBLE PRECISION;

4. **RLS policies on shift_check_ins:**
   - Workers can SELECT their own check-ins (WHERE shift_id IN worker's shifts)
   - Workers can INSERT check-ins for their own shifts
   - Workers can UPDATE check_out fields on their own check-ins
   - Admins/Coordinators can SELECT all in their org
   - Admins can UPDATE any check-in in their org (for override)

5. **RLS policies on worker_push_tokens:**
   - Workers can INSERT/UPDATE/DELETE their own tokens
   - Admins can SELECT all tokens in their org

6. **pg_cron job for auto-checkout:**
   - Enable pg_cron extension (CREATE EXTENSION IF NOT EXISTS pg_cron)
   - Schedule job every 5 minutes: auto-checkout shifts where check_in_time IS NOT NULL AND check_out_time IS NULL AND shift's scheduled_end + 30 minutes < now()
   - Set check_out_time = scheduled_end + 30 minutes, check_out_type = 'auto'
   - Also update shifts.status to 'completed' for auto-checked-out shifts

7. **Audit trigger on shift_check_ins** (same pattern as other tables -- IF audit_log table exists, add trigger)

8. **Updated_at trigger on shift_check_ins and worker_push_tokens** (same pattern as other tables)

Use SECURITY DEFINER helper functions for RLS WHERE clauses (same pattern as existing RLS policies -- check get_user_org_id() and get_user_role() functions exist).
  </action>
  <verify>Run: `cd /Users/shamalkrishna/Desktop/ephraimcare-portal-2026 && cat supabase/migrations/20260124300001_add_shift_check_ins.sql | head -100` to confirm structure. Check that shift_check_ins, worker_push_tokens tables, participant columns, RLS policies, and pg_cron job are all present.</verify>
  <done>Migration file exists with all tables, columns, RLS policies, triggers, and pg_cron auto-checkout job. Valid SQL syntax with proper foreign keys and constraints.</done>
</task>

<task type="auto">
  <name>Task 2: Install dependencies and configure Supabase client</name>
  <files>apps/worker-mobile/package.json, apps/worker-mobile/app.json, apps/worker-mobile/lib/supabase.ts, apps/worker-mobile/constants/config.ts</files>
  <action>
1. **Add dependencies to package.json** (edit the file directly, don't run npm install):
   - expo-notifications: "~0.31.0"
   - expo-sqlite: "~15.2.0"
   - expo-device: "~7.1.0"
   - expo-constants: "~17.1.0"
   - react-native-reanimated: "~3.17.0"
   - @tanstack/query-async-storage-persister: "^5.65.0"
   - @tanstack/react-query-persist-client: "^5.65.0"
   - @react-native-async-storage/async-storage: "^2.1.0"
   - @react-native-community/netinfo: "^11.4.0" (for offline detection)

2. **Update app.json plugins** to add expo-notifications:
   ```json
   "plugins": [
     "expo-router",
     "expo-secure-store",
     ["expo-location", {...}],
     ["expo-notifications", { "icon": "./assets/notification-icon.png", "color": "#66BB6A" }]
   ]
   ```
   Note: The notification icon reference is optional; omit icon/color if asset doesn't exist.

3. **Create lib/supabase.ts:**
   ```typescript
   import 'expo-sqlite/localStorage/install'
   import { createClient } from '@supabase/supabase-js'

   const supabaseUrl = process.env.EXPO_PUBLIC_SUPABASE_URL!
   const supabaseAnonKey = process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY!

   export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
     auth: {
       storage: localStorage,
       autoRefreshToken: true,
       persistSession: true,
       detectSessionInUrl: false,
     },
   })
   ```
   Note: Do NOT import Database type from @ephraimcare/types -- keep untyped for now (postgrest-js typing issues established in prior phases). The `localStorage` global is polyfilled by the expo-sqlite import.

4. **Create constants/config.ts:**
   ```typescript
   export const CHECK_IN_RADIUS_METERS = 500
   export const AUTO_CHECKOUT_MINUTES = 30
   export const GPS_TIMEOUT_MS = 5000
   export const GPS_MAX_ACCURACY_METERS = 100
   export const TIMER_INTERVAL_MS = 1000
   export const QUERY_GC_TIME_MS = 1000 * 60 * 60 * 24 // 24 hours
   export const PUSH_REMINDER_MINUTES_BEFORE = 60
   export const AUTO_CHECKOUT_WARNING_MINUTES = 20
   ```
  </action>
  <verify>Check files exist: `ls apps/worker-mobile/lib/supabase.ts apps/worker-mobile/constants/config.ts` and verify package.json has new deps: `grep "expo-sqlite" apps/worker-mobile/package.json`</verify>
  <done>All packages added to package.json, app.json updated with notification plugin, supabase.ts exports configured client with expo-sqlite localStorage, config.ts exports all app constants.</done>
</task>

</tasks>

<verification>
- Migration file has valid SQL with shift_check_ins table, worker_push_tokens table, participant geo columns
- RLS policies reference existing helper functions (get_user_org_id, get_user_role)
- pg_cron job scheduled for auto-checkout
- Supabase client imports expo-sqlite/localStorage/install before createClient
- All required packages listed in package.json dependencies
- config.ts exports CHECK_IN_RADIUS_METERS = 500
</verification>

<success_criteria>
- shift_check_ins table schema matches the research spec (GPS, timestamps, check_out_type)
- Worker RLS allows read own shifts + write own check-ins
- Supabase client configured with localStorage (not SecureStore -- avoids 2048-byte limit)
- All 9 new dependencies added to package.json
- Auto-checkout pg_cron job runs every 5 minutes
</success_criteria>

<output>
After completion, create `.planning/phases/05-worker-mobile-app/05-01-SUMMARY.md`
</output>
