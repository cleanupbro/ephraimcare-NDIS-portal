---
phase: 05-worker-mobile-app
plan: 05
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - apps/worker-mobile/app/shift/[id].tsx
  - apps/worker-mobile/hooks/useCheckIn.ts
  - apps/worker-mobile/hooks/useLocation.ts
  - apps/worker-mobile/components/AlertBadge.tsx
autonomous: true

must_haves:
  truths:
    - "Shift detail view shows participant name, time, support type, address, and special instructions"
    - "Medical alerts are color-coded: red for critical, yellow for caution, blue for info"
    - "Check-in button is disabled if worker is more than 500m from participant address"
    - "Distance message shown when outside radius (e.g. 'You are 850m away. Must be within 500m.')"
    - "Successful check-in records GPS coordinates and timestamp in shift_check_ins"
    - "Check-in works offline by queuing action in sync store"
  artifacts:
    - path: "apps/worker-mobile/app/shift/[id].tsx"
      provides: "Shift detail screen with alerts, info, and check-in/out button"
      contains: "useShiftDetail"
    - path: "apps/worker-mobile/hooks/useCheckIn.ts"
      provides: "Check-in hook with GPS proximity enforcement and offline fallback"
      exports: ["useCheckIn"]
    - path: "apps/worker-mobile/hooks/useLocation.ts"
      provides: "Location permission and current position hook"
      exports: ["useCurrentLocation"]
    - path: "apps/worker-mobile/components/AlertBadge.tsx"
      provides: "Color-coded alert badge (red/yellow/blue by severity)"
      exports: ["AlertBadge"]
  key_links:
    - from: "apps/worker-mobile/hooks/useCheckIn.ts"
      to: "apps/worker-mobile/lib/proximity.ts"
      via: "isWithinRadius() call before check-in"
      pattern: "isWithinRadius"
    - from: "apps/worker-mobile/hooks/useCheckIn.ts"
      to: "apps/worker-mobile/stores/syncStore.ts"
      via: "addPendingAction on network failure"
      pattern: "addPendingAction"
    - from: "apps/worker-mobile/app/shift/[id].tsx"
      to: "apps/worker-mobile/hooks/useShifts.ts"
      via: "useShiftDetail(id)"
      pattern: "useShiftDetail"
---

<objective>
Shift detail view with medical alerts display and GPS-enforced check-in flow.

Purpose: Workers must see shift details including special instructions and medical alerts (MOBL-07) before checking in. Check-in requires GPS proximity within 500m of the participant's address (MOBL-02). If offline, check-in is queued locally for later sync.

Output: Shift detail screen, check-in hook with proximity enforcement, location hook, alert badge component.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-worker-mobile-app/05-RESEARCH.md
@apps/worker-mobile/hooks/useShifts.ts
@apps/worker-mobile/stores/shiftStore.ts
@apps/worker-mobile/stores/syncStore.ts
@apps/worker-mobile/lib/proximity.ts
@apps/worker-mobile/constants/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Location hook and check-in hook with proximity enforcement</name>
  <files>apps/worker-mobile/hooks/useLocation.ts, apps/worker-mobile/hooks/useCheckIn.ts</files>
  <action>
1. **Create hooks/useLocation.ts:**

```typescript
import { useState, useEffect } from 'react'
import * as Location from 'expo-location'
import { GPS_TIMEOUT_MS, GPS_MAX_ACCURACY_METERS } from '../constants/config'

interface LocationState {
  latitude: number | null
  longitude: number | null
  accuracy: number | null
  loading: boolean
  error: string | null
}

export function useCurrentLocation() {
  const [state, setState] = useState<LocationState>({
    latitude: null, longitude: null, accuracy: null, loading: false, error: null,
  })

  const requestLocation = async (): Promise<{ latitude: number; longitude: number } | null> => {
    setState((s) => ({ ...s, loading: true, error: null }))

    try {
      const { status } = await Location.requestForegroundPermissionsAsync()
      if (status !== 'granted') {
        setState((s) => ({ ...s, loading: false, error: 'Location permission denied' }))
        return null
      }

      const location = await Location.getCurrentPositionAsync({
        accuracy: Location.Accuracy.High,
        timeInterval: GPS_TIMEOUT_MS,
      })

      const { latitude, longitude, accuracy } = location.coords

      // If accuracy is too poor, try once more
      if (accuracy && accuracy > GPS_MAX_ACCURACY_METERS) {
        const retry = await Location.getCurrentPositionAsync({
          accuracy: Location.Accuracy.BestForNavigation,
        })
        setState({
          latitude: retry.coords.latitude,
          longitude: retry.coords.longitude,
          accuracy: retry.coords.accuracy,
          loading: false,
          error: null,
        })
        return { latitude: retry.coords.latitude, longitude: retry.coords.longitude }
      }

      setState({ latitude, longitude, accuracy, loading: false, error: null })
      return { latitude, longitude }
    } catch (err) {
      const message = err instanceof Error ? err.message : 'Failed to get location'
      setState((s) => ({ ...s, loading: false, error: message }))
      return null
    }
  }

  return { ...state, requestLocation }
}
```

2. **Create hooks/useCheckIn.ts:**

Follow the pattern from 05-RESEARCH.md "Check-in Flow (Complete)" with these additions:
- Uses useCurrentLocation for GPS
- Calls isWithinRadius from lib/proximity.ts
- On success: inserts into shift_check_ins via supabase
- On network error: queues via syncStore.addPendingAction
- Updates shiftStore.setActiveShift on success
- Also updates shifts table status to 'in_progress'
- Returns { checkIn, loading, error }

```typescript
import { useState } from 'react'
import { supabase } from '../lib/supabase'
import { isWithinRadius } from '../lib/proximity'
import { useSyncStore } from '../stores/syncStore'
import { useShiftStore } from '../stores/shiftStore'
import { useCurrentLocation } from './useLocation'
import { CHECK_IN_RADIUS_METERS } from '../constants/config'
import { useQueryClient } from '@tanstack/react-query'

interface CheckInResult {
  success: boolean
  error?: string
  distance?: number
}

export function useCheckIn() {
  const [loading, setLoading] = useState(false)
  const addPendingAction = useSyncStore((s) => s.addPendingAction)
  const setActiveShift = useShiftStore((s) => s.setActiveShift)
  const { requestLocation } = useCurrentLocation()
  const queryClient = useQueryClient()

  async function checkIn(
    shiftId: string,
    participantLat: number | null,
    participantLon: number | null,
    participantName: string
  ): Promise<CheckInResult> {
    if (participantLat === null || participantLon === null) {
      return { success: false, error: 'Participant address has no GPS coordinates. Contact admin.' }
    }

    setLoading(true)
    try {
      // 1. Get current GPS
      const coords = await requestLocation()
      if (!coords) {
        return { success: false, error: 'Could not get your location. Check permissions.' }
      }

      // 2. Proximity check
      const { within, distance } = isWithinRadius(
        coords.latitude, coords.longitude,
        participantLat, participantLon,
        CHECK_IN_RADIUS_METERS
      )

      if (!within) {
        return {
          success: false,
          error: `You are ${distance}m away. Must be within ${CHECK_IN_RADIUS_METERS}m to check in.`,
          distance,
        }
      }

      // 3. Record check-in
      const timestamp = new Date().toISOString()
      const { error: dbError } = await supabase
        .from('shift_check_ins')
        .insert({
          shift_id: shiftId,
          check_in_time: timestamp,
          check_in_latitude: coords.latitude,
          check_in_longitude: coords.longitude,
        } as any)

      if (dbError) {
        // Network error or offline: queue for sync
        addPendingAction({
          type: 'check_in',
          shiftId,
          timestamp,
          latitude: coords.latitude,
          longitude: coords.longitude,
        })
      }

      // 4. Update shift status to in_progress
      await supabase
        .from('shifts')
        .update({ status: 'in_progress' } as any)
        .eq('id', shiftId)

      // 5. Update local state
      setActiveShift(shiftId, new Date(timestamp), participantName)

      // 6. Invalidate queries
      queryClient.invalidateQueries({ queryKey: ['shift', shiftId] })
      queryClient.invalidateQueries({ queryKey: ['shifts'] })

      return { success: true }
    } finally {
      setLoading(false)
    }
  }

  return { checkIn, loading }
}
```

Key points:
- Proximity check enforced BEFORE any DB write
- If participant has no lat/lon, check-in blocked with admin contact message
- Uses `as any` for Supabase inserts (established postgrest-js pattern)
- Active shift set in zustand store (TimerBar reads from here in Plan 06)
- Query invalidation ensures UI reflects new status
  </action>
  <verify>Check exports: `grep "export function" apps/worker-mobile/hooks/useCheckIn.ts apps/worker-mobile/hooks/useLocation.ts`</verify>
  <done>useCurrentLocation requests foreground GPS with accuracy retry. useCheckIn enforces 500m proximity, records check-in, handles offline fallback, updates shift status to in_progress.</done>
</task>

<task type="auto">
  <name>Task 2: Shift detail screen and alert badge</name>
  <files>apps/worker-mobile/app/shift/[id].tsx, apps/worker-mobile/components/AlertBadge.tsx</files>
  <action>
1. **Create components/AlertBadge.tsx:**

Color-coded badge for medical alerts. Parse severity from alert text prefixes: "[CRITICAL]", "[CAUTION]", "[INFO]" or default to info.

```typescript
import { View } from 'react-native'
import { Text, Chip } from 'react-native-paper'

type Severity = 'critical' | 'caution' | 'info'

const SEVERITY_COLORS: Record<Severity, { bg: string; text: string }> = {
  critical: { bg: '#FFEBEE', text: '#C62828' },  // red
  caution: { bg: '#FFF8E1', text: '#F57F17' },   // yellow/amber
  info: { bg: '#E3F2FD', text: '#1565C0' },      // blue
}

interface AlertBadgeProps {
  text: string
  severity?: Severity
}

export function AlertBadge({ text, severity = 'info' }: AlertBadgeProps) {
  const colors = SEVERITY_COLORS[severity]
  return (
    <View style={{
      backgroundColor: colors.bg,
      paddingHorizontal: 12,
      paddingVertical: 8,
      borderRadius: 8,
      marginBottom: 8,
    }}>
      <Text style={{ color: colors.text, fontSize: 14 }}>{text}</Text>
    </View>
  )
}

// Parse alerts string into structured array
export function parseAlerts(alertsText: string | null): { text: string; severity: Severity }[] {
  if (!alertsText) return []
  return alertsText.split('\n').filter(Boolean).map((line) => {
    if (line.startsWith('[CRITICAL]')) return { text: line.replace('[CRITICAL]', '').trim(), severity: 'critical' as Severity }
    if (line.startsWith('[CAUTION]')) return { text: line.replace('[CAUTION]', '').trim(), severity: 'caution' as Severity }
    if (line.startsWith('[INFO]')) return { text: line.replace('[INFO]', '').trim(), severity: 'info' as Severity }
    return { text: line.trim(), severity: 'info' as Severity }
  })
}
```

2. **Create app/shift/[id].tsx:**

The shift detail screen shows full info + check-in button:

```typescript
import { View, ScrollView } from 'react-native'
import { Text, Button, Card, Divider, ActivityIndicator } from 'react-native-paper'
import { useLocalSearchParams, useRouter } from 'expo-router'
import { format, parseISO } from 'date-fns'
import { useShiftDetail } from '../../hooks/useShifts'
import { useCheckIn } from '../../hooks/useCheckIn'
import { AlertBadge, parseAlerts } from '../../components/AlertBadge'
import { useState } from 'react'

export default function ShiftDetailScreen() {
  const { id } = useLocalSearchParams<{ id: string }>()
  const router = useRouter()
  const { data: shift, isLoading } = useShiftDetail(id ?? null)
  const { checkIn, loading: checkingIn } = useCheckIn()
  const [checkInError, setCheckInError] = useState<string | null>(null)

  if (isLoading || !shift) {
    return (
      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center' }}>
        <ActivityIndicator size="large" color="#66BB6A" />
      </View>
    )
  }

  const participant = shift.participant
  const checkInRecord = shift.shift_check_ins?.[0]
  const hasCheckedIn = !!checkInRecord?.check_in_time
  const hasCheckedOut = !!checkInRecord?.check_out_time
  const isActive = hasCheckedIn && !hasCheckedOut
  const alerts = parseAlerts(participant?.medical_alerts ?? null)

  const handleCheckIn = async () => {
    setCheckInError(null)
    const result = await checkIn(
      shift.id,
      participant?.latitude ?? null,
      participant?.longitude ?? null,
      `${participant?.first_name} ${participant?.last_name}`
    )
    if (!result.success) {
      setCheckInError(result.error ?? 'Check-in failed')
    }
  }

  // Determine which action button to show
  const canCheckIn = !hasCheckedIn && shift.status !== 'completed' && shift.status !== 'cancelled'
  const canCheckOut = isActive

  return (
    <ScrollView style={{ flex: 1, backgroundColor: '#F5F5F5' }}>
      {/* Header */}
      <View style={{ backgroundColor: '#fff', padding: 16, marginBottom: 8 }}>
        <Text variant="headlineSmall" style={{ fontWeight: '600' }}>
          {participant?.first_name} {participant?.last_name}
        </Text>
        <Text variant="bodyMedium" style={{ color: '#666', marginTop: 4 }}>
          {format(parseISO(shift.scheduled_start), 'h:mm a')} - {format(parseISO(shift.scheduled_end), 'h:mm a')}
        </Text>
        <Text variant="bodySmall" style={{ color: '#999', marginTop: 2 }}>
          {shift.support_type} | {format(new Date(shift.scheduled_date), 'EEEE, d MMM yyyy')}
        </Text>
      </View>

      {/* Medical Alerts */}
      {alerts.length > 0 && (
        <View style={{ paddingHorizontal: 16, marginBottom: 8 }}>
          <Text variant="labelLarge" style={{ marginBottom: 8, color: '#333' }}>Medical Alerts</Text>
          {alerts.map((alert, i) => (
            <AlertBadge key={i} text={alert.text} severity={alert.severity} />
          ))}
        </View>
      )}

      {/* Special Instructions */}
      {participant?.special_instructions && (
        <Card style={{ marginHorizontal: 16, marginBottom: 8 }}>
          <Card.Content>
            <Text variant="labelLarge" style={{ marginBottom: 4 }}>Special Instructions</Text>
            <Text variant="bodyMedium" style={{ color: '#555' }}>
              {participant.special_instructions}
            </Text>
          </Card.Content>
        </Card>
      )}

      {/* Address */}
      {participant?.address && (
        <Card style={{ marginHorizontal: 16, marginBottom: 8 }}>
          <Card.Content>
            <Text variant="labelLarge" style={{ marginBottom: 4 }}>Address</Text>
            <Text variant="bodyMedium" style={{ color: '#555' }}>
              {participant.address}
            </Text>
          </Card.Content>
        </Card>
      )}

      {/* Notes */}
      {shift.notes && (
        <Card style={{ marginHorizontal: 16, marginBottom: 8 }}>
          <Card.Content>
            <Text variant="labelLarge" style={{ marginBottom: 4 }}>Shift Notes</Text>
            <Text variant="bodyMedium" style={{ color: '#555' }}>{shift.notes}</Text>
          </Card.Content>
        </Card>
      )}

      {/* Check-in/out status */}
      {hasCheckedIn && (
        <Card style={{ marginHorizontal: 16, marginBottom: 8 }}>
          <Card.Content>
            <Text variant="labelLarge" style={{ marginBottom: 4 }}>Check-in Record</Text>
            <Text variant="bodySmall">
              Checked in: {format(new Date(checkInRecord.check_in_time), 'h:mm a')}
            </Text>
            {hasCheckedOut && (
              <>
                <Text variant="bodySmall">
                  Checked out: {format(new Date(checkInRecord.check_out_time!), 'h:mm a')}
                  {checkInRecord.check_out_type === 'auto' && ' (auto)'}
                  {checkInRecord.check_out_type === 'admin_override' && ' (override)'}
                </Text>
                <Text variant="bodySmall">
                  Duration: {checkInRecord.duration_minutes} minutes
                </Text>
              </>
            )}
          </Card.Content>
        </Card>
      )}

      {/* Error message */}
      {checkInError && (
        <View style={{ marginHorizontal: 16, marginBottom: 8, padding: 12, backgroundColor: '#FFEBEE', borderRadius: 8 }}>
          <Text style={{ color: '#C62828' }}>{checkInError}</Text>
        </View>
      )}

      {/* Action button */}
      <View style={{ padding: 16 }}>
        {canCheckIn && (
          <Button
            mode="contained"
            onPress={handleCheckIn}
            loading={checkingIn}
            disabled={checkingIn}
            buttonColor="#66BB6A"
            style={{ borderRadius: 8, paddingVertical: 4 }}
          >
            Check In
          </Button>
        )}
        {canCheckOut && (
          <Button
            mode="contained"
            onPress={() => {/* Check-out implemented in Plan 06 */}}
            buttonColor="#42A5F5"
            style={{ borderRadius: 8, paddingVertical: 4 }}
          >
            Check Out
          </Button>
        )}
        {hasCheckedOut && (
          <View style={{ alignItems: 'center', padding: 8 }}>
            <Text variant="bodyMedium" style={{ color: '#66BB6A' }}>Shift completed</Text>
          </View>
        )}
      </View>
    </ScrollView>
  )
}
```

Key points:
- Shows medical alerts BEFORE check-in button (MOBL-07)
- Alerts color-coded by severity (red/yellow/blue)
- Check-in button shows loading state during GPS + proximity check
- Error message displayed in red box below shift info
- Check-out button placeholder (implemented in Plan 06)
- Shows check-in record with timestamps if already checked in
- Shows duration and check-out type (auto/override) if checked out
  </action>
  <verify>Check: `grep "useCheckIn\|useShiftDetail\|AlertBadge" apps/worker-mobile/app/shift/\[id\].tsx`</verify>
  <done>Shift detail screen displays participant info, medical alerts (color-coded), special instructions, address, and shift notes. Check-in button enforces 500m GPS proximity. Error states shown clearly. Check-out button placeholder ready for Plan 06.</done>
</task>

</tasks>

<verification>
- Shift detail loads via useShiftDetail(id) and displays participant name, time, support type
- Medical alerts parsed from newline-separated text with severity prefixes
- AlertBadge renders red/yellow/blue backgrounds based on severity
- Check-in flow: requestLocation -> isWithinRadius -> insert to shift_check_ins
- Distance error message shows actual meters (e.g., "You are 850m away")
- Offline check-in queues to syncStore
</verification>

<success_criteria>
- Worker sees shift detail with all participant info and alerts before check-in (MOBL-07)
- Worker within 500m can check in successfully (MOBL-02)
- Worker outside 500m sees clear distance message (GPS proximity enforcement)
- Check-in records GPS coordinates and timestamp in database
- Offline check-in queues action for later sync (MOBL-09 partial)
</success_criteria>

<output>
After completion, create `.planning/phases/05-worker-mobile-app/05-05-SUMMARY.md`
</output>
