---
phase: 05-worker-mobile-app
plan: 06
type: execute
wave: 4
depends_on: ["05-05"]
files_modified:
  - apps/worker-mobile/hooks/useActiveShift.ts
  - apps/worker-mobile/hooks/useCheckOut.ts
  - apps/worker-mobile/components/TimerBar.tsx
  - apps/worker-mobile/components/CaseNoteModal.tsx
  - apps/worker-mobile/app/shift/[id].tsx
  - apps/worker-mobile/app/(tabs)/_layout.tsx
autonomous: true

must_haves:
  truths:
    - "Worker sees live elapsed timer in header bar during active shift (HH:MM:SS format)"
    - "Timer survives app backgrounding and shows correct elapsed time on foreground resume"
    - "Worker can check out and sees calculated duration (actual hours and minutes)"
    - "After check-out, full-screen modal prompts for case note with Write Note and Skip buttons"
    - "Timer bar is visible across all tabs during active shift"
  artifacts:
    - path: "apps/worker-mobile/hooks/useActiveShift.ts"
      provides: "AppState-aware elapsed timer hook"
      exports: ["useElapsedTimer", "formatElapsed"]
    - path: "apps/worker-mobile/hooks/useCheckOut.ts"
      provides: "Check-out hook with duration calculation"
      exports: ["useCheckOut"]
    - path: "apps/worker-mobile/components/TimerBar.tsx"
      provides: "Persistent header timer bar with green dot and elapsed time"
      exports: ["TimerBar"]
    - path: "apps/worker-mobile/components/CaseNoteModal.tsx"
      provides: "Full-screen modal for case note prompt after check-out"
      exports: ["CaseNoteModal"]
  key_links:
    - from: "apps/worker-mobile/components/TimerBar.tsx"
      to: "apps/worker-mobile/stores/shiftStore.ts"
      via: "useShiftStore reads activeShiftStart"
      pattern: "useShiftStore"
    - from: "apps/worker-mobile/hooks/useCheckOut.ts"
      to: "apps/worker-mobile/stores/shiftStore.ts"
      via: "clearActiveShift on checkout"
      pattern: "clearActiveShift"
    - from: "apps/worker-mobile/app/(tabs)/_layout.tsx"
      to: "apps/worker-mobile/components/TimerBar.tsx"
      via: "TimerBar rendered above Tabs"
      pattern: "TimerBar"
---

<objective>
Live timer during active shifts, check-out flow with duration calculation, and case note prompt.

Purpose: Workers need a persistent visual indicator of elapsed shift time (MOBL-03) that works correctly even after backgrounding the app. Check-out (MOBL-04) calculates actual duration and prompts the worker to add a case note (MOBL-05) before returning to the home screen.

Output: Timer hook, timer bar component, check-out hook, case note modal, updated shift detail and tab layout.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/05-worker-mobile-app/05-RESEARCH.md
@apps/worker-mobile/stores/shiftStore.ts
@apps/worker-mobile/app/shift/[id].tsx
@apps/worker-mobile/app/(tabs)/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Timer hook, timer bar, and check-out hook</name>
  <files>apps/worker-mobile/hooks/useActiveShift.ts, apps/worker-mobile/hooks/useCheckOut.ts, apps/worker-mobile/components/TimerBar.tsx</files>
  <action>
1. **Create hooks/useActiveShift.ts:**

Follow the exact implementation from 05-RESEARCH.md Pattern 4 (AppState-Based Live Timer). Copy `useElapsedTimer` and `formatElapsed` functions. Key behavior:
- Store check-in start time (from shiftStore)
- setInterval every 1 second: elapsed = Date.now() - startTime
- AppState listener: recalculate on 'active' event (foreground resume)
- Return elapsed in seconds
- formatElapsed converts to "HH:MM:SS"

2. **Create hooks/useCheckOut.ts:**

```typescript
import { useState } from 'react'
import { supabase } from '../lib/supabase'
import { useShiftStore } from '../stores/shiftStore'
import { useSyncStore } from '../stores/syncStore'
import { useCurrentLocation } from './useLocation'
import { useQueryClient } from '@tanstack/react-query'

interface CheckOutResult {
  success: boolean
  durationMinutes?: number
  error?: string
}

export function useCheckOut() {
  const [loading, setLoading] = useState(false)
  const clearActiveShift = useShiftStore((s) => s.clearActiveShift)
  const activeShiftId = useShiftStore((s) => s.activeShiftId)
  const addPendingAction = useSyncStore((s) => s.addPendingAction)
  const { requestLocation } = useCurrentLocation()
  const queryClient = useQueryClient()

  async function checkOut(): Promise<CheckOutResult> {
    if (!activeShiftId) {
      return { success: false, error: 'No active shift to check out from' }
    }

    setLoading(true)
    try {
      const timestamp = new Date().toISOString()

      // Get GPS (optional for checkout - don't block if fails)
      const coords = await requestLocation()

      // Calculate duration from check-in time
      const { data: checkInRecord } = await supabase
        .from('shift_check_ins')
        .select('check_in_time')
        .eq('shift_id', activeShiftId)
        .single() as any

      let durationMinutes: number | null = null
      if (checkInRecord?.check_in_time) {
        const checkInTime = new Date(checkInRecord.check_in_time)
        const checkOutTime = new Date(timestamp)
        durationMinutes = Math.round((checkOutTime.getTime() - checkInTime.getTime()) / (1000 * 60))
      }

      // Update check-in record with checkout info
      const updateData: any = {
        check_out_time: timestamp,
        check_out_type: 'manual',
        duration_minutes: durationMinutes,
      }
      if (coords) {
        updateData.check_out_latitude = coords.latitude
        updateData.check_out_longitude = coords.longitude
      }

      const { error: dbError } = await supabase
        .from('shift_check_ins')
        .update(updateData)
        .eq('shift_id', activeShiftId)

      if (dbError) {
        // Offline: queue for sync
        addPendingAction({
          type: 'check_out',
          shiftId: activeShiftId,
          timestamp,
          latitude: coords?.latitude ?? 0,
          longitude: coords?.longitude ?? 0,
        })
      }

      // Update shift status to completed
      await supabase
        .from('shifts')
        .update({ status: 'completed' } as any)
        .eq('id', activeShiftId)

      // Clear active shift state
      clearActiveShift()

      // Invalidate queries
      queryClient.invalidateQueries({ queryKey: ['shift', activeShiftId] })
      queryClient.invalidateQueries({ queryKey: ['shifts'] })

      return { success: true, durationMinutes: durationMinutes ?? undefined }
    } finally {
      setLoading(false)
    }
  }

  return { checkOut, loading }
}
```

3. **Create components/TimerBar.tsx:**

Follow the implementation from 05-RESEARCH.md "Timer Bar Component" pattern. Key details:
- Reads activeShiftStart from useShiftStore
- Uses useElapsedTimer hook for elapsed seconds
- Shows green dot + formatted time (HH:MM:SS)
- Light blue background (#E3F2FD)
- `fontVariant: ['tabular-nums']` for non-jumping digits
- Returns null if no active shift
- Small and persistent (per CONTEXT.md: "Timer should be small and persistent (header bar)")
  </action>
  <verify>Check exports: `grep "export" apps/worker-mobile/hooks/useActiveShift.ts apps/worker-mobile/hooks/useCheckOut.ts apps/worker-mobile/components/TimerBar.tsx`</verify>
  <done>Timer hook uses AppState for background-proof elapsed time. Check-out calculates duration minutes, updates DB, queues offline if needed, clears active shift. TimerBar shows elapsed HH:MM:SS with green dot on light blue background.</done>
</task>

<task type="auto">
  <name>Task 2: Case note modal and integration into shift detail + tab layout</name>
  <files>apps/worker-mobile/components/CaseNoteModal.tsx, apps/worker-mobile/app/shift/[id].tsx, apps/worker-mobile/app/(tabs)/_layout.tsx</files>
  <action>
1. **Create components/CaseNoteModal.tsx:**

Full-screen modal shown after check-out. Two buttons: "Write Note" and "Skip". If "Write Note" tapped, show a text input. The note is saved to case_notes table (or just stored locally if table doesn't exist yet -- Phase 6 creates the full case notes system). For now, the modal prompts and Skip just dismisses.

```typescript
import { useState } from 'react'
import { View, Modal, KeyboardAvoidingView, Platform } from 'react-native'
import { Text, Button, TextInput } from 'react-native-paper'

interface CaseNoteModalProps {
  visible: boolean
  shiftId: string
  participantName: string
  durationMinutes?: number
  onDismiss: () => void
}

export function CaseNoteModal({
  visible, shiftId, participantName, durationMinutes, onDismiss,
}: CaseNoteModalProps) {
  const [showInput, setShowInput] = useState(false)
  const [note, setNote] = useState('')
  const [saving, setSaving] = useState(false)

  const handleSkip = () => {
    setShowInput(false)
    setNote('')
    onDismiss()
  }

  const handleSave = async () => {
    // Phase 6 will implement full case notes system
    // For now, just dismiss (note text is ready for Phase 6 integration)
    setSaving(true)
    // TODO: Save to case_notes table when Phase 6 creates it
    setSaving(false)
    setShowInput(false)
    setNote('')
    onDismiss()
  }

  return (
    <Modal visible={visible} animationType="slide" presentationStyle="fullScreen">
      <KeyboardAvoidingView
        style={{ flex: 1 }}
        behavior={Platform.OS === 'ios' ? 'padding' : undefined}
      >
        <View style={{ flex: 1, justifyContent: 'center', padding: 24, backgroundColor: '#fff' }}>
          <Text variant="headlineSmall" style={{ textAlign: 'center', fontWeight: '600', marginBottom: 8 }}>
            Shift Complete
          </Text>
          <Text variant="bodyMedium" style={{ textAlign: 'center', color: '#666', marginBottom: 4 }}>
            {participantName}
          </Text>
          {durationMinutes !== undefined && (
            <Text variant="bodyMedium" style={{ textAlign: 'center', color: '#66BB6A', marginBottom: 24 }}>
              Duration: {Math.floor(durationMinutes / 60)}h {durationMinutes % 60}m
            </Text>
          )}

          {!showInput ? (
            <>
              <Text variant="bodyLarge" style={{ textAlign: 'center', marginBottom: 24 }}>
                Would you like to add a case note?
              </Text>
              <Button
                mode="contained"
                onPress={() => setShowInput(true)}
                buttonColor="#66BB6A"
                style={{ marginBottom: 12, borderRadius: 8 }}
              >
                Write Note
              </Button>
              <Button
                mode="outlined"
                onPress={handleSkip}
                textColor="#666"
                style={{ borderRadius: 8 }}
              >
                Skip
              </Button>
            </>
          ) : (
            <>
              <TextInput
                mode="outlined"
                label="Case note"
                value={note}
                onChangeText={setNote}
                multiline
                numberOfLines={6}
                style={{ marginBottom: 16, minHeight: 120 }}
                outlineColor="#ccc"
                activeOutlineColor="#66BB6A"
                placeholder="Describe the care delivered during this shift..."
              />
              <Button
                mode="contained"
                onPress={handleSave}
                loading={saving}
                disabled={note.trim().length < 10}
                buttonColor="#66BB6A"
                style={{ marginBottom: 12, borderRadius: 8 }}
              >
                Save Note
              </Button>
              <Button
                mode="text"
                onPress={handleSkip}
                textColor="#999"
              >
                Skip for now
              </Button>
            </>
          )}
        </View>
      </KeyboardAvoidingView>
    </Modal>
  )
}
```

2. **Update app/shift/[id].tsx** to wire check-out + case note modal:

Add to the existing shift detail screen:
- Import useCheckOut and CaseNoteModal
- Add state: `const [showNoteModal, setShowNoteModal] = useState(false)` and `const [checkoutDuration, setCheckoutDuration] = useState<number | undefined>()`
- Replace the check-out button placeholder with actual handler:
  ```
  const handleCheckOut = async () => {
    const result = await checkOut()
    if (result.success) {
      setCheckoutDuration(result.durationMinutes)
      setShowNoteModal(true)
    }
  }
  ```
- Add CaseNoteModal at bottom of component:
  ```
  <CaseNoteModal
    visible={showNoteModal}
    shiftId={shift.id}
    participantName={`${participant.first_name} ${participant.last_name}`}
    durationMinutes={checkoutDuration}
    onDismiss={() => { setShowNoteModal(false); router.back() }}
  />
  ```

3. **Update app/(tabs)/_layout.tsx** to include TimerBar:

Add TimerBar above the Tabs component so it's visible across all tabs during active shift:

```typescript
import { View } from 'react-native'
import { Tabs } from 'expo-router'
import { MaterialCommunityIcons } from '@expo/vector-icons'
import { TimerBar } from '../../components/TimerBar'

export default function TabLayout() {
  return (
    <View style={{ flex: 1 }}>
      <TimerBar />
      <Tabs
        screenOptions={{...existing options...}}
      >
        {...existing tab screens...}
      </Tabs>
    </View>
  )
}
```

The TimerBar renders above tabs only when there's an active shift (returns null otherwise).
  </action>
  <verify>Check integration: `grep "CaseNoteModal\|useCheckOut\|TimerBar" apps/worker-mobile/app/shift/\[id\].tsx apps/worker-mobile/app/\(tabs\)/_layout.tsx`</verify>
  <done>CaseNoteModal prompts after checkout with Write Note/Skip. Shift detail has working check-out button that triggers modal. TimerBar visible across all tabs during active shift. Timer shows correct elapsed time including after backgrounding.</done>
</task>

</tasks>

<verification>
- Timer shows HH:MM:SS format updating every second
- Backgrounding app for 5 minutes and resuming shows correct elapsed (not frozen)
- Check-out calculates duration_minutes correctly
- Check-out updates shift_check_ins and shifts.status
- Case note modal appears after successful check-out
- Skip dismisses modal and navigates back
- TimerBar visible on all 4 tabs during active shift
- TimerBar hidden when no active shift
</verification>

<success_criteria>
- Worker sees live timer during active shift (MOBL-03)
- Timer survives app backgrounding (AppState-aware)
- Worker can check out and sees duration (MOBL-04)
- Case note prompt appears after check-out with Write Note and Skip (MOBL-05)
- Timer bar is small, persistent, and doesn't block navigation
</success_criteria>

<output>
After completion, create `.planning/phases/05-worker-mobile-app/05-06-SUMMARY.md`
</output>
