---
phase: 05-worker-mobile-app
plan: 08
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/admin/app/api/shifts/[id]/override-checkout/route.ts
  - apps/admin/lib/shifts/schemas.ts
autonomous: true

must_haves:
  truths:
    - "Admin can POST to /api/shifts/[id]/override-checkout with a new checkout time"
    - "Override updates shift_check_ins with check_out_type = 'admin_override'"
    - "Override recalculates duration_minutes from original check-in to new checkout"
    - "Unauthenticated or non-admin users receive 403 error"
  artifacts:
    - path: "apps/admin/app/api/shifts/[id]/override-checkout/route.ts"
      provides: "Admin API route for overriding worker checkout time"
      exports: ["POST"]
    - path: "apps/admin/lib/shifts/schemas.ts"
      provides: "Zod schema for override checkout request body"
      contains: "overrideCheckoutSchema"
  key_links:
    - from: "apps/admin/app/api/shifts/[id]/override-checkout/route.ts"
      to: "supabase shift_check_ins table"
      via: "supabase.from('shift_check_ins').update()"
      pattern: "shift_check_ins.*update"
---

<objective>
Admin API endpoint for overriding worker check-out time.

Purpose: Admins need the ability to manually set or correct a worker's check-out time (MOBL-11) -- for cases where auto-checkout triggered incorrectly, or a worker forgot to check out and the actual end time is known. This runs on the admin portal (Next.js API route), not the mobile app.

Output: POST /api/shifts/[id]/override-checkout endpoint with validation and authorization.
</objective>

<execution_context>
@/Users/shamalkrishna/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shamalkrishna/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/admin/lib/shifts/schemas.ts
@supabase/migrations/20260124300001_add_shift_check_ins.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Override checkout API route and schema</name>
  <files>apps/admin/app/api/shifts/[id]/override-checkout/route.ts, apps/admin/lib/shifts/schemas.ts</files>
  <action>
1. **Add overrideCheckoutSchema to apps/admin/lib/shifts/schemas.ts:**

Append to the existing schemas file:

```typescript
export const overrideCheckoutSchema = z.object({
  check_out_time: z.string().datetime({ message: 'Valid ISO datetime required' }),
})
```

2. **Create apps/admin/app/api/shifts/[id]/override-checkout/route.ts:**

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { overrideCheckoutSchema } from '@/lib/shifts/schemas'

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id: shiftId } = await params

  // 1. Auth check
  const supabase = await createClient()
  const { data: { user }, error: authError } = await supabase.auth.getUser()

  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  // 2. Role check (admin or coordinator only)
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single()

  if (!profile || !['admin', 'coordinator'].includes(profile.role)) {
    return NextResponse.json({ error: 'Forbidden: Admin or Coordinator role required' }, { status: 403 })
  }

  // 3. Parse and validate body
  const body = await request.json()
  const parsed = overrideCheckoutSchema.safeParse(body)

  if (!parsed.success) {
    return NextResponse.json(
      { error: 'Validation failed', details: parsed.error.flatten().fieldErrors },
      { status: 400 }
    )
  }

  const { check_out_time } = parsed.data

  // 4. Get existing check-in record
  const { data: checkIn, error: fetchError } = await supabase
    .from('shift_check_ins')
    .select('id, check_in_time, shift_id')
    .eq('shift_id', shiftId)
    .single() as any

  if (fetchError || !checkIn) {
    return NextResponse.json(
      { error: 'No check-in record found for this shift' },
      { status: 404 }
    )
  }

  // 5. Validate checkout time is after check-in time
  const checkInDate = new Date(checkIn.check_in_time)
  const checkOutDate = new Date(check_out_time)

  if (checkOutDate <= checkInDate) {
    return NextResponse.json(
      { error: 'Check-out time must be after check-in time' },
      { status: 400 }
    )
  }

  // 6. Calculate duration
  const durationMinutes = Math.round(
    (checkOutDate.getTime() - checkInDate.getTime()) / (1000 * 60)
  )

  // 7. Update check-in record
  const { error: updateError } = await supabase
    .from('shift_check_ins')
    .update({
      check_out_time: check_out_time,
      check_out_type: 'admin_override',
      duration_minutes: durationMinutes,
    } as any)
    .eq('shift_id', shiftId)

  if (updateError) {
    return NextResponse.json({ error: 'Failed to update checkout' }, { status: 500 })
  }

  // 8. Update shift status to completed
  await supabase
    .from('shifts')
    .update({ status: 'completed' } as any)
    .eq('id', shiftId)

  return NextResponse.json({
    success: true,
    shift_id: shiftId,
    check_out_time,
    check_out_type: 'admin_override',
    duration_minutes: durationMinutes,
  })
}
```

Key points:
- Uses `await params` pattern (Next.js 15 async params)
- Role check: only admin or coordinator can override
- Validates checkout is after check-in (prevents invalid data)
- Calculates duration_minutes from check-in to new checkout
- Sets check_out_type to 'admin_override' (distinguishable from manual/auto)
- Also updates shift status to completed
- Uses `as any` for Supabase query (established pattern)
  </action>
  <verify>Check file exists: `ls apps/admin/app/api/shifts/\[id\]/override-checkout/route.ts` and verify schema: `grep "overrideCheckoutSchema" apps/admin/lib/shifts/schemas.ts`</verify>
  <done>POST /api/shifts/[id]/override-checkout validates admin role, checks checkout > check-in, calculates duration, updates shift_check_ins with admin_override type. Schema validates ISO datetime.</done>
</task>

</tasks>

<verification>
- Route file exists at correct path with POST export
- Schema validates ISO datetime string
- 401 returned for unauthenticated requests
- 403 returned for non-admin/coordinator roles
- 400 returned if checkout time is before check-in time
- 404 returned if no check-in record exists
- 200 returned with correct duration_minutes on success
</verification>

<success_criteria>
- Admin can override a worker's check-out time from the admin portal (MOBL-11)
- Override correctly recalculates duration
- check_out_type is set to 'admin_override' (distinguishable in UI)
- Non-admin users cannot access the endpoint
</success_criteria>

<output>
After completion, create `.planning/phases/05-worker-mobile-app/05-08-SUMMARY.md`
</output>
