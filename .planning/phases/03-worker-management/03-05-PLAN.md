---
phase: 03-worker-management
plan: 05
type: execute
wave: 3
depends_on: ["03-02", "03-03", "03-04"]
files_modified:
  - apps/admin/components/workers/worker-edit-form.tsx
  - apps/admin/app/(protected)/workers/[id]/edit/page.tsx
  - apps/admin/app/api/workers/resend-invite/route.ts
  - apps/admin/components/workers/worker-detail.tsx
  - apps/admin/hooks/use-workers.ts
autonomous: true

must_haves:
  truths:
    - "Admin can edit all worker fields except email (email shown as read-only locked field)"
    - "Saving edits updates the worker and profile records in the database"
    - "Admin can resend invite email from the worker detail page"
    - "Detail page shows Edit, Resend Invite, and Back actions"
    - "Edit form pre-fills all current worker data correctly"
  artifacts:
    - path: "apps/admin/components/workers/worker-edit-form.tsx"
      provides: "Worker edit form with read-only email and pre-filled fields"
      exports: ["WorkerEditForm"]
    - path: "apps/admin/app/(protected)/workers/[id]/edit/page.tsx"
      provides: "Server page that fetches worker data and renders edit form"
      min_lines: 15
    - path: "apps/admin/app/api/workers/resend-invite/route.ts"
      provides: "API route to resend invite link for a worker"
      exports: ["POST"]
  key_links:
    - from: "apps/admin/components/workers/worker-edit-form.tsx"
      to: "apps/admin/hooks/use-workers.ts"
      via: "useUpdateWorker mutation hook"
      pattern: "useUpdateWorker"
    - from: "apps/admin/components/workers/worker-detail.tsx"
      to: "apps/admin/app/api/workers/resend-invite/route.ts"
      via: "fetch POST for resend invite button"
      pattern: "resend-invite"
---

<objective>
Build the worker edit form (email read-only), resend invite API route, and update the detail page with action buttons (Edit, Resend Invite).

Purpose: WORK-04 requires admin to edit worker details except email. WORK-05 requires invite resend capability. This completes the worker CRUD lifecycle.
Output: Edit form at /workers/[id]/edit, resend invite endpoint, and updated detail page with all action buttons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-worker-management/03-RESEARCH.md
@.planning/phases/03-worker-management/03-01-SUMMARY.md
@.planning/phases/03-worker-management/03-03-SUMMARY.md
@.planning/phases/03-worker-management/03-04-SUMMARY.md

# Pattern reference â€” participant edit form
@apps/admin/components/participants/participant-edit-form.tsx
@apps/admin/app/(protected)/participants/[id]/edit/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update worker mutation hook and resend invite API route</name>
  <files>apps/admin/hooks/use-workers.ts, apps/admin/app/api/workers/resend-invite/route.ts</files>
  <action>
**Add to use-workers.ts** (append to existing file created in Plan 02):

Add `useUpdateWorker(workerId: string)` mutation hook:
- mutationFn: Takes WorkerEditData, splits into profile fields (first_name, last_name, phone) and worker fields (services_provided, qualification, hourly_rate, max_hours_per_week, ndis_check_number, ndis_check_expiry, wwcc_number, wwcc_expiry)
- Update profile: `supabase.from('profiles').update({ first_name, last_name, phone }).eq('id', profileId)` (use `as any` for type assertion)
- Update worker: `supabase.from('workers').update(workerFields).eq('id', workerId)` (use `as any` for type assertion)
- Convert empty date strings to null before update
- onSuccess: invalidate ['workers'] and ['worker', workerId] queries, show success toast, navigate to /workers/[id]
- onError: show error toast

Add `useResendInvite()` mutation hook:
- mutationFn: Takes `{ email: string }`, POST to `/api/workers/resend-invite` with JSON body
- onSuccess: show success toast "Invite resent successfully"
- onError: show error toast

**resend-invite/route.ts:**
Create API route that:
1. Verify caller is admin/coordinator (same auth check as invite route)
2. Parse request body: `{ email: string }`
3. Use `createAdminClient()` to call:
   ```typescript
   admin.auth.admin.generateLink({
     type: 'invite',
     email,
     options: { redirectTo: process.env.NEXT_PUBLIC_SITE_URL + '/auth/callback' }
   })
   ```
4. Return `{ success: true }` on success or error response on failure
5. Note: Supabase automatically sends the invite email when SMTP is configured. For local dev, the link appears in Inbucket.
  </action>
  <verify>TypeScript compiles. useUpdateWorker splits updates between profiles and workers tables. useResendInvite calls the resend API. Resend route uses generateLink with type 'invite'.</verify>
  <done>Worker update mutation correctly splits profile vs worker field updates. Resend invite endpoint generates a new invite link for existing workers.</done>
</task>

<task type="auto">
  <name>Task 2: Worker edit form component and page</name>
  <files>apps/admin/components/workers/worker-edit-form.tsx, apps/admin/app/(protected)/workers/[id]/edit/page.tsx</files>
  <action>
**worker-edit-form.tsx:** Client component matching participant-edit-form.tsx pattern:

Props: `{ worker: WorkerWithProfile }`

Use `useForm` with `zodResolver(workerEditSchema)` and defaultValues pre-filled from worker data:
- first_name: worker.profiles.first_name
- last_name: worker.profiles.last_name
- phone: worker.profiles.phone ?? ''
- services_provided: worker.services_provided ?? []
- qualification: worker.qualification ?? []
- hourly_rate: worker.hourly_rate ?? undefined
- max_hours_per_week: worker.max_hours_per_week ?? 38
- ndis_check_number: worker.ndis_check_number ?? ''
- ndis_check_expiry: worker.ndis_check_expiry ?? ''
- wwcc_number: worker.wwcc_number ?? ''
- wwcc_expiry: worker.wwcc_expiry ?? ''

Layout: Same 3 sections as the create form (Basic Info, Support Types & Qualifications, Compliance Checks) with these differences:
- **Email field:** Shown as read-only static text with Lock icon (same pattern as NDIS number in participant edit). Not an input field. Display worker.profiles.email with a lock icon and "Email cannot be changed" helper text.
- **Qualifications:** Pre-fill textarea with qualification array joined by newlines

On submit:
- Transform qualification textarea into array
- Convert empty date strings to null
- Call `updateWorker.mutate(data)` with the workerId

Footer: Cancel (link to /workers/[id]) and "Save Changes" button with loading state.

**[id]/edit/page.tsx:** Server component:
- Fetch worker by id with profile join (same query as detail page)
- If not found, call `notFound()`
- Pass worker.profile_id as the profileId prop to the form for the profile update
- Render WorkerEditForm with worker data
- Metadata: `{ title: 'Edit Worker | Ephraim Care' }`
  </action>
  <verify>TypeScript compiles. Edit form pre-fills all fields from worker data. Email shown as locked text. Form uses workerEditSchema (no email field). Submit calls useUpdateWorker.</verify>
  <done>Worker edit form pre-fills all current data, shows email as locked read-only, validates with workerEditSchema, and saves changes to both profiles and workers tables.</done>
</task>

<task type="auto">
  <name>Task 3: Update detail page with action buttons</name>
  <files>apps/admin/components/workers/worker-detail.tsx</files>
  <action>
Update the worker-detail.tsx component (created in Plan 04) to add functional action buttons:

**Header actions (right side of header row):**
1. **Edit button:** Link/Button that navigates to `/workers/${worker.id}/edit`. Use Pencil icon from lucide-react. Outlined/secondary variant.
2. **Resend Invite button:** Button that calls `resendInvite.mutate({ email: worker.profiles.email })`. Use Mail icon. Outlined variant. Show loading spinner during mutation. Only show this button when the worker is active (is_active = true).
3. **Back to Workers:** Link to /workers. Use ArrowLeft icon. Ghost variant.

Import `useResendInvite` from `@/hooks/use-workers`.

Button layout: Back button on the left, Edit and Resend Invite on the right (flex with gap).

Add a Separator between the header and the stats section for visual clarity.

Ensure the component remains a client component ('use client') since it now uses hooks.
  </action>
  <verify>TypeScript compiles. Detail page shows Edit, Resend Invite, and Back buttons. Resend Invite button calls the API and shows loading state. Resend only visible for active workers.</verify>
  <done>Worker detail page has functional Edit, Resend Invite, and Back buttons. Resend Invite triggers the invite email resend and shows success/error feedback via toast.</done>
</task>

</tasks>

<verification>
1. /workers/[id]/edit loads with pre-filled form data
2. Email field is shown as locked static text (not editable)
3. Saving changes updates both profile (name, phone) and worker (support types, compliance, etc.) records
4. After save, redirected to worker detail page with updated data
5. "Resend Invite" button on detail page triggers invite email
6. Resend shows success toast on completion
7. All action buttons visible on detail page: Back, Edit, Resend Invite
8. Resend Invite only shown for active workers
</verification>

<success_criteria>
- Edit form uses workerEditSchema (email excluded from validation)
- Profile and worker updates happen as separate queries (profile table + workers table)
- Empty compliance date strings converted to null before database update
- Resend invite uses Supabase admin generateLink API (not inviteUserByEmail which creates duplicate users)
- All 3 action buttons functional on detail page
</success_criteria>

<output>
After completion, create `.planning/phases/03-worker-management/03-05-SUMMARY.md`
</output>
