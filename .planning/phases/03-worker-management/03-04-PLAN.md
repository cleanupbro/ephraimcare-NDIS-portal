---
phase: 03-worker-management
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/admin/components/workers/worker-detail.tsx
  - apps/admin/components/workers/worker-stats.tsx
  - apps/admin/components/workers/worker-compliance.tsx
  - apps/admin/hooks/use-worker-stats.ts
  - apps/admin/app/(protected)/workers/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Worker detail page shows full name, email, phone, support types, and qualifications"
    - "Detail page shows three stat cards: Hours This Week, Hours This Month, Next Shift"
    - "Detail page shows a compliance section with NDIS check and WWCC check details"
    - "Compliance items display status badges (Valid/Expiring/Expired) with colored indicators"
    - "Stats show 0 hours and 'No upcoming shifts' when no shift data exists yet"
  artifacts:
    - path: "apps/admin/components/workers/worker-detail.tsx"
      provides: "Main detail layout with profile info, qualifications, and action buttons"
      exports: ["WorkerDetail"]
    - path: "apps/admin/components/workers/worker-stats.tsx"
      provides: "Three stat cards for scheduling data"
      exports: ["WorkerStats"]
    - path: "apps/admin/components/workers/worker-compliance.tsx"
      provides: "Compliance section with check details and status badges"
      exports: ["WorkerCompliance"]
    - path: "apps/admin/hooks/use-worker-stats.ts"
      provides: "TanStack Query hook for worker scheduling statistics"
      exports: ["useWorkerStats"]
    - path: "apps/admin/app/(protected)/workers/[id]/page.tsx"
      provides: "Server component page that fetches worker data"
      min_lines: 20
  key_links:
    - from: "apps/admin/components/workers/worker-stats.tsx"
      to: "apps/admin/hooks/use-worker-stats.ts"
      via: "useWorkerStats hook for hours and next shift data"
      pattern: "useWorkerStats"
    - from: "apps/admin/components/workers/worker-compliance.tsx"
      to: "apps/admin/lib/workers/constants.ts"
      via: "getComplianceStatus for each check type"
      pattern: "getComplianceStatus"
    - from: "apps/admin/app/(protected)/workers/[id]/page.tsx"
      to: "supabase workers table"
      via: "server-side fetch by worker id with profile join"
      pattern: "from.*workers.*eq.*id"
---

<objective>
Build the worker detail page with profile information, scheduling stats (hours this week/month, next shift), qualifications section, and compliance section with traffic light status badges.

Purpose: WORK-03 requires the detail page with scheduling stats. WORK-07 and WORK-08 require NDIS and WWCC check display with expiry dates.
Output: Fully functional /workers/[id] page showing all worker profile data with visual compliance indicators.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-worker-management/03-RESEARCH.md
@.planning/phases/03-worker-management/03-01-SUMMARY.md

# Pattern reference — participant detail page
@apps/admin/components/participants/participant-detail.tsx
@apps/admin/app/(protected)/participants/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Worker stats hook and stat cards component</name>
  <files>apps/admin/hooks/use-worker-stats.ts, apps/admin/components/workers/worker-stats.tsx</files>
  <action>
**use-worker-stats.ts:**
Create a TanStack Query hook that fetches scheduling statistics for a worker:

```typescript
import { useQuery } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'
import { startOfISOWeek, startOfMonth, differenceInMinutes } from 'date-fns'
```

- queryKey: `['worker-stats', workerId]`
- enabled: `!!workerId`
- queryFn:
  1. Get hours this week: Query shifts where worker_id matches, status = 'completed', scheduled_start >= start of current ISO week. Sum actual_start to actual_end durations in hours.
  2. Get hours this month: Same query but scheduled_start >= start of current month.
  3. Get next shift: Query shifts where worker_id matches, status in ('pending', 'confirmed'), scheduled_start >= now(), order by scheduled_start asc, limit 1, maybeSingle(). Join participants for name display.
- Helper: `calculateTotalHours(shifts)` — reduce over shifts, calculate differenceInMinutes(actual_end, actual_start) / 60 for each, sum. Skip shifts where actual_start or actual_end is null.
- Return: `{ hoursThisWeek: number, hoursThisMonth: number, nextShift: {...} | null }`

**worker-stats.tsx:**
Create a component that displays 3 stat cards in a responsive grid (3 columns on lg, 1 on mobile):

1. **Hours This Week** — Clock icon (lucide). Value: `hoursThisWeek.toFixed(1) + ' hrs'`. Show "0.0 hrs" if no data.
2. **Hours This Month** — Calendar icon (lucide). Value: `hoursThisMonth.toFixed(1) + ' hrs'`. Show "0.0 hrs" if no data.
3. **Next Shift** — CalendarClock icon (lucide). Value: If nextShift exists, show participant name + formatted date (e.g., "John Doe - Mon 27 Jan, 9:00 AM"). If null, show "No upcoming shifts" in muted text.

Props: `{ workerId: string }`
Use `useWorkerStats(workerId)` internally.
Each stat card: Card component with CardHeader (icon + label) and CardContent (value in large text).
Show skeleton/loading state while query is loading.
  </action>
  <verify>TypeScript compiles. useWorkerStats returns correct shape. WorkerStats renders 3 cards. Stats show "0.0 hrs" and "No upcoming shifts" when no shift data exists.</verify>
  <done>Worker stats display hours worked this week/month and next scheduled shift. Gracefully shows zeros and "No upcoming shifts" when shift data doesn't exist yet.</done>
</task>

<task type="auto">
  <name>Task 2: Worker compliance section component</name>
  <files>apps/admin/components/workers/worker-compliance.tsx</files>
  <action>
Create a component that displays NDIS Worker Check and WWCC information with status badges:

Props: `{ ndisCheckNumber, ndisCheckExpiry, wwccNumber, wwccExpiry }` (all string | null)

Layout: Card with "Compliance Checks" heading. Inside, a grid or list of 2 items:

**NDIS Worker Check:**
- Row with: Shield icon, "NDIS Worker Check" label
- Check number: Display value or "Not provided" in muted text
- Expiry date: Format with date-fns (e.g., "15 Mar 2027")
- Status badge: Use `getComplianceStatus(ndisCheckExpiry)`:
  - 'valid': Green Badge "Valid"
  - 'expiring': Amber Badge "Expiring" (custom amber class, same as participant plan badge)
  - 'expired': Red/destructive Badge "Expired"
  - 'not_set': Gray Badge "Not Set"

**Working with Children Check (WWCC):**
- Same layout as NDIS check but with ShieldCheck icon and "Working with Children Check" label

If both checks have no data (all 4 fields null), show a muted message: "No compliance checks recorded. Add them from the Edit page."

Use the `getComplianceStatus` function from `@/lib/workers/constants` for status derivation.
Badge component from `@ephraimcare/ui`.
Format dates with `format(new Date(date), 'd MMM yyyy')` from date-fns.
  </action>
  <verify>TypeScript compiles. Component renders both checks with correct status badges. Shows "Not provided" for null values. Shows hint message when all fields are null.</verify>
  <done>Compliance section clearly displays NDIS check and WWCC details with color-coded status badges (Valid/Expiring/Expired/Not Set) and formatted expiry dates.</done>
</task>

<task type="auto">
  <name>Task 3: Worker detail page and main detail component</name>
  <files>apps/admin/components/workers/worker-detail.tsx, apps/admin/app/(protected)/workers/[id]/page.tsx</files>
  <action>
**worker-detail.tsx:** Client component that receives worker data and renders the full detail view:

Props: `{ worker: WorkerWithProfile }` (from domain types)

Layout (top to bottom):
1. **Header row:** Full name (h2) + status badge (Active/Inactive) + action buttons (Edit, Back to List)
2. **Stats section:** `<WorkerStats workerId={worker.id} />`
3. **Profile section:** Card with "Profile" heading. Grid layout:
   - Email (with Mail icon, mailto link)
   - Phone (with Phone icon, tel link, or "Not provided")
   - Hourly Rate (formatted as currency, or "Not set")
   - Max Hours/Week (e.g., "38 hrs")
   - Employee ID (or "Not assigned")
4. **Support Types section:** Card with "Support Types" heading. Render services_provided as Badge components (secondary variant). If empty array or null, show "No support types assigned".
5. **Qualifications section:** Card with "Qualifications" heading. Render qualification array as a bulleted list. If empty/null, show "No qualifications recorded".
6. **Compliance section:** `<WorkerCompliance ndisCheckNumber={worker.ndis_check_number} ndisCheckExpiry={worker.ndis_check_expiry} wwccNumber={worker.wwcc_number} wwccExpiry={worker.wwcc_expiry} />`

Use `'use client'` directive.
Edit button: Link to `/workers/${worker.id}/edit`
Back button: Link to `/workers`

**[id]/page.tsx:** Server component that fetches worker by id:
- Parse params.id from the route
- Query: `.from('workers').select('*, profiles!inner(first_name, last_name, email, phone)').eq('id', id).single()`
- If not found, call `notFound()` from next/navigation
- Render `<WorkerDetail worker={(data as any)} />`
- Metadata: `{ title: 'Worker Detail | Ephraim Care' }`
  </action>
  <verify>Page loads at /workers/[id] with worker data. All sections render. Profile, support types, qualifications, compliance, and stats are all visible. 404 returned for invalid IDs.</verify>
  <done>Worker detail page displays complete profile with scheduling stats, support types as badges, qualifications list, and compliance section with status indicators. Edit and Back buttons navigate correctly.</done>
</task>

</tasks>

<verification>
1. /workers/[id] loads with correct worker data
2. Three stat cards show at the top (Hours This Week, Hours This Month, Next Shift)
3. Profile section shows email, phone, hourly rate, max hours, employee ID
4. Support types rendered as Badge components
5. Qualifications rendered as list items
6. Compliance section shows NDIS and WWCC checks with status badges
7. Invalid worker ID returns 404 page
8. Edit button navigates to /workers/[id]/edit
</verification>

<success_criteria>
- Detail page shows all worker profile fields from WORK-03, WORK-06, WORK-07, WORK-08
- Stats gracefully handle no shift data (0 hrs, no upcoming shifts)
- Compliance badges correctly compute status from expiry dates
- Page follows the same visual structure as participant detail (Cards, sections)
</success_criteria>

<output>
After completion, create `.planning/phases/03-worker-management/03-04-SUMMARY.md`
</output>
