---
phase: 03-worker-management
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/admin/components/workers/worker-form/index.tsx
  - apps/admin/app/(protected)/workers/new/page.tsx
  - apps/admin/app/api/workers/invite/route.ts
  - apps/admin/hooks/use-create-worker.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Invite email requires SMTP or Inbucket check for local dev"
    env_vars:
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key (already set in Phase 1)"
    dashboard_config:
      - task: "Set invite token expiry to 7 days"
        location: "Supabase Dashboard -> Auth -> URL Configuration -> Email expiry, OR supabase/config.toml [auth] section"

must_haves:
  truths:
    - "Admin can fill out worker creation form with name, email, phone, support types, qualifications, and compliance dates"
    - "Submitting the form creates an auth user, profile, and worker record in the database"
    - "New worker receives an invite email with a password setup link"
    - "Form validates required fields and shows error messages for invalid input"
    - "Compliance check fields are optional and can be left empty"
  artifacts:
    - path: "apps/admin/components/workers/worker-form/index.tsx"
      provides: "Single-page worker creation form with sections"
      exports: ["WorkerForm"]
    - path: "apps/admin/app/(protected)/workers/new/page.tsx"
      provides: "Server page wrapper for the create form"
      min_lines: 10
    - path: "apps/admin/app/api/workers/invite/route.ts"
      provides: "API route for worker invitation via Supabase admin client"
      exports: ["POST"]
    - path: "apps/admin/hooks/use-create-worker.ts"
      provides: "Mutation hook that calls the invite API route"
      exports: ["useCreateWorker"]
  key_links:
    - from: "apps/admin/components/workers/worker-form/index.tsx"
      to: "apps/admin/hooks/use-create-worker.ts"
      via: "useCreateWorker mutation on form submit"
      pattern: "useCreateWorker"
    - from: "apps/admin/hooks/use-create-worker.ts"
      to: "apps/admin/app/api/workers/invite/route.ts"
      via: "fetch POST to /api/workers/invite"
      pattern: "fetch.*api/workers/invite"
    - from: "apps/admin/app/api/workers/invite/route.ts"
      to: "supabase auth.admin.inviteUserByEmail"
      via: "createAdminClient from @ephraimcare/supabase"
      pattern: "inviteUserByEmail"
---

<objective>
Build the worker creation form (single-page with sections) and the API route that creates the auth user with invite email, profile record, and worker record atomically.

Purpose: WORK-02 requires admin to create workers with support types, qualifications, and compliance dates. WORK-05 requires the invite email. This plan delivers the full create flow.
Output: Functional /workers/new page with form that creates workers and sends invite emails.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-worker-management/03-RESEARCH.md
@.planning/phases/03-worker-management/03-01-SUMMARY.md

# Pattern reference â€” participant create form
@apps/admin/hooks/use-create-participant.ts

# Admin client for service_role operations
@packages/supabase/src/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Worker invite API route</name>
  <files>apps/admin/app/api/workers/invite/route.ts</files>
  <action>
Create a Next.js API Route handler (POST) that:

1. **Verify caller is admin/coordinator:**
   - Use `createClient()` from `@/lib/supabase/server` to get the current user
   - Query profiles table for the user's role and organization_id
   - Return 401 if no user, 403 if role is not 'admin' or 'coordinator'

2. **Parse and validate request body:**
   - Extract: email, first_name, last_name, phone, services_provided, qualification, hourly_rate, max_hours_per_week, ndis_check_number, ndis_check_expiry, wwcc_number, wwcc_expiry
   - Basic validation: email required, first_name required, last_name required, services_provided must be non-empty array

3. **Create auth user with invite:**
   - Use `createAdminClient()` from `@ephraimcare/supabase`
   - Call `admin.auth.admin.inviteUserByEmail(email, { data: { first_name, last_name, role: 'worker' }, redirectTo: process.env.NEXT_PUBLIC_SITE_URL + '/auth/callback' })`
   - If auth error, return 400 with error message

4. **Create profile record:**
   - Insert into profiles: { id: authData.user.id, role: 'worker', first_name, last_name, email, phone, organization_id }
   - Use `as any` for PostgREST type assertion

5. **Create worker record:**
   - Insert into workers: { profile_id: authData.user.id, organization_id, services_provided, qualification, hourly_rate, max_hours_per_week, ndis_check_number, ndis_check_expiry (or null), wwcc_number, wwcc_expiry (or null) }
   - Use `as any` for PostgREST type assertion
   - Select the created worker id

6. **Error handling and cleanup:**
   - If profile insert fails: delete the auth user via `admin.auth.admin.deleteUser(userId)`
   - If worker insert fails: delete both profile and auth user
   - Return appropriate error status codes

7. **Success response:**
   - Return `{ id: worker.id, user_id: authData.user.id }` with status 201

Convert empty string dates to null before insert (ndis_check_expiry, wwcc_expiry).
  </action>
  <verify>TypeScript compiles. API route exports POST function. The route handles auth verification, user creation, profile creation, worker creation, and cleanup on failure.</verify>
  <done>POST /api/workers/invite creates an auth user with invite email, profile record, and worker record. Returns 201 on success or appropriate error codes on failure. Cleans up on partial failures.</done>
</task>

<task type="auto">
  <name>Task 2: Create worker mutation hook and form component</name>
  <files>apps/admin/hooks/use-create-worker.ts, apps/admin/components/workers/worker-form/index.tsx</files>
  <action>
**use-create-worker.ts:**
- Export `useCreateWorker()` hook using TanStack Query `useMutation`
- mutationFn: POST to `/api/workers/invite` with JSON body
- onSuccess: invalidate ['workers'] query, show success toast, navigate to /workers
- onError: show error toast with the error message from response
- Return the mutation object

**worker-form/index.tsx:**
Create a single-page form with 3 visual sections. Use `useForm` from react-hook-form with `zodResolver(workerFullSchema)`.

**Section 1: Basic Information** (Card with heading)
- First Name (Input, required)
- Last Name (Input, required)
- Email (Input, type="email", required)
- Phone (Input, optional, placeholder "+61...")
- Layout: 2-column grid for name fields, full-width for email and phone

**Section 2: Support Types & Qualifications** (Card with heading)
- Support Types: Render SUPPORT_TYPES as a grid of checkboxes. Each checked type adds to the services_provided array. Show validation error if none selected.
- Qualifications: A textarea where user can enter qualifications (one per line). Split by newlines into array on submit. Placeholder: "Enter qualifications, one per line (e.g., Certificate III Individual Support)"
- Hourly Rate: Input type="number", step="0.01", optional
- Max Hours/Week: Input type="number", default 38

**Section 3: Compliance Checks** (Card with heading + "(Optional)" label)
- NDIS Worker Check Number (Input, optional)
- NDIS Worker Check Expiry (Input type="date", optional)
- WWCC Number (Input, optional)
- WWCC Expiry (Input type="date", optional)
- Layout: 2-column grid (number + date side by side for each check)
- Helper text: "These can be added later from the worker's profile page"

**Form footer:**
- Cancel button (navigates back to /workers)
- Submit button ("Create Worker") with loading spinner when submitting
- Show form-level error message if mutation fails

On submit:
- Transform qualification textarea into array (split by newlines, trim, filter empty)
- Convert empty date strings to undefined (Zod handles the rest)
- Call `createWorker.mutate(data)`

Use `'use client'` directive. Import `useCreateWorker` hook.
  </action>
  <verify>TypeScript compiles. Form renders 3 sections with all fields. Submit calls useCreateWorker. Validation errors display per-field. Support types use checkbox grid. Qualifications use textarea split by newlines.</verify>
  <done>Worker creation form displays all fields in organized sections. Submitting with valid data calls the invite API route. Invalid submissions show Zod validation errors. Support types rendered as checkboxes from SUPPORT_TYPES constant.</done>
</task>

<task type="auto">
  <name>Task 3: Worker creation page wrapper</name>
  <files>apps/admin/app/(protected)/workers/new/page.tsx</files>
  <action>
Create a simple server component page:

```typescript
import { WorkerForm } from '@/components/workers/worker-form'

export const metadata = { title: 'Add Worker | Ephraim Care' }

export default function NewWorkerPage() {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold tracking-tight">Add Worker</h1>
        <p className="text-muted-foreground">Create a new worker profile and send them an invitation to set up their account.</p>
      </div>
      <WorkerForm />
    </div>
  )
}
```

Ensure the directory structure apps/admin/app/(protected)/workers/new/ exists.
  </action>
  <verify>Page renders at /workers/new with the heading and WorkerForm component. No TypeScript errors.</verify>
  <done>/workers/new displays the worker creation form with appropriate heading and description text.</done>
</task>

</tasks>

<verification>
1. /workers/new renders the form with 3 sections
2. All fields from WORK-02 are present: name, email, phone, support types, qualifications, compliance dates
3. Form validation: shows error if no support type selected, shows error if email invalid
4. Compliance fields are optional (can submit with empty compliance section)
5. POST /api/workers/invite creates auth user + profile + worker records
6. Invite email is sent (check Inbucket at localhost:54324 in local dev)
7. On success, user is redirected to /workers list
8. On failure (e.g., duplicate email), error toast is shown
</verification>

<success_criteria>
- Form validates all required fields before submission
- API route verifies admin role before proceeding
- Auth user created with invite email containing password setup link
- Worker record has correct organization_id from the creating admin's org
- Cleanup runs if any step fails (no orphan auth users or profiles)
- On success, worker appears in the /workers list
</success_criteria>

<output>
After completion, create `.planning/phases/03-worker-management/03-03-SUMMARY.md`
</output>
