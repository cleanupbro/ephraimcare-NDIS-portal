---
phase: 03-worker-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260124100001_add_worker_compliance_columns.sql
  - apps/admin/lib/workers/schemas.ts
  - apps/admin/lib/workers/constants.ts
  - packages/types/src/domain.ts
autonomous: true

must_haves:
  truths:
    - "Workers table has columns for NDIS check number, NDIS check expiry, WWCC number, and WWCC expiry"
    - "Zod schemas validate worker creation and edit forms with correct field constraints"
    - "Support types and compliance status helpers are available as pure functions"
    - "TypeScript types for WorkerWithProfile exist for use across list/detail/edit"
  artifacts:
    - path: "supabase/migrations/20260124100001_add_worker_compliance_columns.sql"
      provides: "NDIS and WWCC compliance columns on workers table"
      contains: "ndis_check_number"
    - path: "apps/admin/lib/workers/schemas.ts"
      provides: "Zod schemas for worker forms"
      exports: ["workerFullSchema", "workerEditSchema"]
    - path: "apps/admin/lib/workers/constants.ts"
      provides: "Support types list, compliance status helpers"
      exports: ["getComplianceStatus", "getOverallComplianceStatus", "SUPPORT_TYPES"]
    - path: "packages/types/src/domain.ts"
      provides: "WorkerWithProfile type for joined queries"
      contains: "WorkerWithProfile"
  key_links:
    - from: "apps/admin/lib/workers/schemas.ts"
      to: "apps/admin/lib/workers/constants.ts"
      via: "SUPPORT_TYPES used in schema enum validation"
      pattern: "SUPPORT_TYPES"
---

<objective>
Create the foundation layer for worker management: database migration for compliance columns, Zod validation schemas, support type constants, compliance status helpers, and domain type extensions.

Purpose: All worker CRUD plans depend on these shared schemas, types, and utilities. This plan must complete before any UI work begins.
Output: Migration file, schemas, constants, and type definitions ready for consumption by Plans 02-05.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-worker-management/03-RESEARCH.md

# Existing schema to extend
@supabase/migrations/20260124000007_create_workers.sql

# Pattern reference from Phase 2
@apps/admin/lib/participants/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for compliance columns</name>
  <files>supabase/migrations/20260124100001_add_worker_compliance_columns.sql</files>
  <action>
Create a new migration file that adds four columns to the workers table:
- ndis_check_number TEXT (nullable)
- ndis_check_expiry DATE (nullable)
- wwcc_number TEXT (nullable)
- wwcc_expiry DATE (nullable)

Add an index on ndis_check_expiry and wwcc_expiry for the compliance dashboard queries that will filter by expiry date:
```sql
create index idx_workers_ndis_expiry on workers(ndis_check_expiry) where ndis_check_expiry is not null;
create index idx_workers_wwcc_expiry on workers(wwcc_expiry) where wwcc_expiry is not null;
```

This follows the research recommendation of Option B (columns on workers table) for MVP since only 2 check types exist.
  </action>
  <verify>Run `supabase db reset` or confirm the migration file has valid SQL syntax (no syntax errors in ALTER TABLE statements).</verify>
  <done>Workers table has ndis_check_number, ndis_check_expiry, wwcc_number, wwcc_expiry columns with partial indexes on expiry dates.</done>
</task>

<task type="auto">
  <name>Task 2: Zod schemas and constants for worker forms</name>
  <files>apps/admin/lib/workers/schemas.ts, apps/admin/lib/workers/constants.ts</files>
  <action>
**schemas.ts:** Create Zod schemas matching the research patterns:
- `workerBasicSchema`: first_name (required, max 100), last_name (required, max 100), email (valid email), phone (optional, Australian format regex /^(\+61|0)[2-9]\d{8}$/)
- `workerDetailsSchema`: services_provided (array of strings, min 1), qualification (optional array of strings, default []), hourly_rate (optional coerced number >= 0), max_hours_per_week (coerced number 1-168, default 38)
- `workerComplianceSchema`: ndis_check_number (optional string), ndis_check_expiry (optional string), wwcc_number (optional string), wwcc_expiry (optional string). All fields accept empty strings via `.or(z.literal(''))`.
- `workerFullSchema`: merge of all three (used for creation)
- `workerEditSchema`: workerBasicSchema.omit({ email: true }).merge(workerDetailsSchema).merge(workerComplianceSchema)
- Export inferred types: WorkerBasicData, WorkerDetailsData, WorkerComplianceData, WorkerFullData, WorkerEditData

**constants.ts:** Create:
- `SUPPORT_TYPES` array: ['Personal Care', 'Community Access', 'Domestic Assistance', 'Transport', 'Social & Recreational', 'Respite Care', 'Skill Building', 'Behaviour Support'] (common NDIS support categories)
- `ComplianceStatus` type: 'valid' | 'expiring' | 'expired' | 'not_set'
- `getComplianceStatus(expiryDate: string | null): ComplianceStatus` — uses date-fns: isPast -> 'expired', isBefore(expiry, addDays(now, 90)) -> 'expiring', else 'valid', null -> 'not_set'
- `getOverallComplianceStatus(ndisExpiry, wwccExpiry): ComplianceStatus` — returns worst status (expired > expiring > not_set > valid)
- `COMPLIANCE_COLORS` map: { valid: 'bg-green-500', expiring: 'bg-amber-500', expired: 'bg-red-500', not_set: 'bg-gray-300' }
  </action>
  <verify>Run `npx tsc --noEmit` from apps/admin to confirm no type errors. Verify schemas.ts exports all 5 schemas and 5 types, constants.ts exports SUPPORT_TYPES, getComplianceStatus, getOverallComplianceStatus, COMPLIANCE_COLORS.</verify>
  <done>Worker schemas validate all form fields with correct constraints. Compliance helpers compute status from expiry dates. Support types constant provides consistent options across the app.</done>
</task>

<task type="auto">
  <name>Task 3: Domain type extensions for worker queries</name>
  <files>packages/types/src/domain.ts</files>
  <action>
Add to the existing domain.ts file (or create if it doesn't exist in packages/types/src/):

```typescript
export interface WorkerWithProfile {
  id: string
  profile_id: string
  employee_id: string | null
  qualification: string[] | null
  services_provided: string[] | null
  hourly_rate: number | null
  max_hours_per_week: number | null
  organization_id: string
  is_active: boolean
  ndis_check_number: string | null
  ndis_check_expiry: string | null
  wwcc_number: string | null
  wwcc_expiry: string | null
  created_at: string
  updated_at: string
  profiles: {
    first_name: string
    last_name: string
    email: string
    phone: string | null
  }
}

export interface WorkerStats {
  hoursThisWeek: number
  hoursThisMonth: number
  nextShift: {
    id: string
    scheduled_start: string
    scheduled_end: string
    participants: { first_name: string; last_name: string }
  } | null
}
```

If domain.ts doesn't exist yet, create it with these types. If it exists, append to the existing file without modifying other types.
  </action>
  <verify>Run `npx tsc --noEmit` from packages/types to confirm the types compile. Verify WorkerWithProfile and WorkerStats are exported.</verify>
  <done>WorkerWithProfile type available for list/detail queries with joined profile data. WorkerStats type available for detail page stat cards.</done>
</task>

</tasks>

<verification>
1. Migration file exists at supabase/migrations/20260124100001_add_worker_compliance_columns.sql with ALTER TABLE adding 4 columns
2. apps/admin/lib/workers/schemas.ts exports workerFullSchema, workerEditSchema, and 5 type aliases
3. apps/admin/lib/workers/constants.ts exports SUPPORT_TYPES (8 items), getComplianceStatus, getOverallComplianceStatus
4. packages/types/src/domain.ts exports WorkerWithProfile and WorkerStats interfaces
5. TypeScript compiles without errors across affected packages
</verification>

<success_criteria>
- All 4 compliance columns defined in migration SQL
- Zod schemas enforce: required first_name/last_name, valid email, optional phone with AU format, at least 1 support type, optional compliance fields
- getComplianceStatus returns correct status for: null date, past date, date within 90 days, date > 90 days from now
- WorkerWithProfile includes profiles relation with name/email/phone fields
</success_criteria>

<output>
After completion, create `.planning/phases/03-worker-management/03-01-SUMMARY.md`
</output>
