---
phase: 07-invoicing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/lib/invoices/calculations.ts
  - apps/admin/lib/invoices/schemas.ts
  - apps/admin/lib/invoices/constants.ts
  - apps/admin/lib/invoices/csv-export.ts
autonomous: true

must_haves:
  truths:
    - "calculateBillableMinutes returns the lesser of scheduled vs actual duration"
    - "getDayType correctly identifies weekday, saturday, sunday, and public_holiday"
    - "getRate selects the correct tier rate based on day type"
    - "calculateLineTotal multiplies hours by rate with correct rounding"
    - "calculateInvoiceTotals computes subtotal, GST at 10%, and total"
    - "generatePaceCsv produces 16-column CSV with NDIS-compliant formatting"
    - "Zod schemas validate generate invoice and rate form payloads"
  artifacts:
    - path: "apps/admin/lib/invoices/calculations.ts"
      provides: "All billing calculation functions"
      exports: ["calculateBillableMinutes", "getDayType", "getRate", "calculateLineTotal", "calculateInvoiceTotals", "formatHours"]
    - path: "apps/admin/lib/invoices/schemas.ts"
      provides: "Zod validation schemas"
      exports: ["generateInvoiceSchema", "supportTypeRateSchema", "publicHolidaySchema", "finalizeInvoiceSchema"]
    - path: "apps/admin/lib/invoices/constants.ts"
      provides: "Invoice-related constants"
      exports: ["INVOICE_STATUS_COLORS", "DAY_TYPE_LABELS", "GST_RATE", "EPHRAIM_CARE_ABN", "EPHRAIM_CARE_DETAILS"]
    - path: "apps/admin/lib/invoices/csv-export.ts"
      provides: "PACE CSV generation"
      exports: ["generatePaceCsv", "PACE_CSV_HEADERS"]
  key_links:
    - from: "apps/admin/lib/invoices/calculations.ts"
      to: "date-fns"
      via: "differenceInMinutes, isSaturday, isSunday, isSameDay imports"
      pattern: "import.*from.*date-fns"
    - from: "apps/admin/lib/invoices/csv-export.ts"
      to: "apps/admin/lib/invoices/types.ts"
      via: "InvoiceWithLineItems type import"
      pattern: "InvoiceWithLineItems"
---

<objective>
Create the pure business logic and validation layer for invoicing: billing calculations (lesser-of rule, day type detection, rate selection, GST), Zod schemas for form validation, constants (status colors, business details), and PACE CSV export function.

Purpose: These are stateless utility functions that the API routes and UI will consume. Building them as pure functions enables testing and reuse.
Output: Four library files in apps/admin/lib/invoices/.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-invoicing/07-RESEARCH.md
@.planning/phases/07-invoicing/07-CONTEXT.md
@apps/admin/lib/shifts/constants.ts
@apps/admin/lib/shifts/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing calculations and constants</name>
  <files>apps/admin/lib/invoices/calculations.ts, apps/admin/lib/invoices/constants.ts</files>
  <action>
**constants.ts** - Create with:

1. GST_RATE = 0.10

2. EPHRAIM_CARE_ABN = '76685693565' (no spaces, for CSV)
   EPHRAIM_CARE_ABN_DISPLAY = '76 685 693 565' (for PDF display)

3. EPHRAIM_CARE_DETAILS object:
   - name: 'Ephraim Care Pty Ltd'
   - abn: '76 685 693 565'
   - phone: '0451 918 884'
   - email: 'info@ephraimcare.com.au'
   - address: 'Factory 1A, 9 Lyn Parade, Prestons NSW 2170'

4. INVOICE_STATUS_COLORS (same pattern as SHIFT_STATUS_COLORS):
   - draft: gray
   - pending: yellow
   - submitted: blue (this is "finalized")
   - paid: green
   - overdue: red
   - cancelled: red/lighter

5. DAY_TYPE_LABELS:
   - weekday: 'Weekday'
   - saturday: 'Saturday'
   - sunday: 'Sunday'
   - public_holiday: 'Public Holiday'

6. PACE_GST_CODE = 'P1' (taxable per INVC-06 requirement)

**calculations.ts** - Create with these exported functions:

1. calculateBillableMinutes(scheduledStart: Date, scheduledEnd: Date, actualCheckIn: Date, actualCheckOut: Date): number
   - Uses differenceInMinutes from date-fns for both scheduled and actual
   - Returns Math.min(scheduledMinutes, actualMinutes)
   - INVC-02: lesser of scheduled vs actual
   - INVC-03: exact minutes, no rounding

2. getDayType(date: Date, publicHolidayDates: string[]): DayType
   - Import isSaturday, isSunday from date-fns
   - Check public holidays FIRST (format holiday dates to compare with date's YYYY-MM-DD)
   - Then check saturday, sunday
   - Default: weekday
   - Import DayType from ./types

3. getRate(rate: SupportTypeRate, dayType: DayType): number
   - Switch on dayType to return weekday_rate, saturday_rate, sunday_rate, or public_holiday_rate

4. calculateLineTotal(billableMinutes: number, hourlyRate: number): number
   - hours = billableMinutes / 60
   - Return Math.round(hours * hourlyRate * 100) / 100

5. calculateInvoiceTotals(lineTotals: number[]): { subtotal: number; gst: number; total: number }
   - subtotal = sum of lineTotals
   - gst = Math.round(subtotal * GST_RATE * 100) / 100
   - total = Math.round((subtotal + gst) * 100) / 100

6. formatHours(minutes: number): string
   - Return (minutes / 60).toFixed(2)

7. formatCurrency(amount: number): string
   - Return amount.toLocaleString('en-AU', { style: 'currency', currency: 'AUD' })

Import DayType and SupportTypeRate from './types'. Import GST_RATE from './constants'.
  </action>
  <verify>Check file exists and exports all named functions. Run `npx tsc --noEmit apps/admin/lib/invoices/calculations.ts 2>&1 || true`.</verify>
  <done>calculations.ts exports 7 functions. constants.ts exports business details, status colors, GST rate, day type labels. All use correct rounding patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod schemas and PACE CSV export</name>
  <files>apps/admin/lib/invoices/schemas.ts, apps/admin/lib/invoices/csv-export.ts</files>
  <action>
**schemas.ts** - Create with Zod schemas (import { z } from 'zod'):

1. generateInvoiceSchema = z.object({
     participant_id: z.string().uuid(),
     period_start: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
     period_end: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
   }).refine(data => data.period_start <= data.period_end, { message: 'Start date must be before end date', path: ['period_end'] })

2. supportTypeRateSchema = z.object({
     support_type: z.string().min(1, 'Support type is required'),
     ndis_item_number: z.string().optional().or(z.literal('')),
     weekday_rate: z.coerce.number().positive('Rate must be positive'),
     saturday_rate: z.coerce.number().positive('Rate must be positive'),
     sunday_rate: z.coerce.number().positive('Rate must be positive'),
     public_holiday_rate: z.coerce.number().positive('Rate must be positive'),
     effective_from: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
   })

3. publicHolidaySchema = z.object({
     holiday_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
     name: z.string().min(1, 'Holiday name is required').max(100),
   })

4. finalizeInvoiceSchema = z.object({
     invoice_id: z.string().uuid(),
   })

Export type inferences: GenerateInvoiceInput, SupportTypeRateInput, PublicHolidayInput.

**csv-export.ts** - Create with:

1. PACE_CSV_HEADERS array (all 16 column names exactly as in research):
   'RegistrationNumber', 'NDISNumber', 'SupportsDeliveredFrom', 'SupportsDeliveredTo', 'SupportNumber', 'ClaimReference', 'Quantity', 'Hours', 'UnitPrice', 'GSTCode', 'AuthorisedBy', 'ParticipantApproved', 'InKindFundingProgram', 'ClaimType', 'CancellationReason', 'ABN of Support Provider'

2. interface PaceCsvInvoice (simplified input type for the function):
   - invoice_number: string
   - participant_ndis_number: string
   - line_items: Array<{ service_date: string; ndis_item_number: string; billable_minutes: number; unit_price: number }>

3. generatePaceCsv(invoices: PaceCsvInvoice[], registrationNumber: string): string
   - Build header row from PACE_CSV_HEADERS
   - For each invoice, for each line item, build a row:
     - RegistrationNumber: registrationNumber param
     - NDISNumber: invoice.participant_ndis_number
     - SupportsDeliveredFrom: item.service_date (already YYYY-MM-DD)
     - SupportsDeliveredTo: item.service_date (same day for single-day services)
     - SupportNumber: item.ndis_item_number
     - ClaimReference: invoice.invoice_number
     - Quantity: (item.billable_minutes / 60).toFixed(2)
     - Hours: '' (always blank)
     - UnitPrice: item.unit_price.toFixed(2)
     - GSTCode: PACE_GST_CODE (import from constants)
     - AuthorisedBy through CancellationReason: '' (blank)
     - ABN: EPHRAIM_CARE_ABN (import from constants)
   - Join rows with '\n', no trailing newline
   - Return header + '\n' + rows

No external CSV library needed -- data is fixed-format with no user text in fields (no comma/quote escaping needed per research).
  </action>
  <verify>Check both files exist. Verify PACE_CSV_HEADERS has exactly 16 entries. Verify generatePaceCsv function signature matches the interface.</verify>
  <done>schemas.ts exports 4 Zod schemas + 3 type inferences. csv-export.ts exports generatePaceCsv function and PACE_CSV_HEADERS constant. CSV output has exactly 16 columns per row.</done>
</task>

</tasks>

<verification>
- All 4 files in apps/admin/lib/invoices/ compile without TypeScript errors
- calculations.ts uses Math.round for currency precision
- csv-export.ts produces exactly 16 columns per row
- schemas.ts validates date format as YYYY-MM-DD
- constants.ts has correct ABN (no spaces for CSV, with spaces for display)
</verification>

<success_criteria>
- Pure utility functions with no side effects or API calls
- Correct lesser-of-scheduled-vs-actual calculation
- PACE CSV matches the 16-column NDIS format exactly
- Zod schemas ready for form and API validation
</success_criteria>

<output>
After completion, create `.planning/phases/07-invoicing/07-02-SUMMARY.md`
</output>
