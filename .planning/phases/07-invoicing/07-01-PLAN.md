---
phase: 07-invoicing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260125100001_invoicing_phase7.sql
  - apps/admin/lib/invoices/types.ts
autonomous: true

must_haves:
  truths:
    - "support_type_rates table exists with weekday/saturday/sunday/holiday rate columns"
    - "public_holidays table exists with holiday_date and name columns"
    - "invoice_number_counter table exists for gapless sequential numbering"
    - "invoices table has period_start, period_end, finalized_at, finalized_by columns"
    - "invoice_line_items table has support_type, day_type, scheduled_minutes, actual_minutes, billable_minutes columns"
    - "next_invoice_number() function returns INV-YYYY-NNN format"
    - "prevent_finalized_invoice_edit trigger blocks UPDATE on submitted/paid invoices"
    - "Old generate_invoice_number trigger is dropped"
  artifacts:
    - path: "supabase/migrations/20260125100001_invoicing_phase7.sql"
      provides: "All Phase 7 schema changes"
      contains: "support_type_rates"
    - path: "apps/admin/lib/invoices/types.ts"
      provides: "TypeScript types for invoice domain"
      exports: ["Invoice", "InvoiceLineItem", "SupportTypeRate", "PublicHoliday", "DayType"]
  key_links:
    - from: "invoice_line_items"
      to: "support_type_rates"
      via: "unit_price snapshotted at generation time"
      pattern: "unit_price decimal"
    - from: "invoices"
      to: "invoice_number_counter"
      via: "next_invoice_number RPC function"
      pattern: "next_invoice_number"
---

<objective>
Create the database migration for Phase 7 invoicing: new tables (support_type_rates, public_holidays, invoice_number_counter), schema additions to existing invoices/invoice_line_items tables, replace the invoice number trigger with a gapless counter function, add finalization protection trigger, and RLS policies for new tables. Also create TypeScript domain types.

Purpose: All subsequent plans depend on these schema changes and types being in place.
Output: One migration file and one types file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-invoicing/07-RESEARCH.md
@.planning/phases/07-invoicing/07-CONTEXT.md
@supabase/migrations/20260124000012_create_invoices.sql
@supabase/migrations/20260124000002_create_types.sql
@supabase/migrations/20260124300001_add_shift_check_ins.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 7 database migration</name>
  <files>supabase/migrations/20260125100001_invoicing_phase7.sql</files>
  <action>
Create a single migration file that does the following in order:

1. ALTER invoices table - add columns:
   - period_start date
   - period_end date
   - finalized_at timestamptz
   - finalized_by uuid references profiles(id)

2. ALTER invoice_line_items table - add columns:
   - support_type text
   - day_type text (check constraint: weekday, saturday, sunday, public_holiday)
   - scheduled_minutes integer
   - actual_minutes integer
   - billable_minutes integer

3. CREATE support_type_rates table:
   - id uuid PK default gen_random_uuid()
   - support_type text NOT NULL
   - ndis_item_number text (nullable, admin configures later)
   - weekday_rate decimal(10,2) NOT NULL
   - saturday_rate decimal(10,2) NOT NULL
   - sunday_rate decimal(10,2) NOT NULL
   - public_holiday_rate decimal(10,2) NOT NULL
   - effective_from date NOT NULL default current_date
   - is_active boolean default true
   - organization_id uuid NOT NULL references organizations(id)
   - created_at timestamptz default now()
   - updated_at timestamptz default now()
   - UNIQUE constraint on (support_type, organization_id, effective_from)
   - Indexes: org, support_type

4. CREATE public_holidays table:
   - id uuid PK default gen_random_uuid()
   - holiday_date date NOT NULL
   - name text NOT NULL
   - organization_id uuid NOT NULL references organizations(id)
   - created_by uuid references profiles(id)
   - created_at timestamptz default now()
   - UNIQUE constraint on (holiday_date, organization_id)
   - Index: org, holiday_date

5. CREATE invoice_number_counter table:
   - id uuid PK default gen_random_uuid()
   - year integer NOT NULL
   - current_sequence integer NOT NULL default 0
   - organization_id uuid NOT NULL references organizations(id)
   - UNIQUE constraint on (year, organization_id)

6. DROP the old trigger and function:
   - DROP TRIGGER trg_generate_invoice_number ON invoices
   - DROP FUNCTION generate_invoice_number()

7. CREATE next_invoice_number(p_organization_id uuid) function:
   - Returns text
   - Uses INSERT ON CONFLICT DO UPDATE to atomically increment counter
   - Format: 'INV-' || year || '-' || lpad(sequence, 3, '0')
   - Year from current_date

8. CREATE prevent_finalized_invoice_edit() trigger function:
   - BEFORE UPDATE on invoices
   - If OLD.status IN ('submitted', 'paid'), RAISE EXCEPTION 'Cannot modify a finalized invoice'
   - Return NEW otherwise

9. CREATE TRIGGER trg_prevent_finalized_edit on invoices

10. ENABLE RLS on new tables

11. RLS POLICIES for support_type_rates:
    - "Admin can manage rates" - ALL for authenticated where is_admin_or_coordinator() and org match
    - "All authenticated can view rates" - SELECT for authenticated where org match

12. RLS POLICIES for public_holidays:
    - "Admin can manage holidays" - ALL for authenticated where get_user_role() = 'admin' and org match
    - "All authenticated can view holidays" - SELECT for authenticated where org match

13. RLS POLICIES for invoice_number_counter:
    - "Admin can use counter" - ALL for authenticated where is_admin_or_coordinator() and org match

14. TRIGGERS for updated_at on support_type_rates (moddatetime)

15. AUDIT TRIGGERS on support_type_rates and public_holidays (same pattern as shift_check_ins - DO block checking audit function exists)

Use "alter table ... add column if not exists" pattern for safety. Use existing RLS helper functions (get_user_organization_id(), is_admin_or_coordinator(), get_user_role()).
  </action>
  <verify>Run `cat supabase/migrations/20260125100001_invoicing_phase7.sql | head -300` to confirm the file has all sections. Check that DROP TRIGGER comes before CREATE FUNCTION. Check that the next_invoice_number function uses INSERT ON CONFLICT pattern.</verify>
  <done>Migration file exists with all 15 sections: ALTER invoices, ALTER line_items, CREATE 3 tables, DROP old trigger/function, CREATE new function, CREATE finalization trigger, ENABLE RLS, 5 RLS policies, moddatetime trigger, audit triggers.</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript domain types for invoicing</name>
  <files>apps/admin/lib/invoices/types.ts</files>
  <action>
Create the types file at apps/admin/lib/invoices/types.ts with these type definitions:

1. DayType = 'weekday' | 'saturday' | 'sunday' | 'public_holiday'

2. InvoiceStatus = 'draft' | 'pending' | 'submitted' | 'paid' | 'overdue' | 'cancelled'

3. SupportTypeRate interface:
   - id: string
   - support_type: string
   - ndis_item_number: string | null
   - weekday_rate: number
   - saturday_rate: number
   - sunday_rate: number
   - public_holiday_rate: number
   - effective_from: string
   - is_active: boolean
   - organization_id: string
   - created_at: string
   - updated_at: string

4. PublicHoliday interface:
   - id: string
   - holiday_date: string
   - name: string
   - organization_id: string
   - created_by: string | null
   - created_at: string

5. Invoice interface:
   - id: string
   - invoice_number: string
   - participant_id: string
   - plan_id: string | null
   - invoice_date: string
   - due_date: string | null
   - period_start: string
   - period_end: string
   - subtotal: number
   - gst: number
   - total: number
   - status: InvoiceStatus
   - payment_reference: string | null
   - notes: string | null
   - finalized_at: string | null
   - finalized_by: string | null
   - organization_id: string
   - created_by: string | null
   - created_at: string
   - updated_at: string

6. InvoiceLineItem interface:
   - id: string
   - invoice_id: string
   - shift_id: string | null
   - ndis_item_number: string
   - description: string
   - service_date: string
   - support_type: string
   - day_type: DayType
   - scheduled_minutes: number
   - actual_minutes: number
   - billable_minutes: number
   - quantity: number (hours as decimal)
   - unit_price: number
   - line_total: number
   - created_at: string

7. InvoiceWithLineItems = Invoice & { line_items: InvoiceLineItem[] }

8. InvoiceWithParticipant = Invoice & { participants: { first_name: string; last_name: string; ndis_number: string } | null }

9. GenerateInvoicePayload interface:
   - participant_id: string
   - period_start: string
   - period_end: string

10. InvoiceGenerationResult interface:
    - invoice: Invoice
    - line_items: InvoiceLineItem[]

Export all types. No runtime code, pure type definitions.
  </action>
  <verify>Run `npx tsc --noEmit apps/admin/lib/invoices/types.ts 2>&1 || true` to check for syntax errors. Verify all exports exist.</verify>
  <done>types.ts exports DayType, InvoiceStatus, SupportTypeRate, PublicHoliday, Invoice, InvoiceLineItem, InvoiceWithLineItems, InvoiceWithParticipant, GenerateInvoicePayload, InvoiceGenerationResult.</done>
</task>

</tasks>

<verification>
- Migration file is syntactically valid SQL
- Types file compiles without TypeScript errors
- next_invoice_number function produces INV-YYYY-NNN format
- prevent_finalized_invoice_edit trigger targets correct statuses
- Old trigger is explicitly dropped before new function is created
</verification>

<success_criteria>
- Migration creates 3 new tables, adds columns to 2 existing tables, replaces invoice numbering, adds finalization lock
- TypeScript types cover all invoice domain objects
- No breaking changes to existing invoices table structure
</success_criteria>

<output>
After completion, create `.planning/phases/07-invoicing/07-01-SUMMARY.md`
</output>
