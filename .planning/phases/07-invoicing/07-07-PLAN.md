---
phase: 07-invoicing
plan: 07
type: execute
wave: 4
depends_on: ["07-05"]
files_modified:
  - apps/admin/app/api/invoices/export-csv/route.ts
  - apps/admin/components/invoices/ExportCsvButton.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can select multiple finalized invoices and export as PACE CSV"
    - "CSV has exactly 16 columns matching NDIS Bulk Payment format"
    - "CSV dates use YYYY-MM-DD format"
    - "CSV ABN has no spaces (76685693565)"
    - "CSV GSTCode is P1 (taxable per requirement)"
    - "CSV file downloads with descriptive filename"
    - "Only finalized (submitted/paid) invoices are exportable"
  artifacts:
    - path: "apps/admin/app/api/invoices/export-csv/route.ts"
      provides: "PACE CSV export API endpoint"
      exports: ["POST"]
    - path: "apps/admin/components/invoices/ExportCsvButton.tsx"
      provides: "Export button component with invoice selection"
      min_lines: 40
  key_links:
    - from: "apps/admin/app/api/invoices/export-csv/route.ts"
      to: "apps/admin/lib/invoices/csv-export.ts"
      via: "generatePaceCsv function call"
      pattern: "generatePaceCsv"
    - from: "apps/admin/components/invoices/ExportCsvButton.tsx"
      to: "apps/admin/app/api/invoices/export-csv/route.ts"
      via: "POST fetch to /api/invoices/export-csv"
      pattern: "api/invoices/export-csv"
---

<objective>
Implement NDIS Bulk Payment CSV export (INVC-12). Create the API route that generates PACE-compliant CSV from selected finalized invoices, and the UI button/component on the invoice list page for triggering the export.

Purpose: PACE CSV is how Ephraim Care submits bulk claims to NDIA for payment.
Output: CSV export API route and an export button component integrated into the invoice list page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-invoicing/07-RESEARCH.md
@.planning/phases/07-invoicing/07-CONTEXT.md
@.planning/phases/07-invoicing/07-05-SUMMARY.md
@apps/admin/lib/invoices/csv-export.ts
@apps/admin/lib/invoices/types.ts
@apps/admin/lib/invoices/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PACE CSV export API route</name>
  <files>apps/admin/app/api/invoices/export-csv/route.ts</files>
  <action>
Create POST route handler:

1. Auth check: getUser() + verify admin/coordinator role (same pattern as other routes)
2. Parse body: expect { invoice_ids: string[], registration_number?: string }
   - invoice_ids: array of UUIDs (the invoices to include in CSV)
   - registration_number: optional NDIS provider registration number (starts with '405')
   - If registration_number not provided, use a placeholder or fetch from org settings (for now, default to empty string and let admin configure later)

3. Validate invoice_ids is non-empty array:
   if (!invoice_ids?.length) return 400 { error: 'No invoices selected' }

4. Fetch all selected invoices with their line items and participant data:
   supabase.from('invoices') (as any)
   .select('invoice_number, status, participants(ndis_number), invoice_line_items(service_date, ndis_item_number, billable_minutes, unit_price)')
   .in('id', invoice_ids)
   .in('status', ['submitted', 'paid'])

5. If no invoices found (all might be draft): return 400 { error: 'No finalized invoices found. Only submitted or paid invoices can be exported.' }

6. Transform data to PaceCsvInvoice[] format:
   Map each invoice to { invoice_number, participant_ndis_number: invoice.participants?.ndis_number, line_items: invoice.invoice_line_items }

7. Generate CSV: import { generatePaceCsv } from '@/lib/invoices/csv-export'
   const csv = generatePaceCsv(transformedInvoices, registration_number || '')

8. Return response with CSV content:
   return new NextResponse(csv, {
     headers: {
       'Content-Type': 'text/csv; charset=utf-8',
       'Content-Disposition': `attachment; filename="NDIS-Bulk-Payment-${new Date().toISOString().split('T')[0]}.csv"`,
     },
   })

Handle errors with try/catch, return 500 on unexpected failures.
  </action>
  <verify>Check file exists and exports POST. Verify it imports generatePaceCsv from csv-export.ts. Verify it filters for submitted/paid status only. Verify Content-Type is text/csv.</verify>
  <done>POST /api/invoices/export-csv accepts invoice IDs, fetches finalized invoices, generates PACE-compliant 16-column CSV, returns as downloadable file.</done>
</task>

<task type="auto">
  <name>Task 2: Create ExportCsvButton and integrate into invoice list</name>
  <files>apps/admin/components/invoices/ExportCsvButton.tsx, apps/admin/app/(protected)/invoices/page.tsx</files>
  <action>
**ExportCsvButton.tsx** - Client component:

Props: { invoiceIds?: string[] } (optional -- if not provided, exports ALL finalized invoices)

Functionality:
- Button labeled "Export PACE CSV" with Download icon (lucide-react)
- On click:
  1. If invoiceIds provided, use those. Otherwise, fetch all finalized invoice IDs from the page's data.
  2. POST to /api/invoices/export-csv with { invoice_ids: ids }
  3. Handle response:
     - If error response: show toast with error message
     - If success: create a Blob from response, create download link, trigger download
  4. Show loading state (spinner + "Exporting..." text) while request is in flight
  5. Disable button if no finalized invoices exist

Download trigger pattern:
```typescript
const blob = await response.blob();
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = response.headers.get('content-disposition')?.split('filename="')[1]?.replace('"', '') || 'NDIS-Bulk-Payment.csv';
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
```

**Update invoices/page.tsx:**

Add the ExportCsvButton to the page header area (next to "Generate Invoice" button):
- Import ExportCsvButton
- Place it in the header actions area
- Pass all finalized invoice IDs from the useInvoices() data:
  const finalizedIds = invoices?.filter(i => ['submitted', 'paid'].includes(i.status)).map(i => i.id) || []
  <ExportCsvButton invoiceIds={finalizedIds} />
- Button should be disabled when finalizedIds is empty (no finalized invoices to export)

Also on the invoice detail page (apps/admin/app/(protected)/invoices/[id]/page.tsx):
- For finalized invoices, the "Export CSV" button should now work (it was placeholder in Plan 05)
- Wire it to use ExportCsvButton with just the current invoice's ID: <ExportCsvButton invoiceIds={[invoice.id]} />
  </action>
  <verify>Check ExportCsvButton.tsx exists and has the blob download pattern. Check invoices/page.tsx imports and renders ExportCsvButton. Check the detail page also has the export button for finalized invoices.</verify>
  <done>Export PACE CSV button appears on invoice list (exports all finalized) and on individual invoice detail (exports single). Clicking triggers download of properly-named CSV file. Button disabled when no finalized invoices exist.</done>
</task>

</tasks>

<verification>
- POST /api/invoices/export-csv returns text/csv content type
- CSV has header row with exactly 16 column names
- CSV data rows have exactly 16 fields each
- ABN field contains '76685693565' (no spaces)
- GSTCode field is 'P1'
- Dates in CSV are YYYY-MM-DD format
- Only submitted/paid invoices are included (drafts rejected)
- Downloaded file has descriptive filename with date
- ExportCsvButton triggers actual file download in browser
</verification>

<success_criteria>
- INVC-12: System generates NDIS Bulk Payment CSV in PACE-compliant format
- CSV export available from both list page (bulk) and detail page (single invoice)
- Only finalized invoices exportable (drafts excluded)
- CSV format matches NDIA's 16-column specification exactly
</success_criteria>

<output>
After completion, create `.planning/phases/07-invoicing/07-07-SUMMARY.md`
</output>
