---
phase: 07-invoicing
plan: 05
type: execute
wave: 3
depends_on: ["07-02", "07-04"]
files_modified:
  - apps/admin/app/(protected)/invoices/page.tsx
  - apps/admin/app/(protected)/invoices/[id]/page.tsx
  - apps/admin/app/api/invoices/[id]/finalize/route.ts
  - apps/admin/components/invoices/InvoicePreview.tsx
  - apps/admin/components/invoices/LineItemsTable.tsx
autonomous: true

must_haves:
  truths:
    - "Invoice list page shows all invoices with status badges and links to detail"
    - "Invoice detail page shows full preview with line items table"
    - "Line items show date, service type, day type, hours, rate, and line total"
    - "Draft invoices show Finalize button; finalized invoices show locked state"
    - "Finalize API changes status from draft to submitted and sets finalized_at/by"
    - "Finalized invoices cannot be edited (no edit/delete buttons visible, API rejects mutations)"
    - "Invoice totals section shows subtotal, GST (10%), and total"
  artifacts:
    - path: "apps/admin/app/(protected)/invoices/page.tsx"
      provides: "Invoice list page (replaces placeholder)"
      min_lines: 80
    - path: "apps/admin/app/(protected)/invoices/[id]/page.tsx"
      provides: "Invoice detail/preview page"
      min_lines: 60
    - path: "apps/admin/app/api/invoices/[id]/finalize/route.ts"
      provides: "Finalize invoice API"
      exports: ["POST"]
    - path: "apps/admin/components/invoices/InvoicePreview.tsx"
      provides: "Invoice preview component with totals"
      min_lines: 80
    - path: "apps/admin/components/invoices/LineItemsTable.tsx"
      provides: "Line items table component"
      min_lines: 40
  key_links:
    - from: "apps/admin/app/(protected)/invoices/[id]/page.tsx"
      to: "apps/admin/hooks/use-invoices.ts"
      via: "useInvoice hook call"
      pattern: "useInvoice"
    - from: "apps/admin/app/(protected)/invoices/[id]/page.tsx"
      to: "apps/admin/app/api/invoices/[id]/finalize/route.ts"
      via: "useFinalizeInvoice hook -> POST"
      pattern: "useFinalizeInvoice"
    - from: "apps/admin/components/invoices/InvoicePreview.tsx"
      to: "apps/admin/lib/invoices/constants.ts"
      via: "EPHRAIM_CARE_DETAILS, formatCurrency"
      pattern: "EPHRAIM_CARE_DETAILS|formatCurrency"
---

<objective>
Build the invoice list page (replacing the existing placeholder), invoice detail/preview page with line items table, and the finalization API. The detail page should feel like "reviewing a real invoice" per the CONTEXT.md vision.

Purpose: INVC-05 (line item display), INVC-08 (approve/finalize), INVC-09 (locked state).
Output: List page, detail page, finalize API, and two reusable invoice UI components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-invoicing/07-CONTEXT.md
@.planning/phases/07-invoicing/07-04-SUMMARY.md
@apps/admin/app/(protected)/invoices/page.tsx
@apps/admin/hooks/use-invoices.ts
@apps/admin/lib/invoices/types.ts
@apps/admin/lib/invoices/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace invoice list page and create finalize API</name>
  <files>apps/admin/app/(protected)/invoices/page.tsx, apps/admin/app/api/invoices/[id]/finalize/route.ts</files>
  <action>
**invoices/page.tsx** - Replace entirely. Make it a client component ('use client'):

- Use useInvoices() hook for data fetching (TanStack Query, not server-side)
- Header: "Invoices" title + count + "Generate Invoice" button (links to /invoices/generate)
- Filter bar (optional, simple): status filter (All, Draft, Submitted, Paid) as tabs or Select
- Table with columns:
  - Invoice # (monospace, linked to /invoices/[id])
  - Participant name
  - Period (period_start - period_end formatted)
  - Date (invoice_date)
  - Total (formatted as currency)
  - Status (colored badge using INVOICE_STATUS_COLORS)
- Each row clickable (navigates to /invoices/[id])
- Empty state: "No invoices yet. Generate your first invoice." with link to generate page
- Loading state: skeleton or spinner

**finalize/route.ts** - POST handler:

1. Auth check: getUser() + verify admin/coordinator role
2. Get invoice id from params (await params pattern)
3. Fetch invoice: supabase.from('invoices') (as any) .select('status').eq('id', id).single()
4. If not found: 404
5. If status !== 'draft': return 400 { error: 'Only draft invoices can be finalized' }
6. Update invoice: .update({ status: 'submitted', finalized_at: new Date().toISOString(), finalized_by: user.id }).eq('id', id)
7. If error (could be trigger rejection): return 500 with error message
8. Return 200 { success: true, status: 'submitted' }

Follow the override-checkout route pattern for auth check structure.
  </action>
  <verify>Check page.tsx is now a client component with useInvoices(). Check finalize route.ts exports POST and checks status === 'draft'. Verify the old server-side page is replaced.</verify>
  <done>Invoice list page uses TanStack Query, shows all invoices with status badges, links to detail pages, and has "Generate Invoice" CTA. Finalize API transitions draft to submitted and sets finalized_at timestamp.</done>
</task>

<task type="auto">
  <name>Task 2: Create invoice detail page and preview components</name>
  <files>apps/admin/app/(protected)/invoices/[id]/page.tsx, apps/admin/components/invoices/InvoicePreview.tsx, apps/admin/components/invoices/LineItemsTable.tsx</files>
  <action>
**LineItemsTable.tsx** - Reusable component:

Props: { lineItems: InvoiceLineItem[] }

Table with columns (per INVC-05 and CONTEXT.md: date, service type, hours, rate, line total):
- Date: service_date formatted as DD/MM/YYYY (en-AU)
- Service: support_type capitalized
- Day Type: day_type label from DAY_TYPE_LABELS
- Hours: formatHours(billable_minutes) + "hrs"
- Rate: formatCurrency(unit_price) + "/hr"
- Total: formatCurrency(line_total)

Chronological order (already sorted by API). Show totals row at bottom if desired (or leave for InvoicePreview).

**InvoicePreview.tsx** - The "real invoice" preview component:

Props: { invoice: InvoiceWithLineItems & { participants: {...} } }

Layout that looks like a professional invoice document (white card with shadow, padded):

1. Header section:
   - "INVOICE" title
   - Invoice number (right-aligned, large monospace)
   - Invoice date and period (period_start to period_end)

2. From section (left side):
   - Ephraim Care Pty Ltd (from EPHRAIM_CARE_DETAILS)
   - ABN, phone, email, address

3. Bill To section (right side):
   - Participant name (first + last)
   - NDIS Number

4. Line items: Render <LineItemsTable lineItems={invoice.line_items} />

5. Totals section (right-aligned):
   - Subtotal: formatCurrency(invoice.subtotal)
   - GST (10%): formatCurrency(invoice.gst)
   - Total (bold, larger): formatCurrency(invoice.total)

6. Status indicator:
   - If draft: subtle "DRAFT" watermark or badge
   - If submitted: "FINALIZED" badge with lock icon + finalized_at date

7. Footer: "Powered by OpBros" in muted text

**[id]/page.tsx** - Client component:

- Extract id from params (use useParams from next/navigation or receive as prop)
- Use useInvoice(id) to fetch data
- Loading state while fetching
- Render <InvoicePreview invoice={data} />
- Action buttons below preview:
  - If status === 'draft':
    - "Finalize Invoice" button (primary, shows confirmation dialog before calling useFinalizeInvoice)
    - "Delete Draft" button (destructive, optional - delete then redirect)
  - If status === 'submitted' or 'paid':
    - "Download PDF" button (links to /api/invoices/[id]/pdf - built in Plan 06)
    - "Export CSV" button (for later, can be disabled/hidden until Plan 07)
    - Lock icon + "This invoice has been finalized and cannot be edited"
- Back link to /invoices list

Confirmation dialog for finalize: "Are you sure you want to finalize this invoice? Once finalized, it cannot be edited." with Cancel/Finalize buttons.
  </action>
  <verify>Check all 3 files exist. Verify InvoicePreview renders EPHRAIM_CARE_DETAILS. Verify LineItemsTable shows 6 columns. Verify detail page conditionally shows Finalize vs locked state based on status.</verify>
  <done>Detail page shows full invoice preview that looks like a real invoice document. Draft invoices have "Finalize" button with confirmation. Finalized invoices show locked state with download options. Line items display date, service, day type, hours, rate, total.</done>
</task>

</tasks>

<verification>
- Invoice list page loads and displays invoices from the database
- Clicking an invoice row navigates to /invoices/[id]
- Detail page shows complete invoice preview with business details and line items
- "Finalize" button only appears on draft invoices
- After finalization, page shows locked state (no edit buttons)
- Finalize API rejects non-draft invoices with 400 error
- Line items table shows all required columns (INVC-05)
- Totals section shows subtotal + GST + total (INVC-06)
</verification>

<success_criteria>
- INVC-05: Line items display date, service type, hours, rate, line total
- INVC-06: GST at 10% shown in totals
- INVC-08: Admin can finalize (draft to submitted)
- INVC-09: Finalized invoices locked (UI hides edit, DB trigger prevents mutation)
- Preview feels like reviewing a real invoice (CONTEXT.md vision)
</success_criteria>

<output>
After completion, create `.planning/phases/07-invoicing/07-05-SUMMARY.md`
</output>
