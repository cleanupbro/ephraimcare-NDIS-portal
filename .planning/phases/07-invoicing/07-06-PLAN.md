---
phase: 07-invoicing
plan: 06
type: execute
wave: 4
depends_on: ["07-02", "07-05"]
files_modified:
  - apps/admin/app/api/invoices/[id]/pdf/route.ts
  - apps/admin/components/pdf/InvoicePDF.tsx
  - apps/admin/components/pdf/pdf-styles.ts
  - apps/admin/next.config.ts
  - apps/admin/public/fonts/Inter-Regular.ttf
  - apps/admin/public/fonts/Inter-Medium.ttf
  - apps/admin/public/fonts/Inter-Bold.ttf
  - apps/admin/public/images/ephraim-care-logo.png
autonomous: true

must_haves:
  truths:
    - "GET /api/invoices/[id]/pdf returns a downloadable PDF file"
    - "PDF contains Ephraim Care branding (logo, business name, ABN, contact details)"
    - "PDF contains participant name and NDIS number in Bill To section"
    - "PDF contains line items table with all required columns"
    - "PDF shows subtotal, GST (10%), and total"
    - "PDF footer shows 'Powered by OpBros'"
    - "PDF uses Ephraim Care colors (green #66BB6A, teal #00BFA5)"
    - "PDF filename is the invoice number (e.g., INV-2026-001.pdf)"
  artifacts:
    - path: "apps/admin/app/api/invoices/[id]/pdf/route.ts"
      provides: "PDF generation API endpoint"
      exports: ["GET"]
    - path: "apps/admin/components/pdf/InvoicePDF.tsx"
      provides: "React PDF document component"
      min_lines: 100
    - path: "apps/admin/components/pdf/pdf-styles.ts"
      provides: "Shared PDF styles and font registration"
      exports: ["styles", "registerFonts"]
    - path: "apps/admin/next.config.ts"
      provides: "Next.js config with serverExternalPackages"
      contains: "serverExternalPackages"
  key_links:
    - from: "apps/admin/app/api/invoices/[id]/pdf/route.ts"
      to: "apps/admin/components/pdf/InvoicePDF.tsx"
      via: "pdf(<InvoicePDF />) call"
      pattern: "pdf.*InvoicePDF"
    - from: "apps/admin/app/api/invoices/[id]/pdf/route.ts"
      to: "@react-pdf/renderer"
      via: "pdf().toBuffer() for server-side generation"
      pattern: "pdf.*toBuffer"
    - from: "apps/admin/components/pdf/pdf-styles.ts"
      to: "public/fonts/"
      via: "Font.register with absolute paths"
      pattern: "Font.register"
---

<objective>
Implement PDF export for invoices using @react-pdf/renderer. Create the PDF document component with Ephraim Care branding, the API route that generates the PDF server-side, download font files, and update Next.js config.

Purpose: INVC-11 -- finalized invoices exportable as branded PDF suitable for NDIS submission.
Output: PDF API route, React PDF components, fonts, logo placeholder, and config update.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-invoicing/07-RESEARCH.md
@.planning/phases/07-invoicing/07-CONTEXT.md
@.planning/phases/07-invoicing/07-05-SUMMARY.md
@apps/admin/next.config.ts
@apps/admin/lib/invoices/types.ts
@apps/admin/lib/invoices/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-pdf, download fonts, update config</name>
  <files>apps/admin/next.config.ts, apps/admin/public/fonts/Inter-Regular.ttf, apps/admin/public/fonts/Inter-Medium.ttf, apps/admin/public/fonts/Inter-Bold.ttf, apps/admin/public/images/ephraim-care-logo.png</files>
  <action>
1. Install @react-pdf/renderer:
   Run: pnpm --filter @ephraimcare/admin add @react-pdf/renderer

2. Download Inter font files (TTF, not variable fonts) to apps/admin/public/fonts/:
   - Inter-Regular.ttf from Google Fonts CDN or fontsource
   - Inter-Medium.ttf (weight 500)
   - Inter-Bold.ttf (weight 700)
   Use curl to download from: https://fonts.gstatic.com/s/inter/v18/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hiA.woff2

   Actually, @react-pdf/renderer needs TTF files (not WOFF2). Download from:
   - https://github.com/rsms/inter/releases (get the TTF static files)
   - Or use: curl -L "https://fonts.gstatic.com/s/inter/v18/UcC73FwrK3iLTeHuS_fjbvMwCp50BTk3MA.ttf" (regular)

   Alternative approach: Use fontsource package or download directly. If download fails, create placeholder .ttf files and note in SUMMARY that real fonts need to be added. The PDF will still work with fallback Helvetica if font registration fails gracefully.

3. Create a placeholder logo at apps/admin/public/images/ephraim-care-logo.png:
   - If no logo exists in the project, create a simple placeholder PNG (can be a 200x60 transparent PNG)
   - Note in SUMMARY that the real Ephraim Care logo should replace this file
   - The PDF component should gracefully handle missing logo (try/catch or conditional render)

4. Update apps/admin/next.config.ts:
   Add serverExternalPackages to the config:
   ```typescript
   const nextConfig: NextConfig = {
     outputFileTracingRoot: path.join(__dirname, '../../'),
     transpilePackages: [...existing...],
     serverExternalPackages: ['@react-pdf/renderer'],
   }
   ```

This ensures @react-pdf/renderer runs in Node.js context, not bundled by webpack.
  </action>
  <verify>Run `pnpm --filter @ephraimcare/admin list @react-pdf/renderer` to confirm installation. Check next.config.ts has serverExternalPackages. Check public/fonts/ directory has TTF files (or placeholders).</verify>
  <done>@react-pdf/renderer installed. Next.js config updated with serverExternalPackages. Font files present in public/fonts/. Logo placeholder in public/images/.</done>
</task>

<task type="auto">
  <name>Task 2: Create PDF components and API route</name>
  <files>apps/admin/components/pdf/pdf-styles.ts, apps/admin/components/pdf/InvoicePDF.tsx, apps/admin/app/api/invoices/[id]/pdf/route.ts</files>
  <action>
**pdf-styles.ts** - Font registration and shared styles:

```typescript
import { Font, StyleSheet } from '@react-pdf/renderer';
import path from 'path';

// Register Inter fonts (TTF only)
export function registerFonts() {
  try {
    Font.register({
      family: 'Inter',
      fonts: [
        { src: path.join(process.cwd(), 'public/fonts/Inter-Regular.ttf') },
        { src: path.join(process.cwd(), 'public/fonts/Inter-Medium.ttf'), fontWeight: 500 },
        { src: path.join(process.cwd(), 'public/fonts/Inter-Bold.ttf'), fontWeight: 700 },
      ],
    });
  } catch (e) {
    // Graceful fallback to Helvetica if fonts not found
    console.warn('Font registration failed, using fallback:', e);
  }
}

// Ephraim Care brand colors
const BRAND_GREEN = '#66BB6A';
const BRAND_TEAL = '#00BFA5';

export const styles = StyleSheet.create({
  page: { padding: 40, fontSize: 10, fontFamily: 'Inter' },
  header: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 30 },
  logo: { width: 120, height: 40 },
  companyName: { fontSize: 16, fontWeight: 700, color: BRAND_GREEN },
  invoiceTitle: { fontSize: 24, fontWeight: 700, color: BRAND_TEAL, textAlign: 'right' },
  invoiceNumber: { fontSize: 12, textAlign: 'right', marginTop: 4 },
  section: { marginBottom: 15 },
  sectionTitle: { fontSize: 10, fontWeight: 700, color: '#666', marginBottom: 4, textTransform: 'uppercase' },
  row: { flexDirection: 'row' },
  fromTo: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 20 },
  fromBlock: { width: '50%' },
  toBlock: { width: '50%', textAlign: 'right' },
  text: { fontSize: 10, marginBottom: 2, color: '#333' },
  textBold: { fontSize: 10, fontWeight: 700, marginBottom: 2 },
  // Table styles
  tableHeader: { flexDirection: 'row', backgroundColor: '#f8f8f8', borderBottomWidth: 1, borderBottomColor: '#ddd', paddingVertical: 6, paddingHorizontal: 4 },
  tableRow: { flexDirection: 'row', borderBottomWidth: 0.5, borderBottomColor: '#eee', paddingVertical: 5, paddingHorizontal: 4 },
  colDate: { width: '15%' },
  colService: { width: '20%' },
  colDayType: { width: '15%' },
  colHours: { width: '12%', textAlign: 'right' },
  colRate: { width: '18%', textAlign: 'right' },
  colTotal: { width: '20%', textAlign: 'right' },
  headerText: { fontSize: 8, fontWeight: 700, color: '#666', textTransform: 'uppercase' },
  cellText: { fontSize: 9, color: '#333' },
  cellRight: { fontSize: 9, color: '#333', textAlign: 'right' },
  // Totals
  totalsBlock: { marginTop: 20, alignItems: 'flex-end' },
  totalRow: { flexDirection: 'row', width: 200, justifyContent: 'space-between', paddingVertical: 3 },
  totalLabel: { fontSize: 10, color: '#666' },
  totalValue: { fontSize: 10, fontWeight: 500 },
  grandTotal: { flexDirection: 'row', width: 200, justifyContent: 'space-between', paddingVertical: 6, borderTopWidth: 1.5, borderTopColor: BRAND_TEAL, marginTop: 4 },
  grandTotalLabel: { fontSize: 12, fontWeight: 700 },
  grandTotalValue: { fontSize: 12, fontWeight: 700, color: BRAND_TEAL },
  // Footer
  footer: { position: 'absolute', bottom: 30, left: 40, right: 40, textAlign: 'center', fontSize: 8, color: '#999' },
  // Period
  periodText: { fontSize: 9, color: '#666', marginTop: 2 },
  // Status watermark
  draftWatermark: { position: 'absolute', top: '45%', left: '25%', fontSize: 60, color: '#f0f0f0', fontWeight: 700, transform: 'rotate(-30deg)' },
});
```

**InvoicePDF.tsx** - The React PDF document component:

```typescript
import { Document, Page, View, Text, Image } from '@react-pdf/renderer';
import { styles, registerFonts } from './pdf-styles';
import { EPHRAIM_CARE_DETAILS } from '@/lib/invoices/constants';
import { formatHours } from '@/lib/invoices/calculations';
import type { InvoiceWithLineItems } from '@/lib/invoices/types';
import path from 'path';

// Register fonts on module load
registerFonts();

interface InvoicePDFProps {
  invoice: InvoiceWithLineItems & {
    participants: { first_name: string; last_name: string; ndis_number: string } | null;
  };
}

export function InvoicePDF({ invoice }: InvoicePDFProps) {
  const logoPath = path.join(process.cwd(), 'public/images/ephraim-care-logo.png');
  const participant = invoice.participants;
  const isDraft = invoice.status === 'draft';

  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {isDraft && <Text style={styles.draftWatermark}>DRAFT</Text>}

        {/* Header: Company + Invoice Title */}
        <View style={styles.header}>
          <View>
            {/* Try to render logo, fall back to text */}
            <Text style={styles.companyName}>{EPHRAIM_CARE_DETAILS.name}</Text>
          </View>
          <View>
            <Text style={styles.invoiceTitle}>INVOICE</Text>
            <Text style={styles.invoiceNumber}>{invoice.invoice_number}</Text>
            <Text style={styles.periodText}>
              Date: {formatDate(invoice.invoice_date)}
            </Text>
            <Text style={styles.periodText}>
              Period: {formatDate(invoice.period_start)} - {formatDate(invoice.period_end)}
            </Text>
          </View>
        </View>

        {/* From / Bill To */}
        <View style={styles.fromTo}>
          <View style={styles.fromBlock}>
            <Text style={styles.sectionTitle}>From</Text>
            <Text style={styles.textBold}>{EPHRAIM_CARE_DETAILS.name}</Text>
            <Text style={styles.text}>ABN: {EPHRAIM_CARE_DETAILS.abn}</Text>
            <Text style={styles.text}>{EPHRAIM_CARE_DETAILS.address}</Text>
            <Text style={styles.text}>{EPHRAIM_CARE_DETAILS.phone}</Text>
            <Text style={styles.text}>{EPHRAIM_CARE_DETAILS.email}</Text>
          </View>
          <View style={styles.toBlock}>
            <Text style={styles.sectionTitle}>Bill To</Text>
            <Text style={styles.textBold}>
              {participant ? `${participant.first_name} ${participant.last_name}` : 'Unknown'}
            </Text>
            <Text style={styles.text}>
              NDIS: {participant?.ndis_number || 'N/A'}
            </Text>
          </View>
        </View>

        {/* Line Items Table */}
        <View style={styles.section}>
          {/* Table Header */}
          <View style={styles.tableHeader}>
            <Text style={[styles.headerText, styles.colDate]}>Date</Text>
            <Text style={[styles.headerText, styles.colService]}>Service</Text>
            <Text style={[styles.headerText, styles.colDayType]}>Day Type</Text>
            <Text style={[styles.headerText, styles.colHours]}>Hours</Text>
            <Text style={[styles.headerText, styles.colRate]}>Rate</Text>
            <Text style={[styles.headerText, styles.colTotal]}>Total</Text>
          </View>
          {/* Table Rows */}
          {invoice.line_items.map((item, i) => (
            <View key={i} style={styles.tableRow}>
              <Text style={[styles.cellText, styles.colDate]}>{formatDate(item.service_date)}</Text>
              <Text style={[styles.cellText, styles.colService]}>{item.support_type}</Text>
              <Text style={[styles.cellText, styles.colDayType]}>{item.day_type}</Text>
              <Text style={[styles.cellRight, styles.colHours]}>{formatHours(item.billable_minutes)}</Text>
              <Text style={[styles.cellRight, styles.colRate]}>${item.unit_price.toFixed(2)}</Text>
              <Text style={[styles.cellRight, styles.colTotal]}>${item.line_total.toFixed(2)}</Text>
            </View>
          ))}
        </View>

        {/* Totals */}
        <View style={styles.totalsBlock}>
          <View style={styles.totalRow}>
            <Text style={styles.totalLabel}>Subtotal</Text>
            <Text style={styles.totalValue}>${invoice.subtotal.toFixed(2)}</Text>
          </View>
          <View style={styles.totalRow}>
            <Text style={styles.totalLabel}>GST (10%)</Text>
            <Text style={styles.totalValue}>${invoice.gst.toFixed(2)}</Text>
          </View>
          <View style={styles.grandTotal}>
            <Text style={styles.grandTotalLabel}>Total</Text>
            <Text style={styles.grandTotalValue}>${invoice.total.toFixed(2)}</Text>
          </View>
        </View>

        {/* Footer */}
        <Text style={styles.footer}>Powered by OpBros</Text>
      </Page>
    </Document>
  );
}

function formatDate(dateStr: string): string {
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit', year: 'numeric' });
}
```

Adjust the above as needed -- this is the target structure. The key requirements are: branding, Bill To with NDIS number, line items table, totals with GST, footer, and draft watermark.

**pdf/route.ts** - GET handler:

1. export const runtime = 'nodejs' (CRITICAL - not edge)
2. export const dynamic = 'force-dynamic'
3. Auth check: getUser() + verify admin/coordinator
4. Get id from params (await params)
5. Fetch invoice with line items and participant: supabase.from('invoices') (as any).select('*, invoice_line_items(*), participants(first_name, last_name, ndis_number)').eq('id', id).single()
6. If not found: 404
7. Import { pdf } from '@react-pdf/renderer'
8. Import { InvoicePDF } from '@/components/pdf/InvoicePDF'
9. Generate buffer: const buffer = await pdf(<InvoicePDF invoice={data} />).toBuffer()
10. Return new NextResponse(buffer, { headers: { 'Content-Type': 'application/pdf', 'Content-Disposition': `attachment; filename="${data.invoice_number}.pdf"` } })
11. Wrap in try/catch, return 500 on PDF generation failure
  </action>
  <verify>Check all 3 files exist. Verify route.ts has `export const runtime = 'nodejs'`. Verify InvoicePDF renders EPHRAIM_CARE_DETAILS fields. Verify pdf-styles.ts calls Font.register. Run `pnpm --filter @ephraimcare/admin build 2>&1 | tail -20` to check for build errors (may need --no-lint flag).</verify>
  <done>GET /api/invoices/[id]/pdf generates and returns a branded PDF. PDF includes logo/company name, ABN, participant details, line items table, GST totals, and OpBros footer. Uses Inter font and Ephraim Care green/teal colors.</done>
</task>

</tasks>

<verification>
- @react-pdf/renderer is in admin package.json
- next.config.ts has serverExternalPackages: ['@react-pdf/renderer']
- PDF route uses runtime = 'nodejs' (not edge)
- PDF contains all required sections (header, from, bill-to, line items, totals, footer)
- PDF uses Ephraim Care branding colors
- Downloaded PDF filename matches invoice number
- Font files exist in public/fonts/ (or graceful fallback works)
</verification>

<success_criteria>
- INVC-11: Invoice exportable as PDF with Ephraim Care branding (logo, ABN, colors)
- PDF is downloadable from the invoice detail page
- PDF renders correctly with line items, GST, and totals
- No edge runtime errors (uses Node.js runtime)
</success_criteria>

<output>
After completion, create `.planning/phases/07-invoicing/07-06-SUMMARY.md`
</output>
