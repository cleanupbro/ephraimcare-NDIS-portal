---
phase: 11-compliance-incidents
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260126000001_incidents_phase11.sql
  - apps/admin/lib/incidents/schemas.ts
  - apps/admin/lib/incidents/constants.ts
  - packages/utils/src/types/incidents.ts
autonomous: true

must_haves:
  truths:
    - "incidents table exists with type, severity, description, status, NDIA fields"
    - "shift_cancellation_requests table exists for participant requests"
    - "RLS policies enforce organization-level isolation"
  artifacts:
    - path: "supabase/migrations/20260126000001_incidents_phase11.sql"
      provides: "Database tables for incidents and cancellation requests"
    - path: "apps/admin/lib/incidents/schemas.ts"
      provides: "Zod validation schemas"
    - path: "apps/admin/lib/incidents/constants.ts"
      provides: "Incident types, severities, statuses"
---

<objective>
Create database schema for incident reporting and shift cancellation requests.

Purpose: Establish the data foundation for compliance tracking, incident management, and participant self-service.

Output: Migration file, TypeScript types, Zod schemas, and constants.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-compliance-incidents/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create incidents migration</name>
  <files>supabase/migrations/20260126000001_incidents_phase11.sql</files>
  <action>
Create migration file with:

```sql
-- ============================================================================
-- Phase 11: Incidents and Compliance
-- ============================================================================

-- Incidents table
CREATE TABLE IF NOT EXISTS incidents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  participant_id UUID REFERENCES participants(id) ON DELETE SET NULL,
  worker_id UUID REFERENCES workers(id) ON DELETE SET NULL,
  shift_id UUID REFERENCES shifts(id) ON DELETE SET NULL,
  reported_by UUID NOT NULL REFERENCES profiles(id),

  -- Core fields
  incident_type TEXT NOT NULL,
  severity TEXT NOT NULL CHECK (severity IN ('low', 'medium', 'high', 'critical')),
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  actions_taken TEXT,
  location TEXT,

  -- Lifecycle
  status TEXT NOT NULL DEFAULT 'open' CHECK (status IN ('open', 'in_review', 'closed')),
  closed_at TIMESTAMPTZ,
  closed_by UUID REFERENCES profiles(id),

  -- NDIA reporting
  requires_ndia_report BOOLEAN DEFAULT FALSE,
  ndia_reported_at TIMESTAMPTZ,
  ndia_reference_number TEXT,
  ndia_reported_by UUID REFERENCES profiles(id),

  -- Timestamps
  incident_date TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Shift cancellation requests
CREATE TABLE IF NOT EXISTS shift_cancellation_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  shift_id UUID NOT NULL REFERENCES shifts(id) ON DELETE CASCADE,
  participant_id UUID NOT NULL REFERENCES participants(id) ON DELETE CASCADE,
  reason TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  reviewed_by UUID REFERENCES profiles(id),
  reviewed_at TIMESTAMPTZ,
  admin_notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_incidents_organization ON incidents(organization_id);
CREATE INDEX idx_incidents_status ON incidents(status);
CREATE INDEX idx_incidents_severity ON incidents(severity);
CREATE INDEX idx_incidents_requires_ndia ON incidents(requires_ndia_report) WHERE requires_ndia_report = TRUE AND ndia_reported_at IS NULL;
CREATE INDEX idx_cancellation_requests_status ON shift_cancellation_requests(status);
CREATE INDEX idx_cancellation_requests_shift ON shift_cancellation_requests(shift_id);

-- RLS policies
ALTER TABLE incidents ENABLE ROW LEVEL SECURITY;
ALTER TABLE shift_cancellation_requests ENABLE ROW LEVEL SECURITY;

-- Incidents: org isolation
CREATE POLICY "incidents_org_isolation" ON incidents
  FOR ALL USING (organization_id = get_user_organization_id());

-- Cancellation requests: org isolation
CREATE POLICY "cancellation_requests_org_isolation" ON shift_cancellation_requests
  FOR ALL USING (organization_id = get_user_organization_id());

-- Participants can create cancellation requests for their own shifts
CREATE POLICY "participants_create_own_requests" ON shift_cancellation_requests
  FOR INSERT WITH CHECK (
    participant_id IN (
      SELECT id FROM participants WHERE user_id = auth.uid()
    )
  );

-- Participants can view their own requests
CREATE POLICY "participants_view_own_requests" ON shift_cancellation_requests
  FOR SELECT USING (
    participant_id IN (
      SELECT id FROM participants WHERE user_id = auth.uid()
    )
  );

-- Updated_at trigger for incidents
CREATE TRIGGER update_incidents_updated_at
  BEFORE UPDATE ON incidents
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```
  </action>
  <verify>Run migration: `cd supabase && supabase db push` or check SQL syntax</verify>
  <done>Migration creates incidents and shift_cancellation_requests tables with RLS</done>
</task>

<task type="auto">
  <name>Task 2: Create incidents constants</name>
  <files>apps/admin/lib/incidents/constants.ts</files>
  <action>
Create new file:

```typescript
// ─── Incident Types ──────────────────────────────────────────────────────────

export const INCIDENT_TYPES = [
  'injury',
  'medication_error',
  'property_damage',
  'behavioral',
  'abuse_neglect',
  'fall',
  'missing_person',
  'other',
] as const

export type IncidentType = (typeof INCIDENT_TYPES)[number]

export const INCIDENT_TYPE_LABELS: Record<IncidentType, string> = {
  injury: 'Injury',
  medication_error: 'Medication Error',
  property_damage: 'Property Damage',
  behavioral: 'Behavioral Incident',
  abuse_neglect: 'Abuse/Neglect',
  fall: 'Fall',
  missing_person: 'Missing Person',
  other: 'Other',
}

// ─── Severity Levels ─────────────────────────────────────────────────────────

export const INCIDENT_SEVERITIES = ['low', 'medium', 'high', 'critical'] as const

export type IncidentSeverity = (typeof INCIDENT_SEVERITIES)[number]

export const SEVERITY_LABELS: Record<IncidentSeverity, string> = {
  low: 'Low',
  medium: 'Medium',
  high: 'High',
  critical: 'Critical',
}

export const SEVERITY_COLORS: Record<IncidentSeverity, string> = {
  low: 'bg-green-100 text-green-800',
  medium: 'bg-amber-100 text-amber-800',
  high: 'bg-orange-100 text-orange-800',
  critical: 'bg-red-100 text-red-800',
}

// ─── Incident Status ─────────────────────────────────────────────────────────

export const INCIDENT_STATUSES = ['open', 'in_review', 'closed'] as const

export type IncidentStatus = (typeof INCIDENT_STATUSES)[number]

export const STATUS_LABELS: Record<IncidentStatus, string> = {
  open: 'Open',
  in_review: 'In Review',
  closed: 'Closed',
}

export const STATUS_COLORS: Record<IncidentStatus, string> = {
  open: 'bg-blue-100 text-blue-800',
  in_review: 'bg-amber-100 text-amber-800',
  closed: 'bg-gray-100 text-gray-800',
}

// ─── NDIA Reporting ──────────────────────────────────────────────────────────

/** Incident types that always require NDIA notification */
export const NDIA_MANDATORY_TYPES: IncidentType[] = ['abuse_neglect']

/** Severity levels that require NDIA notification */
export const NDIA_MANDATORY_SEVERITIES: IncidentSeverity[] = ['critical']

/** Hours within which NDIA must be notified for reportable incidents */
export const NDIA_REPORTING_HOURS = 24

export function requiresNdiaReport(type: IncidentType, severity: IncidentSeverity): boolean {
  return NDIA_MANDATORY_TYPES.includes(type) || NDIA_MANDATORY_SEVERITIES.includes(severity)
}

// ─── Cancellation Request Status ─────────────────────────────────────────────

export const CANCELLATION_STATUSES = ['pending', 'approved', 'rejected'] as const

export type CancellationStatus = (typeof CANCELLATION_STATUSES)[number]

export const CANCELLATION_STATUS_LABELS: Record<CancellationStatus, string> = {
  pending: 'Pending',
  approved: 'Approved',
  rejected: 'Rejected',
}
```
  </action>
  <verify>TypeScript compilation: `pnpm tsc --noEmit`</verify>
  <done>Constants file with incident types, severities, statuses, and NDIA rules</done>
</task>

<task type="auto">
  <name>Task 3: Create incidents Zod schemas</name>
  <files>apps/admin/lib/incidents/schemas.ts</files>
  <action>
Create new file:

```typescript
import { z } from 'zod'
import { INCIDENT_TYPES, INCIDENT_SEVERITIES, INCIDENT_STATUSES } from './constants'

// ─── Incident Schemas ────────────────────────────────────────────────────────

export const incidentCreateSchema = z.object({
  participant_id: z.string().uuid().optional().nullable(),
  worker_id: z.string().uuid().optional().nullable(),
  shift_id: z.string().uuid().optional().nullable(),
  incident_type: z.enum(INCIDENT_TYPES),
  severity: z.enum(INCIDENT_SEVERITIES),
  title: z.string().min(5, 'Title must be at least 5 characters').max(200),
  description: z.string().min(20, 'Description must be at least 20 characters').max(5000),
  actions_taken: z.string().max(2000).optional(),
  location: z.string().max(200).optional(),
  incident_date: z.string().refine((val) => !isNaN(Date.parse(val)), 'Invalid date'),
})

export type IncidentCreateFormData = z.infer<typeof incidentCreateSchema>

export const incidentUpdateSchema = incidentCreateSchema.partial().extend({
  status: z.enum(INCIDENT_STATUSES).optional(),
})

export type IncidentUpdateFormData = z.infer<typeof incidentUpdateSchema>

export const ndiaReportSchema = z.object({
  ndia_reference_number: z.string().min(1, 'Reference number is required').max(50),
})

export type NdiaReportFormData = z.infer<typeof ndiaReportSchema>

// ─── Cancellation Request Schemas ────────────────────────────────────────────

export const cancellationRequestSchema = z.object({
  shift_id: z.string().uuid(),
  reason: z.string().min(10, 'Please provide a reason (at least 10 characters)').max(500),
})

export type CancellationRequestFormData = z.infer<typeof cancellationRequestSchema>

export const cancellationReviewSchema = z.object({
  status: z.enum(['approved', 'rejected']),
  admin_notes: z.string().max(500).optional(),
})

export type CancellationReviewFormData = z.infer<typeof cancellationReviewSchema>
```
  </action>
  <verify>TypeScript compilation: `pnpm tsc --noEmit`</verify>
  <done>Zod schemas for incident creation, update, NDIA reporting, and cancellation requests</done>
</task>

<task type="auto">
  <name>Task 4: Create shared TypeScript types</name>
  <files>packages/utils/src/types/incidents.ts</files>
  <action>
Create new file:

```typescript
// ─── Incident Types ──────────────────────────────────────────────────────────

export interface Incident {
  id: string
  organization_id: string
  participant_id: string | null
  worker_id: string | null
  shift_id: string | null
  reported_by: string
  incident_type: string
  severity: 'low' | 'medium' | 'high' | 'critical'
  title: string
  description: string
  actions_taken: string | null
  location: string | null
  status: 'open' | 'in_review' | 'closed'
  closed_at: string | null
  closed_by: string | null
  requires_ndia_report: boolean
  ndia_reported_at: string | null
  ndia_reference_number: string | null
  ndia_reported_by: string | null
  incident_date: string
  created_at: string
  updated_at: string
}

export interface IncidentWithRelations extends Incident {
  participants?: { first_name: string; last_name: string } | null
  workers?: { profiles: { first_name: string; last_name: string } | null } | null
  reporter?: { first_name: string; last_name: string } | null
}

// ─── Cancellation Request Types ──────────────────────────────────────────────

export interface ShiftCancellationRequest {
  id: string
  organization_id: string
  shift_id: string
  participant_id: string
  reason: string
  status: 'pending' | 'approved' | 'rejected'
  reviewed_by: string | null
  reviewed_at: string | null
  admin_notes: string | null
  created_at: string
}

export interface CancellationRequestWithRelations extends ShiftCancellationRequest {
  shifts?: {
    scheduled_start: string
    scheduled_end: string
    workers?: { profiles: { first_name: string; last_name: string } | null } | null
  } | null
  participants?: { first_name: string; last_name: string } | null
}
```
  </action>
  <verify>TypeScript compilation: `pnpm tsc --noEmit`</verify>
  <done>Shared TypeScript interfaces for incidents and cancellation requests</done>
</task>

</tasks>

<verification>
1. Check migration SQL syntax is valid
2. Run `pnpm tsc --noEmit` to verify TypeScript compiles
3. Verify constants, schemas, and types are properly exported
</verification>

<success_criteria>
- Migration file creates incidents and shift_cancellation_requests tables
- RLS policies enforce organization isolation
- Constants define all incident types, severities, statuses
- Zod schemas validate form inputs
- TypeScript types match database schema
</success_criteria>

<output>
After completion, create `.planning/phases/11-compliance-incidents/11-01-SUMMARY.md`
</output>
