---
phase: 11-compliance-incidents
plan: 02
type: execute
wave: 2
depends_on: [11-01]
files_modified:
  - apps/admin/app/(protected)/incidents/page.tsx
  - apps/admin/app/(protected)/incidents/new/page.tsx
  - apps/admin/components/incidents/incident-form.tsx
  - apps/admin/components/incidents/incident-list.tsx
  - apps/admin/hooks/use-incidents.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create incident with type, severity, description"
    - "Incident list shows all incidents with status and severity badges"
    - "Incidents can be filtered by status, severity, type"
  artifacts:
    - path: "apps/admin/app/(protected)/incidents/page.tsx"
      provides: "Incident list page"
    - path: "apps/admin/components/incidents/incident-form.tsx"
      provides: "Incident creation form"
    - path: "apps/admin/hooks/use-incidents.ts"
      provides: "TanStack Query hooks for incidents"
---

<objective>
Build the incident reporting form and list page for admin portal.

Purpose: Allow administrators to create, view, and manage incident reports.

Output: Incident list page with filters, incident creation form, and TanStack Query hooks.
</objective>

<context>
@.planning/phases/11-compliance-incidents/11-RESEARCH.md
@.planning/phases/11-compliance-incidents/11-01-PLAN.md
@apps/admin/lib/incidents/constants.ts
@apps/admin/lib/incidents/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create incidents hooks</name>
  <files>apps/admin/hooks/use-incidents.ts</files>
  <action>
Create TanStack Query hooks for incidents:

```typescript
'use client'

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { createClient } from '@/lib/supabase/client'
import type { IncidentCreateFormData, IncidentUpdateFormData } from '@/lib/incidents/schemas'

// ─── Query Keys ──────────────────────────────────────────────────────────────

export const incidentKeys = {
  all: ['incidents'] as const,
  list: (filters?: IncidentFilters) => [...incidentKeys.all, 'list', filters] as const,
  detail: (id: string) => [...incidentKeys.all, 'detail', id] as const,
}

interface IncidentFilters {
  status?: string
  severity?: string
  incident_type?: string
}

// ─── useIncidents ────────────────────────────────────────────────────────────

export function useIncidents(filters?: IncidentFilters) {
  const supabase = createClient()

  return useQuery({
    queryKey: incidentKeys.list(filters),
    queryFn: async () => {
      let query = supabase
        .from('incidents')
        .select(`
          *,
          participants(first_name, last_name),
          workers(profiles(first_name, last_name)),
          reporter:profiles!reported_by(first_name, last_name)
        `)
        .order('created_at', { ascending: false })

      if (filters?.status && filters.status !== 'all') {
        query = query.eq('status', filters.status)
      }
      if (filters?.severity && filters.severity !== 'all') {
        query = query.eq('severity', filters.severity)
      }
      if (filters?.incident_type && filters.incident_type !== 'all') {
        query = query.eq('incident_type', filters.incident_type)
      }

      const { data, error } = await query

      if (error) throw error
      return data
    },
  })
}

// ─── useIncident ─────────────────────────────────────────────────────────────

export function useIncident(id: string) {
  const supabase = createClient()

  return useQuery({
    queryKey: incidentKeys.detail(id),
    queryFn: async () => {
      const { data, error } = await supabase
        .from('incidents')
        .select(`
          *,
          participants(first_name, last_name),
          workers(profiles(first_name, last_name)),
          reporter:profiles!reported_by(first_name, last_name)
        `)
        .eq('id', id)
        .single()

      if (error) throw error
      return data
    },
    enabled: !!id,
  })
}

// ─── useCreateIncident ───────────────────────────────────────────────────────

export function useCreateIncident() {
  const supabase = createClient()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (data: IncidentCreateFormData & { organization_id: string; reported_by: string; requires_ndia_report: boolean }) => {
      const { data: incident, error } = await supabase
        .from('incidents')
        .insert(data as any)
        .select()
        .single()

      if (error) throw error
      return incident
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: incidentKeys.all })
    },
  })
}

// ─── useUpdateIncident ───────────────────────────────────────────────────────

export function useUpdateIncident() {
  const supabase = createClient()
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async ({ id, ...data }: IncidentUpdateFormData & { id: string }) => {
      const { data: incident, error } = await supabase
        .from('incidents')
        .update(data as any)
        .eq('id', id)
        .select()
        .single()

      if (error) throw error
      return incident
    },
    onSuccess: (_, variables) => {
      queryClient.invalidateQueries({ queryKey: incidentKeys.all })
      queryClient.invalidateQueries({ queryKey: incidentKeys.detail(variables.id) })
    },
  })
}

// ─── usePendingNdiaReports ───────────────────────────────────────────────────

export function usePendingNdiaReports() {
  const supabase = createClient()

  return useQuery({
    queryKey: [...incidentKeys.all, 'ndia-pending'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('incidents')
        .select('id, title, severity, incident_date, created_at')
        .eq('requires_ndia_report', true)
        .is('ndia_reported_at', null)
        .order('created_at', { ascending: true })

      if (error) throw error
      return data
    },
  })
}
```
  </action>
  <verify>TypeScript compilation passes</verify>
  <done>TanStack Query hooks for incidents CRUD and NDIA reporting</done>
</task>

<task type="auto">
  <name>Task 2: Create incident form component</name>
  <files>apps/admin/components/incidents/incident-form.tsx</files>
  <action>
Create incident form component with all required fields, automatic NDIA flag calculation.
Form includes: participant selector, worker selector, type, severity, title, description, actions taken, location, incident date.
Uses existing Select, Input, Textarea, Label, Button components.
Calls requiresNdiaReport() from constants to set requires_ndia_report flag.
  </action>
  <verify>Component renders without errors</verify>
  <done>Incident form with validation and NDIA auto-flagging</done>
</task>

<task type="auto">
  <name>Task 3: Create incident list page</name>
  <files>apps/admin/app/(protected)/incidents/page.tsx</files>
  <action>
Create list page with:
- Filter bar: status, severity, type dropdowns
- DataTable with columns: Title, Type, Severity, Status, Participant, Date, Actions
- "Report Incident" button linking to /incidents/new
- Badge components for severity and status
  </action>
  <verify>Page renders and displays incidents</verify>
  <done>Incident list page with filters and DataTable</done>
</task>

<task type="auto">
  <name>Task 4: Create incident creation page</name>
  <files>apps/admin/app/(protected)/incidents/new/page.tsx</files>
  <action>
Create page that renders IncidentForm component.
On success, redirect to /incidents.
  </action>
  <verify>Form submits and creates incident</verify>
  <done>Incident creation page with form</done>
</task>

<task type="auto">
  <name>Task 5: Add incidents to sidebar navigation</name>
  <files>apps/admin/components/layout/sidebar.tsx</files>
  <action>
Add "Incidents" link to sidebar navigation with AlertTriangle icon.
Place after Invoices link.
  </action>
  <verify>Sidebar shows Incidents link</verify>
  <done>Incidents added to admin sidebar</done>
</task>

</tasks>

<verification>
1. Navigate to /incidents - see empty state or list
2. Click "Report Incident" - form loads
3. Fill form with critical severity - see NDIA flag auto-set
4. Submit - redirects to list with new incident
5. Filter by status/severity - list updates
</verification>

<success_criteria>
- Admin can create incident with all required fields
- Incident list shows title, type, severity badge, status badge
- Filters work for status, severity, type
- NDIA report flag auto-calculated from type/severity
</success_criteria>
