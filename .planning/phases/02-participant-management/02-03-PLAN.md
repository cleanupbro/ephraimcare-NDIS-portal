---
phase: 02-participant-management
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/admin/lib/participants/form-store.ts
  - apps/admin/components/participants/participant-form/step-basic-info.tsx
  - apps/admin/components/participants/participant-form/step-plan-details.tsx
  - apps/admin/components/participants/participant-form/step-contacts.tsx
  - apps/admin/components/participants/participant-form/step-support-needs.tsx
  - apps/admin/components/participants/participant-form/index.tsx
  - apps/admin/app/(protected)/participants/new/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate through 4 form steps with clickable step indicators"
    - "Each step validates with Zod before allowing advancement to next step"
    - "NDIS number uniqueness is checked on blur in Step 1 with inline error"
    - "Plan end date must be after start date (validated in Step 2)"
    - "Submitting the final step creates a participant and NDIS plan in Supabase"
    - "After successful creation, admin is redirected to participant list or detail"
    - "Form state resets after successful creation (no ghost data)"
  artifacts:
    - path: "apps/admin/lib/participants/form-store.ts"
      provides: "Zustand store for multi-step form state"
      exports: ["useParticipantFormStore"]
    - path: "apps/admin/components/participants/participant-form/index.tsx"
      provides: "Multi-step form orchestrator with stepper UI"
      exports: ["ParticipantForm"]
    - path: "apps/admin/components/participants/participant-form/step-basic-info.tsx"
      provides: "Step 1 form with NDIS uniqueness check"
      exports: ["StepBasicInfo"]
    - path: "apps/admin/components/participants/participant-form/step-plan-details.tsx"
      provides: "Step 2 form with date validation"
      exports: ["StepPlanDetails"]
    - path: "apps/admin/components/participants/participant-form/step-contacts.tsx"
      provides: "Step 3 form for address and emergency contacts"
      exports: ["StepContacts"]
    - path: "apps/admin/components/participants/participant-form/step-support-needs.tsx"
      provides: "Step 4 form for notes"
      exports: ["StepSupportNeeds"]
    - path: "apps/admin/app/(protected)/participants/new/page.tsx"
      provides: "Create participant page"
  key_links:
    - from: "apps/admin/components/participants/participant-form/step-basic-info.tsx"
      to: "apps/admin/hooks/use-participants.ts"
      via: "useCheckNdisNumber hook for uniqueness"
      pattern: "useCheckNdisNumber"
    - from: "apps/admin/components/participants/participant-form/index.tsx"
      to: "apps/admin/lib/participants/form-store.ts"
      via: "useParticipantFormStore for cross-step state"
      pattern: "useParticipantFormStore"
    - from: "apps/admin/components/participants/participant-form/index.tsx"
      to: "apps/admin/hooks/use-participants.ts"
      via: "useCreateParticipant mutation for final submit"
      pattern: "useCreateParticipant"
---

<objective>
Build the multi-step participant creation form with 4 validated steps, Zustand state management, NDIS uniqueness checking, and Supabase insertion -- delivering requirements PART-02 (multi-step form), PART-08 (form validation), and PART-09 (NDIS uniqueness).

Purpose: Admin can register new NDIS participants with all required information in a guided, validated flow.
Output: Complete 4-step form with per-step validation, cross-step state via Zustand, uniqueness checking, and database creation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-participant-management/02-RESEARCH.md
@.planning/phases/02-participant-management/02-01-SUMMARY.md

@apps/admin/lib/participants/schemas.ts
@packages/types/src/domain.ts
@apps/admin/hooks/use-participants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zustand form store and Step 1-2 components</name>
  <files>
    apps/admin/lib/participants/form-store.ts
    apps/admin/components/participants/participant-form/step-basic-info.tsx
    apps/admin/components/participants/participant-form/step-plan-details.tsx
  </files>
  <action>
    **form-store.ts:**
    Create Zustand store with:
    - State: currentStep (number, default 0), basicInfo (BasicInfoData | null), planDetails (PlanDetailsData | null), contacts (ContactsData | null), supportNeeds (SupportNeedsData | null), completedSteps (Set<number>)
    - Actions: setStep(step), setBasicInfo(data), setPlanDetails(data), setContacts(data), setSupportNeeds(data), markStepComplete(step), reset()
    - Derived: getFullFormData() - returns combined data from all steps or null if required steps incomplete
    - canNavigateToStep(step) - returns true if all previous steps are completed

    **step-basic-info.tsx:**
    "use client" component with:
    - useForm<BasicInfoData> with zodResolver(basicInfoSchema)
    - defaultValues from store.basicInfo (pre-fill if returning to step)
    - Fields: first_name, last_name, ndis_number, date_of_birth (type="date"), phone, email
    - NDIS uniqueness check: Use useWatch on 'ndis_number' field. When value is 9 digits, call useCheckNdisNumber hook. If exists, show inline error "This NDIS number is already registered" below the field. Block form submission (set custom error via form.setError).
    - On submit: setBasicInfo(data), markStepComplete(0), call onNext()
    - Use Input, Label components from @ephraimcare/ui
    - Use useWatch() (NOT form.watch()) for the NDIS number reactivity - React 19 compatible

    **step-plan-details.tsx:**
    "use client" component with:
    - useForm<PlanDetailsData> with zodResolver(planDetailsSchema)
    - defaultValues from store.planDetails
    - Fields: plan_number (optional), plan_start_date (type="date"), plan_end_date (type="date"), total_budget (type="number", step="0.01")
    - Budget categories: optional repeatable section (start with one empty row, add more button). Each row has category (text) + allocated_amount (number). Use useFieldArray or manual array state.
    - Validation: Zod refine ensures end_date > start_date (shows error on plan_end_date field)
    - On submit: setPlanDetails(data), markStepComplete(1), call onNext()

    IMPORTANT for both steps:
    - Use useWatch() hook (not form.watch()) for any reactive field values
    - Each step is independent React Hook Form instance (not shared FormProvider)
    - "Next" button is type="submit" which triggers validation before proceeding
  </action>
  <verify>
    Run `pnpm typecheck`. All three files compile.
    Zustand store has reset() method that clears all state.
    Step components use zodResolver with correct schema imports.
    useWatch is used instead of form.watch().
  </verify>
  <done>Zustand store manages cross-step form state. Step 1 validates basic info with NDIS uniqueness check. Step 2 validates plan details with date logic.</done>
</task>

<task type="auto">
  <name>Task 2: Create Step 3-4 components</name>
  <files>
    apps/admin/components/participants/participant-form/step-contacts.tsx
    apps/admin/components/participants/participant-form/step-support-needs.tsx
  </files>
  <action>
    **step-contacts.tsx:**
    "use client" component with:
    - useForm<ContactsData> with zodResolver(contactsSchema)
    - defaultValues from store.contacts
    - Fields: address_line_1, address_line_2, suburb, state (Select dropdown with Australian states: NSW, VIC, QLD, SA, WA, TAS, NT, ACT), postcode, emergency_contact_name, emergency_contact_phone
    - Group fields visually: "Address" section + "Emergency Contact" section using headings or Separator
    - On submit: setContacts(data), markStepComplete(2), call onNext()

    **step-support-needs.tsx:**
    "use client" component with:
    - useForm<SupportNeedsData> with zodResolver(supportNeedsSchema)
    - defaultValues from store.supportNeeds
    - Fields: notes (Textarea with character count showing "X / 2000")
    - This is the final step, so button text is "Create Participant" instead of "Next"
    - On submit: setSupportNeeds(data), markStepComplete(3), call onSubmitAll()
    - The onSubmitAll prop triggers the final creation mutation from the parent orchestrator

    Both steps follow the same pattern as Steps 1-2:
    - Independent useForm instances
    - zodResolver for validation
    - Store hydration for defaultValues
    - "Back" button (type="button") to navigate to previous step
  </action>
  <verify>
    Run `pnpm typecheck`. Both files compile.
    Step 3 uses Select component for Australian state dropdown.
    Step 4 shows character count for notes textarea.
    Both steps have "Back" button functionality.
  </verify>
  <done>Step 3 captures address + emergency contact info. Step 4 captures support notes and triggers final creation. All steps have back navigation.</done>
</task>

<task type="auto">
  <name>Task 3: Create form orchestrator and new participant page</name>
  <files>
    apps/admin/components/participants/participant-form/index.tsx
    apps/admin/app/(protected)/participants/new/page.tsx
  </files>
  <action>
    **index.tsx (ParticipantForm orchestrator):**
    "use client" component that:

    1. Stepper UI at top showing 4 steps:
       - Step indicators: numbered circles (1, 2, 3, 4) with labels ("Basic Info", "Plan Details", "Contacts", "Support Needs")
       - Active step: primary color filled circle
       - Completed step: green checkmark circle, clickable to navigate back
       - Future step: gray outline circle, NOT clickable unless all prior steps completed
       - Connecting line between circles (gray for incomplete, green for completed)

    2. Step content area:
       - Conditionally renders the current step component based on store.currentStep
       - Passes onNext handler (increments step) and onBack handler (decrements step)
       - Step 4 passes onSubmitAll handler instead of onNext

    3. Final submission (onSubmitAll):
       - Calls store.getFullFormData() to assemble all step data
       - Gets organization_id from user session (create a helper or use existing auth context)
       - Calls useCreateParticipant().mutateAsync() with assembled data
       - On success: toast success message, store.reset(), router.push('/participants') or to the new participant's detail page
       - On error: toast error message with details

    4. Reset on mount: useEffect that calls store.reset() when component mounts (prevents ghost data from previous creates)

    **new/page.tsx:**
    Server component (or simple client wrapper) that:
    - Renders page title "Add New Participant"
    - Renders breadcrumb: Participants > New
    - Renders ParticipantForm component
    - Uses Card component to wrap the form in a clean container

    IMPORTANT:
    - The orchestrator manages which step is shown, NOT the individual steps
    - Steps call onNext/onBack/onSubmitAll -- they don't manage navigation themselves
    - Use router from next/navigation for post-creation redirect
    - Use toast/sonner for success/error notifications
    - Reset form store on component mount to prevent stale data
  </action>
  <verify>
    Run `pnpm typecheck`.
    Run `pnpm build --filter=@ephraimcare/admin` to verify the new/ route compiles.
    Verify the form orchestrator renders step indicators.
    Verify it calls store.reset() on mount.
    Verify successful creation invalidates participant list cache and navigates away.
  </verify>
  <done>Multi-step form renders with clickable stepper, validates each step before advancement, checks NDIS uniqueness, creates participant + plan in database, resets state, and redirects on success.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build --filter=@ephraimcare/admin` succeeds
3. Form store has reset() and getFullFormData() methods
4. Step 1 checks NDIS uniqueness via useCheckNdisNumber hook
5. Step 2 validates plan_end_date > plan_start_date
6. Step 4 triggers final creation mutation
7. Orchestrator resets store on mount and after success
8. Stepper UI allows clicking completed steps but not future steps
</verification>

<success_criteria>
- Admin can fill 4 steps of participant form with validation at each step (PART-02)
- Form enforces required fields, date logic, and format checks (PART-08)
- NDIS number uniqueness checked in real-time with inline error (PART-09)
- Successful creation inserts participant + NDIS plan into Supabase
- Form state resets after creation (no ghost data)
</success_criteria>

<output>
After completion, create `.planning/phases/02-participant-management/02-03-SUMMARY.md`
</output>
