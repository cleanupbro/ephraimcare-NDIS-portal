---
phase: 02-participant-management
plan: 05
type: execute
wave: 4
depends_on: ["02-04"]
files_modified:
  - apps/admin/components/participants/participant-edit-form.tsx
  - apps/admin/app/(protected)/participants/[id]/edit/page.tsx
  - apps/admin/components/participants/archive-dialog.tsx
  - apps/admin/components/participants/participant-detail.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can edit participant details with NDIS number and plan dates read-only"
    - "Edit form pre-fills with current participant data"
    - "Admin must type participant name to confirm archival"
    - "Archive is blocked if participant has upcoming or active shifts"
    - "Archived participant disappears from default list but accessible via 'Archived' filter"
    - "Success/error toast notifications shown for edit and archive actions"
  artifacts:
    - path: "apps/admin/components/participants/participant-edit-form.tsx"
      provides: "Edit form with read-only fields and update mutation"
      exports: ["ParticipantEditForm"]
    - path: "apps/admin/app/(protected)/participants/[id]/edit/page.tsx"
      provides: "Edit page route"
    - path: "apps/admin/components/participants/archive-dialog.tsx"
      provides: "Type-to-confirm archive dialog with shift check"
      exports: ["ArchiveDialog"]
  key_links:
    - from: "apps/admin/components/participants/participant-edit-form.tsx"
      to: "apps/admin/hooks/use-participants.ts"
      via: "useUpdateParticipant mutation"
      pattern: "useUpdateParticipant"
    - from: "apps/admin/components/participants/archive-dialog.tsx"
      to: "apps/admin/hooks/use-participants.ts"
      via: "useArchiveParticipant + useHasActiveShifts hooks"
      pattern: "useArchiveParticipant|useHasActiveShifts"
    - from: "apps/admin/components/participants/participant-detail.tsx"
      to: "apps/admin/components/participants/archive-dialog.tsx"
      via: "ArchiveDialog rendered in detail page header"
      pattern: "ArchiveDialog"
---

<objective>
Build edit functionality with read-only NDIS number/plan dates, and archive functionality with type-to-confirm dialog and active shift blocking -- delivering requirements PART-04 (edit) and PART-05 (archive/soft delete).

Purpose: Admin can maintain participant records and remove inactive participants from the active view without data loss.
Output: Edit page with pre-filled form, archive dialog with business rule enforcement, and action buttons wired on detail page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-participant-management/02-RESEARCH.md
@.planning/phases/02-participant-management/02-04-SUMMARY.md

@packages/types/src/domain.ts
@apps/admin/lib/participants/schemas.ts
@apps/admin/hooks/use-participants.ts
@apps/admin/components/participants/participant-detail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create participant edit form and edit page</name>
  <files>
    apps/admin/components/participants/participant-edit-form.tsx
    apps/admin/app/(protected)/participants/[id]/edit/page.tsx
  </files>
  <action>
    **participant-edit-form.tsx (ParticipantEditForm):**
    "use client" component. Props: { participant: Participant }

    Implementation:
    1. Single-page form (NOT multi-step -- editing is simpler than creation)
    2. useForm with zodResolver(participantFullSchema) -- the merged schema from schemas.ts
    3. defaultValues: pre-fill from participant prop (first_name, last_name, phone, email, address fields, notes, etc.)
    4. READ-ONLY fields (per PART-04):
       - ndis_number: displayed as static text or disabled input with visual "locked" indicator
       - Plan dates are not shown in edit form (they belong to ndis_plans table, edited separately in future)
    5. EDITABLE fields: first_name, last_name, date_of_birth, phone, email, all address fields, emergency contact fields, notes
    6. On submit: call useUpdateParticipant mutation with participant.id + form data
       - Strip ndis_number from payload before sending (even if shown)
       - On success: toast "Participant updated", router.push(`/participants/${participant.id}`)
       - On error: toast error message
    7. Cancel button: router.back() or link to detail page
    8. Layout: organized in fieldsets/sections matching the detail page (Personal, Address, Emergency Contact, Notes)

    **edit/page.tsx:**
    Server component that:
    1. Awaits params to get id (Next.js 15 pattern)
    2. Fetches participant by id (single query)
    3. If not found: notFound()
    4. Renders breadcrumb: Participants > {name} > Edit
    5. Renders ParticipantEditForm with { participant }
    6. Wraps in Card for consistent layout
  </action>
  <verify>
    Run `pnpm typecheck`.
    Run `pnpm build --filter=@ephraimcare/admin`.
    Verify ndis_number is NOT included in the mutation payload.
    Verify the form pre-fills all fields from participant prop.
    Verify notFound() handles missing participants.
  </verify>
  <done>Edit form pre-fills current data, disables NDIS number, validates editable fields, and updates participant via mutation with success/error feedback.</done>
</task>

<task type="auto">
  <name>Task 2: Create type-to-confirm archive dialog</name>
  <files>apps/admin/components/participants/archive-dialog.tsx</files>
  <action>
    Create `apps/admin/components/participants/archive-dialog.tsx` (ArchiveDialog).
    "use client" component.

    Props: {
      participantId: string
      participantName: string (full name: "First Last")
      onArchived?: () => void (callback after successful archive)
    }

    Implementation:
    1. Call useHasActiveShifts(participantId) to check for blocking shifts
    2. State: confirmText (string), open (boolean for dialog)
    3. Computed: isConfirmed = confirmText.trim() === participantName

    4. Trigger button:
       - Text: "Archive Participant"
       - variant="destructive" (red)
       - DISABLED if hasActiveShifts is true
       - If disabled, show tooltip/text: "Cannot archive: participant has upcoming or active shifts. Cancel or reassign them first."

    5. AlertDialog content:
       - Title: "Archive {participantName}?"
       - Description: "This participant will be hidden from the active list. Their data will be preserved but this action cannot be undone."
       - Input field with instruction: "Type '{participantName}' to confirm:"
       - Placeholder: "Type participant's full name"
       - Cancel button: clears confirmText and closes dialog
       - Confirm button ("Archive"): disabled until isConfirmed is true, variant destructive

    6. On confirm:
       - Call useArchiveParticipant().mutateAsync(participantId)
       - On success: toast "Participant archived", reset confirmText, close dialog, call onArchived() if provided, router.push('/participants')
       - On error: toast error message

    7. Reset confirmText when dialog closes (onOpenChange handler)

    Import: AlertDialog components from @ephraimcare/ui, Input, Button, useArchiveParticipant + useHasActiveShifts from hooks.
  </action>
  <verify>
    Run `pnpm typecheck`.
    Confirm button is disabled until exact name match.
    Archive button is disabled when hasActiveShifts is true.
    Dialog resets state on close.
  </verify>
  <done>Archive dialog requires exact name typing, blocks when active shifts exist, shows clear messaging, and archives via mutation with redirect.</done>
</task>

<task type="auto">
  <name>Task 3: Wire edit and archive buttons on detail page</name>
  <files>apps/admin/components/participants/participant-detail.tsx</files>
  <action>
    Update the existing ParticipantDetail component to add action buttons in the header section:

    1. Add to the header area (Section 1), aligned to the right:
       - "Edit" button: Link to `/participants/${participant.id}/edit`, variant="outline", with Pencil icon (lucide-react)
       - ArchiveDialog component (only shown if participant.is_active is true):
         - Pass participantId={participant.id}
         - Pass participantName={`${participant.first_name} ${participant.last_name}`}

    2. If participant is NOT active (is_active === false):
       - Show "Archived" badge prominently in the header
       - Hide the archive button (already archived)
       - Still show edit button (admin can update contact info even for archived participants)

    3. Add toast provider/notifications:
       - Ensure Toaster component is rendered somewhere in the layout (check if already present from Phase 1, if not add it to the protected layout)
       - Import toast from sonner for success/error messages in edit form and archive dialog

    4. Verify imports: Link from next/link, ArchiveDialog from ./archive-dialog, Button from @ephraimcare/ui, Pencil icon from lucide-react.
  </action>
  <verify>
    Run `pnpm typecheck`.
    Run `pnpm build --filter=@ephraimcare/admin`.
    Detail page shows Edit and Archive buttons for active participants.
    Detail page shows only Edit for archived participants.
    Clicking Edit navigates to edit page.
    Archive dialog appears when Archive button clicked.
  </verify>
  <done>Detail page has Edit (link) and Archive (dialog trigger) action buttons, with Archive hidden for already-archived participants. Toast notifications work for all CRUD operations.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build --filter=@ephraimcare/admin` succeeds
3. Edit form shows NDIS number as read-only
4. Edit form pre-fills current values and updates on submit
5. Archive dialog requires exact name match to enable confirm
6. Archive is blocked when participant has active shifts
7. Archived participants show in list when "Archived" filter selected
8. Toast notifications appear for success and error states
</verification>

<success_criteria>
- Admin can edit participant details except NDIS number and plan dates (PART-04)
- Admin can archive participant with type-to-confirm and active shift blocking (PART-05)
- Archived participants hidden from default list, accessible via filter (PART-05)
- All actions provide clear success/error feedback via toast
</success_criteria>

<output>
After completion, create `.planning/phases/02-participant-management/02-05-SUMMARY.md`
</output>
