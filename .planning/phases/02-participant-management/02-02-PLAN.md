---
phase: 02-participant-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/admin/hooks/use-participants.ts
  - apps/admin/components/participants/participant-columns.tsx
  - apps/admin/components/participants/participant-search.tsx
  - apps/admin/components/participants/participant-list.tsx
  - apps/admin/app/(protected)/participants/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see a list of all active participants in a sortable table"
    - "Admin can search participants by name or NDIS number with debounced server-side filtering"
    - "Admin can filter participants by status (active, archived, all)"
    - "List updates reactively when search term or filter changes"
    - "Empty state shown when no participants match search/filter"
  artifacts:
    - path: "apps/admin/hooks/use-participants.ts"
      provides: "TanStack Query hooks for participant data fetching and mutations"
      exports: ["useParticipants", "useParticipant", "useCreateParticipant", "useUpdateParticipant", "useArchiveParticipant", "useCheckNdisNumber", "useHasActiveShifts"]
    - path: "apps/admin/components/participants/participant-list.tsx"
      provides: "Client component wrapping DataTable with participant columns"
      exports: ["ParticipantList"]
    - path: "apps/admin/components/participants/participant-search.tsx"
      provides: "Search input + status filter dropdown"
      exports: ["ParticipantSearch"]
    - path: "apps/admin/components/participants/participant-columns.tsx"
      provides: "TanStack Table column definitions for participants"
      exports: ["participantColumns"]
  key_links:
    - from: "apps/admin/hooks/use-participants.ts"
      to: "supabase"
      via: "createClient() queries with ilike and or()"
      pattern: "\\.or\\("
    - from: "apps/admin/components/participants/participant-list.tsx"
      to: "apps/admin/components/ui/data-table.tsx"
      via: "DataTable component import"
      pattern: "DataTable"
    - from: "apps/admin/app/(protected)/participants/page.tsx"
      to: "apps/admin/components/participants/participant-list.tsx"
      via: "ParticipantList component with initialData"
      pattern: "ParticipantList"
---

<objective>
Build the participant list page with server-side search, status filtering, and sortable data table -- delivering requirement PART-01 (view list with search/filter).

Purpose: Admin can find any participant quickly by name or NDIS number, and toggle between active/archived views.
Output: Fully functional participant list page with search, filter, and navigation to detail/create pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-participant-management/02-RESEARCH.md
@.planning/phases/02-participant-management/02-01-SUMMARY.md

@packages/types/src/domain.ts
@apps/admin/lib/supabase/client.ts
@apps/admin/lib/supabase/server.ts
@apps/admin/components/ui/data-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TanStack Query hooks for participant CRUD</name>
  <files>apps/admin/hooks/use-participants.ts</files>
  <action>
    Create `apps/admin/hooks/use-participants.ts` with all query/mutation hooks needed across the phase:

    **useParticipants({ search, status }):**
    - queryKey: ['participants', { search, status }]
    - Fetches from 'participants' table with select('*') and order by first_name
    - If status === 'active': filter .eq('is_active', true)
    - If status === 'archived': filter .eq('is_active', false)
    - If status === 'all': no is_active filter
    - If search is non-empty (trimmed): apply .or(`first_name.ilike.%${term}%,last_name.ilike.%${term}%,ndis_number.ilike.%${term}%`)
    - Return typed as Participant[] from @ephraimcare/types

    **useParticipant(id):**
    - queryKey: ['participant', id]
    - Fetches single participant with .eq('id', id).single()
    - Also fetches related ndis_plans (where is_current = true) and plan_budgets via join
    - enabled: !!id
    - Return: participant with nested current plan + budgets

    **useCreateParticipant():**
    - useMutation that inserts into 'participants' table
    - Also inserts into 'ndis_plans' if plan details provided
    - Includes organization_id from session (extract via supabase.auth.getUser() then lookup profile)
    - onSuccess: invalidateQueries(['participants'])

    **useUpdateParticipant():**
    - useMutation that updates participant by id
    - Does NOT allow updating ndis_number (strip it from payload)
    - onSuccess: invalidateQueries(['participants']), invalidateQueries(['participant', id])

    **useArchiveParticipant():**
    - useMutation that sets is_active = false
    - onSuccess: invalidateQueries(['participants'])

    **useCheckNdisNumber(ndisNumber, excludeId?):**
    - queryKey: ['ndis-check', ndisNumber]
    - Queries participants where ndis_number = value, excluding excludeId if provided
    - enabled: ndisNumber.length === 9
    - staleTime: 30_000
    - Returns { exists: boolean }

    **useHasActiveShifts(participantId):**
    - queryKey: ['participant-active-shifts', participantId]
    - Queries shifts table for participant with status IN ('scheduled', 'confirmed', 'in_progress') AND scheduled_end >= now()
    - Uses select('*', { count: 'exact', head: true })
    - enabled: !!participantId
    - Returns boolean

    IMPORTANT: Use createClient from '@/lib/supabase/client' (browser client). For organization_id, query the current user's profile to get it.

    For the useParticipant hook that fetches with plan + budgets, structure the select as:
    `select('*, ndis_plans(*), ndis_plans(plan_budgets(*))') .eq('ndis_plans.is_current', true)`
    Or use two separate queries (participant + its current plan with budgets) and combine.
  </action>
  <verify>
    Run `pnpm typecheck` from monorepo root. All hooks have correct return types.
    Each hook follows TanStack Query v5 patterns (useQuery/useMutation with proper queryKey arrays).
  </verify>
  <done>All 7 hooks exist, are correctly typed, use proper Supabase filter syntax, and handle the organization_id requirement.</done>
</task>

<task type="auto">
  <name>Task 2: Create participant column definitions and search component</name>
  <files>
    apps/admin/components/participants/participant-columns.tsx
    apps/admin/components/participants/participant-search.tsx
  </files>
  <action>
    **participant-columns.tsx:**
    "use client" directive. Define `participantColumns: ColumnDef<Participant>[]` with:

    1. Name column:
       - accessorFn: (row) => `${row.first_name} ${row.last_name}`
       - id: 'name'
       - header: Sortable button with ArrowUpDown icon (from lucide-react)
       - cell: Link to `/participants/${row.original.id}` with hover:underline

    2. NDIS Number column:
       - accessorKey: 'ndis_number'
       - header: 'NDIS Number'
       - cell: monospace font, text-xs

    3. Status column:
       - accessorKey: 'is_active'
       - header: 'Status'
       - cell: Badge with variant='default' for active (green), variant='secondary' for archived

    Import Participant type from @ephraimcare/types, Button/Badge from @ephraimcare/ui, Link from next/link.

    **participant-search.tsx:**
    "use client" directive. Component that renders:

    1. Search Input:
       - Placeholder "Search by name or NDIS number..."
       - Uses useDeferredValue (React 19) to debounce the search value
       - Calls onSearchChange prop with deferred value
       - Search icon (lucide-react) as prefix

    2. Status Filter:
       - Select dropdown with options: "Active" (default), "Archived", "All"
       - Calls onStatusChange prop with selected value

    Props interface:
    - search: string
    - status: 'active' | 'archived' | 'all'
    - onSearchChange: (value: string) => void
    - onStatusChange: (value: 'active' | 'archived' | 'all') => void

    Layout: flex row with gap, search input taking flex-1, select with fixed width.
  </action>
  <verify>
    Run `pnpm typecheck`. Both files compile without errors.
    Column definitions reference correct Participant fields from types package.
  </verify>
  <done>Column definitions produce sortable name, NDIS number, and status columns. Search component handles debounced input + status select.</done>
</task>

<task type="auto">
  <name>Task 3: Build participant list page with DataTable integration</name>
  <files>
    apps/admin/components/participants/participant-list.tsx
    apps/admin/app/(protected)/participants/page.tsx
  </files>
  <action>
    **participant-list.tsx:**
    "use client" directive. Client component that:

    1. Manages search state (useState for raw input, useDeferredValue for query)
    2. Manages status filter state (useState<'active' | 'archived' | 'all'>('active'))
    3. Calls useParticipants({ search: deferredSearch, status }) to fetch data
    4. Renders ParticipantSearch component (passing state + handlers)
    5. Renders DataTable with participantColumns and fetched data
    6. Shows Skeleton loading state while isPending
    7. Accepts initialData prop for SSR hydration (passes to useParticipants as initialData option)

    Props: { initialData: Participant[] }

    Import: useParticipants from hooks, DataTable from components/ui, participantColumns, ParticipantSearch, Skeleton from UI.

    **page.tsx (replace existing):**
    Server component that:

    1. Creates server Supabase client
    2. Fetches initial participants (active only, ordered by first_name)
    3. Renders page header with title "Participants" and count subtitle
    4. Renders "Add Participant" button (Link to /participants/new) using Button component
    5. Renders ParticipantList with initialData

    Replace the existing placeholder table with the new component-based architecture. The page should use shadcn/ui Button for the add button, with Plus icon from lucide-react.
  </action>
  <verify>
    Run `pnpm typecheck` from monorepo root.
    Run `pnpm build --filter=@ephraimcare/admin` to verify page compiles.
    The page.tsx should be a valid Next.js server component (async function, no 'use client').
    The participant-list.tsx should be a valid client component ('use client' + hooks).
  </verify>
  <done>Participant list page renders with server-fetched initial data, client-side search with debouncing, status filter, sortable columns with name linking to detail page, and "Add Participant" button linking to create page.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build --filter=@ephraimcare/admin` succeeds
3. Participant list page uses DataTable with proper columns
4. Search uses useDeferredValue for debouncing
5. Status filter switches between active/archived/all
6. All 7 query hooks are properly typed
</verification>

<success_criteria>
- Admin can see participants in a sortable table (PART-01)
- Searching by name or NDIS number filters results via server-side query
- Status filter shows active (default), archived, or all participants
- Empty state displayed when no results match
- "Add Participant" button visible and links to /participants/new
</success_criteria>

<output>
After completion, create `.planning/phases/02-participant-management/02-02-SUMMARY.md`
</output>
