---
phase: 02-participant-management
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - apps/admin/components/participants/participant-budget.tsx
  - apps/admin/components/participants/participant-plan-badge.tsx
  - apps/admin/components/participants/participant-detail.tsx
  - apps/admin/app/(protected)/participants/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view a participant's full details on a dedicated page"
    - "Budget utilization shows as a progress bar with dollar amounts and percentage"
    - "Budget bar uses traffic light colors: green under 70%, amber 70-90%, red above 90%"
    - "Plan countdown shows days remaining with color-coded badge"
    - "Badge is red when under 30 days, amber under 60 days"
    - "Detail page shows personal info, NDIS plan, contacts, and support notes in scrolling sections"
    - "No active plan gracefully shows 'No active plan' state instead of NaN/errors"
  artifacts:
    - path: "apps/admin/components/participants/participant-budget.tsx"
      provides: "Budget progress bar with traffic light thresholds"
      exports: ["BudgetProgress"]
    - path: "apps/admin/components/participants/participant-plan-badge.tsx"
      provides: "Plan countdown badge with color coding"
      exports: ["PlanCountdown"]
    - path: "apps/admin/components/participants/participant-detail.tsx"
      provides: "Full detail page content with scrolling sections"
      exports: ["ParticipantDetail"]
    - path: "apps/admin/app/(protected)/participants/[id]/page.tsx"
      provides: "Dynamic route server component for participant detail"
  key_links:
    - from: "apps/admin/app/(protected)/participants/[id]/page.tsx"
      to: "supabase"
      via: "Server-side fetch of participant with plan and budgets"
      pattern: "from\\('participants'\\)"
    - from: "apps/admin/components/participants/participant-detail.tsx"
      to: "apps/admin/components/participants/participant-budget.tsx"
      via: "BudgetProgress component with allocated/used props"
      pattern: "BudgetProgress"
    - from: "apps/admin/components/participants/participant-detail.tsx"
      to: "apps/admin/components/participants/participant-plan-badge.tsx"
      via: "PlanCountdown component with endDate prop"
      pattern: "PlanCountdown"
---

<objective>
Build the participant detail page with scrolling sections showing personal info, NDIS plan with budget visualization and countdown badge, contacts, and support notes -- delivering requirements PART-03 (detail page), PART-06 (budget percentage), and PART-07 (days until plan ends).

Purpose: Admin can see all participant information at a glance, including financial and plan timeline status.
Output: Detail page with budget progress bar (traffic light colors) and plan countdown badge (color-coded urgency).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-participant-management/02-RESEARCH.md
@.planning/phases/02-participant-management/02-02-SUMMARY.md

@packages/types/src/domain.ts
@apps/admin/hooks/use-participants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create budget progress bar and plan countdown badge components</name>
  <files>
    apps/admin/components/participants/participant-budget.tsx
    apps/admin/components/participants/participant-plan-badge.tsx
  </files>
  <action>
    **participant-budget.tsx (BudgetProgress):**
    "use client" component. Props: { allocated: number, used: number }

    Implementation:
    1. Calculate percentage: allocated > 0 ? Math.round((used / allocated) * 100) : 0
    2. Guard: if allocated <= 0, render "No budget data" text instead of bar
    3. Determine color class by percentage:
       - >= 90: 'bg-red-500' (over budget warning)
       - >= 70: 'bg-amber-500' (approaching limit)
       - < 70: 'bg-green-500' (healthy)
    4. Render:
       - Top row: "${used formatted} of ${allocated formatted}" on left, "${percentage}%" on right
       - Progress bar (div with percentage width, rounded, colored background inside gray track)
       - Bottom row: "Remaining: ${allocated - used formatted}" in muted text
    5. Format currency as AUD: new Intl.NumberFormat('en-AU', { style: 'currency', currency: 'AUD' }).format(amount)

    Do NOT use shadcn Progress component if it doesn't support custom indicator colors easily. Build a simple div-based progress bar:
    ```
    <div className="h-2 w-full rounded-full bg-muted">
      <div className={`h-full rounded-full ${colorClass}`} style={{ width: `${Math.min(percentage, 100)}%` }} />
    </div>
    ```

    **participant-plan-badge.tsx (PlanCountdown):**
    "use client" component. Props: { endDate: string | null | undefined }

    Implementation:
    1. If no endDate or invalid: render Badge with "No plan" in secondary variant
    2. Calculate daysRemaining using differenceInDays(new Date(endDate), new Date()) from date-fns
    3. If daysRemaining < 0: Badge variant="destructive" with "Plan expired"
    4. If daysRemaining < 30: Badge variant="destructive" with "{X} days remaining" (red - urgent)
    5. If daysRemaining < 60: Badge with amber styling (use className override for amber since shadcn Badge may not have amber variant) with "{X} days remaining"
    6. Otherwise: Badge variant="default" (or outline) with "{X} days remaining" (green/neutral)

    For amber: use className="bg-amber-100 text-amber-800 border-amber-200" on the Badge.

    Import differenceInDays from 'date-fns', Badge from @ephraimcare/ui.
  </action>
  <verify>
    Run `pnpm typecheck`.
    BudgetProgress handles: allocated=0, used=0, used > allocated (shows >100% capped at bar width 100%).
    PlanCountdown handles: null endDate, past endDate, 15-day-out, 45-day-out, 90-day-out.
  </verify>
  <done>Budget progress bar shows traffic light colors based on utilization. Plan countdown badge shows days remaining with red/amber/green urgency coloring. Both handle edge cases gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Create participant detail content component</name>
  <files>apps/admin/components/participants/participant-detail.tsx</files>
  <action>
    Create `apps/admin/components/participants/participant-detail.tsx` (ParticipantDetail).
    "use client" component.

    Props: {
      participant: Participant (from @ephraimcare/types)
      currentPlan: NdisPlan | null
      budgets: PlanBudget[]
    }

    Layout: Scrolling page with clearly delineated sections using Card components:

    **Section 1: Header**
    - Full name (h2, font-heading)
    - NDIS number in monospace
    - PlanCountdown badge (using currentPlan?.end_date)
    - Status badge (Active/Archived)
    - Action buttons area (Edit + Archive - placeholders for now, wired in Plan 05)

    **Section 2: NDIS Plan (Card)**
    - Title: "NDIS Plan"
    - If no current plan: show "No active plan" message
    - If plan exists: show plan number, start/end dates formatted, total budget
    - BudgetProgress bar with:
      - allocated = sum of all budgets[].allocated_amount (or currentPlan.total_budget if no budget breakdown)
      - used = sum of all budgets[].used_amount

    **Section 3: Budget Breakdown (Card, only if budgets.length > 0)**
    - Table showing each budget category: category name, allocated, used, remaining
    - Each row has its own mini progress indicator

    **Section 4: Personal Information (Card)**
    - Date of birth (formatted), age calculated
    - Phone, Email
    - Full address (line 1, line 2, suburb, state, postcode)

    **Section 5: Emergency Contact (Card)**
    - Name, Phone
    - "Not provided" if both empty

    **Section 6: Support Notes (Card)**
    - Notes text or "No notes recorded"

    Use Separator between sections, Card for each section container.
    Format dates using format(new Date(dateStr), 'dd MMM yyyy') from date-fns.
    Calculate age using differenceInYears from date-fns.

    Handle all null/undefined fields gracefully with "Not provided" or "â€”" fallbacks.
  </action>
  <verify>
    Run `pnpm typecheck`.
    Component renders all 6 sections with proper null handling.
    BudgetProgress receives correct aggregated values.
    PlanCountdown receives correct endDate.
  </verify>
  <done>Detail component renders participant's full profile across 6 sections with budget visualization, plan countdown, and graceful null handling.</done>
</task>

<task type="auto">
  <name>Task 3: Create participant detail page route</name>
  <files>apps/admin/app/(protected)/participants/[id]/page.tsx</files>
  <action>
    Create `apps/admin/app/(protected)/participants/[id]/page.tsx` as a Next.js server component.

    Implementation:
    1. Extract `id` from params (Next.js 15 dynamic route: `{ params }: { params: Promise<{ id: string }> }` -- await params)
    2. Create server Supabase client
    3. Fetch participant by id: `.from('participants').select('*').eq('id', id).single()`
    4. If not found: call notFound() from next/navigation
    5. Fetch current NDIS plan: `.from('ndis_plans').select('*').eq('participant_id', id).eq('is_current', true).maybeSingle()`
    6. If plan exists, fetch budgets: `.from('plan_budgets').select('*').eq('plan_id', plan.id)`
    7. Render breadcrumb: Participants (link) > {participant name}
    8. Render ParticipantDetail component with { participant, currentPlan, budgets }

    IMPORTANT Next.js 15 patterns:
    - params is a Promise in Next.js 15 dynamic routes (must await it)
    - Use `import { notFound } from 'next/navigation'` for 404 handling
    - This is an async server component, no "use client"

    Back button: Include a link back to /participants at the top (or in breadcrumb).
  </action>
  <verify>
    Run `pnpm typecheck`.
    Run `pnpm build --filter=@ephraimcare/admin` to verify dynamic route compiles.
    Verify params is awaited (Next.js 15 requirement).
    Verify notFound() is called when participant doesn't exist.
  </verify>
  <done>Dynamic route fetches participant with plan + budgets server-side, renders detail component, handles 404 gracefully.</done>
</task>

</tasks>

<verification>
1. `pnpm typecheck` passes
2. `pnpm build --filter=@ephraimcare/admin` succeeds
3. BudgetProgress shows correct colors at different percentages
4. PlanCountdown shows correct badge colors at different day thresholds
5. Detail page loads participant data server-side with plan and budgets
6. Missing plan shows "No active plan" gracefully
7. Participant not found returns 404
</verification>

<success_criteria>
- Participant detail page shows personal info, NDIS plan, contacts, support needs (PART-03)
- Budget used percentage displays as traffic-light progress bar (PART-06)
- Days until plan ends shows as color-coded countdown badge (PART-07)
- Edge cases handled: no plan, no budgets, expired plan, null fields
</success_criteria>

<output>
After completion, create `.planning/phases/02-participant-management/02-04-SUMMARY.md`
</output>
