---
phase: 01-foundation
plan: 06
type: execute
wave: 4
depends_on: ["01-04"]
files_modified:
  - supabase/seed.sql
  - supabase/seed-auth-users.ts
autonomous: true

must_haves:
  truths:
    - "Seed script creates 5 participants with valid NDIS numbers"
    - "Seed script creates 5 workers with support types and compliance dates"
    - "Seed script creates 20 shifts across different statuses"
    - "Seed script creates 2 invoices with line items"
    - "Seed data passes all constraint checks (FK, unique, not null)"
    - "Seed creates an organization and auth users with assigned roles"
  artifacts:
    - path: "supabase/seed.sql"
      provides: "Complete seed data for testing"
      contains: "participants"
    - path: "supabase/seed-auth-users.ts"
      provides: "Auth user creation script (uses service role)"
      contains: "createUser"
  key_links:
    - from: "supabase/seed.sql"
      to: "supabase/migrations/20260124000010_create_shifts.sql"
      via: "inserts reference shifts table"
      pattern: "insert into.*shifts"
    - from: "supabase/seed-auth-users.ts"
      to: "packages/supabase/src/admin.ts"
      via: "uses admin client for user creation"
      pattern: "createAdminClient\\|SUPABASE_SERVICE_ROLE_KEY"
---

<objective>
Create comprehensive seed data that populates the database with realistic test data: 1 organization, auth users for each role, 5 participants, 5 workers, 20 shifts, 2 invoices with line items, and support type configuration.

Purpose: INFR-05 requires seed data for testing. Without it, every developer starts with an empty database and cannot test features. The seed also proves all constraints (FK, unique, enums) work correctly.
Output: A seed script that populates the database with test data when run via `supabase db reset` or `pnpm db:seed`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth user seed script</name>
  <files>
    supabase/seed-auth-users.ts
    supabase/seed-auth-users-run.sh
  </files>
  <action>
    Supabase seed.sql cannot create auth.users directly (requires admin API). Create a TypeScript script that uses the Supabase admin client to create test users.

    **supabase/seed-auth-users.ts:**
    - Uses @supabase/supabase-js createClient with SUPABASE_SERVICE_ROLE_KEY
    - Creates the following test users via supabase.auth.admin.createUser():
      1. admin@ephraimcare.test (password: "Admin123!") - role: admin
      2. coordinator@ephraimcare.test (password: "Coord123!") - role: coordinator
      3. worker1@ephraimcare.test through worker5@ephraimcare.test (password: "Worker123!") - role: worker
      4. participant1@ephraimcare.test through participant5@ephraimcare.test (password: "Part123!") - role: participant
    - For each user: createUser with email_confirm: true (skip email verification for seed)
    - After creating users, insert user_roles records linking each user to the test organization
    - Uses a fixed UUID for the organization: '00000000-0000-0000-0000-000000000001' (matches seed.sql)
    - Prints created user IDs for reference

    **supabase/seed-auth-users-run.sh:**
    ```bash
    #!/bin/bash
    # Run auth user seed script
    # Requires: SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY in environment
    npx tsx supabase/seed-auth-users.ts
    ```

    Also update root package.json to add script:
    - "db:seed-users": "npx tsx supabase/seed-auth-users.ts"

    IMPORTANT: The script must handle "user already exists" gracefully (skip or update, don't crash).
  </action>
  <verify>
    - seed-auth-users.ts creates 12 users (1 admin, 1 coordinator, 5 workers, 5 participants)
    - Each user gets a role assigned in user_roles table
    - Script uses service role key (bypasses RLS)
    - Script handles existing users gracefully
  </verify>
  <done>Auth user seed script creates test users with role assignments</done>
</task>

<task type="auto">
  <name>Task 2: Create seed.sql with all test data</name>
  <files>
    supabase/seed.sql
  </files>
  <action>
    Create comprehensive seed.sql that inserts test data. This runs via `supabase db reset` which uses the service role (bypasses RLS).

    **Order of inserts (respects foreign keys):**

    1. **Organization:**
    ```sql
    INSERT INTO public.organizations (id, name, abn, phone, email, address)
    VALUES ('00000000-0000-0000-0000-000000000001', 'Ephraim Care', '12345678901', '+61 2 1234 5678', 'admin@ephraimcare.com.au', '123 Main St, Liverpool NSW 2170');
    ```

    2. **Support Types (5 types with rates):**
    - Personal Care: $65/hr (6500 cents)
    - Community Access: $70/hr (7000 cents)
    - Domestic Assistance: $55/hr (5500 cents)
    - Transport: $45/hr (4500 cents)
    - Respite Care: $75/hr (7500 cents)
    All linked to org '00000000-0000-0000-0000-000000000001'

    3. **Participants (5):** Use fixed UUIDs for FK references later.
    - Alice Johnson (NDIS: 4312345, DOB: 1985-03-15, status: active)
    - Bob Smith (NDIS: 4312346, DOB: 1990-07-22, status: active)
    - Carol Williams (NDIS: 4312347, DOB: 1978-11-30, status: active)
    - David Brown (NDIS: 4312348, DOB: 1995-01-08, status: active)
    - Eve Davis (NDIS: 4312349, DOB: 1982-09-14, status: archived)
    Include: phone, email, address, emergency contacts, support needs, medical alerts where appropriate.

    4. **Workers (5):** Use fixed UUIDs.
    - Sarah Wilson (support_types: Personal Care, Community Access; NDIS check expires 2027-06-30)
    - James Taylor (support_types: Domestic Assistance, Transport; NDIS check expires 2026-03-15 - expiring soon!)
    - Maria Garcia (support_types: Personal Care, Respite Care; NDIS check expires 2027-12-01)
    - Ahmed Hassan (support_types: Community Access, Transport; NDIS check expires 2025-12-01 - EXPIRED for testing)
    - Lisa Chen (support_types: all types; NDIS check expires 2027-09-30)

    5. **NDIS Plans (5, one per participant):**
    - Alice: $50,000 budget, plan 2025-07-01 to 2026-06-30, used $12,500
    - Bob: $35,000 budget, plan 2025-10-01 to 2026-09-30, used $8,000
    - Carol: $60,000 budget, plan 2025-04-01 to 2026-03-31, used $30,000
    - David: $25,000 budget, plan 2026-01-01 to 2026-12-31, used $2,000
    - Eve: $40,000 budget, plan 2024-01-01 to 2024-12-31, used $40,000 (plan ended)

    6. **Shifts (20):** Mix of statuses and dates.
    Create shifts spanning the past week to next week:
    - 4 completed shifts (have actual_start and actual_end)
    - 3 in_progress shifts
    - 5 confirmed shifts (future)
    - 4 pending shifts (future)
    - 2 cancelled shifts (with cancellation_reason)
    - 2 proposed shifts
    Distribute across workers and participants. Include GPS coords for completed shifts.
    Use realistic times (9am-12pm, 1pm-4pm, etc.) in Australia/Sydney timezone.

    7. **Case Notes (4, for completed shifts):**
    - One per completed shift
    - Content: realistic care delivery descriptions (> 10 chars)
    - Mix of concern levels (none, low, medium)

    8. **Invoices (2) + Line Items:**
    - Invoice 1: INV-2026-001, for Alice, period Jan 1-15, status: final, 3 line items from completed shifts
    - Invoice 2: INV-2026-002, for Bob, period Jan 1-15, status: draft, 2 line items
    - Calculate correct subtotal, GST (10%), and total for each
    - Use lesser-of-scheduled-vs-actual for billable minutes

    **IMPORTANT:**
    - Use fixed UUIDs so they can be referenced in tests
    - All amounts in cents (bigint)
    - All timestamps in UTC (Supabase stores UTC)
    - Ensure constraint compliance (not null, unique, FK references)
    - Add comments explaining each section
  </action>
  <verify>
    - seed.sql has 5 participants, 5 workers, 20 shifts, 2 invoices
    - All INSERT statements use correct column names matching migration schemas
    - Fixed UUIDs used for FK references
    - Invoice amounts calculated correctly (subtotal + 10% GST = total)
    - Shift statuses cover all 6 enum values
    - NDIS numbers are unique 7-digit numbers
    - One worker has expired NDIS check (for future screening tests)
  </verify>
  <done>Complete seed data with 5 participants, 5 workers, 20 shifts, 2 invoices, support types, and NDIS plans</done>
</task>

</tasks>

<verification>
- seed.sql inserts data in correct FK order (org -> support_types -> participants -> workers -> ndis_plans -> shifts -> case_notes -> invoices)
- All 20 shifts have valid participant_id and worker_id references
- Invoice line items reference valid shift_ids
- Amounts are in cents and GST calculated at 10%
- Auth user script creates users with confirmed emails
- Running `supabase db reset` followed by seed-auth-users.ts produces a fully populated database
</verification>

<success_criteria>
- Seed data satisfies INFR-05 (5 participants, 5 workers, 20 shifts, 2 invoices)
- All constraint checks pass (FK, unique, not null, check constraints)
- Auth users exist with correct role assignments
- Mix of data states enables testing of different scenarios (expired checks, cancelled shifts, final/draft invoices)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-06-SUMMARY.md`
</output>
