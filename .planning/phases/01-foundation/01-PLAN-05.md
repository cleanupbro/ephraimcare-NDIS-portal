---
phase: 01-foundation
plan: 05
type: execute
wave: 4
depends_on: ["01-02", "01-04"]
files_modified:
  - apps/admin/middleware.ts
  - apps/admin/app/(auth)/login/page.tsx
  - apps/admin/app/(auth)/login/actions.ts
  - apps/admin/app/(auth)/reset-password/page.tsx
  - apps/admin/app/(auth)/reset-password/actions.ts
  - apps/admin/app/(auth)/reset-password/confirm/page.tsx
  - apps/admin/app/(auth)/layout.tsx
  - apps/admin/app/(protected)/layout.tsx
  - apps/admin/app/(protected)/dashboard/page.tsx
  - apps/admin/components/auth/login-form.tsx
  - apps/admin/components/auth/reset-password-form.tsx
  - apps/admin/components/auth/session-provider.tsx
  - apps/participant/middleware.ts
  - apps/participant/app/(auth)/login/page.tsx
  - apps/participant/app/(auth)/login/actions.ts
  - apps/participant/app/(auth)/layout.tsx
  - apps/participant/app/(protected)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can log in with email and password and see the dashboard (AUTH-01)"
    - "Admin can reset password via email link (AUTH-02)"
    - "Session auto-logs out after 8 hours of inactivity (AUTH-03)"
    - "Worker role cannot access admin dashboard (receives access denied)"
    - "Failed login shows clear error messages (AUTH-08)"
    - "Unauthenticated users are redirected to login page"
  artifacts:
    - path: "apps/admin/middleware.ts"
      provides: "Auth middleware with role-based route protection"
      contains: "updateSession"
    - path: "apps/admin/app/(auth)/login/page.tsx"
      provides: "Login page with form"
      contains: "login"
    - path: "apps/admin/app/(auth)/reset-password/page.tsx"
      provides: "Password reset request page"
      contains: "reset"
    - path: "apps/admin/components/auth/session-provider.tsx"
      provides: "Client-side session monitor (8hr timeout)"
      contains: "createInactivityMonitor"
  key_links:
    - from: "apps/admin/middleware.ts"
      to: "packages/supabase/src/middleware.ts"
      via: "updateSession import"
      pattern: "import.*updateSession.*@ephraimcare/supabase"
    - from: "apps/admin/app/(auth)/login/actions.ts"
      to: "packages/supabase/src/server.ts"
      via: "server action uses Supabase server client"
      pattern: "createClient.*@ephraimcare/supabase"
    - from: "apps/admin/components/auth/session-provider.tsx"
      to: "packages/supabase/src/session-monitor.ts"
      via: "inactivity monitor import"
      pattern: "createInactivityMonitor"
---

<objective>
Implement the complete authentication system for the admin portal: login with email/password, password reset via email link, 8-hour inactivity timeout, role-based route protection via middleware, and clear error messages. Also add basic auth to the participant portal.

Purpose: AUTH-01 through AUTH-08 are Phase 1 requirements. Without auth, no protected features can exist. The middleware enforces RBAC and the session provider handles auto-logout.
Output: Working auth flow -- admin can log in, see dashboard, reset password, and get auto-logged-out after inactivity.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin portal auth middleware and route protection</name>
  <files>
    apps/admin/middleware.ts
    apps/admin/app/(auth)/layout.tsx
    apps/admin/app/(protected)/layout.tsx
    apps/admin/components/auth/session-provider.tsx
  </files>
  <action>
    **apps/admin/middleware.ts:**
    - Import updateSession from @ephraimcare/supabase
    - Export middleware function that calls updateSession(request)
    - Export config.matcher that matches all routes EXCEPT static files, _next, api, favicon:
      ```typescript
      export const config = {
        matcher: ['/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)']
      }
      ```
    - Inside updateSession, add role-based protection:
      - If path starts with /dashboard and user has no 'admin' or 'coordinator' role in JWT claims -> redirect to /unauthorized
      - If no user at all and path is protected -> redirect to /login

    **apps/admin/app/(auth)/layout.tsx:**
    - Simple layout for auth pages (centered card, Ephraim Care branding)
    - Import globals.css from @ephraimcare/ui
    - Check if user is already authenticated, redirect to /dashboard if so

    **apps/admin/app/(protected)/layout.tsx:**
    - Layout wrapping all protected routes
    - Include SessionProvider component
    - Include basic sidebar/header shell (minimal -- just role display)
    - Include PoweredByFooter from @ephraimcare/ui

    **apps/admin/components/auth/session-provider.tsx:**
    - 'use client' component
    - Uses createInactivityMonitor from @ephraimcare/supabase with 8-hour timeout
    - On timeout: calls supabase.auth.signOut() and redirects to /login
    - Wraps children with the monitor active
    - Shows a warning toast/banner 5 minutes before timeout (optional but nice)
  </action>
  <verify>
    - middleware.ts exports middleware function and config.matcher
    - (auth) layout checks for existing session
    - (protected) layout includes SessionProvider and PoweredByFooter
    - session-provider.tsx uses 8-hour timeout (8 * 60 * 60 * 1000)
  </verify>
  <done>Middleware enforces auth + role checks, session provider handles 8hr timeout</done>
</task>

<task type="auto">
  <name>Task 2: Login and password reset pages with server actions</name>
  <files>
    apps/admin/app/(auth)/login/page.tsx
    apps/admin/app/(auth)/login/actions.ts
    apps/admin/app/(auth)/reset-password/page.tsx
    apps/admin/app/(auth)/reset-password/actions.ts
    apps/admin/app/(auth)/reset-password/confirm/page.tsx
    apps/admin/components/auth/login-form.tsx
    apps/admin/components/auth/reset-password-form.tsx
    apps/admin/app/(protected)/dashboard/page.tsx
    apps/admin/app/unauthorized/page.tsx
  </files>
  <action>
    **Login Page (apps/admin/app/(auth)/login/page.tsx):**
    - Server component that renders LoginForm
    - Page title: "Admin Login"
    - Ephraim Care logo/name at top

    **Login Actions (apps/admin/app/(auth)/login/actions.ts):**
    - 'use server'
    - login(formData: FormData) action:
      - Extract email and password from formData
      - Create Supabase server client
      - Call supabase.auth.signInWithPassword({ email, password })
      - On success: redirect to /dashboard
      - On error: return { error: 'Invalid email or password' } (AUTH-08: clear message)
      - Handle specific error codes:
        - 'invalid_credentials' -> "Invalid email or password"
        - 'email_not_confirmed' -> "Please verify your email before logging in"
        - Other -> "An unexpected error occurred. Please try again."

    **Login Form (apps/admin/components/auth/login-form.tsx):**
    - 'use client' component
    - Email input (type email, required)
    - Password input (type password, required)
    - Submit button with loading state
    - Error message display (red text below form)
    - "Forgot password?" link to /reset-password
    - Uses React Hook Form + Zod for client-side validation
    - Calls login server action on submit
    - Styled with shadcn/ui Card component (or manual Tailwind matching the theme)

    **Reset Password Page (apps/admin/app/(auth)/reset-password/page.tsx):**
    - Renders ResetPasswordForm
    - Title: "Reset Password"

    **Reset Password Actions (apps/admin/app/(auth)/reset-password/actions.ts):**
    - 'use server'
    - requestReset(formData: FormData) action:
      - Extract email
      - Call supabase.auth.resetPasswordForEmail(email, { redirectTo: `${origin}/reset-password/confirm` })
      - Return { success: true, message: 'Check your email for a reset link' }
    - confirmReset(formData: FormData) action:
      - Extract new password
      - Call supabase.auth.updateUser({ password })
      - Redirect to /login with success message

    **Reset Password Form (apps/admin/components/auth/reset-password-form.tsx):**
    - Email input with submit button
    - Success state shows "Check your email" message
    - Back link to /login

    **Confirm Password Page (apps/admin/app/(auth)/reset-password/confirm/page.tsx):**
    - New password input (with confirmation field)
    - Validates passwords match and min 8 chars
    - Calls confirmReset action

    **Dashboard Page (apps/admin/app/(protected)/dashboard/page.tsx):**
    - Server component
    - Get current user via Supabase server client (getUser())
    - Read user_role from JWT claims
    - Display: "Welcome to Ephraim Care Admin"
    - Display: "Role: {user_role}" badge
    - Display: user email
    - Placeholder content: "Dashboard content coming soon"
    - This proves AUTH-01 works end-to-end

    **Unauthorized Page (apps/admin/app/unauthorized/page.tsx):**
    - "Access Denied" heading
    - "You do not have permission to access this page."
    - "Your role: {role}" display
    - Link back to appropriate portal or logout button
    - This proves AUTH-06 works (Worker role hits this page)

    **Also set up participant portal basic auth:**
    - apps/participant/middleware.ts: Same updateSession pattern, redirects to /login
    - apps/participant/app/(auth)/login/page.tsx: Basic login page (participant role)
    - apps/participant/app/(auth)/login/actions.ts: Same login action pattern
    - apps/participant/app/(auth)/layout.tsx: Auth layout
    - apps/participant/app/(protected)/layout.tsx: Protected layout with PoweredByFooter
  </action>
  <verify>
    - Login page renders with email/password fields
    - Login action handles error cases and returns clear messages (AUTH-08)
    - Reset password flow has both request and confirm pages
    - Dashboard page reads and displays user role from JWT
    - Unauthorized page exists for role-denied access
    - Participant portal has basic login flow
  </verify>
  <done>Complete auth flow: login -> dashboard with role display, password reset via email, clear error messages, participant portal basic auth</done>
</task>

</tasks>

<verification>
- Admin can reach /login page (unauthenticated)
- Login form validates email/password client-side
- Server action authenticates and redirects to /dashboard
- Dashboard displays current user's role
- /unauthorized page shown when wrong role
- Reset password sends email and allows password update
- Session provider will sign out after 8 hours inactivity
- Participant portal has its own login flow
- AUTH-01, AUTH-02, AUTH-03, AUTH-06, AUTH-08 all addressed
</verification>

<success_criteria>
- Admin login works end-to-end (email/password -> dashboard)
- Password reset sends email link and allows new password
- Middleware blocks unauthenticated access to protected routes
- Middleware blocks unauthorized roles (Worker can't access admin)
- Session auto-logout configured at 8 hours
- Error messages are specific and helpful
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
