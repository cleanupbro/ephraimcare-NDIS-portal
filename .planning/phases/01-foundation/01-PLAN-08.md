---
phase: 01-foundation
plan: 08
type: execute
wave: 5
depends_on: ["01-02", "01-05"]
files_modified:
  - apps/admin/vitest.config.ts
  - apps/admin/tests/setup.ts
  - apps/admin/tests/unit/login-form.test.tsx
  - apps/admin/tests/unit/session-monitor.test.ts
  - apps/admin/tests/unit/role-badge.test.tsx
  - apps/admin/playwright.config.ts
  - apps/admin/tests/e2e/auth.spec.ts
  - packages/utils/vitest.config.ts
  - packages/utils/tests/dates.test.ts
  - packages/utils/tests/currency.test.ts
  - packages/utils/tests/validators.test.ts
autonomous: true

must_haves:
  truths:
    - "Unit tests pass for utils package (dates, currency, validators)"
    - "Unit tests pass for auth components (login form, session monitor, role badge)"
    - "E2E test file exists for auth flow (login, unauthorized access)"
    - "Test infrastructure is configured and turbo run test works"
    - "Vitest and Playwright configs are correct for monorepo"
  artifacts:
    - path: "apps/admin/vitest.config.ts"
      provides: "Vitest config for admin app"
      contains: "jsdom"
    - path: "packages/utils/tests/dates.test.ts"
      provides: "Timezone utility tests"
      contains: "Australia/Sydney"
    - path: "apps/admin/tests/e2e/auth.spec.ts"
      provides: "E2E auth flow tests"
      contains: "login"
  key_links:
    - from: "apps/admin/vitest.config.ts"
      to: "packages/utils/src/dates.ts"
      via: "resolve alias for @ephraimcare/*"
      pattern: "@ephraimcare"
    - from: "apps/admin/playwright.config.ts"
      to: "apps/admin/app/(auth)/login/page.tsx"
      via: "E2E tests target login page"
      pattern: "baseURL.*3000"
---

<objective>
Set up the testing infrastructure (Vitest for unit/integration, Playwright for E2E) and write initial test suites covering auth components and shared utilities. This establishes the testing patterns for all future phases.

Purpose: INFR-06 requires "Full automated test coverage." This plan creates the testing infrastructure and initial test suites that prove the pattern works. Future phases add tests as features are built.
Output: Working Vitest + Playwright setup with passing unit tests and E2E test structure.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Vitest and write unit tests for packages/utils</name>
  <files>
    packages/utils/vitest.config.ts
    packages/utils/tests/dates.test.ts
    packages/utils/tests/currency.test.ts
    packages/utils/tests/validators.test.ts
    packages/utils/package.json
  </files>
  <action>
    **packages/utils/vitest.config.ts:**
    ```typescript
    import { defineConfig } from 'vitest/config'

    export default defineConfig({
      test: {
        globals: true,
      },
    })
    ```

    Update packages/utils/package.json to add:
    - devDependencies: vitest@^3
    - scripts: { "test": "vitest run", "test:watch": "vitest" }

    **packages/utils/tests/dates.test.ts:**
    Test the timezone utilities:
    - toSydneyTime: converts UTC date to Sydney timezone TZDate
    - formatSydneyDate: formats date in Sydney time with given format string
    - getCurrentSydneyTime: returns a TZDate instance
    - getTimezoneAbbreviation: returns 'AEST' for winter dates, 'AEDT' for summer dates
    - Edge case: midnight UTC -> correct Sydney date (next day during AEST)
    - Edge case: DST transition dates

    **packages/utils/tests/currency.test.ts:**
    Test currency utilities:
    - formatAUD(10000) -> "$100.00"
    - formatAUD(0) -> "$0.00"
    - formatAUD(150050) -> "$1,500.50"
    - formatAUD(99) -> "$0.99"
    - parseCentsFromDollars(100) -> 10000
    - parseCentsFromDollars(0.99) -> 99
    - parseCentsFromDollars(1500.50) -> 150050

    **packages/utils/tests/validators.test.ts:**
    Test Zod schemas:
    - ndisNumberSchema: valid "4312345" passes, "123" fails, "abcdefg" fails, "43123456" passes (7 digits)
    - emailSchema: valid emails pass, invalid fail
    - dateRangeSchema: from < to passes, from > to fails, from = to fails
  </action>
  <verify>
    - cd packages/utils && pnpm test passes all tests
    - At least 15 test cases across 3 test files
    - No test failures
  </verify>
  <done>Utils package has Vitest config and passing unit tests for dates, currency, validators</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vitest for admin app and write component tests</name>
  <files>
    apps/admin/vitest.config.ts
    apps/admin/tests/setup.ts
    apps/admin/tests/unit/login-form.test.tsx
    apps/admin/tests/unit/session-monitor.test.ts
    apps/admin/tests/unit/role-badge.test.tsx
    apps/admin/package.json
  </files>
  <action>
    **apps/admin/vitest.config.ts (from research):**
    ```typescript
    import { defineConfig } from 'vitest/config'
    import react from '@vitejs/plugin-react'
    import path from 'path'

    export default defineConfig({
      plugins: [react()],
      test: {
        environment: 'jsdom',
        globals: true,
        setupFiles: ['./tests/setup.ts'],
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, './'),
          '@ephraimcare/ui': path.resolve(__dirname, '../../packages/ui/src'),
          '@ephraimcare/utils': path.resolve(__dirname, '../../packages/utils/src'),
          '@ephraimcare/supabase': path.resolve(__dirname, '../../packages/supabase/src'),
          '@ephraimcare/types': path.resolve(__dirname, '../../packages/types/src'),
        },
      },
    })
    ```

    **apps/admin/tests/setup.ts:**
    ```typescript
    import '@testing-library/jest-dom'
    ```

    Update apps/admin/package.json devDependencies:
    - vitest@^3, @vitejs/plugin-react, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event, jsdom

    **apps/admin/tests/unit/login-form.test.tsx:**
    - Test LoginForm renders email and password inputs
    - Test LoginForm shows validation error for empty email
    - Test LoginForm shows validation error for empty password
    - Test submit button exists and is clickable
    - Test "Forgot password?" link exists with correct href
    - Mock the login server action (can't test actual auth in unit test)
    - Use @testing-library/react render + screen queries

    **apps/admin/tests/unit/session-monitor.test.ts:**
    - Test createInactivityMonitor calls onTimeout after specified time (use fake timers)
    - Test mouse/keyboard events reset the timer
    - Test cleanup function removes event listeners
    - Test default timeout is 8 hours
    - Use vi.useFakeTimers() and vi.advanceTimersByTime()

    **apps/admin/tests/unit/role-badge.test.tsx:**
    - Test renders "admin" text for admin role
    - Test renders "coordinator" text for coordinator role
    - Test applies green color class for admin
    - Test applies teal color class for coordinator
    - Test renders with correct pill styling (rounded-full)
  </action>
  <verify>
    - cd apps/admin && pnpm test passes all tests
    - At least 12 test cases across 3 test files
    - No test failures
    - Vitest config resolves @ephraimcare/* aliases correctly
  </verify>
  <done>Admin app has Vitest config and passing unit tests for auth components</done>
</task>

<task type="auto">
  <name>Task 3: Configure Playwright and create E2E test structure</name>
  <files>
    apps/admin/playwright.config.ts
    apps/admin/tests/e2e/auth.spec.ts
  </files>
  <action>
    **apps/admin/playwright.config.ts (from research):**
    ```typescript
    import { defineConfig, devices } from '@playwright/test'

    export default defineConfig({
      testDir: './tests/e2e',
      fullyParallel: true,
      forbidOnly: !!process.env.CI,
      retries: process.env.CI ? 2 : 0,
      workers: process.env.CI ? 1 : undefined,
      reporter: 'html',
      use: {
        baseURL: 'http://localhost:3000',
        trace: 'on-first-retry',
      },
      projects: [
        { name: 'chromium', use: { ...devices['Desktop Chrome'] } },
      ],
      webServer: {
        command: 'pnpm run dev',
        url: 'http://localhost:3000',
        reuseExistingServer: !process.env.CI,
      },
    })
    ```

    Update apps/admin/package.json:
    - devDependencies: @playwright/test
    - scripts: { "test:e2e": "playwright test" }

    **apps/admin/tests/e2e/auth.spec.ts:**
    Write E2E tests for the auth flow (these test against a running app + Supabase):

    ```typescript
    import { test, expect } from '@playwright/test'

    test.describe('Authentication', () => {
      test('login page loads', async ({ page }) => {
        await page.goto('/login')
        await expect(page.getByRole('heading', { name: /login/i })).toBeVisible()
        await expect(page.getByLabel(/email/i)).toBeVisible()
        await expect(page.getByLabel(/password/i)).toBeVisible()
      })

      test('shows error on invalid credentials', async ({ page }) => {
        await page.goto('/login')
        await page.getByLabel(/email/i).fill('wrong@example.com')
        await page.getByLabel(/password/i).fill('wrongpassword')
        await page.getByRole('button', { name: /sign in|log in/i }).click()
        await expect(page.getByText(/invalid|error/i)).toBeVisible()
      })

      test('redirects to login when accessing protected route', async ({ page }) => {
        await page.goto('/dashboard')
        await expect(page).toHaveURL(/.*login/)
      })

      test('successful login redirects to dashboard', async ({ page }) => {
        // Uses seed data credentials
        await page.goto('/login')
        await page.getByLabel(/email/i).fill('admin@ephraimcare.test')
        await page.getByLabel(/password/i).fill('Admin123!')
        await page.getByRole('button', { name: /sign in|log in/i }).click()
        await expect(page).toHaveURL(/.*dashboard/)
        await expect(page.getByText(/welcome/i)).toBeVisible()
      })

      test('dashboard displays user role', async ({ page }) => {
        // Login first
        await page.goto('/login')
        await page.getByLabel(/email/i).fill('admin@ephraimcare.test')
        await page.getByLabel(/password/i).fill('Admin123!')
        await page.getByRole('button', { name: /sign in|log in/i }).click()
        await expect(page).toHaveURL(/.*dashboard/)
        await expect(page.getByText(/admin/i)).toBeVisible()
      })

      test('password reset page loads', async ({ page }) => {
        await page.goto('/reset-password')
        await expect(page.getByLabel(/email/i)).toBeVisible()
      })

      test('unauthorized role cannot access admin pages', async ({ page }) => {
        // Login as worker
        await page.goto('/login')
        await page.getByLabel(/email/i).fill('worker1@ephraimcare.test')
        await page.getByLabel(/password/i).fill('Worker123!')
        await page.getByRole('button', { name: /sign in|log in/i }).click()
        // Should be redirected to unauthorized page
        await expect(page.getByText(/access denied|unauthorized/i)).toBeVisible()
      })
    })
    ```

    Also verify turbo run test works from root by ensuring package.json scripts are correct.
  </action>
  <verify>
    - playwright.config.ts exists with correct webServer config
    - E2E test file has 7 test cases covering auth flow
    - turbo run test --dry-run includes admin and utils test tasks
    - Playwright can be installed: npx playwright install chromium
  </verify>
  <done>Playwright configured with E2E auth tests, turbo run test orchestrates all test suites</done>
</task>

</tasks>

<verification>
- pnpm turbo run test passes unit tests (packages/utils + apps/admin)
- Unit tests cover: dates, currency, validators, login-form, session-monitor, role-badge
- Playwright config exists for E2E testing
- E2E tests cover: login success, login failure, protected redirect, role display, unauthorized access
- Testing infrastructure works within Turborepo task graph
</verification>

<success_criteria>
- INFR-06 addressed: testing infrastructure exists with unit + E2E test patterns
- turbo run test executes all unit test suites
- At least 25+ test cases across all test files
- Patterns established for future phases to add tests
- E2E tests can run against dev server (when Supabase is running)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-08-SUMMARY.md`
</output>
