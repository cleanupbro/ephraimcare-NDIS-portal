---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/package.json
  - supabase/config.toml
  - supabase/migrations/20260124000001_create_extensions.sql
  - supabase/migrations/20260124000002_create_types.sql
  - supabase/migrations/20260124000003_create_audit_schema.sql
  - supabase/migrations/20260124000004_create_organizations.sql
  - supabase/migrations/20260124000005_create_profiles.sql
  - supabase/migrations/20260124000006_create_user_roles.sql
  - supabase/migrations/20260124000007_create_participants.sql
  - supabase/migrations/20260124000008_create_workers.sql
  - supabase/migrations/20260124000009_create_ndis_plans.sql
  - supabase/migrations/20260124000010_create_shifts.sql
  - supabase/migrations/20260124000011_create_case_notes.sql
  - supabase/migrations/20260124000012_create_invoices.sql
  - supabase/migrations/20260124000013_create_support_types.sql
  - supabase/migrations/20260124000014_create_error_log.sql
  - supabase/migrations/20260124000015_create_triggers.sql
autonomous: true

must_haves:
  truths:
    - "All tables exist in the database after migrations run"
    - "Audit trigger fires on insert/update/delete and logs to audit.audit_log"
    - "Error log table captures failed operations (INFR-04)"
    - "All tables have organization_id for multi-tenant isolation"
    - "Shift statuses match spec: pending, proposed, confirmed, in_progress, completed, cancelled"
  artifacts:
    - path: "supabase/migrations/20260124000003_create_audit_schema.sql"
      provides: "Audit trail infrastructure"
      contains: "audit.audit_log"
    - path: "supabase/migrations/20260124000010_create_shifts.sql"
      provides: "Shifts table with status enum"
      contains: "shift_status"
    - path: "supabase/migrations/20260124000014_create_error_log.sql"
      provides: "Error logging table"
      contains: "error_log"
    - path: "supabase/migrations/20260124000015_create_triggers.sql"
      provides: "Audit + updated_at triggers on all tables"
      contains: "audit_trigger_func"
  key_links:
    - from: "supabase/migrations/20260124000010_create_shifts.sql"
      to: "supabase/migrations/20260124000007_create_participants.sql"
      via: "foreign key participant_id"
      pattern: "references.*participants"
    - from: "supabase/migrations/20260124000012_create_invoices.sql"
      to: "supabase/migrations/20260124000007_create_participants.sql"
      via: "foreign key participant_id"
      pattern: "references.*participants"
---

<objective>
Create the complete database schema via ordered SQL migrations. This includes all tables (organizations, profiles, user_roles, participants, workers, NDIS plans, shifts, case_notes, invoices, support_types, error_log), custom types/enums, extensions, the audit schema with trigger function, and updated_at triggers.

Purpose: The database is the foundation for ALL features. Tables, types, and triggers must exist before RLS policies, auth hooks, or seed data can be applied.
Output: 15 ordered SQL migration files that create the complete schema when run sequentially.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase workspace config and foundation migrations (extensions, types, audit, core tables)</name>
  <files>
    supabase/package.json
    supabase/config.toml
    supabase/migrations/20260124000001_create_extensions.sql
    supabase/migrations/20260124000002_create_types.sql
    supabase/migrations/20260124000003_create_audit_schema.sql
    supabase/migrations/20260124000004_create_organizations.sql
    supabase/migrations/20260124000005_create_profiles.sql
    supabase/migrations/20260124000006_create_user_roles.sql
  </files>
  <action>
    **supabase/package.json:**
    - name: "@ephraimcare/supabase-config"
    - private: true
    - scripts: { "generate": "supabase gen types typescript --local > ../packages/types/src/database.ts" }

    **supabase/config.toml:**
    - project_id = "ephraimcare-dev"
    - [api] port = 54321
    - [db] port = 54322
    - [auth] site_url = "http://localhost:3000"
    - [auth] additional_redirect_urls = ["http://localhost:3001"]

    **Migration 001 - Extensions:**
    ```sql
    create extension if not exists "moddatetime" schema extensions;
    create extension if not exists "pgcrypto" schema extensions;
    create extension if not exists "uuid-ossp" schema extensions;
    ```

    **Migration 002 - Types (enums):**
    ```sql
    create type public.app_role as enum ('admin', 'coordinator', 'worker', 'participant');
    create type public.shift_status as enum ('pending', 'proposed', 'confirmed', 'in_progress', 'completed', 'cancelled');
    create type public.invoice_status as enum ('draft', 'final', 'void');
    create type public.participant_status as enum ('active', 'archived', 'on_hold');
    create type public.worker_status as enum ('active', 'inactive', 'on_leave');
    create type public.note_concern_level as enum ('none', 'low', 'medium', 'high');
    create type public.incident_severity as enum ('low', 'medium', 'high', 'critical');
    create type public.incident_status as enum ('open', 'in_review', 'closed');
    ```

    **Migration 003 - Audit Schema (exact pattern from research Pattern 3):**
    - Create schema audit
    - Create audit.audit_log table (id bigserial, table_name, record_id uuid, operation text, old_data jsonb, new_data jsonb, changed_by uuid, changed_at timestamptz default now())
    - Create audit.audit_trigger_func() function (SECURITY DEFINER, handles INSERT/UPDATE/DELETE, captures auth.uid())
    - Create index on audit_log (table_name, changed_at)

    **Migration 004 - Organizations:**
    ```sql
    create table public.organizations (
      id uuid primary key default gen_random_uuid(),
      name text not null,
      abn text,
      phone text,
      email text,
      address text,
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now()
    );
    ```

    **Migration 005 - Profiles:**
    ```sql
    create table public.profiles (
      id uuid primary key references auth.users on delete cascade,
      email text not null,
      full_name text,
      avatar_url text,
      organization_id uuid references public.organizations(id),
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now()
    );
    ```
    - Add trigger: on auth.users insert, create matching profile (use a function that inserts into profiles on new user signup)

    **Migration 006 - User Roles (exact pattern from research Pattern 2):**
    - Create user_roles table (id bigint generated, user_id uuid references auth.users on delete cascade, role app_role, organization_id uuid references organizations, unique(user_id, role))
    - Create custom_access_token_hook function (plpgsql, stable) that injects user_role and organization_id into JWT claims
    - Create authorize function helper: authorize(requested_role app_role) returns boolean
  </action>
  <verify>
    - All 6 migration files exist in supabase/migrations/
    - SQL syntax is valid (no obvious typos in CREATE TABLE statements)
    - Foreign key references point to correct tables
    - audit_trigger_func captures auth.uid() for changed_by
  </verify>
  <done>Foundation migrations exist: extensions, types, audit schema, organizations, profiles, user_roles with auth hook</done>
</task>

<task type="auto">
  <name>Task 2: Create entity and feature table migrations</name>
  <files>
    supabase/migrations/20260124000007_create_participants.sql
    supabase/migrations/20260124000008_create_workers.sql
    supabase/migrations/20260124000009_create_ndis_plans.sql
    supabase/migrations/20260124000010_create_shifts.sql
    supabase/migrations/20260124000011_create_case_notes.sql
    supabase/migrations/20260124000012_create_invoices.sql
    supabase/migrations/20260124000013_create_support_types.sql
    supabase/migrations/20260124000014_create_error_log.sql
    supabase/migrations/20260124000015_create_triggers.sql
  </files>
  <action>
    **Migration 007 - Participants:**
    ```sql
    create table public.participants (
      id uuid primary key default gen_random_uuid(),
      user_id uuid references auth.users on delete set null,  -- optional portal login
      organization_id uuid not null references public.organizations(id),
      first_name text not null,
      last_name text not null,
      ndis_number text not null,
      date_of_birth date,
      phone text,
      email text,
      address text,
      emergency_contact_name text,
      emergency_contact_phone text,
      support_needs text,
      medical_alerts text,
      status public.participant_status not null default 'active',
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now(),
      constraint unique_ndis_number unique (ndis_number)
    );
    ```
    - Create index on (organization_id, status)
    - Create index on ndis_number

    **Migration 008 - Workers:**
    ```sql
    create table public.workers (
      id uuid primary key default gen_random_uuid(),
      user_id uuid references auth.users on delete set null,  -- login reference
      organization_id uuid not null references public.organizations(id),
      first_name text not null,
      last_name text not null,
      email text not null,
      phone text,
      support_types text[] default '{}',  -- array of support type names
      qualifications text[] default '{}',
      years_experience integer default 0,
      ndis_check_number text,
      ndis_check_expiry date,
      wwcc_expiry date,
      status public.worker_status not null default 'active',
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now()
    );
    ```
    - Create index on (organization_id, status)

    **Migration 009 - NDIS Plans:**
    ```sql
    create table public.ndis_plans (
      id uuid primary key default gen_random_uuid(),
      participant_id uuid not null references public.participants(id) on delete cascade,
      organization_id uuid not null references public.organizations(id),
      plan_start_date date not null,
      plan_end_date date not null,
      total_budget_cents bigint not null default 0,
      used_budget_cents bigint not null default 0,
      is_current boolean not null default true,
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now()
    );
    ```
    - Create index on (participant_id, is_current)

    **Migration 010 - Shifts:**
    ```sql
    create table public.shifts (
      id uuid primary key default gen_random_uuid(),
      organization_id uuid not null references public.organizations(id),
      participant_id uuid not null references public.participants(id),
      worker_id uuid not null references public.workers(id),
      support_type text not null,
      scheduled_start timestamptz not null,
      scheduled_end timestamptz not null,
      actual_start timestamptz,       -- check-in time
      actual_end timestamptz,         -- check-out time
      check_in_lat numeric(10,7),
      check_in_lng numeric(10,7),
      check_out_lat numeric(10,7),
      check_out_lng numeric(10,7),
      status public.shift_status not null default 'pending',
      notes text,
      cancellation_reason text,
      admin_override_checkout boolean default false,
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now()
    );
    ```
    - Create indexes on (organization_id, status), (worker_id, scheduled_start), (participant_id, scheduled_start)

    **Migration 011 - Case Notes:**
    ```sql
    create table public.case_notes (
      id uuid primary key default gen_random_uuid(),
      organization_id uuid not null references public.organizations(id),
      shift_id uuid not null references public.shifts(id),
      worker_id uuid not null references public.workers(id),
      participant_id uuid not null references public.participants(id),
      content text not null check (char_length(content) >= 10),
      concern_level public.note_concern_level not null default 'none',
      duration_minutes integer,
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now()
    );
    ```

    **Migration 012 - Invoices:**
    ```sql
    create table public.invoices (
      id uuid primary key default gen_random_uuid(),
      organization_id uuid not null references public.organizations(id),
      participant_id uuid not null references public.participants(id),
      invoice_number text not null unique,  -- INV-YYYY-NNN format
      period_start date not null,
      period_end date not null,
      subtotal_cents bigint not null default 0,
      gst_cents bigint not null default 0,
      total_cents bigint not null default 0,
      status public.invoice_status not null default 'draft',
      finalized_at timestamptz,
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now()
    );

    create table public.invoice_line_items (
      id uuid primary key default gen_random_uuid(),
      invoice_id uuid not null references public.invoices(id) on delete cascade,
      shift_id uuid references public.shifts(id),
      service_date date not null,
      support_type text not null,
      scheduled_minutes integer not null,
      actual_minutes integer not null,
      billable_minutes integer not null,  -- lesser of scheduled vs actual
      rate_cents integer not null,
      line_total_cents bigint not null,
      created_at timestamptz not null default now()
    );
    ```

    **Migration 013 - Support Types (rate configuration):**
    ```sql
    create table public.support_types (
      id uuid primary key default gen_random_uuid(),
      organization_id uuid not null references public.organizations(id),
      name text not null,
      description text,
      rate_cents integer not null,  -- hourly rate in cents
      is_active boolean not null default true,
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now(),
      unique(organization_id, name)
    );
    ```

    **Migration 014 - Error Log (INFR-04):**
    ```sql
    create table public.error_log (
      id bigserial primary key,
      operation text not null,
      error_message text not null,
      error_details jsonb,
      user_id uuid,
      organization_id uuid,
      context jsonb,  -- request details, input data, etc.
      created_at timestamptz not null default now()
    );
    ```
    - Create index on (created_at desc)
    - Create index on (user_id)

    **Migration 015 - Triggers (all tables):**
    - Apply moddatetime updated_at trigger to: organizations, profiles, participants, workers, ndis_plans, shifts, case_notes, invoices, support_types
    - Apply audit.audit_trigger_func to: organizations, participants, workers, ndis_plans, shifts, case_notes, invoices, support_types, user_roles
    - Create profile auto-creation trigger (on auth.users insert -> create profile row)

    Each trigger should be:
    ```sql
    create trigger handle_updated_at before update on public.TABLE
      for each row execute procedure moddatetime(updated_at);

    create trigger audit_log_trigger after insert or update or delete on public.TABLE
      for each row execute function audit.audit_trigger_func();
    ```
  </action>
  <verify>
    - All 9 migration files exist (007 through 015)
    - shifts table has shift_status enum type
    - invoices table has invoice_number with unique constraint
    - error_log table exists with user_id and context columns
    - Trigger migration covers all tables (count at least 9 audit triggers)
    - All foreign keys reference correct parent tables
  </verify>
  <done>All entity tables, invoicing, error logging, and triggers are defined in ordered migrations</done>
</task>

</tasks>

<verification>
- 15 SQL migration files exist in supabase/migrations/ directory
- Files are correctly ordered (extensions first, types second, tables middle, triggers last)
- All foreign key references are valid (no forward references)
- audit_trigger_func exists before it's applied to tables
- shift_status enum includes all 6 statuses from requirements
- error_log table has user context and timestamps (INFR-04)
- moddatetime and audit triggers applied to all entity tables
</verification>

<success_criteria>
- Complete database schema defined in 15 ordered migrations
- All Phase 1-13 tables exist (forward-looking schema)
- Audit trail infrastructure captures all data changes
- Error log table exists for operational debugging
- Triggers automate updated_at and audit logging
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
