---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-03"]
files_modified:
  - supabase/migrations/20260124000016_create_rls_policies.sql
  - supabase/migrations/20260124000017_grant_permissions.sql
autonomous: true

must_haves:
  truths:
    - "RLS is enabled on ALL public tables"
    - "Users can only see data from their own organization"
    - "Admin/Coordinator can insert and update, Worker/Participant have read-only or limited access"
    - "Auth hook permissions are granted to supabase_auth_admin role"
    - "Workers can only see their own case notes"
  artifacts:
    - path: "supabase/migrations/20260124000016_create_rls_policies.sql"
      provides: "Complete RLS policies for all tables"
      contains: "enable row level security"
    - path: "supabase/migrations/20260124000017_grant_permissions.sql"
      provides: "Auth hook and RLS helper permissions"
      contains: "supabase_auth_admin"
  key_links:
    - from: "supabase/migrations/20260124000016_create_rls_policies.sql"
      to: "supabase/migrations/20260124000006_create_user_roles.sql"
      via: "get_user_role() and get_user_organization_id() functions"
      pattern: "get_user_organization_id"
    - from: "supabase/migrations/20260124000017_grant_permissions.sql"
      to: "supabase/migrations/20260124000006_create_user_roles.sql"
      via: "grants on custom_access_token_hook"
      pattern: "grant.*execute.*custom_access_token_hook"
---

<objective>
Create RLS (Row Level Security) policies for ALL tables and grant necessary permissions for the auth hook to function. This enforces organization-level data isolation and role-based access at the database level.

Purpose: RLS is the security backbone -- without it, any authenticated user could read/write all data. AUTH-07 and INFR-03 require organization-level isolation on all tables.
Output: Complete RLS policies and permission grants that enforce multi-tenant isolation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RLS policies for all tables</name>
  <files>
    supabase/migrations/20260124000016_create_rls_policies.sql
  </files>
  <action>
    Create comprehensive RLS policies. First define the helper functions (if not already in migration 006), then enable RLS and add policies for each table.

    **RLS Helper Functions** (create if not in migration 006):
    ```sql
    -- Get current user's role from JWT claims
    create or replace function public.get_user_role()
    returns public.app_role language sql stable
    as $$ select (auth.jwt() ->> 'user_role')::public.app_role; $$;

    -- Get current user's organization from JWT claims
    create or replace function public.get_user_organization_id()
    returns uuid language sql stable
    as $$ select (auth.jwt() ->> 'organization_id')::uuid; $$;

    -- Check if user is admin or coordinator
    create or replace function public.is_admin_or_coordinator()
    returns boolean language sql stable
    as $$ select get_user_role() in ('admin', 'coordinator'); $$;
    ```

    **Policy Pattern for each table:**

    **organizations:**
    - SELECT: user's organization_id matches (users only see their own org)
    - INSERT/UPDATE: admin only

    **profiles:**
    - SELECT: same organization (via join or direct organization_id check)
    - UPDATE: own profile only (id = auth.uid())

    **user_roles:**
    - SELECT: admin/coordinator can see all in their org
    - INSERT/UPDATE/DELETE: admin only in their org

    **participants:**
    - SELECT: same organization
    - INSERT/UPDATE: admin/coordinator in same org
    - Participant user can SELECT their own record (user_id = auth.uid())

    **workers:**
    - SELECT: same organization
    - INSERT/UPDATE: admin/coordinator in same org
    - Worker can SELECT their own record (user_id = auth.uid())

    **ndis_plans:**
    - SELECT: same organization
    - INSERT/UPDATE: admin/coordinator in same org

    **shifts:**
    - SELECT: same organization (worker sees own shifts, admin sees all in org)
    - INSERT/UPDATE: admin/coordinator in same org

    **case_notes:**
    - SELECT: admin/coordinator sees all in org, worker sees only own notes (worker_id matches)
    - INSERT: worker in same org (only their own shifts)
    - NOTE-05: participant role CANNOT select case_notes at all
    - NOTE-06: worker can only see own case_notes

    **invoices + invoice_line_items:**
    - SELECT: same organization. Participant can see their own invoices.
    - INSERT/UPDATE: admin/coordinator in same org

    **support_types:**
    - SELECT: same organization
    - INSERT/UPDATE: admin only in same org

    **error_log:**
    - SELECT: admin only in same org
    - INSERT: any authenticated user in same org (app logs errors)

    **audit.audit_log:**
    - No RLS needed on audit schema (only service role accesses it)
    - OR: SELECT admin only (if exposing via API)

    IMPORTANT: Every policy MUST include the organization check: `organization_id = get_user_organization_id()`. This is the multi-tenant isolation (INFR-03, AUTH-07).

    For tables without organization_id directly (profiles), join through the user's organization or check auth.uid().
  </action>
  <verify>
    - RLS is enabled on ALL public tables (grep "enable row level security" should count 10+ tables)
    - Every SELECT policy includes organization_id check
    - case_notes has specific worker-only policy
    - participant cannot see case_notes
    - invoices allow participant SELECT on their own records
  </verify>
  <done>RLS policies enforce organization isolation and role-based access on all tables</done>
</task>

<task type="auto">
  <name>Task 2: Create permission grants for auth hook and service roles</name>
  <files>
    supabase/migrations/20260124000017_grant_permissions.sql
  </files>
  <action>
    Grant necessary permissions for the auth hook and application roles.

    **Auth Hook Permissions (CRITICAL for Pitfall 5):**
    ```sql
    -- Grant supabase_auth_admin access to the hook function and user_roles table
    grant usage on schema public to supabase_auth_admin;
    grant execute on function public.custom_access_token_hook to supabase_auth_admin;
    grant select on table public.user_roles to supabase_auth_admin;

    -- Revoke function execution from public (security)
    revoke execute on function public.custom_access_token_hook from authenticated;
    revoke execute on function public.custom_access_token_hook from anon;
    ```

    **RLS Helper Function Permissions:**
    ```sql
    -- These functions are used in RLS policies, so authenticated users need EXECUTE
    grant execute on function public.get_user_role to authenticated;
    grant execute on function public.get_user_organization_id to authenticated;
    grant execute on function public.is_admin_or_coordinator to authenticated;
    ```

    **Audit Schema Permissions:**
    ```sql
    -- Audit trigger runs as SECURITY DEFINER, but grant schema usage
    grant usage on schema audit to authenticated;
    -- Only admin can read audit logs
    grant select on table audit.audit_log to authenticated;
    ```

    **Profile Auto-Creation Permissions:**
    ```sql
    -- The profile creation trigger needs to insert into profiles
    -- It runs as SECURITY DEFINER so this is handled, but grant for clarity
    grant insert on table public.profiles to supabase_auth_admin;
    ```

    Also add a comment explaining that the auth hook must be enabled in the Supabase Dashboard:
    ```sql
    -- IMPORTANT: After running migrations, enable the auth hook in:
    -- Supabase Dashboard > Authentication > Hooks (Beta)
    -- Set "Custom access token" hook to: public.custom_access_token_hook
    -- This injects user_role and organization_id into JWT claims
    ```
  </action>
  <verify>
    - supabase_auth_admin has EXECUTE on custom_access_token_hook
    - supabase_auth_admin has SELECT on user_roles
    - authenticated role has EXECUTE on helper functions
    - Comment about dashboard enablement exists in the file
  </verify>
  <done>Auth hook permissions granted, RLS helper functions accessible, dashboard enablement documented</done>
</task>

</tasks>

<verification>
- RLS enabled on all public tables (organizations, profiles, user_roles, participants, workers, ndis_plans, shifts, case_notes, invoices, invoice_line_items, support_types, error_log)
- Organization isolation enforced via get_user_organization_id() in all policies
- Role-based access: admin can CRUD, coordinator can CRUD, worker has limited access, participant has read-only
- case_notes: worker sees only own, participant sees none
- Auth hook permissions will allow JWT claims injection when hook is enabled
- All 17 migration files form a complete, ordered schema
</verification>

<success_criteria>
- Every public table has RLS enabled with at least SELECT and INSERT policies
- Organization-level isolation proven by policy structure
- Auth hook permissions documented and granted
- Worker/Participant role restrictions enforced at database level
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
